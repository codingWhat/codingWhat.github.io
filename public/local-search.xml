<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>Claude Codeé«˜æ•ˆå¼€å‘å®è·µæŒ‡å—</title>
    <link href="/2025/08/17/effective-vibe-coding-with-claude/"/>
    <url>/2025/08/17/effective-vibe-coding-with-claude/</url>
    
    <content type="html"><![CDATA[<h2 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h2><p>Claude Codeæ˜¯ä¸€æ¬¾AIé©±åŠ¨çš„å¼€å‘å·¥å…·ï¼Œé€šè¿‡æ™ºèƒ½åŒ–çš„ä»£ç ç”Ÿæˆã€é¡¹ç›®ç®¡ç†å’Œå·¥ä½œæµä¼˜åŒ–ï¼Œæ˜¾è‘—æå‡å¼€å‘æ•ˆç‡ã€‚æœ¬æ–‡å°†æ·±å…¥ä»‹ç»Claude Codeçš„æ ¸å¿ƒåŠŸèƒ½ã€é…ç½®ç­–ç•¥å’Œæœ€ä½³å®è·µï¼Œå¸®åŠ©å¼€å‘è€…æ„å»ºé«˜æ•ˆçš„AIç¼–ç¨‹å·¥ä½œæµã€‚</p><h2 id="ä¸€ã€é¡¹ç›®åˆå§‹åŒ–ä¸é…ç½®"><a href="#ä¸€ã€é¡¹ç›®åˆå§‹åŒ–ä¸é…ç½®" class="headerlink" title="ä¸€ã€é¡¹ç›®åˆå§‹åŒ–ä¸é…ç½®"></a>ä¸€ã€é¡¹ç›®åˆå§‹åŒ–ä¸é…ç½®</h2><h3 id="1-1-CLAUDE-mdé…ç½®"><a href="#1-1-CLAUDE-mdé…ç½®" class="headerlink" title="1.1 CLAUDE.mdé…ç½®"></a>1.1 CLAUDE.mdé…ç½®</h3><p>CLAUDE.mdæ˜¯é¡¹ç›®çš„æ ¸å¿ƒé…ç½®æ–‡ä»¶ï¼Œå®šä¹‰äº†AIåŠ©æ‰‹çš„è¡Œä¸ºæ¨¡å¼å’Œé¡¹ç›®ä¸Šä¸‹æ–‡ã€‚</p><p><strong>åˆå§‹åŒ–æ­¥éª¤ï¼š</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">($): claude <br>($): /init<br></code></pre></td></tr></table></figure><p><strong>æœ€ä½³å®è·µï¼š</strong></p><ul><li>æ˜ç¡®å®šä¹‰é¡¹ç›®æŠ€æœ¯æ ˆå’Œæ¶æ„è§„èŒƒ</li><li>è¯¦ç»†æè¿°ä»£ç é£æ ¼å’Œå‘½åçº¦å®š</li><li>åŒ…å«å¸¸ç”¨å‘½ä»¤å’Œæ„å»ºæµç¨‹</li><li>å®šæœŸæ›´æ–°é¡¹ç›®çŠ¶æ€å’Œä¾èµ–å˜åŒ–</li></ul><h3 id="1-2-é«˜è´¨é‡CLAUDE-mdé…ç½®æ¨¡æ¿"><a href="#1-2-é«˜è´¨é‡CLAUDE-mdé…ç½®æ¨¡æ¿" class="headerlink" title="1.2 é«˜è´¨é‡CLAUDE.mdé…ç½®æ¨¡æ¿"></a>1.2 é«˜è´¨é‡CLAUDE.mdé…ç½®æ¨¡æ¿</h3><p>åŸºäºç¤¾åŒºé«˜èµé…ç½®ï¼Œä»¥ä¸‹æ˜¯å®Œæ•´çš„CLAUDE.mdæ¨¡æ¿ï¼š</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs markdown"><span class="hljs-section"># CLAUDE.md é¡¹ç›®é…ç½®æ–‡ä»¶</span><br><br><span class="hljs-section">## å¼€å‘å“²å­¦</span><br><span class="hljs-bullet">-</span> <span class="hljs-strong">**æ¸è¿›å¼å¼€å‘**</span>ï¼šå¢é‡æ”¹è¿›èƒœè¿‡å¤§å¹…é‡æ„<br><span class="hljs-bullet">-</span> <span class="hljs-strong">**å­¦ä¹ å¯¼å‘**</span>ï¼šä»ç°æœ‰ä»£ç ä¸­å­¦ä¹ æ¨¡å¼å’Œçº¦å®š<br><span class="hljs-bullet">-</span> <span class="hljs-strong">**å®ç”¨ä¸»ä¹‰**</span>ï¼šå®ç”¨æ€§ä¼˜äºæ•™æ¡ä¸»ä¹‰<br><span class="hljs-bullet">-</span> <span class="hljs-strong">**æ¸…æ™°æ„å›¾**</span>ï¼šæ¸…æ™°è¡¨è¾¾ä¼˜äºå·§å¦™ä»£ç <br><br><span class="hljs-section">## æ ¸å¿ƒç®€æ´æ€§åŸåˆ™</span><br><span class="hljs-bullet">-</span> æ¯ä¸ªå‡½æ•°/ç±»å•ä¸€èŒè´£<br><span class="hljs-bullet">-</span> é¿å…è¿‡æ—©æŠ½è±¡<br><span class="hljs-bullet">-</span> é€‰æ‹©ç®€å•ç›´æ¥çš„è§£å†³æ–¹æ¡ˆ<br><span class="hljs-bullet">-</span> éœ€è¦è§£é‡Šçš„ä»£ç å°±æ˜¯è¿‡äºå¤æ‚çš„ä»£ç <br><br><span class="hljs-section">## é¡¹ç›®æŠ€æœ¯æ ˆ</span><br><span class="hljs-bullet">-</span> <span class="hljs-strong">**è¯­è¨€ç‰ˆæœ¬**</span>ï¼šGo 1.21+, Python 3.11+<br><span class="hljs-bullet">-</span> <span class="hljs-strong">**æ¡†æ¶ä¾èµ–**</span>ï¼š[å…·ä½“ç‰ˆæœ¬å·]<br><span class="hljs-bullet">-</span> <span class="hljs-strong">**æ„å»ºå·¥å…·**</span>ï¼šMakefile, Docker, CI/CDé…ç½®<br><span class="hljs-bullet">-</span> <span class="hljs-strong">**æ•°æ®åº“**</span>ï¼šMySQL 8.0+, Redis 6.0+<br><span class="hljs-bullet">-</span> <span class="hljs-strong">**ç›‘æ§å·¥å…·**</span>ï¼šPrometheus, Grafana<br><br><span class="hljs-section">## å®æ–½æµç¨‹</span><br><span class="hljs-bullet">1.</span> <span class="hljs-strong">**ä»»åŠ¡åˆ†è§£**</span>ï¼šå°†å¤æ‚å·¥ä½œåˆ†è§£ä¸º3-5ä¸ªé˜¶æ®µ<br><span class="hljs-bullet">2.</span> <span class="hljs-strong">**æ–‡æ¡£åŒ–è®¡åˆ’**</span>ï¼šè®°å½•å®æ–½è®¡åˆ’å’Œä¾èµ–å…³ç³»<br><span class="hljs-bullet">3.</span> <span class="hljs-strong">**æµ‹è¯•é©±åŠ¨å¼€å‘**</span>ï¼š<br><span class="hljs-bullet">   -</span> ç†è§£ç°æœ‰æ¨¡å¼<br><span class="hljs-bullet">   -</span> å…ˆå†™æµ‹è¯•<br><span class="hljs-bullet">   -</span> å®ç°æœ€å°å¯è¡Œä»£ç <br><span class="hljs-bullet">   -</span> æµ‹è¯•é€šè¿‡åé‡æ„<br><span class="hljs-bullet">   -</span> æäº¤æ¸…æ™°çš„æ¶ˆæ¯<br><br><span class="hljs-section">## å…³é”®è´¨é‡é—¨ç¦</span><br><span class="hljs-bullet">-</span> æ‰€æœ‰æµ‹è¯•å¿…é¡»é€šè¿‡<br><span class="hljs-bullet">-</span> éµå¾ªé¡¹ç›®çº¦å®š<br><span class="hljs-bullet">-</span> æ— linter/formatterè­¦å‘Š<br><span class="hljs-bullet">-</span> æ¸…æ™°çš„æäº¤æ¶ˆæ¯<br><span class="hljs-bullet">-</span> æ— æœªå¤„ç†çš„TODO<br><br><span class="hljs-section">## æŠ€æœ¯æ ‡å‡†</span><br><span class="hljs-bullet">-</span> <span class="hljs-strong">**ç»„åˆä¼˜äºç»§æ‰¿**</span><br><span class="hljs-bullet">-</span> <span class="hljs-strong">**æ¥å£ä¼˜äºå•ä¾‹**</span><br><span class="hljs-bullet">-</span> <span class="hljs-strong">**æ˜¾å¼æ•°æ®æµå’Œä¾èµ–å…³ç³»**</span><br><span class="hljs-bullet">-</span> <span class="hljs-strong">**æµ‹è¯•é©±åŠ¨å¼€å‘ä¼˜å…ˆ**</span><br><br><span class="hljs-section">## é”™è¯¯å¤„ç†åŸåˆ™</span><br><span class="hljs-bullet">-</span> æœ€å¤š3æ¬¡å°è¯•è§£å†³é—®é¢˜<br><span class="hljs-bullet">-</span> è¯¦ç»†è®°å½•å¤±è´¥è¿‡ç¨‹<br><span class="hljs-bullet">-</span> ç ”ç©¶æ›¿ä»£æ–¹æ¡ˆ<br><span class="hljs-bullet">-</span> è´¨ç–‘åŸºæœ¬å‡è®¾<br><br><span class="hljs-section">## é‡è¦æé†’</span><br><span class="hljs-bullet">-</span> æ°¸ä¸ç»•è¿‡æäº¤é’©å­<br><span class="hljs-bullet">-</span> å§‹ç»ˆå¢é‡æäº¤å¯å·¥ä½œä»£ç <br><span class="hljs-bullet">-</span> ä»ç°æœ‰å®ç°ä¸­å­¦ä¹ <br><span class="hljs-bullet">-</span> 3æ¬¡å¤±è´¥ååœæ­¢å¹¶é‡æ–°è¯„ä¼°<br></code></pre></td></tr></table></figure><h2 id="äºŒã€ä¸“ä¸šåŒ–Agenté…ç½®"><a href="#äºŒã€ä¸“ä¸šåŒ–Agenté…ç½®" class="headerlink" title="äºŒã€ä¸“ä¸šåŒ–Agenté…ç½®"></a>äºŒã€ä¸“ä¸šåŒ–Agenté…ç½®</h2><h3 id="2-1-Agentç³»ç»Ÿæ¶æ„"><a href="#2-1-Agentç³»ç»Ÿæ¶æ„" class="headerlink" title="2.1 Agentç³»ç»Ÿæ¶æ„"></a>2.1 Agentç³»ç»Ÿæ¶æ„</h3><p>Claude Codeçš„Agentç³»ç»ŸåŸºäºä»»åŠ¡ä¸“ä¸šåŒ–è®¾è®¡ï¼Œé€šè¿‡é…ç½®ä¸“é—¨çš„AIåŠ©æ‰‹å¤„ç†ç‰¹å®šå¼€å‘åœºæ™¯ã€‚</p><p><strong>æ ¸å¿ƒAgenté…ç½®ï¼š</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">($): claude<br>($): /agents<br></code></pre></td></tr></table></figure><p><strong>æ¨èAgenté…ç½®ï¼š</strong></p><table><thead><tr><th>Agentç±»å‹</th><th>æ¨¡å‹é€‰æ‹©</th><th>ä¸“ä¸šé¢†åŸŸ</th><th>ä½¿ç”¨åœºæ™¯</th></tr></thead><tbody><tr><td>python-pro</td><td>Sonnet</td><td>Pythonå¼€å‘</td><td>åç«¯æœåŠ¡ã€æ•°æ®å¤„ç†</td></tr><tr><td>golang-pro</td><td>Sonnet</td><td>Goå¼€å‘</td><td>å¾®æœåŠ¡ã€é«˜å¹¶å‘ç³»ç»Ÿ</td></tr><tr><td>performance-engineer</td><td>Opus</td><td>æ€§èƒ½ä¼˜åŒ–</td><td>ç³»ç»Ÿè°ƒä¼˜ã€ç“¶é¢ˆåˆ†æ</td></tr><tr><td>prompt-engineer</td><td>Opus</td><td>æç¤ºå·¥ç¨‹</td><td>AIå·¥ä½œæµè®¾è®¡</td></tr></tbody></table><h3 id="2-2-Agentè‡ªåŠ¨åŒ¹é…æœºåˆ¶"><a href="#2-2-Agentè‡ªåŠ¨åŒ¹é…æœºåˆ¶" class="headerlink" title="2.2 Agentè‡ªåŠ¨åŒ¹é…æœºåˆ¶"></a>2.2 Agentè‡ªåŠ¨åŒ¹é…æœºåˆ¶</h3><p>ç³»ç»Ÿé€šè¿‡å…³é”®è¯è¯†åˆ«è‡ªåŠ¨é€‰æ‹©åˆé€‚çš„Agentï¼š</p><ul><li><strong>è§¦å‘è¯æ±‡</strong>ï¼š<code>performance</code>, <code>optimization</code> â†’ performance-engineer</li><li><strong>æ–‡ä»¶æ‰©å±•å</strong>ï¼š<code>*.go</code> â†’ golang-pro</li><li><strong>æ˜¾å¼æŒ‡å®š</strong>ï¼š<code>@python-pro é‡æ„è¿™ä¸ªæ¨¡å—</code></li></ul><h2 id="ä¸‰ã€å¹¶è¡Œå¼€å‘å·¥ä½œæµ"><a href="#ä¸‰ã€å¹¶è¡Œå¼€å‘å·¥ä½œæµ" class="headerlink" title="ä¸‰ã€å¹¶è¡Œå¼€å‘å·¥ä½œæµ"></a>ä¸‰ã€å¹¶è¡Œå¼€å‘å·¥ä½œæµ</h2><h3 id="3-1-Git-Worktreeé›†æˆ"><a href="#3-1-Git-Worktreeé›†æˆ" class="headerlink" title="3.1 Git Worktreeé›†æˆ"></a>3.1 Git Worktreeé›†æˆ</h3><p>åˆ©ç”¨Git Worktreeå®ç°å¤šåˆ†æ”¯å¹¶è¡Œå¼€å‘ï¼Œæ¯ä¸ªå·¥ä½œåŒºè¿è¡Œç‹¬ç«‹çš„Claudeå®ä¾‹ã€‚</p><p><strong>åˆ›å»ºå·¥ä½œåŒºï¼š</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># åˆ›å»ºåŠŸèƒ½åˆ†æ”¯å·¥ä½œåŒº</span><br>git worktree add ../project-feature-auth feature/auth<br><span class="hljs-built_in">cd</span> ../project-feature-auth<br>claude<br></code></pre></td></tr></table></figure><p><strong>ç®¡ç†ç­–ç•¥ï¼š</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># å·¥ä½œåŒºåˆ—è¡¨</span><br>git worktree list<br><br><span class="hljs-comment"># æ¸…ç†å·¥ä½œåŒº</span><br>git worktree remove ../project-feature-auth<br>git branch -d feature/auth<br></code></pre></td></tr></table></figure><h3 id="3-2-å·¥ä½œåŒºæœ€ä½³å®è·µ"><a href="#3-2-å·¥ä½œåŒºæœ€ä½³å®è·µ" class="headerlink" title="3.2 å·¥ä½œåŒºæœ€ä½³å®è·µ"></a>3.2 å·¥ä½œåŒºæœ€ä½³å®è·µ</h3><p><strong>ç›®å½•ç»“æ„è®¾è®¡ï¼š</strong></p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs cmake"><span class="hljs-keyword">project</span>-main/           <span class="hljs-comment"># ä¸»åˆ†æ”¯</span><br>â”œâ”€â”€ <span class="hljs-keyword">project</span>-feature-a/  <span class="hljs-comment"># åŠŸèƒ½Aåˆ†æ”¯</span><br>â”œâ”€â”€ <span class="hljs-keyword">project</span>-hotfix-b/   <span class="hljs-comment"># çƒ­ä¿®å¤Båˆ†æ”¯</span><br>â””â”€â”€ <span class="hljs-keyword">project</span>-release-c/  <span class="hljs-comment"># å‘å¸ƒCåˆ†æ”¯</span><br></code></pre></td></tr></table></figure><p><strong>ç»ˆç«¯ç®¡ç†ï¼š</strong></p><ul><li>iTerm2é…ç½®ï¼šæ¯ä¸ªå·¥ä½œåŒºç‹¬ç«‹æ ‡ç­¾é¡µ</li><li>é€šçŸ¥è®¾ç½®ï¼šClaudeéœ€è¦æ³¨æ„æ—¶å‘é€æé†’</li><li>IDEé›†æˆï¼šæ¯ä¸ªå·¥ä½œåŒºæ‰“å¼€ç‹¬ç«‹çª—å£</li></ul><h2 id="å››ã€æ™ºèƒ½æ€è€ƒæ¨¡å¼"><a href="#å››ã€æ™ºèƒ½æ€è€ƒæ¨¡å¼" class="headerlink" title="å››ã€æ™ºèƒ½æ€è€ƒæ¨¡å¼"></a>å››ã€æ™ºèƒ½æ€è€ƒæ¨¡å¼</h2><h3 id="4-1-æ€è€ƒæ¨¡å¼åˆ†çº§"><a href="#4-1-æ€è€ƒæ¨¡å¼åˆ†çº§" class="headerlink" title="4.1 æ€è€ƒæ¨¡å¼åˆ†çº§"></a>4.1 æ€è€ƒæ¨¡å¼åˆ†çº§</h3><p>Claudeçš„Extended Thinkingç³»ç»Ÿæä¾›å››ä¸ªé€’è¿›çš„æ€è€ƒå±‚çº§ï¼š</p><table><thead><tr><th>æ¨¡å¼</th><th>è®¡ç®—é¢„ç®—</th><th>é€‚ç”¨åœºæ™¯</th><th>å“åº”æ—¶é—´</th></tr></thead><tbody><tr><td>think</td><td>åŸºç¡€</td><td>ç®€å•é—®é¢˜åˆ†æ</td><td>2-5ç§’</td></tr><tr><td>think hard</td><td>ä¸­ç­‰</td><td>å¤æ‚é€»è¾‘æ¨ç†</td><td>5-15ç§’</td></tr><tr><td>think harder</td><td>é«˜çº§</td><td>ç³»ç»Ÿæ¶æ„è®¾è®¡</td><td>15-30ç§’</td></tr><tr><td>ultrathink</td><td>æœ€é«˜</td><td>å…³é”®å†³ç­–åˆ†æ</td><td>30-60ç§’</td></tr></tbody></table><h3 id="4-2-ä½¿ç”¨ç­–ç•¥"><a href="#4-2-ä½¿ç”¨ç­–ç•¥" class="headerlink" title="4.2 ä½¿ç”¨ç­–ç•¥"></a>4.2 ä½¿ç”¨ç­–ç•¥</h3><p><strong>åœºæ™¯åŒ¹é…ï¼š</strong></p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs markdown"><span class="hljs-section"># ç®€å•ä»£ç å®¡æŸ¥</span><br>&quot;è¯·å®¡æŸ¥è¿™ä¸ªå‡½æ•°ï¼Œuse think mode&quot;<br><br><span class="hljs-section"># æ¶æ„è®¾è®¡</span><br>&quot;è®¾è®¡å¾®æœåŠ¡æ‹†åˆ†æ–¹æ¡ˆï¼Œuse think harder mode&quot;<br><br><span class="hljs-section"># æ€§èƒ½è°ƒä¼˜</span><br>&quot;åˆ†æç³»ç»Ÿç“¶é¢ˆå¹¶æä¾›ä¼˜åŒ–æ–¹æ¡ˆï¼Œuse ultrathink mode&quot;<br></code></pre></td></tr></table></figure><h2 id="äº”ã€è®¡åˆ’æ¨¡å¼ä¸ä»»åŠ¡ç®¡ç†"><a href="#äº”ã€è®¡åˆ’æ¨¡å¼ä¸ä»»åŠ¡ç®¡ç†" class="headerlink" title="äº”ã€è®¡åˆ’æ¨¡å¼ä¸ä»»åŠ¡ç®¡ç†"></a>äº”ã€è®¡åˆ’æ¨¡å¼ä¸ä»»åŠ¡ç®¡ç†</h2><h3 id="5-1-Plan-Modeå·¥ä½œæœºåˆ¶"><a href="#5-1-Plan-Modeå·¥ä½œæœºåˆ¶" class="headerlink" title="5.1 Plan Modeå·¥ä½œæœºåˆ¶"></a>5.1 Plan Modeå·¥ä½œæœºåˆ¶</h3><p>Plan ModeåŸºäºOpusæ¨¡å‹ï¼Œä¸“é—¨ç”¨äºå¤æ‚ä»»åŠ¡çš„åˆ†è§£å’Œè§„åˆ’ã€‚</p><p><strong>æ¿€æ´»æ–¹å¼ï¼š</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">Shift + Tab  <span class="hljs-comment"># è¿›å…¥è®¡åˆ’æ¨¡å¼</span><br></code></pre></td></tr></table></figure><p><strong>åº”ç”¨åœºæ™¯ï¼š</strong></p><ul><li>å¤§å‹åŠŸèƒ½å¼€å‘è§„åˆ’</li><li>ç³»ç»Ÿé‡æ„ç­–ç•¥åˆ¶å®š</li><li>æŠ€æœ¯é€‰å‹å†³ç­–åˆ†æ</li></ul><h3 id="5-2-ä»»åŠ¡åˆ†è§£ç­–ç•¥"><a href="#5-2-ä»»åŠ¡åˆ†è§£ç­–ç•¥" class="headerlink" title="5.2 ä»»åŠ¡åˆ†è§£ç­–ç•¥"></a>5.2 ä»»åŠ¡åˆ†è§£ç­–ç•¥</h3><p><strong>åˆ†è§£åŸåˆ™ï¼š</strong></p><ol><li><strong>ä»»åŠ¡åŸå­åŒ–</strong>ï¼šæ¯ä¸ªå­ä»»åŠ¡ç‹¬ç«‹å¯éªŒè¯</li><li><strong>ä¾èµ–å…³ç³»æ˜ç¡®</strong>ï¼šå®šä¹‰ä»»åŠ¡é—´çš„å…ˆåé¡ºåº</li><li><strong>é‡Œç¨‹ç¢‘è®¾å®š</strong>ï¼šå…³é”®èŠ‚ç‚¹çš„äº¤ä»˜ç‰©å®šä¹‰</li><li><strong>é£é™©è¯„ä¼°</strong>ï¼šè¯†åˆ«æ½œåœ¨é˜»å¡ç‚¹</li></ol><h2 id="å…­ã€Python-Goè‡ªåŠ¨åŒ–Hookç³»ç»Ÿ"><a href="#å…­ã€Python-Goè‡ªåŠ¨åŒ–Hookç³»ç»Ÿ" class="headerlink" title="å…­ã€Python&#x2F;Goè‡ªåŠ¨åŒ–Hookç³»ç»Ÿ"></a>å…­ã€Python&#x2F;Goè‡ªåŠ¨åŒ–Hookç³»ç»Ÿ</h2><h3 id="6-1-Hookç³»ç»Ÿæ¶æ„"><a href="#6-1-Hookç³»ç»Ÿæ¶æ„" class="headerlink" title="6.1 Hookç³»ç»Ÿæ¶æ„"></a>6.1 Hookç³»ç»Ÿæ¶æ„</h3><p>Claude Codeçš„Hookç³»ç»Ÿä¸“ä¸ºPythonå’ŒGoåç«¯å¼€å‘ä¼˜åŒ–ï¼Œåœ¨å…³é”®å·¥ä½œæµèŠ‚ç‚¹è‡ªåŠ¨æ‰§è¡Œè´¨é‡æ£€æŸ¥å’Œä¼˜åŒ–è„šæœ¬ã€‚</p><p><strong>Hookè§¦å‘æ—¶æœºï¼š</strong></p><ul><li><code>pre-tool-call</code>: ä»£ç ç¼–å†™å‰æ£€æŸ¥</li><li><code>post-tool-call</code>: ä»£ç ç¼–å†™åéªŒè¯  </li><li><code>code-change</code>: æ–‡ä»¶å˜æ›´æ—¶è§¦å‘</li><li><code>test-run</code>: æµ‹è¯•æ‰§è¡Œæ—¶æ£€æŸ¥</li><li><code>commit-ready</code>: Gitæäº¤å‰éªŒè¯</li></ul><h3 id="6-2-Pythonä»£ç è´¨é‡Hook"><a href="#6-2-Pythonä»£ç è´¨é‡Hook" class="headerlink" title="6.2 Pythonä»£ç è´¨é‡Hook"></a>6.2 Pythonä»£ç è´¨é‡Hook</h3><p><strong>Pythoné¡¹ç›®è‡ªåŠ¨åŒ–è´¨é‡ç®¡ç†ï¼š</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># .claude/hooks/python_quality.py</span><br><span class="hljs-keyword">import</span> subprocess<br><span class="hljs-keyword">import</span> sys<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">from</span> pathlib <span class="hljs-keyword">import</span> Path<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">PythonQualityHook</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, project_root</span>):<br>        <span class="hljs-variable language_">self</span>.project_root = Path(project_root)<br>        <span class="hljs-variable language_">self</span>.venv_python = <span class="hljs-variable language_">self</span>._find_python_executable()<br>    <br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_find_python_executable</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;æŸ¥æ‰¾è™šæ‹Ÿç¯å¢ƒä¸­çš„Pythonå¯æ‰§è¡Œæ–‡ä»¶&quot;&quot;&quot;</span><br>        venv_paths = [<br>            <span class="hljs-variable language_">self</span>.project_root / <span class="hljs-string">&quot;venv&quot;</span> / <span class="hljs-string">&quot;bin&quot;</span> / <span class="hljs-string">&quot;python&quot;</span>,<br>            <span class="hljs-variable language_">self</span>.project_root / <span class="hljs-string">&quot;.venv&quot;</span> / <span class="hljs-string">&quot;bin&quot;</span> / <span class="hljs-string">&quot;python&quot;</span>,<br>            <span class="hljs-string">&quot;python&quot;</span><br>        ]<br>        <span class="hljs-keyword">for</span> path <span class="hljs-keyword">in</span> venv_paths:<br>            <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(path, Path) <span class="hljs-keyword">and</span> path.exists():<br>                <span class="hljs-keyword">return</span> <span class="hljs-built_in">str</span>(path)<br>            <span class="hljs-keyword">elif</span> path == <span class="hljs-string">&quot;python&quot;</span>:<br>                <span class="hljs-keyword">return</span> path<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;python3&quot;</span><br>    <br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">run_command</span>(<span class="hljs-params">self, cmd, check=<span class="hljs-literal">True</span></span>):<br>        <span class="hljs-string">&quot;&quot;&quot;æ‰§è¡Œshellå‘½ä»¤&quot;&quot;&quot;</span><br>        <span class="hljs-keyword">try</span>:<br>            result = subprocess.run(<br>                cmd, shell=<span class="hljs-literal">True</span>, cwd=<span class="hljs-variable language_">self</span>.project_root,<br>                capture_output=<span class="hljs-literal">True</span>, text=<span class="hljs-literal">True</span>, check=check<br>            )<br>            <span class="hljs-keyword">return</span> result<br>        <span class="hljs-keyword">except</span> subprocess.CalledProcessError <span class="hljs-keyword">as</span> e:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Command failed: <span class="hljs-subst">&#123;cmd&#125;</span>&quot;</span>)<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Error: <span class="hljs-subst">&#123;e.stderr&#125;</span>&quot;</span>)<br>            <span class="hljs-keyword">raise</span><br>    <br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">check_code_formatting</span>(<span class="hljs-params">self, file_path</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;æ£€æŸ¥ä»£ç æ ¼å¼åŒ–&quot;&quot;&quot;</span><br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;ğŸ” æ£€æŸ¥Pythonä»£ç æ ¼å¼...&quot;</span>)<br>        <br>        <span class="hljs-comment"># Blackä»£ç æ ¼å¼åŒ–æ£€æŸ¥</span><br>        <span class="hljs-keyword">try</span>:<br>            <span class="hljs-variable language_">self</span>.run_command(<span class="hljs-string">f&quot;<span class="hljs-subst">&#123;self.venv_python&#125;</span> -m black --check --diff <span class="hljs-subst">&#123;file_path&#125;</span>&quot;</span>)<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;âœ… Blackæ ¼å¼æ£€æŸ¥é€šè¿‡&quot;</span>)<br>        <span class="hljs-keyword">except</span> subprocess.CalledProcessError:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;âŒ Blackæ ¼å¼æ£€æŸ¥å¤±è´¥ï¼Œè‡ªåŠ¨æ ¼å¼åŒ–...&quot;</span>)<br>            <span class="hljs-variable language_">self</span>.run_command(<span class="hljs-string">f&quot;<span class="hljs-subst">&#123;self.venv_python&#125;</span> -m black <span class="hljs-subst">&#123;file_path&#125;</span>&quot;</span>)<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;âœ… ä»£ç å·²è‡ªåŠ¨æ ¼å¼åŒ–&quot;</span>)<br>        <br>        <span class="hljs-comment"># isortå¯¼å…¥æ’åºæ£€æŸ¥</span><br>        <span class="hljs-keyword">try</span>:<br>            <span class="hljs-variable language_">self</span>.run_command(<span class="hljs-string">f&quot;<span class="hljs-subst">&#123;self.venv_python&#125;</span> -m isort --check-only --diff <span class="hljs-subst">&#123;file_path&#125;</span>&quot;</span>)<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;âœ… isortå¯¼å…¥æ’åºæ£€æŸ¥é€šè¿‡&quot;</span>)<br>        <span class="hljs-keyword">except</span> subprocess.CalledProcessError:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;âŒ å¯¼å…¥æ’åºæ£€æŸ¥å¤±è´¥ï¼Œè‡ªåŠ¨ä¿®å¤...&quot;</span>)<br>            <span class="hljs-variable language_">self</span>.run_command(<span class="hljs-string">f&quot;<span class="hljs-subst">&#123;self.venv_python&#125;</span> -m isort <span class="hljs-subst">&#123;file_path&#125;</span>&quot;</span>)<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;âœ… å¯¼å…¥é¡ºåºå·²è‡ªåŠ¨ä¿®å¤&quot;</span>)<br>    <br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">run_linting</span>(<span class="hljs-params">self, file_path</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;è¿è¡Œä»£ç è´¨é‡æ£€æŸ¥&quot;&quot;&quot;</span><br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;ğŸ” è¿è¡ŒPythonä»£ç è´¨é‡æ£€æŸ¥...&quot;</span>)<br>        <br>        <span class="hljs-comment"># Flake8æ£€æŸ¥</span><br>        <span class="hljs-keyword">try</span>:<br>            <span class="hljs-variable language_">self</span>.run_command(<span class="hljs-string">f&quot;<span class="hljs-subst">&#123;self.venv_python&#125;</span> -m flake8 <span class="hljs-subst">&#123;file_path&#125;</span>&quot;</span>)<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;âœ… Flake8æ£€æŸ¥é€šè¿‡&quot;</span>)<br>        <span class="hljs-keyword">except</span> subprocess.CalledProcessError <span class="hljs-keyword">as</span> e:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;âŒ Flake8æ£€æŸ¥å‘ç°é—®é¢˜:\n<span class="hljs-subst">&#123;e.stderr&#125;</span>&quot;</span>)<br>            <span class="hljs-keyword">raise</span><br>        <br>        <span class="hljs-comment"># MyPyç±»å‹æ£€æŸ¥</span><br>        <span class="hljs-keyword">try</span>:<br>            <span class="hljs-variable language_">self</span>.run_command(<span class="hljs-string">f&quot;<span class="hljs-subst">&#123;self.venv_python&#125;</span> -m mypy <span class="hljs-subst">&#123;file_path&#125;</span>&quot;</span>)<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;âœ… MyPyç±»å‹æ£€æŸ¥é€šè¿‡&quot;</span>)<br>        <span class="hljs-keyword">except</span> subprocess.CalledProcessError <span class="hljs-keyword">as</span> e:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;âš ï¸ MyPyç±»å‹æ£€æŸ¥è­¦å‘Š:\n<span class="hljs-subst">&#123;e.stderr&#125;</span>&quot;</span>)<br>    <br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">run_tests</span>(<span class="hljs-params">self, file_path</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;è¿è¡Œç›¸å…³æµ‹è¯•&quot;&quot;&quot;</span><br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;ğŸ§ª è¿è¡ŒPythonæµ‹è¯•...&quot;</span>)<br>        <br>        test_file = <span class="hljs-variable language_">self</span>._find_test_file(file_path)<br>        <span class="hljs-keyword">if</span> test_file:<br>            <span class="hljs-keyword">try</span>:<br>                <span class="hljs-variable language_">self</span>.run_command(<span class="hljs-string">f&quot;<span class="hljs-subst">&#123;self.venv_python&#125;</span> -m pytest <span class="hljs-subst">&#123;test_file&#125;</span> -v&quot;</span>)<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;âœ… ç›¸å…³æµ‹è¯•é€šè¿‡&quot;</span>)<br>            <span class="hljs-keyword">except</span> subprocess.CalledProcessError:<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;âŒ æµ‹è¯•å¤±è´¥&quot;</span>)<br>                <span class="hljs-keyword">raise</span><br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;âš ï¸ æœªæ‰¾åˆ°ç›¸å…³æµ‹è¯•æ–‡ä»¶&quot;</span>)<br>    <br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_find_test_file</span>(<span class="hljs-params">self, file_path</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;æŸ¥æ‰¾å¯¹åº”çš„æµ‹è¯•æ–‡ä»¶&quot;&quot;&quot;</span><br>        file_path = Path(file_path)<br>        possible_test_paths = [<br>            file_path.parent / <span class="hljs-string">f&quot;test_<span class="hljs-subst">&#123;file_path.stem&#125;</span>.py&quot;</span>,<br>            file_path.parent / <span class="hljs-string">&quot;tests&quot;</span> / <span class="hljs-string">f&quot;test_<span class="hljs-subst">&#123;file_path.stem&#125;</span>.py&quot;</span>,<br>            <span class="hljs-variable language_">self</span>.project_root / <span class="hljs-string">&quot;tests&quot;</span> / <span class="hljs-string">f&quot;test_<span class="hljs-subst">&#123;file_path.stem&#125;</span>.py&quot;</span><br>        ]<br>        <br>        <span class="hljs-keyword">for</span> test_path <span class="hljs-keyword">in</span> possible_test_paths:<br>            <span class="hljs-keyword">if</span> test_path.exists():<br>                <span class="hljs-keyword">return</span> <span class="hljs-built_in">str</span>(test_path)<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><br>    <br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">check_security</span>(<span class="hljs-params">self, file_path</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;å®‰å…¨æ£€æŸ¥&quot;&quot;&quot;</span><br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;ğŸ”’ è¿è¡ŒPythonå®‰å…¨æ£€æŸ¥...&quot;</span>)<br>        <br>        <span class="hljs-keyword">try</span>:<br>            <span class="hljs-variable language_">self</span>.run_command(<span class="hljs-string">f&quot;<span class="hljs-subst">&#123;self.venv_python&#125;</span> -m bandit -r <span class="hljs-subst">&#123;file_path&#125;</span>&quot;</span>)<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;âœ… Banditå®‰å…¨æ£€æŸ¥é€šè¿‡&quot;</span>)<br>        <span class="hljs-keyword">except</span> subprocess.CalledProcessError <span class="hljs-keyword">as</span> e:<br>            <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;No issues identified&quot;</span> <span class="hljs-keyword">in</span> e.stdout:<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;âœ… æœªå‘ç°å®‰å…¨é—®é¢˜&quot;</span>)<br>            <span class="hljs-keyword">else</span>:<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;âš ï¸ å‘ç°æ½œåœ¨å®‰å…¨é—®é¢˜:\n<span class="hljs-subst">&#123;e.stdout&#125;</span>&quot;</span>)<br>    <br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">execute</span>(<span class="hljs-params">self, file_path</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;æ‰§è¡Œå®Œæ•´çš„Pythonè´¨é‡æ£€æŸ¥æµç¨‹&quot;&quot;&quot;</span><br>        <span class="hljs-keyword">try</span>:<br>            <span class="hljs-variable language_">self</span>.check_code_formatting(file_path)<br>            <span class="hljs-variable language_">self</span>.run_linting(file_path)<br>            <span class="hljs-variable language_">self</span>.run_tests(file_path)<br>            <span class="hljs-variable language_">self</span>.check_security(file_path)<br>            <span class="hljs-keyword">return</span> &#123;<span class="hljs-string">&quot;success&quot;</span>: <span class="hljs-literal">True</span>, <span class="hljs-string">&quot;message&quot;</span>: <span class="hljs-string">&quot;Pythonè´¨é‡æ£€æŸ¥å…¨éƒ¨é€šè¿‡&quot;</span>&#125;<br>        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>            <span class="hljs-keyword">return</span> &#123;<span class="hljs-string">&quot;success&quot;</span>: <span class="hljs-literal">False</span>, <span class="hljs-string">&quot;error&quot;</span>: <span class="hljs-built_in">str</span>(e)&#125;<br></code></pre></td></tr></table></figure><h3 id="6-3-Goä»£ç è´¨é‡Hook"><a href="#6-3-Goä»£ç è´¨é‡Hook" class="headerlink" title="6.3 Goä»£ç è´¨é‡Hook"></a>6.3 Goä»£ç è´¨é‡Hook</h3><p><strong>Goé¡¹ç›®è‡ªåŠ¨åŒ–è´¨é‡ç®¡ç†ï¼š</strong></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// .claude/hooks/go_quality.go</span><br><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;bufio&quot;</span><br><span class="hljs-string">&quot;fmt&quot;</span><br><span class="hljs-string">&quot;os&quot;</span><br><span class="hljs-string">&quot;os/exec&quot;</span><br><span class="hljs-string">&quot;path/filepath&quot;</span><br><span class="hljs-string">&quot;strings&quot;</span><br>)<br><br><span class="hljs-keyword">type</span> GoQualityHook <span class="hljs-keyword">struct</span> &#123;<br>ProjectRoot <span class="hljs-type">string</span><br>GoPath      <span class="hljs-type">string</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewGoQualityHook</span><span class="hljs-params">(projectRoot <span class="hljs-type">string</span>)</span></span> *GoQualityHook &#123;<br>goPath := findGoExecutable()<br><span class="hljs-keyword">return</span> &amp;GoQualityHook&#123;<br>ProjectRoot: projectRoot,<br>GoPath:      goPath,<br>&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">findGoExecutable</span><span class="hljs-params">()</span></span> <span class="hljs-type">string</span> &#123;<br><span class="hljs-keyword">if</span> path, err := exec.LookPath(<span class="hljs-string">&quot;go&quot;</span>); err == <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> path<br>&#125;<br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;go&quot;</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(hook *GoQualityHook)</span></span> runCommand(name <span class="hljs-type">string</span>, args ...<span class="hljs-type">string</span>) <span class="hljs-type">error</span> &#123;<br>cmd := exec.Command(name, args...)<br>cmd.Dir = hook.ProjectRoot<br><br>output, err := cmd.CombinedOutput()<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>fmt.Printf(<span class="hljs-string">&quot;Command failed: %s %v\n&quot;</span>, name, args)<br>fmt.Printf(<span class="hljs-string">&quot;Error: %s\n&quot;</span>, <span class="hljs-type">string</span>(output))<br><span class="hljs-keyword">return</span> err<br>&#125;<br><br><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(output) &gt; <span class="hljs-number">0</span> &#123;<br>fmt.Printf(<span class="hljs-string">&quot;Output: %s\n&quot;</span>, <span class="hljs-type">string</span>(output))<br>&#125;<br><br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(hook *GoQualityHook)</span></span> checkCodeFormatting(filePath <span class="hljs-type">string</span>) <span class="hljs-type">error</span> &#123;<br>fmt.Println(<span class="hljs-string">&quot;ğŸ” æ£€æŸ¥Goä»£ç æ ¼å¼...&quot;</span>)<br><br><span class="hljs-comment">// gofmtæ£€æŸ¥</span><br>cmd := exec.Command(<span class="hljs-string">&quot;gofmt&quot;</span>, <span class="hljs-string">&quot;-l&quot;</span>, filePath)<br>cmd.Dir = hook.ProjectRoot<br>output, err := cmd.Output()<br><br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">&quot;gofmtæ£€æŸ¥å¤±è´¥: %v&quot;</span>, err)<br>&#125;<br><br><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(output) &gt; <span class="hljs-number">0</span> &#123;<br>fmt.Println(<span class="hljs-string">&quot;âŒ ä»£ç æ ¼å¼ä¸ç¬¦åˆæ ‡å‡†ï¼Œè‡ªåŠ¨æ ¼å¼åŒ–...&quot;</span>)<br><span class="hljs-keyword">if</span> err := hook.runCommand(<span class="hljs-string">&quot;gofmt&quot;</span>, <span class="hljs-string">&quot;-w&quot;</span>, filePath); err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> err<br>&#125;<br>fmt.Println(<span class="hljs-string">&quot;âœ… ä»£ç å·²è‡ªåŠ¨æ ¼å¼åŒ–&quot;</span>)<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>fmt.Println(<span class="hljs-string">&quot;âœ… gofmtæ ¼å¼æ£€æŸ¥é€šè¿‡&quot;</span>)<br>&#125;<br><br><span class="hljs-comment">// goimportsæ£€æŸ¥å’Œä¿®å¤</span><br>cmd = exec.Command(<span class="hljs-string">&quot;goimports&quot;</span>, <span class="hljs-string">&quot;-l&quot;</span>, filePath)<br>cmd.Dir = hook.ProjectRoot<br>output, err = cmd.Output()<br><br><span class="hljs-keyword">if</span> err == <span class="hljs-literal">nil</span> &amp;&amp; <span class="hljs-built_in">len</span>(output) &gt; <span class="hljs-number">0</span> &#123;<br>fmt.Println(<span class="hljs-string">&quot;âŒ å¯¼å…¥è¯­å¥éœ€è¦æ•´ç†ï¼Œè‡ªåŠ¨ä¿®å¤...&quot;</span>)<br><span class="hljs-keyword">if</span> err := hook.runCommand(<span class="hljs-string">&quot;goimports&quot;</span>, <span class="hljs-string">&quot;-w&quot;</span>, filePath); err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> err<br>&#125;<br>fmt.Println(<span class="hljs-string">&quot;âœ… å¯¼å…¥è¯­å¥å·²è‡ªåŠ¨æ•´ç†&quot;</span>)<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>fmt.Println(<span class="hljs-string">&quot;âœ… å¯¼å…¥è¯­å¥æ£€æŸ¥é€šè¿‡&quot;</span>)<br>&#125;<br><br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(hook *GoQualityHook)</span></span> runLinting(filePath <span class="hljs-type">string</span>) <span class="hljs-type">error</span> &#123;<br>fmt.Println(<span class="hljs-string">&quot;ğŸ” è¿è¡ŒGoä»£ç è´¨é‡æ£€æŸ¥...&quot;</span>)<br><br><span class="hljs-comment">// go vetæ£€æŸ¥</span><br><span class="hljs-keyword">if</span> err := hook.runCommand(hook.GoPath, <span class="hljs-string">&quot;vet&quot;</span>, filePath); err != <span class="hljs-literal">nil</span> &#123;<br>fmt.Println(<span class="hljs-string">&quot;âŒ go vetæ£€æŸ¥å¤±è´¥&quot;</span>)<br><span class="hljs-keyword">return</span> err<br>&#125;<br>fmt.Println(<span class="hljs-string">&quot;âœ… go vetæ£€æŸ¥é€šè¿‡&quot;</span>)<br><br><span class="hljs-comment">// golintæ£€æŸ¥</span><br>cmd := exec.Command(<span class="hljs-string">&quot;golint&quot;</span>, filePath)<br>cmd.Dir = hook.ProjectRoot<br>output, err := cmd.Output()<br><br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>fmt.Printf(<span class="hljs-string">&quot;âš ï¸ golintä¸å¯ç”¨: %v\n&quot;</span>, err)<br>&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(output) &gt; <span class="hljs-number">0</span> &#123;<br>fmt.Printf(<span class="hljs-string">&quot;âš ï¸ golintå»ºè®®:\n%s&quot;</span>, <span class="hljs-type">string</span>(output))<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>fmt.Println(<span class="hljs-string">&quot;âœ… golintæ£€æŸ¥é€šè¿‡&quot;</span>)<br>&#125;<br><br><span class="hljs-comment">// staticcheckæ£€æŸ¥ï¼ˆå¦‚æœå¯ç”¨ï¼‰</span><br><span class="hljs-keyword">if</span> _, err := exec.LookPath(<span class="hljs-string">&quot;staticcheck&quot;</span>); err == <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">if</span> err := hook.runCommand(<span class="hljs-string">&quot;staticcheck&quot;</span>, filePath); err != <span class="hljs-literal">nil</span> &#123;<br>fmt.Println(<span class="hljs-string">&quot;âš ï¸ staticcheckå‘ç°é—®é¢˜&quot;</span>)<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>fmt.Println(<span class="hljs-string">&quot;âœ… staticcheckæ£€æŸ¥é€šè¿‡&quot;</span>)<br>&#125;<br>&#125;<br><br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(hook *GoQualityHook)</span></span> runTests(filePath <span class="hljs-type">string</span>) <span class="hljs-type">error</span> &#123;<br>fmt.Println(<span class="hljs-string">&quot;ğŸ§ª è¿è¡ŒGoæµ‹è¯•...&quot;</span>)<br><br><span class="hljs-comment">// æŸ¥æ‰¾å¯¹åº”çš„æµ‹è¯•æ–‡ä»¶</span><br>testFile := hook.findTestFile(filePath)<br><span class="hljs-keyword">if</span> testFile == <span class="hljs-string">&quot;&quot;</span> &#123;<br>fmt.Println(<span class="hljs-string">&quot;âš ï¸ æœªæ‰¾åˆ°ç›¸å…³æµ‹è¯•æ–‡ä»¶&quot;</span>)<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-comment">// è¿è¡Œæµ‹è¯•</span><br><span class="hljs-keyword">if</span> err := hook.runCommand(hook.GoPath, <span class="hljs-string">&quot;test&quot;</span>, <span class="hljs-string">&quot;-v&quot;</span>, testFile); err != <span class="hljs-literal">nil</span> &#123;<br>fmt.Println(<span class="hljs-string">&quot;âŒ æµ‹è¯•å¤±è´¥&quot;</span>)<br><span class="hljs-keyword">return</span> err<br>&#125;<br><br>fmt.Println(<span class="hljs-string">&quot;âœ… æµ‹è¯•é€šè¿‡&quot;</span>)<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(hook *GoQualityHook)</span></span> findTestFile(filePath <span class="hljs-type">string</span>) <span class="hljs-type">string</span> &#123;<br>dir := filepath.Dir(filePath)<br>base := strings.TrimSuffix(filepath.Base(filePath), <span class="hljs-string">&quot;.go&quot;</span>)<br><br>possibleTests := []<span class="hljs-type">string</span>&#123;<br>filepath.Join(dir, base+<span class="hljs-string">&quot;_test.go&quot;</span>),<br>filepath.Join(dir, <span class="hljs-string">&quot;tests&quot;</span>, base+<span class="hljs-string">&quot;_test.go&quot;</span>),<br>&#125;<br><br><span class="hljs-keyword">for</span> _, testPath := <span class="hljs-keyword">range</span> possibleTests &#123;<br><span class="hljs-keyword">if</span> _, err := os.Stat(testPath); err == <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> testPath<br>&#125;<br>&#125;<br><br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(hook *GoQualityHook)</span></span> checkSecurity(filePath <span class="hljs-type">string</span>) <span class="hljs-type">error</span> &#123;<br>fmt.Println(<span class="hljs-string">&quot;ğŸ”’ è¿è¡ŒGoå®‰å…¨æ£€æŸ¥...&quot;</span>)<br><br><span class="hljs-comment">// gosecå®‰å…¨æ£€æŸ¥</span><br><span class="hljs-keyword">if</span> _, err := exec.LookPath(<span class="hljs-string">&quot;gosec&quot;</span>); err == <span class="hljs-literal">nil</span> &#123;<br>cmd := exec.Command(<span class="hljs-string">&quot;gosec&quot;</span>, filePath)<br>cmd.Dir = hook.ProjectRoot<br>output, err := cmd.Output()<br><br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>fmt.Printf(<span class="hljs-string">&quot;âš ï¸ gosecæ£€æŸ¥è­¦å‘Š:\n%s&quot;</span>, <span class="hljs-type">string</span>(output))<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>fmt.Println(<span class="hljs-string">&quot;âœ… gosecå®‰å…¨æ£€æŸ¥é€šè¿‡&quot;</span>)<br>&#125;<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>fmt.Println(<span class="hljs-string">&quot;âš ï¸ gosecæœªå®‰è£…ï¼Œè·³è¿‡å®‰å…¨æ£€æŸ¥&quot;</span>)<br>&#125;<br><br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(hook *GoQualityHook)</span></span> checkBenchmarks(filePath <span class="hljs-type">string</span>) <span class="hljs-type">error</span> &#123;<br>fmt.Println(<span class="hljs-string">&quot;âš¡ è¿è¡ŒGoæ€§èƒ½åŸºå‡†æµ‹è¯•...&quot;</span>)<br><br><span class="hljs-keyword">if</span> !strings.Contains(filePath, <span class="hljs-string">&quot;_test.go&quot;</span>) &#123;<br>fmt.Println(<span class="hljs-string">&quot;âš ï¸ éæµ‹è¯•æ–‡ä»¶ï¼Œè·³è¿‡åŸºå‡†æµ‹è¯•&quot;</span>)<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-comment">// è¿è¡ŒåŸºå‡†æµ‹è¯•</span><br>cmd := exec.Command(hook.GoPath, <span class="hljs-string">&quot;test&quot;</span>, <span class="hljs-string">&quot;-bench=.&quot;</span>, <span class="hljs-string">&quot;-benchmem&quot;</span>, filePath)<br>cmd.Dir = hook.ProjectRoot<br>output, err := cmd.Output()<br><br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>fmt.Printf(<span class="hljs-string">&quot;âš ï¸ åŸºå‡†æµ‹è¯•å¤±è´¥: %v\n&quot;</span>, err)<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>fmt.Printf(<span class="hljs-string">&quot;ğŸ“Š åŸºå‡†æµ‹è¯•ç»“æœ:\n%s&quot;</span>, <span class="hljs-type">string</span>(output))<br>hook.analyzeBenchmarkResults(<span class="hljs-type">string</span>(output))<br>&#125;<br><br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(hook *GoQualityHook)</span></span> analyzeBenchmarkResults(output <span class="hljs-type">string</span>) &#123;<br>scanner := bufio.NewScanner(strings.NewReader(output))<br><span class="hljs-keyword">for</span> scanner.Scan() &#123;<br>line := scanner.Text()<br><span class="hljs-keyword">if</span> strings.Contains(line, <span class="hljs-string">&quot;ns/op&quot;</span>) &#123;<br>parts := strings.Fields(line)<br><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(parts) &gt;= <span class="hljs-number">3</span> &#123;<br>fmt.Printf(<span class="hljs-string">&quot;âš¡ å‡½æ•° %s æ€§èƒ½: %s ns/op\n&quot;</span>, parts[<span class="hljs-number">0</span>], parts[<span class="hljs-number">2</span>])<br>&#125;<br>&#125;<br>&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(hook *GoQualityHook)</span></span> Execute(filePath <span class="hljs-type">string</span>) <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-keyword">interface</span>&#123;&#125; &#123;<br>fmt.Printf(<span class="hljs-string">&quot;ğŸš€ å¼€å§‹Goä»£ç è´¨é‡æ£€æŸ¥: %s\n&quot;</span>, filePath)<br><br><span class="hljs-keyword">var</span> errors []<span class="hljs-type">string</span><br><br><span class="hljs-keyword">if</span> err := hook.checkCodeFormatting(filePath); err != <span class="hljs-literal">nil</span> &#123;<br>errors = <span class="hljs-built_in">append</span>(errors, fmt.Sprintf(<span class="hljs-string">&quot;æ ¼å¼æ£€æŸ¥å¤±è´¥: %v&quot;</span>, err))<br>&#125;<br><br><span class="hljs-keyword">if</span> err := hook.runLinting(filePath); err != <span class="hljs-literal">nil</span> &#123;<br>errors = <span class="hljs-built_in">append</span>(errors, fmt.Sprintf(<span class="hljs-string">&quot;é™æ€æ£€æŸ¥å¤±è´¥: %v&quot;</span>, err))<br>&#125;<br><br><span class="hljs-keyword">if</span> err := hook.runTests(filePath); err != <span class="hljs-literal">nil</span> &#123;<br>errors = <span class="hljs-built_in">append</span>(errors, fmt.Sprintf(<span class="hljs-string">&quot;æµ‹è¯•å¤±è´¥: %v&quot;</span>, err))<br>&#125;<br><br><span class="hljs-keyword">if</span> err := hook.checkSecurity(filePath); err != <span class="hljs-literal">nil</span> &#123;<br>errors = <span class="hljs-built_in">append</span>(errors, fmt.Sprintf(<span class="hljs-string">&quot;å®‰å…¨æ£€æŸ¥å¤±è´¥: %v&quot;</span>, err))<br>&#125;<br><br><span class="hljs-keyword">if</span> err := hook.checkBenchmarks(filePath); err != <span class="hljs-literal">nil</span> &#123;<br>errors = <span class="hljs-built_in">append</span>(errors, fmt.Sprintf(<span class="hljs-string">&quot;åŸºå‡†æµ‹è¯•å¤±è´¥: %v&quot;</span>, err))<br>&#125;<br><br><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(errors) &gt; <span class="hljs-number">0</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-keyword">interface</span>&#123;&#125;&#123;<br><span class="hljs-string">&quot;success&quot;</span>: <span class="hljs-literal">false</span>,<br><span class="hljs-string">&quot;errors&quot;</span>:  errors,<br>&#125;<br>&#125;<br><br><span class="hljs-keyword">return</span> <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-keyword">interface</span>&#123;&#125;&#123;<br><span class="hljs-string">&quot;success&quot;</span>: <span class="hljs-literal">true</span>,<br><span class="hljs-string">&quot;message&quot;</span>: <span class="hljs-string">&quot;Goä»£ç è´¨é‡æ£€æŸ¥å…¨éƒ¨é€šè¿‡&quot;</span>,<br>&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(os.Args) &lt; <span class="hljs-number">2</span> &#123;<br>fmt.Println(<span class="hljs-string">&quot;Usage: go run go_quality.go &lt;file_path&gt;&quot;</span>)<br>os.Exit(<span class="hljs-number">1</span>)<br>&#125;<br><br>hook := NewGoQualityHook(<span class="hljs-string">&quot;.&quot;</span>)<br>result := hook.Execute(os.Args[<span class="hljs-number">1</span>])<br><br><span class="hljs-keyword">if</span> !result[<span class="hljs-string">&quot;success&quot;</span>].(<span class="hljs-type">bool</span>) &#123;<br>fmt.Printf(<span class="hljs-string">&quot;âŒ æ£€æŸ¥å¤±è´¥: %v\n&quot;</span>, result[<span class="hljs-string">&quot;errors&quot;</span>])<br>os.Exit(<span class="hljs-number">1</span>)<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>fmt.Println(<span class="hljs-string">&quot;âœ… æ‰€æœ‰æ£€æŸ¥é€šè¿‡&quot;</span>)<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="6-4-æ™ºèƒ½Gitæäº¤Hook"><a href="#6-4-æ™ºèƒ½Gitæäº¤Hook" class="headerlink" title="6.4 æ™ºèƒ½Gitæäº¤Hook"></a>6.4 æ™ºèƒ½Gitæäº¤Hook</h3><p><strong>è¯­ä¹‰åŒ–æäº¤è‡ªåŠ¨ç®¡ç†ï¼š</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># .claude/hooks/smart_commit.py</span><br><span class="hljs-keyword">import</span> subprocess<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">import</span> re<br><span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> datetime<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">SmartCommitHook</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, project_root</span>):<br>        <span class="hljs-variable language_">self</span>.project_root = project_root<br>        <span class="hljs-variable language_">self</span>.commit_types = &#123;<br>            <span class="hljs-string">&#x27;feat&#x27;</span>: <span class="hljs-string">&#x27;æ–°åŠŸèƒ½&#x27;</span>,<br>            <span class="hljs-string">&#x27;fix&#x27;</span>: <span class="hljs-string">&#x27;é”™è¯¯ä¿®å¤&#x27;</span>,<br>            <span class="hljs-string">&#x27;refactor&#x27;</span>: <span class="hljs-string">&#x27;ä»£ç é‡æ„&#x27;</span>,<br>            <span class="hljs-string">&#x27;test&#x27;</span>: <span class="hljs-string">&#x27;æµ‹è¯•ç›¸å…³&#x27;</span>,<br>            <span class="hljs-string">&#x27;docs&#x27;</span>: <span class="hljs-string">&#x27;æ–‡æ¡£æ›´æ–°&#x27;</span>,<br>            <span class="hljs-string">&#x27;style&#x27;</span>: <span class="hljs-string">&#x27;ä»£ç æ ¼å¼&#x27;</span>,<br>            <span class="hljs-string">&#x27;perf&#x27;</span>: <span class="hljs-string">&#x27;æ€§èƒ½ä¼˜åŒ–&#x27;</span>,<br>            <span class="hljs-string">&#x27;chore&#x27;</span>: <span class="hljs-string">&#x27;å…¶ä»–æ‚é¡¹&#x27;</span><br>        &#125;<br>    <br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">run_command</span>(<span class="hljs-params">self, cmd</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;æ‰§è¡ŒGitå‘½ä»¤&quot;&quot;&quot;</span><br>        <span class="hljs-keyword">try</span>:<br>            result = subprocess.run(<br>                cmd, shell=<span class="hljs-literal">True</span>, cwd=<span class="hljs-variable language_">self</span>.project_root,<br>                capture_output=<span class="hljs-literal">True</span>, text=<span class="hljs-literal">True</span>, check=<span class="hljs-literal">True</span><br>            )<br>            <span class="hljs-keyword">return</span> result.stdout.strip()<br>        <span class="hljs-keyword">except</span> subprocess.CalledProcessError <span class="hljs-keyword">as</span> e:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;å‘½ä»¤æ‰§è¡Œå¤±è´¥: <span class="hljs-subst">&#123;cmd&#125;</span>&quot;</span>)<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;é”™è¯¯: <span class="hljs-subst">&#123;e.stderr&#125;</span>&quot;</span>)<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><br>    <br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_changed_files</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;è·å–å˜æ›´æ–‡ä»¶åˆ—è¡¨&quot;&quot;&quot;</span><br>        result = <span class="hljs-variable language_">self</span>.run_command(<span class="hljs-string">&quot;git diff --name-only HEAD&quot;</span>)<br>        <span class="hljs-keyword">if</span> result:<br>            <span class="hljs-keyword">return</span> result.split(<span class="hljs-string">&#x27;\n&#x27;</span>)<br>        <span class="hljs-keyword">return</span> []<br>    <br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_staged_files</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;è·å–æš‚å­˜åŒºæ–‡ä»¶åˆ—è¡¨&quot;&quot;&quot;</span><br>        result = <span class="hljs-variable language_">self</span>.run_command(<span class="hljs-string">&quot;git diff --name-only --cached&quot;</span>)<br>        <span class="hljs-keyword">if</span> result:<br>            <span class="hljs-keyword">return</span> result.split(<span class="hljs-string">&#x27;\n&#x27;</span>)<br>        <span class="hljs-keyword">return</span> []<br>    <br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">infer_commit_type</span>(<span class="hljs-params">self, files</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;æ ¹æ®å˜æ›´æ–‡ä»¶æ¨æ–­æäº¤ç±»å‹&quot;&quot;&quot;</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> files:<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;chore&#x27;</span><br>        <br>        <span class="hljs-comment"># æ–‡ä»¶ç±»å‹åˆ†æ</span><br>        has_tests = <span class="hljs-built_in">any</span>(<span class="hljs-string">&#x27;test&#x27;</span> <span class="hljs-keyword">in</span> f.lower() <span class="hljs-keyword">for</span> f <span class="hljs-keyword">in</span> files)<br>        has_docs = <span class="hljs-built_in">any</span>(f.endswith((<span class="hljs-string">&#x27;.md&#x27;</span>, <span class="hljs-string">&#x27;.rst&#x27;</span>, <span class="hljs-string">&#x27;.txt&#x27;</span>)) <span class="hljs-keyword">for</span> f <span class="hljs-keyword">in</span> files)<br>        has_python = <span class="hljs-built_in">any</span>(f.endswith(<span class="hljs-string">&#x27;.py&#x27;</span>) <span class="hljs-keyword">for</span> f <span class="hljs-keyword">in</span> files)<br>        has_go = <span class="hljs-built_in">any</span>(f.endswith(<span class="hljs-string">&#x27;.go&#x27;</span>) <span class="hljs-keyword">for</span> f <span class="hljs-keyword">in</span> files)<br>        has_config = <span class="hljs-built_in">any</span>(f.endswith((<span class="hljs-string">&#x27;.yml&#x27;</span>, <span class="hljs-string">&#x27;.yaml&#x27;</span>, <span class="hljs-string">&#x27;.json&#x27;</span>, <span class="hljs-string">&#x27;.toml&#x27;</span>)) <span class="hljs-keyword">for</span> f <span class="hljs-keyword">in</span> files)<br>        <br>        <span class="hljs-comment"># æ¨æ–­é€»è¾‘</span><br>        <span class="hljs-keyword">if</span> has_tests <span class="hljs-keyword">and</span> <span class="hljs-built_in">len</span>(files) == <span class="hljs-number">1</span>:<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;test&#x27;</span><br>        <span class="hljs-keyword">elif</span> has_docs:<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;docs&#x27;</span><br>        <span class="hljs-keyword">elif</span> has_config:<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;chore&#x27;</span><br>        <span class="hljs-keyword">elif</span> has_python <span class="hljs-keyword">or</span> has_go:<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;feat&#x27;</span>  <span class="hljs-comment"># é»˜è®¤è®¤ä¸ºæ˜¯æ–°åŠŸèƒ½</span><br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;chore&#x27;</span><br>    <br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">infer_scope</span>(<span class="hljs-params">self, files</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;æ¨æ–­å½±å“èŒƒå›´&quot;&quot;&quot;</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> files:<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><br>        <br>        <span class="hljs-comment"># æ ¹æ®ç›®å½•ç»“æ„æ¨æ–­èŒƒå›´</span><br>        directories = <span class="hljs-built_in">set</span>()<br>        <span class="hljs-keyword">for</span> file <span class="hljs-keyword">in</span> files:<br>            parts = file.split(<span class="hljs-string">&#x27;/&#x27;</span>)<br>            <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(parts) &gt; <span class="hljs-number">1</span>:<br>                directories.add(parts[<span class="hljs-number">0</span>])<br>        <br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(directories) == <span class="hljs-number">1</span>:<br>            <span class="hljs-keyword">return</span> <span class="hljs-built_in">list</span>(directories)[<span class="hljs-number">0</span>]<br>        <span class="hljs-keyword">elif</span> <span class="hljs-built_in">len</span>(directories) &lt;= <span class="hljs-number">3</span>:<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;,&#x27;</span>.join(<span class="hljs-built_in">sorted</span>(directories))<br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;multiple&#x27;</span><br>    <br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">analyze_changes</span>(<span class="hljs-params">self, files</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;åˆ†æå˜æ›´å†…å®¹&quot;&quot;&quot;</span><br>        changes = &#123;<br>            <span class="hljs-string">&#x27;added_lines&#x27;</span>: <span class="hljs-number">0</span>,<br>            <span class="hljs-string">&#x27;deleted_lines&#x27;</span>: <span class="hljs-number">0</span>,<br>            <span class="hljs-string">&#x27;modified_files&#x27;</span>: <span class="hljs-built_in">len</span>(files)<br>        &#125;<br>        <br>        <span class="hljs-comment"># è·å–è¯¦ç»†çš„å˜æ›´ç»Ÿè®¡</span><br>        result = <span class="hljs-variable language_">self</span>.run_command(<span class="hljs-string">&quot;git diff --stat&quot;</span>)<br>        <span class="hljs-keyword">if</span> result:<br>            <span class="hljs-comment"># è§£æç»Ÿè®¡ä¿¡æ¯</span><br>            lines = result.split(<span class="hljs-string">&#x27;\n&#x27;</span>)<br>            <span class="hljs-keyword">for</span> line <span class="hljs-keyword">in</span> lines:<br>                <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;insertion&#x27;</span> <span class="hljs-keyword">in</span> line <span class="hljs-keyword">and</span> <span class="hljs-string">&#x27;deletion&#x27;</span> <span class="hljs-keyword">in</span> line:<br>                    <span class="hljs-comment"># æå–æ’å…¥å’Œåˆ é™¤çš„è¡Œæ•°</span><br>                    insertions = re.search(<span class="hljs-string">r&#x27;(\d+) insertion&#x27;</span>, line)<br>                    deletions = re.search(<span class="hljs-string">r&#x27;(\d+) deletion&#x27;</span>, line)<br>                    <br>                    <span class="hljs-keyword">if</span> insertions:<br>                        changes[<span class="hljs-string">&#x27;added_lines&#x27;</span>] = <span class="hljs-built_in">int</span>(insertions.group(<span class="hljs-number">1</span>))<br>                    <span class="hljs-keyword">if</span> deletions:<br>                        changes[<span class="hljs-string">&#x27;deleted_lines&#x27;</span>] = <span class="hljs-built_in">int</span>(deletions.group(<span class="hljs-number">1</span>))<br>        <br>        <span class="hljs-keyword">return</span> changes<br>    <br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">generate_commit_message</span>(<span class="hljs-params">self, commit_type, scope, description, files</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;ç”Ÿæˆè¯­ä¹‰åŒ–æäº¤æ¶ˆæ¯&quot;&quot;&quot;</span><br>        <span class="hljs-comment"># åŸºæœ¬æ ¼å¼: type(scope): description</span><br>        scope_str = <span class="hljs-string">f&quot;(<span class="hljs-subst">&#123;scope&#125;</span>)&quot;</span> <span class="hljs-keyword">if</span> scope <span class="hljs-keyword">else</span> <span class="hljs-string">&quot;&quot;</span><br>        header = <span class="hljs-string">f&quot;<span class="hljs-subst">&#123;commit_type&#125;</span><span class="hljs-subst">&#123;scope_str&#125;</span>: <span class="hljs-subst">&#123;description&#125;</span>&quot;</span><br>        <br>        <span class="hljs-comment"># æ·»åŠ è¯¦ç»†ä¿¡æ¯</span><br>        changes = <span class="hljs-variable language_">self</span>.analyze_changes(files)<br>        body_parts = []<br>        <br>        <span class="hljs-keyword">if</span> changes[<span class="hljs-string">&#x27;modified_files&#x27;</span>] &gt; <span class="hljs-number">1</span>:<br>            body_parts.append(<span class="hljs-string">f&quot;ä¿®æ”¹äº† <span class="hljs-subst">&#123;changes[<span class="hljs-string">&#x27;modified_files&#x27;</span>]&#125;</span> ä¸ªæ–‡ä»¶&quot;</span>)<br>        <br>        <span class="hljs-keyword">if</span> changes[<span class="hljs-string">&#x27;added_lines&#x27;</span>] &gt; <span class="hljs-number">0</span>:<br>            body_parts.append(<span class="hljs-string">f&quot;æ–°å¢ <span class="hljs-subst">&#123;changes[<span class="hljs-string">&#x27;added_lines&#x27;</span>]&#125;</span> è¡Œ&quot;</span>)<br>        <br>        <span class="hljs-keyword">if</span> changes[<span class="hljs-string">&#x27;deleted_lines&#x27;</span>] &gt; <span class="hljs-number">0</span>:<br>            body_parts.append(<span class="hljs-string">f&quot;åˆ é™¤ <span class="hljs-subst">&#123;changes[<span class="hljs-string">&#x27;deleted_lines&#x27;</span>]&#125;</span> è¡Œ&quot;</span>)<br>        <br>        <span class="hljs-comment"># æ„å»ºå®Œæ•´æ¶ˆæ¯</span><br>        message_parts = [header]<br>        <br>        <span class="hljs-keyword">if</span> body_parts:<br>            message_parts.append(<span class="hljs-string">&quot;&quot;</span>)  <span class="hljs-comment"># ç©ºè¡Œ</span><br>            message_parts.extend(body_parts)<br>        <br>        <span class="hljs-comment"># æ·»åŠ æ—¶é—´æˆ³å’Œå·¥å…·æ ‡è¯†</span><br>        message_parts.extend([<br>            <span class="hljs-string">&quot;&quot;</span>,<br>            <span class="hljs-string">f&quot;ğŸ¤– Generated with Claude Code at <span class="hljs-subst">&#123;datetime.now().strftime(<span class="hljs-string">&#x27;%Y-%m-%d %H:%M:%S&#x27;</span>)&#125;</span>&quot;</span><br>        ])<br>        <br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;\n&#x27;</span>.join(message_parts)<br>    <br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">execute</span>(<span class="hljs-params">self, description=<span class="hljs-string">&quot;è‡ªåŠ¨æäº¤&quot;</span></span>):<br>        <span class="hljs-string">&quot;&quot;&quot;æ‰§è¡Œæ™ºèƒ½æäº¤æµç¨‹&quot;&quot;&quot;</span><br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;ğŸš€ å¼€å§‹æ™ºèƒ½Gitæäº¤æµç¨‹...&quot;</span>)<br>        <br>        <span class="hljs-comment"># æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´</span><br>        changed_files = <span class="hljs-variable language_">self</span>.get_changed_files()<br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> changed_files:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;âš ï¸ æ²¡æœ‰æ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´&quot;</span>)<br>            <span class="hljs-keyword">return</span> &#123;<span class="hljs-string">&quot;success&quot;</span>: <span class="hljs-literal">False</span>, <span class="hljs-string">&quot;message&quot;</span>: <span class="hljs-string">&quot;æ— å˜æ›´æ–‡ä»¶&quot;</span>&#125;<br>        <br>        <span class="hljs-comment"># æš‚å­˜æ‰€æœ‰å˜æ›´</span><br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;ğŸ“ æš‚å­˜ <span class="hljs-subst">&#123;<span class="hljs-built_in">len</span>(changed_files)&#125;</span> ä¸ªå˜æ›´æ–‡ä»¶...&quot;</span>)<br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-variable language_">self</span>.run_command(<span class="hljs-string">&quot;git add .&quot;</span>):<br>            <span class="hljs-keyword">return</span> &#123;<span class="hljs-string">&quot;success&quot;</span>: <span class="hljs-literal">False</span>, <span class="hljs-string">&quot;message&quot;</span>: <span class="hljs-string">&quot;æ–‡ä»¶æš‚å­˜å¤±è´¥&quot;</span>&#125;<br>        <br>        <span class="hljs-comment"># è·å–æš‚å­˜æ–‡ä»¶</span><br>        staged_files = <span class="hljs-variable language_">self</span>.get_staged_files()<br>        <br>        <span class="hljs-comment"># æ¨æ–­æäº¤ä¿¡æ¯</span><br>        commit_type = <span class="hljs-variable language_">self</span>.infer_commit_type(staged_files)<br>        scope = <span class="hljs-variable language_">self</span>.infer_scope(staged_files)<br>        <br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;ğŸ” æ¨æ–­æäº¤ç±»å‹: <span class="hljs-subst">&#123;commit_type&#125;</span>&quot;</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;ğŸ¯ å½±å“èŒƒå›´: <span class="hljs-subst">&#123;scope <span class="hljs-keyword">or</span> <span class="hljs-string">&#x27;æœªæŒ‡å®š&#x27;</span>&#125;</span>&quot;</span>)<br>        <br>        <span class="hljs-comment"># ç”Ÿæˆæäº¤æ¶ˆæ¯</span><br>        commit_message = <span class="hljs-variable language_">self</span>.generate_commit_message(<br>            commit_type, scope, description, staged_files<br>        )<br>        <br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;ğŸ’¬ ç”Ÿæˆæäº¤æ¶ˆæ¯:\n<span class="hljs-subst">&#123;commit_message&#125;</span>&quot;</span>)<br>        <br>        <span class="hljs-comment"># æ‰§è¡Œæäº¤</span><br>        escaped_message = commit_message.replace(<span class="hljs-string">&#x27;&quot;&#x27;</span>, <span class="hljs-string">&#x27;\\&quot;&#x27;</span>)<br>        <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>.run_command(<span class="hljs-string">f&#x27;git commit -m &quot;<span class="hljs-subst">&#123;escaped_message&#125;</span>&quot;&#x27;</span>):<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;âœ… æäº¤æˆåŠŸ&quot;</span>)<br>            <br>            <span class="hljs-comment"># è·å–æäº¤å“ˆå¸Œ</span><br>            commit_hash = <span class="hljs-variable language_">self</span>.run_command(<span class="hljs-string">&quot;git rev-parse HEAD&quot;</span>)<br>            <br>            <span class="hljs-keyword">return</span> &#123;<br>                <span class="hljs-string">&quot;success&quot;</span>: <span class="hljs-literal">True</span>,<br>                <span class="hljs-string">&quot;message&quot;</span>: <span class="hljs-string">&quot;æ™ºèƒ½æäº¤å®Œæˆ&quot;</span>,<br>                <span class="hljs-string">&quot;commit_hash&quot;</span>: commit_hash,<br>                <span class="hljs-string">&quot;files_changed&quot;</span>: <span class="hljs-built_in">len</span>(staged_files),<br>                <span class="hljs-string">&quot;commit_type&quot;</span>: commit_type<br>            &#125;<br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">return</span> &#123;<span class="hljs-string">&quot;success&quot;</span>: <span class="hljs-literal">False</span>, <span class="hljs-string">&quot;message&quot;</span>: <span class="hljs-string">&quot;æäº¤å¤±è´¥&quot;</span>&#125;<br><br><span class="hljs-comment"># ä½¿ç”¨ç¤ºä¾‹</span><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    <span class="hljs-keyword">import</span> sys<br>    <br>    description = sys.argv[<span class="hljs-number">1</span>] <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(sys.argv) &gt; <span class="hljs-number">1</span> <span class="hljs-keyword">else</span> <span class="hljs-string">&quot;è‡ªåŠ¨æäº¤&quot;</span><br>    hook = SmartCommitHook(os.getcwd())<br>    result = hook.execute(description)<br>    <br>    <span class="hljs-keyword">if</span> result[<span class="hljs-string">&quot;success&quot;</span>]:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;ğŸ‰ <span class="hljs-subst">&#123;result[<span class="hljs-string">&#x27;message&#x27;</span>]&#125;</span>&quot;</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;ğŸ“Š æäº¤ç»Ÿè®¡: <span class="hljs-subst">&#123;result[<span class="hljs-string">&#x27;files_changed&#x27;</span>]&#125;</span> ä¸ªæ–‡ä»¶ï¼Œç±»å‹: <span class="hljs-subst">&#123;result[<span class="hljs-string">&#x27;commit_type&#x27;</span>]&#125;</span>&quot;</span>)<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;âŒ æäº¤å¤±è´¥: <span class="hljs-subst">&#123;result[<span class="hljs-string">&#x27;message&#x27;</span>]&#125;</span>&quot;</span>)<br>        sys.exit(<span class="hljs-number">1</span>)<br></code></pre></td></tr></table></figure><h3 id="6-5-Hooké…ç½®ç®¡ç†"><a href="#6-5-Hooké…ç½®ç®¡ç†" class="headerlink" title="6.5 Hooké…ç½®ç®¡ç†"></a>6.5 Hooké…ç½®ç®¡ç†</h3><p><strong>ç»Ÿä¸€é…ç½®æ–‡ä»¶ï¼š</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># .claude/hooks.yml</span><br><span class="hljs-attr">hooks:</span><br>  <span class="hljs-attr">python_quality:</span><br>    <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span><br>    <span class="hljs-attr">trigger:</span> [<span class="hljs-string">&quot;pre-tool-call&quot;</span>, <span class="hljs-string">&quot;code-change&quot;</span>]<br>    <span class="hljs-attr">file_patterns:</span> [<span class="hljs-string">&quot;*.py&quot;</span>]<br>    <span class="hljs-attr">tools:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">black</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">isort</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">flake8</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">mypy</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">pytest</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">bandit</span><br>    <span class="hljs-attr">auto_fix:</span> <span class="hljs-literal">true</span><br>    <span class="hljs-attr">strict_mode:</span> <span class="hljs-literal">false</span><br>    <br>  <span class="hljs-attr">go_quality:</span><br>    <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span><br>    <span class="hljs-attr">trigger:</span> [<span class="hljs-string">&quot;pre-tool-call&quot;</span>, <span class="hljs-string">&quot;code-change&quot;</span>]<br>    <span class="hljs-attr">file_patterns:</span> [<span class="hljs-string">&quot;*.go&quot;</span>]<br>    <span class="hljs-attr">tools:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">gofmt</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">goimports</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">go_vet</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">golint</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">staticcheck</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">gosec</span><br>    <span class="hljs-attr">auto_fix:</span> <span class="hljs-literal">true</span><br>    <span class="hljs-attr">run_benchmarks:</span> <span class="hljs-literal">true</span><br>    <br>  <span class="hljs-attr">smart_commit:</span><br>    <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span><br>    <span class="hljs-attr">trigger:</span> [<span class="hljs-string">&quot;post-tool-call&quot;</span>]<br>    <span class="hljs-attr">conventional_commits:</span> <span class="hljs-literal">true</span><br>    <span class="hljs-attr">auto_stage:</span> <span class="hljs-literal">true</span><br>    <span class="hljs-attr">include_stats:</span> <span class="hljs-literal">true</span><br>    <br><span class="hljs-comment"># å…¨å±€é…ç½®</span><br><span class="hljs-attr">global:</span><br>  <span class="hljs-attr">timeout:</span> <span class="hljs-number">30000</span><br>  <span class="hljs-attr">log_level:</span> <span class="hljs-string">info</span><br>  <span class="hljs-attr">parallel_execution:</span> <span class="hljs-literal">false</span><br>  <br><span class="hljs-comment"># é¡¹ç›®ç‰¹å®šè®¾ç½®</span><br><span class="hljs-attr">project:</span><br>  <span class="hljs-attr">python_version:</span> <span class="hljs-string">&quot;3.11&quot;</span><br>  <span class="hljs-attr">go_version:</span> <span class="hljs-string">&quot;1.21&quot;</span><br>  <span class="hljs-attr">test_coverage_threshold:</span> <span class="hljs-number">80</span><br>  <span class="hljs-attr">benchmark_threshold:</span> <span class="hljs-string">&quot;10%&quot;</span><br></code></pre></td></tr></table></figure><h3 id="6-6-Hookæœ€ä½³å®è·µ"><a href="#6-6-Hookæœ€ä½³å®è·µ" class="headerlink" title="6.6 Hookæœ€ä½³å®è·µ"></a>6.6 Hookæœ€ä½³å®è·µ</h3><p><strong>æ€§èƒ½ä¼˜åŒ–ç­–ç•¥ï¼š</strong></p><ol><li><strong>æ™ºèƒ½è§¦å‘</strong>ï¼šåªåœ¨ç›¸å…³æ–‡ä»¶å˜æ›´æ—¶è¿è¡Œå¯¹åº”Hook</li><li><strong>å¢é‡æ£€æŸ¥</strong>ï¼šä»…æ£€æŸ¥å˜æ›´çš„æ–‡ä»¶ï¼Œé¿å…å…¨é¡¹ç›®æ‰«æ</li><li><strong>å¹¶è¡Œæ‰§è¡Œ</strong>ï¼šç‹¬ç«‹çš„æ£€æŸ¥é¡¹å¹¶è¡Œè¿è¡Œ</li><li><strong>ç»“æœç¼“å­˜</strong>ï¼šç¼“å­˜é™æ€æ£€æŸ¥ç»“æœï¼Œé¿å…é‡å¤è®¡ç®—</li></ol><p><strong>é”™è¯¯å¤„ç†åŸåˆ™ï¼š</strong></p><ol><li><strong>æ¸è¿›å¼å¤±è´¥</strong>ï¼šæ ¼å¼åŒ–ç±»é—®é¢˜è‡ªåŠ¨ä¿®å¤ï¼Œä¸¥é‡é—®é¢˜é˜»å¡</li><li><strong>è¯¦ç»†åé¦ˆ</strong>ï¼šæä¾›å…·ä½“çš„é”™è¯¯ä½ç½®å’Œä¿®å¤å»ºè®®</li><li><strong>å›æ»šæœºåˆ¶</strong>ï¼šHookå¤±è´¥æ—¶æ¢å¤åˆ°åŸå§‹çŠ¶æ€</li><li><strong>æ—¥å¿—è®°å½•</strong>ï¼šè®°å½•æ‰€æœ‰Hookæ‰§è¡Œè¿‡ç¨‹ç”¨äºè°ƒè¯•</li></ol><p><strong>å›¢é˜Ÿåä½œä¼˜åŒ–ï¼š</strong></p><ol><li><strong>ç»Ÿä¸€æ ‡å‡†</strong>ï¼šå›¢é˜Ÿå…±äº«Hooké…ç½®ï¼Œç¡®ä¿ä»£ç é£æ ¼ä¸€è‡´</li><li><strong>CIé›†æˆ</strong>ï¼šHookæ£€æŸ¥ç»“æœä¸CI&#x2F;CDæµç¨‹é›†æˆ</li><li><strong>è‡ªå®šä¹‰è§„åˆ™</strong>ï¼šæ”¯æŒé¡¹ç›®ç‰¹å®šçš„è´¨é‡æ£€æŸ¥è§„åˆ™</li><li><strong>æ€§èƒ½ç›‘æ§</strong>ï¼šè·Ÿè¸ªHookæ‰§è¡Œæ—¶é—´ï¼Œä¼˜åŒ–å¼€å‘ä½“éªŒ</li></ol><h2 id="ä¸ƒã€æ€§èƒ½ä¼˜åŒ–ä¸æˆæœ¬æ§åˆ¶"><a href="#ä¸ƒã€æ€§èƒ½ä¼˜åŒ–ä¸æˆæœ¬æ§åˆ¶" class="headerlink" title="ä¸ƒã€æ€§èƒ½ä¼˜åŒ–ä¸æˆæœ¬æ§åˆ¶"></a>ä¸ƒã€æ€§èƒ½ä¼˜åŒ–ä¸æˆæœ¬æ§åˆ¶</h2><h3 id="7-1-Tokenä½¿ç”¨ä¼˜åŒ–"><a href="#7-1-Tokenä½¿ç”¨ä¼˜åŒ–" class="headerlink" title="7.1 Tokenä½¿ç”¨ä¼˜åŒ–"></a>7.1 Tokenä½¿ç”¨ä¼˜åŒ–</h3><p><strong>ä¸Šä¸‹æ–‡ç®¡ç†ç­–ç•¥ï¼š</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">/clear    <span class="hljs-comment"># æ¸…ç†ä¸Šä¸‹æ–‡ï¼Œé˜²æ­¢Tokenç´¯ç§¯</span><br>/resume   <span class="hljs-comment"># æ¢å¤é‡è¦ä¸Šä¸‹æ–‡ä¿¡æ¯</span><br></code></pre></td></tr></table></figure><p><strong>æ‰§è¡Œæ—¶æœºï¼š</strong></p><ul><li>å­ä»»åŠ¡å®Œæˆåç«‹å³æ‰§è¡Œ<code>/clear</code></li><li>é•¿æ—¶é—´ä¼šè¯ä¸­å®šæœŸæ¸…ç†</li><li>åˆ‡æ¢å¼€å‘ä¸»é¢˜æ—¶é‡ç½®ä¸Šä¸‹æ–‡</li></ul><h3 id="7-2-å®æ—¶ç›‘æ§å·¥å…·"><a href="#7-2-å®æ—¶ç›‘æ§å·¥å…·" class="headerlink" title="7.2 å®æ—¶ç›‘æ§å·¥å…·"></a>7.2 å®æ—¶ç›‘æ§å·¥å…·</h3><p><strong><a href="https://github.com/Maciek-roboblog/Claude-Code-Usage-Monitor">Claude-Code-Usage-Monitoré…ç½®</a>ï¼š</strong><br><img src="/images/Claude-Code-Usage-Monitor.png" alt="Token_Usage"></p><h2 id="å…«ã€æ‰©å±•èµ„æºä¸å­¦ä¹ è·¯å¾„"><a href="#å…«ã€æ‰©å±•èµ„æºä¸å­¦ä¹ è·¯å¾„" class="headerlink" title="å…«ã€æ‰©å±•èµ„æºä¸å­¦ä¹ è·¯å¾„"></a>å…«ã€æ‰©å±•èµ„æºä¸å­¦ä¹ è·¯å¾„</h2><p><strong>å®˜æ–¹èµ„æºï¼š</strong></p><ul><li><a href="https://docs.anthropic.com/claude-code">Claude Codeå®˜æ–¹æ–‡æ¡£</a></li><li><a href="https://www.anthropic.com/engineering/claude-code-best-practices">Anthropicå·¥ç¨‹æœ€ä½³å®è·µ</a></li><li><a href="https://github.com/modelcontextprotocol/servers">MCPåè®®è§„èŒƒ</a></li></ul><p><strong>ç¤¾åŒºèµ„æºï¼š</strong></p><ul><li><a href="https://github.com/hesreallyhim/awesome-claude-code">Awesome Claude Code</a></li><li><a href="https://github.com/bmad-code-org/BMAD-METHOD">BMAD-METHODæ¡†æ¶</a></li><li><a href="https://github.com/LichAmnesia/GPT-Prompt-Hub/blob/main/CLAUDE.md">é«˜è´¨é‡CLAUDE.mdæ¨¡æ¿</a></li></ul><p><strong>å­¦ä¹ è·¯å¾„ï¼š</strong></p><ol><li><strong>åŸºç¡€é…ç½®</strong>ï¼šCLAUDE.mdè®¾ç½®å’Œé¡¹ç›®åˆå§‹åŒ–</li><li><strong>å·¥ä½œæµä¼˜åŒ–</strong>ï¼šAgenté…ç½®å’Œæ€è€ƒæ¨¡å¼</li><li><strong>é«˜çº§é›†æˆ</strong>ï¼šMCPæœåŠ¡å™¨å’Œè‡ªåŠ¨åŒ–Hook</li><li><strong>ä¼ä¸šå®è·µ</strong>ï¼šBMAD-METHODå’Œå›¢é˜Ÿåä½œ</li><li><strong>ç”Ÿæ€æ‰©å±•</strong>ï¼šè‡ªå®šä¹‰å‘½ä»¤å’Œç›‘æ§ç³»ç»Ÿ</li></ol><hr><p>é€šè¿‡ç³»ç»Ÿæ€§é‡‡ç”¨Claude Codeçš„é…ç½®ç­–ç•¥ã€å·¥ä½œæµä¼˜åŒ–å’Œç”Ÿæ€é›†æˆï¼Œç‰¹åˆ«æ˜¯é’ˆå¯¹Pythonå’ŒGoåç«¯å¼€å‘çš„ä¸“ä¸šåŒ–Hookç³»ç»Ÿï¼Œå¼€å‘å›¢é˜Ÿèƒ½å¤Ÿæ„å»ºé«˜æ•ˆã€æ™ºèƒ½çš„AIé©±åŠ¨å¼€å‘ç¯å¢ƒï¼Œå®ç°ä»£ç è´¨é‡å’Œå¼€å‘æ•ˆç‡çš„åŒé‡æå‡ã€‚</p>]]></content>
    
    
    <categories>
      
      <category>å¼€å‘å·¥å…·</category>
      
      <category>AIç¼–ç¨‹</category>
      
    </categories>
    
    
    <tags>
      
      <tag>AIç¼–ç¨‹</tag>
      
      <tag>Claude</tag>
      
      <tag>å¼€å‘æ•ˆç‡</tag>
      
      <tag>æœ€ä½³å®è·µ</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Go RWMutexè¯»é”é‡å…¥æ­»é”é—®é¢˜æ·±åº¦åˆ†æ</title>
    <link href="/2024/09/19/rwmutex-deadlock/"/>
    <url>/2024/09/19/rwmutex-deadlock/</url>
    
    <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡æ·±åº¦åˆ†æGoè¯­è¨€ä¸­sync.RWMutexè¯»é”é‡å…¥å¯¼è‡´çš„æ­»é”é—®é¢˜ï¼Œé€šè¿‡æºç è§£æå’Œå®é™…æ¡ˆä¾‹ï¼Œæ­ç¤ºé—®é¢˜æœ¬è´¨å¹¶æä¾›è§£å†³æ–¹æ¡ˆã€‚</p></blockquote><span id="more"></span><h2 id="é—®é¢˜åœºæ™¯"><a href="#é—®é¢˜åœºæ™¯" class="headerlink" title="é—®é¢˜åœºæ™¯"></a>é—®é¢˜åœºæ™¯</h2><p>åœ¨é«˜å¹¶å‘ä¸šåŠ¡ç³»ç»Ÿä¸­ï¼Œé”™è¯¯ä½¿ç”¨sync.RWMutexçš„è¯»é”é‡å…¥æœºåˆ¶å®¹æ˜“å¼•å‘æ­»é”ã€‚ä¸‹é¢é€šè¿‡ä¸€ä¸ªç®€åŒ–çš„å®šæ—¶ç»Ÿè®¡å™¨æ¡ˆä¾‹æ¥å¤ç°å’Œåˆ†æè¯¥é—®é¢˜ã€‚</p><p>è¯¥ç»Ÿè®¡å™¨çš„æ ¸å¿ƒåŠŸèƒ½ï¼š</p><ul><li><code>Incr</code>æ–¹æ³•ï¼šå¤–éƒ¨å¹¶å‘è°ƒç”¨ï¼Œæ›´æ–°ç»Ÿè®¡æ•°æ®</li><li><code>Run</code>æ–¹æ³•ï¼šå®šæ—¶ä»»åŠ¡ï¼Œå°†çƒ­ç‚¹æ•°æ®ä»dataå¤åˆ¶åˆ°hotåˆ‡ç‰‡</li><li><code>stat</code>æ–¹æ³•ï¼šå†…éƒ¨ç»Ÿè®¡é€»è¾‘ï¼Œæ¶‰åŠè¯»é”é‡å…¥<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs golang"><span class="hljs-keyword">type</span> Counter <span class="hljs-keyword">struct</span> &#123;<br>data <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">int</span><br>hot  []<span class="hljs-type">string</span><br>mu   sync.RWMutex<br>&#125;<br><br><span class="hljs-comment">// stat ç»Ÿè®¡çƒ­ç‚¹æ•°æ® - å­˜åœ¨è¯»é”é‡å…¥é—®é¢˜</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Counter)</span></span> stat() &#123;<br>c.mu.RLock() <span class="hljs-comment">// è¯»é”é‡å…¥ï¼šå¤–å±‚Run()å·²æŒæœ‰è¯»é”</span><br><span class="hljs-keyword">defer</span> c.mu.RUnlock()<br><br><span class="hljs-comment">// å¤åˆ¶çƒ­ç‚¹æ•°æ®åˆ°hotåˆ‡ç‰‡</span><br><span class="hljs-keyword">for</span> key := <span class="hljs-keyword">range</span> c.data &#123;<br><span class="hljs-keyword">if</span> c.data[key] &gt; <span class="hljs-number">100</span> &#123; <span class="hljs-comment">// å‡è®¾é˜ˆå€¼ä¸º100</span><br>c.hot = <span class="hljs-built_in">append</span>(c.hot, key)<br>&#125;<br>&#125;<br>&#125;<br><br><span class="hljs-comment">// Incr å¹¶å‘æ›´æ–°è®¡æ•°å™¨</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Counter)</span></span> Incr(key <span class="hljs-type">string</span>) &#123;<br>c.mu.Lock()   <span class="hljs-comment">// å†™é”</span><br><span class="hljs-keyword">defer</span> c.mu.Unlock()<br><br><span class="hljs-keyword">if</span> c.data == <span class="hljs-literal">nil</span> &#123;<br>c.data = <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">int</span>)<br>&#125;<br>c.data[key]++<br>&#125;<br><br><span class="hljs-comment">// Run å®šæ—¶ç»Ÿè®¡ä»»åŠ¡</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Counter)</span></span> Run() &#123;<br>ticker := time.NewTicker(<span class="hljs-number">2</span> * time.Second)<br><span class="hljs-keyword">defer</span> ticker.Stop()<br><br><span class="hljs-keyword">for</span> &#123;<br><span class="hljs-keyword">select</span> &#123;<br><span class="hljs-keyword">case</span> &lt;-ticker.C:<br>c.mu.RLock()   <span class="hljs-comment">// å¤–å±‚è¯»é”</span><br><span class="hljs-comment">// ä¸€äº›è¯»å–æ“ä½œ...</span><br>c.stat()       <span class="hljs-comment">// å†…å±‚è¯»é”é‡å…¥ - æ­»é”é£é™©ç‚¹</span><br><span class="hljs-comment">// å…¶ä»–æ“ä½œ...</span><br>c.mu.RUnlock()<br>&#125;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure></li></ul><h2 id="RWMutexå®ç°åŸç†"><a href="#RWMutexå®ç°åŸç†" class="headerlink" title="RWMutexå®ç°åŸç†"></a>RWMutexå®ç°åŸç†</h2><p>è¦ç†è§£æ­»é”äº§ç”Ÿçš„æ ¹æœ¬åŸå› ï¼Œéœ€è¦æ·±å…¥åˆ†æsync.RWMutexçš„åº•å±‚å®ç°æœºåˆ¶ã€‚ä»¥ä¸‹åŸºäºGo 1.18ç‰ˆæœ¬æºç è¿›è¡Œåˆ†æã€‚</p><h3 id="æ ¸å¿ƒæ•°æ®ç»“æ„"><a href="#æ ¸å¿ƒæ•°æ®ç»“æ„" class="headerlink" title="æ ¸å¿ƒæ•°æ®ç»“æ„"></a>æ ¸å¿ƒæ•°æ®ç»“æ„</h3><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs golang"><span class="hljs-keyword">type</span> RWMutex <span class="hljs-keyword">struct</span> &#123;<br>w           Mutex  <span class="hljs-comment">// å†™é”äº’æ–¥é‡</span><br>writerSem   <span class="hljs-type">uint32</span> <span class="hljs-comment">// å†™åç¨‹ä¿¡å·é‡</span><br>readerSem   <span class="hljs-type">uint32</span> <span class="hljs-comment">// è¯»åç¨‹ä¿¡å·é‡</span><br>readerCount <span class="hljs-type">int32</span>  <span class="hljs-comment">// è¯»åç¨‹è®¡æ•°å™¨</span><br>readerWait  <span class="hljs-type">int32</span>  <span class="hljs-comment">// ç­‰å¾…çš„è¯»åç¨‹æ•°é‡</span><br>&#125;<br><br><span class="hljs-keyword">const</span> rwmutexMaxReaders = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">30</span> <span class="hljs-comment">// æœ€å¤§è¯»åç¨‹æ•°ï¼šçº¦10äº¿</span><br></code></pre></td></tr></table></figure><h3 id="å†™é”è·å–æœºåˆ¶"><a href="#å†™é”è·å–æœºåˆ¶" class="headerlink" title="å†™é”è·å–æœºåˆ¶"></a>å†™é”è·å–æœºåˆ¶</h3><p>å†™é”çš„è·å–è¿‡ç¨‹åŒ…å«ä»¥ä¸‹å…³é”®æ­¥éª¤ï¼š</p><ol><li><strong>äº’æ–¥é”ç«äº‰</strong>ï¼šé¦–å…ˆè·å–å†…éƒ¨äº’æ–¥é”<code>w</code>ï¼Œç¡®ä¿åŒä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªå†™åç¨‹</li><li><strong>è¯»åç¨‹æ ‡è®°</strong>ï¼šå°†<code>readerCount</code>å‡å»<code>rwmutexMaxReaders</code>ä½¿å…¶å˜ä¸ºè´Ÿæ•°<ul><li><strong>è®¾è®¡ç²¾é«“</strong>ï¼šè´Ÿæ•°æ ‡è¯†æœ‰å†™é”åœ¨ç­‰å¾…ï¼Œé˜»æ­¢æ–°è¯»é”è·å–</li><li>æ–°è¯»åç¨‹æ£€æµ‹åˆ°è´Ÿæ•°åç›´æ¥è¿›å…¥é˜»å¡çŠ¶æ€</li></ul></li><li><strong>ç­‰å¾…è®¡æ•°</strong>ï¼šè®¡ç®—å½“å‰æ´»è·ƒè¯»åç¨‹æ•°ï¼Œè®¾ç½®<code>readerWait</code></li><li><strong>é˜»å¡ç­‰å¾…</strong>ï¼šå¦‚æœæœ‰æ´»è·ƒè¯»åç¨‹ï¼Œå†™åç¨‹è¿›å…¥ä¿¡å·é‡ç­‰å¾…<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs golang"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(rw *RWMutex)</span></span> Lock() &#123;<br><span class="hljs-comment">// 1. è·å–å†™é”äº’æ–¥é‡ï¼Œé˜²æ­¢å¤šä¸ªå†™åç¨‹ç«äº‰</span><br>rw.w.Lock()<br><br><span class="hljs-comment">// 2. æ ‡è®°æœ‰å†™é”ç­‰å¾…ï¼šreaderCountå˜ä¸ºè´Ÿæ•°</span><br>r := atomic.AddInt32(&amp;rw.readerCount, -rwmutexMaxReaders) + rwmutexMaxReaders<br><br><span class="hljs-comment">// 3. å¦‚æœæœ‰æ´»è·ƒè¯»åç¨‹ï¼Œè®¾ç½®ç­‰å¾…è®¡æ•°å¹¶é˜»å¡</span><br><span class="hljs-keyword">if</span> r != <span class="hljs-number">0</span> &amp;&amp; atomic.AddInt32(&amp;rw.readerWait, r) != <span class="hljs-number">0</span> &#123;<br>runtime_SemacquireMutex(&amp;rw.writerSem, <span class="hljs-literal">false</span>, <span class="hljs-number">0</span>)<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure></li></ol><h3 id="å†™é”é‡Šæ”¾æœºåˆ¶"><a href="#å†™é”é‡Šæ”¾æœºåˆ¶" class="headerlink" title="å†™é”é‡Šæ”¾æœºåˆ¶"></a>å†™é”é‡Šæ”¾æœºåˆ¶</h3><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs golang"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(rw *RWMutex)</span></span> Unlock() &#123;<br><span class="hljs-comment">// 1. æ¢å¤readerCountä¸ºæ­£æ•°ï¼Œå–æ¶ˆå†™é”ç­‰å¾…æ ‡è®°</span><br>r := atomic.AddInt32(&amp;rw.readerCount, rwmutexMaxReaders)<br><br><span class="hljs-comment">// 2. æ£€æŸ¥é‡å¤è§£é”é”™è¯¯</span><br><span class="hljs-keyword">if</span> r &gt;= rwmutexMaxReaders &#123;<br>throw(<span class="hljs-string">&quot;sync: Unlock of unlocked RWMutex&quot;</span>)<br>&#125;<br><br><span class="hljs-comment">// 3. å”¤é†’æ‰€æœ‰ç­‰å¾…çš„è¯»åç¨‹</span><br><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-type">int</span>(r); i++ &#123;<br>runtime_Semrelease(&amp;rw.readerSem, <span class="hljs-literal">false</span>, <span class="hljs-number">0</span>)<br>&#125;<br><br><span class="hljs-comment">// 4. é‡Šæ”¾å†™é”äº’æ–¥é‡</span><br>rw.w.Unlock()<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="è¯»é”è·å–æœºåˆ¶"><a href="#è¯»é”è·å–æœºåˆ¶" class="headerlink" title="è¯»é”è·å–æœºåˆ¶"></a>è¯»é”è·å–æœºåˆ¶</h3><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs golang"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(rw *RWMutex)</span></span> RLock() &#123;<br><span class="hljs-comment">// 1. åŸå­é€’å¢è¯»åç¨‹è®¡æ•°</span><br><span class="hljs-keyword">if</span> atomic.AddInt32(&amp;rw.readerCount, <span class="hljs-number">1</span>) &lt; <span class="hljs-number">0</span> &#123;<br><span class="hljs-comment">// 2. æ£€æµ‹åˆ°è´Ÿæ•°ï¼šæœ‰å†™é”ç­‰å¾…ï¼Œå½“å‰è¯»åç¨‹å¿…é¡»é˜»å¡</span><br>runtime_SemacquireMutex(&amp;rw.readerSem, <span class="hljs-literal">false</span>, <span class="hljs-number">0</span>)<br>&#125;<br><span class="hljs-comment">// 3. æ­£æ•°æƒ…å†µï¼šç›´æ¥è·å–è¯»é”æˆåŠŸ</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="è¯»é”é‡Šæ”¾æœºåˆ¶"><a href="#è¯»é”é‡Šæ”¾æœºåˆ¶" class="headerlink" title="è¯»é”é‡Šæ”¾æœºåˆ¶"></a>è¯»é”é‡Šæ”¾æœºåˆ¶</h3><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs golang"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(rw *RWMutex)</span></span> RUnlock() &#123;<br><span class="hljs-comment">// 1. åŸå­é€’å‡è¯»åç¨‹è®¡æ•°</span><br><span class="hljs-keyword">if</span> r := atomic.AddInt32(&amp;rw.readerCount, <span class="hljs-number">-1</span>); r &lt; <span class="hljs-number">0</span> &#123;<br><span class="hljs-comment">// 2. è´Ÿæ•°æƒ…å†µï¼šæœ‰å†™é”ç­‰å¾…ï¼Œè¿›å…¥æ…¢è·¯å¾„</span><br>rw.rUnlockSlow(r)<br>&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(rw *RWMutex)</span></span> rUnlockSlow(r <span class="hljs-type">int32</span>) &#123;<br><span class="hljs-comment">// 3. é€’å‡ç­‰å¾…è®¡æ•°ï¼Œæ£€æŸ¥æ˜¯å¦ä¸ºæœ€åä¸€ä¸ªè¯»åç¨‹</span><br><span class="hljs-keyword">if</span> atomic.AddInt32(&amp;rw.readerWait, <span class="hljs-number">-1</span>) == <span class="hljs-number">0</span> &#123;<br><span class="hljs-comment">// 4. æœ€åä¸€ä¸ªè¯»åç¨‹é‡Šæ”¾æ—¶ï¼Œå”¤é†’ç­‰å¾…çš„å†™åç¨‹</span><br>runtime_Semrelease(&amp;rw.writerSem, <span class="hljs-literal">false</span>, <span class="hljs-number">1</span>)<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="æ­»é”æˆå› åˆ†æ"><a href="#æ­»é”æˆå› åˆ†æ" class="headerlink" title="æ­»é”æˆå› åˆ†æ"></a>æ­»é”æˆå› åˆ†æ</h2><p>åŸºäºRWMutexçš„å®ç°åŸç†ï¼Œæœ¬æ¡ˆä¾‹çš„æ­»é”äº§ç”Ÿè¿‡ç¨‹å¦‚ä¸‹ï¼š</p><h3 id="æ­»é”è§¦å‘åºåˆ—"><a href="#æ­»é”è§¦å‘åºåˆ—" class="headerlink" title="æ­»é”è§¦å‘åºåˆ—"></a>æ­»é”è§¦å‘åºåˆ—</h3><p>å‡è®¾æœ‰ä¸¤ä¸ªåç¨‹ï¼šåç¨‹Aæ‰§è¡Œ<code>Run()</code>æ–¹æ³•ï¼Œåç¨‹Bæ‰§è¡Œ<code>Incr()</code>æ–¹æ³•</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs stylus">æ—¶é—´çº¿    åç¨‹A (Run)                åç¨‹B (Incr)              ç³»ç»ŸçŠ¶æ€<br>------    ----------------------    -------------------      ------------------<br>T1        c<span class="hljs-selector-class">.mu</span><span class="hljs-selector-class">.RLock</span>()              -                        readerCount = <span class="hljs-number">1</span><br>T2        -                         c<span class="hljs-selector-class">.mu</span><span class="hljs-selector-class">.Lock</span>()              å†™é”ç­‰å¾…, readerCount = -<span class="hljs-number">1073741823</span><br>                                                              readerWait = <span class="hljs-number">1</span><br>T3        c<span class="hljs-selector-class">.stat</span>() -&gt; <span class="hljs-built_in">RLock</span>()       <span class="hljs-selector-attr">[é˜»å¡ç­‰å¾…]</span>                åç¨‹Aå°è¯•é‡å…¥è¯»é”<br>T4        <span class="hljs-selector-attr">[é˜»å¡ç­‰å¾…]</span>                 <span class="hljs-selector-attr">[é˜»å¡ç­‰å¾…]</span>                æ­»é”å½¢æˆï¼<br></code></pre></td></tr></table></figure><h3 id="å…³é”®é—®é¢˜ç‚¹"><a href="#å…³é”®é—®é¢˜ç‚¹" class="headerlink" title="å…³é”®é—®é¢˜ç‚¹"></a>å…³é”®é—®é¢˜ç‚¹</h3><ol><li><strong>T1æ—¶åˆ»</strong>ï¼šåç¨‹Aè·å–è¯»é”æˆåŠŸï¼Œ<code>readerCount = 1</code></li><li><strong>T2æ—¶åˆ»</strong>ï¼šåç¨‹Bå°è¯•è·å–å†™é”<ul><li>æ‰§è¡Œ<code>atomic.AddInt32(&amp;rw.readerCount, -rwmutexMaxReaders)</code></li><li><code>readerCount</code>å˜ä¸ºè´Ÿæ•°ï¼š<code>1 - 1073741824 = -1073741823</code></li><li>æ£€æµ‹åˆ°æœ‰æ´»è·ƒè¯»åç¨‹ï¼Œè®¾ç½®<code>readerWait = 1</code>ï¼Œåç¨‹Bè¿›å…¥é˜»å¡</li></ul></li><li><strong>T3æ—¶åˆ»</strong>ï¼šåç¨‹Aåœ¨<code>stat()</code>ä¸­å°è¯•é‡å…¥è¯»é”<ul><li>æ‰§è¡Œ<code>atomic.AddInt32(&amp;rw.readerCount, 1)</code></li><li>ç»“æœä»ä¸ºè´Ÿæ•°ï¼š<code>-1073741823 + 1 = -1073741822</code></li><li>åç¨‹Aæ£€æµ‹åˆ°è´Ÿæ•°ï¼Œè¿›å…¥é˜»å¡ç­‰å¾…</li></ul></li><li><strong>æ­»é”å½¢æˆ</strong>ï¼šåç¨‹Aç­‰å¾…åç¨‹Bé‡Šæ”¾å†™é”ï¼Œåç¨‹Bç­‰å¾…åç¨‹Aé‡Šæ”¾è¯»é”</li></ol><h3 id="æ ¸å¿ƒçŸ›ç›¾"><a href="#æ ¸å¿ƒçŸ›ç›¾" class="headerlink" title="æ ¸å¿ƒçŸ›ç›¾"></a>æ ¸å¿ƒçŸ›ç›¾</h3><ul><li><strong>å†™é”è·å–æ¡ä»¶</strong>ï¼šå¿…é¡»ç­‰å¾…æ‰€æœ‰æ´»è·ƒè¯»é”é‡Šæ”¾</li><li><strong>è¯»é”é‡å…¥é—®é¢˜</strong>ï¼šå·²æŒæœ‰è¯»é”çš„åç¨‹å†æ¬¡è¯·æ±‚è¯»é”æ—¶ï¼Œé‡åˆ°å†™é”ç­‰å¾…ä¼šè¢«é˜»å¡</li><li><strong>å¾ªç¯ä¾èµ–</strong>ï¼šè¯»é”æŒæœ‰è€…æ— æ³•é‡Šæ”¾é”ï¼Œå†™é”æ— æ³•è·å–ï¼›å†™é”ç­‰å¾…å¯¼è‡´è¯»é”é‡å…¥å¤±è´¥</li></ul><h2 id="è§£å†³æ–¹æ¡ˆ"><a href="#è§£å†³æ–¹æ¡ˆ" class="headerlink" title="è§£å†³æ–¹æ¡ˆ"></a>è§£å†³æ–¹æ¡ˆ</h2><h3 id="æ–¹æ¡ˆä¸€ï¼šé¿å…è¯»é”é‡å…¥"><a href="#æ–¹æ¡ˆä¸€ï¼šé¿å…è¯»é”é‡å…¥" class="headerlink" title="æ–¹æ¡ˆä¸€ï¼šé¿å…è¯»é”é‡å…¥"></a>æ–¹æ¡ˆä¸€ï¼šé¿å…è¯»é”é‡å…¥</h3><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs golang"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Counter)</span></span> Run() &#123;<br>ticker := time.NewTicker(<span class="hljs-number">2</span> * time.Second)<br><span class="hljs-keyword">defer</span> ticker.Stop()<br><br><span class="hljs-keyword">for</span> &#123;<br><span class="hljs-keyword">select</span> &#123;<br><span class="hljs-keyword">case</span> &lt;-ticker.C:<br>c.mu.RLock()<br><span class="hljs-comment">// ç›´æ¥åœ¨æ­¤å¤„è¿›è¡Œç»Ÿè®¡ï¼Œé¿å…è°ƒç”¨éœ€è¦é‡å…¥è¯»é”çš„æ–¹æ³•</span><br>hotKeys := c.statInternal() <span class="hljs-comment">// ä¸å†åŠ é”çš„å†…éƒ¨å®ç°</span><br>c.mu.RUnlock()<br><br><span class="hljs-comment">// ä½¿ç”¨ç»Ÿè®¡ç»“æœ</span><br>c.processHotKeys(hotKeys)<br>&#125;<br>&#125;<br>&#125;<br><br><span class="hljs-comment">// statInternal æ— é”çš„å†…éƒ¨ç»Ÿè®¡å®ç°</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Counter)</span></span> statInternal() []<span class="hljs-type">string</span> &#123;<br><span class="hljs-keyword">var</span> hotKeys []<span class="hljs-type">string</span><br><span class="hljs-keyword">for</span> key := <span class="hljs-keyword">range</span> c.data &#123;<br><span class="hljs-keyword">if</span> c.data[key] &gt; <span class="hljs-number">100</span> &#123;<br>hotKeys = <span class="hljs-built_in">append</span>(hotKeys, key)<br>&#125;<br>&#125;<br><span class="hljs-keyword">return</span> hotKeys<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="æ–¹æ¡ˆäºŒï¼šåˆ†ç¦»é”çš„èŒè´£"><a href="#æ–¹æ¡ˆäºŒï¼šåˆ†ç¦»é”çš„èŒè´£" class="headerlink" title="æ–¹æ¡ˆäºŒï¼šåˆ†ç¦»é”çš„èŒè´£"></a>æ–¹æ¡ˆäºŒï¼šåˆ†ç¦»é”çš„èŒè´£</h3><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs golang"><span class="hljs-keyword">type</span> Counter <span class="hljs-keyword">struct</span> &#123;<br>data   <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">int</span><br>hot    []<span class="hljs-type">string</span><br>dataMu sync.RWMutex <span class="hljs-comment">// æ•°æ®è¯»å†™é”</span><br>hotMu  sync.RWMutex <span class="hljs-comment">// çƒ­ç‚¹æ•°æ®è¯»å†™é”</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Counter)</span></span> stat() &#123;<br>c.dataMu.RLock()<br>hotKeys := c.statInternal()<br>c.dataMu.RUnlock()<br><br>c.hotMu.Lock()<br>c.hot = hotKeys<br>c.hotMu.Unlock()<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="æ–¹æ¡ˆä¸‰ï¼šä½¿ç”¨åŸå­æ“ä½œæˆ–æ— é”æ•°æ®ç»“æ„"><a href="#æ–¹æ¡ˆä¸‰ï¼šä½¿ç”¨åŸå­æ“ä½œæˆ–æ— é”æ•°æ®ç»“æ„" class="headerlink" title="æ–¹æ¡ˆä¸‰ï¼šä½¿ç”¨åŸå­æ“ä½œæˆ–æ— é”æ•°æ®ç»“æ„"></a>æ–¹æ¡ˆä¸‰ï¼šä½¿ç”¨åŸå­æ“ä½œæˆ–æ— é”æ•°æ®ç»“æ„</h3><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs golang"><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;sync/atomic&quot;</span><br><br><span class="hljs-keyword">type</span> Counter <span class="hljs-keyword">struct</span> &#123;<br>data unsafe.Pointer <span class="hljs-comment">// *map[string]*int64</span><br>hot  atomic.Value   <span class="hljs-comment">// []string</span><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="æœ€ä½³å®è·µ"><a href="#æœ€ä½³å®è·µ" class="headerlink" title="æœ€ä½³å®è·µ"></a>æœ€ä½³å®è·µ</h2><ol><li><strong>é¿å…é”é‡å…¥</strong>ï¼šè®¾è®¡æ—¶ç¡®ä¿åŒä¸€åç¨‹ä¸ä¼šé‡å¤è·å–ç›¸åŒç±»å‹çš„é”</li><li><strong>é”ç²’åº¦åˆ†ç¦»</strong>ï¼šå°†ä¸åŒèŒè´£çš„æ•°æ®ç”¨ä¸åŒçš„é”ä¿æŠ¤</li><li><strong>å‡å°‘é”æŒæœ‰æ—¶é—´</strong>ï¼šå°½å¿«é‡Šæ”¾é”ï¼Œé¿å…åœ¨æŒé”æœŸé—´è°ƒç”¨å…¶ä»–å¯èƒ½åŠ é”çš„å‡½æ•°</li><li><strong>ä½¿ç”¨Goå®˜æ–¹å»ºè®®</strong>ï¼šé¿å…è¯»å†™é”çš„é‡å…¥ä½¿ç”¨</li></ol><blockquote><p><strong>Goå®˜æ–¹è­¦å‘Š</strong>ï¼šRWMutexçš„è®¾è®¡å¹¶ä¸æ”¯æŒé‡å…¥ï¼Œé‡å…¥å¯èƒ½å¯¼è‡´æ­»é”ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<br><img src="/images/avoid_rlock_reentrant.png" alt="avoid_rlock_reentrant"></p></blockquote><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>RWMutexè¯»é”é‡å…¥æ­»é”æ˜¯Goå¹¶å‘ç¼–ç¨‹ä¸­çš„ç»å…¸é™·é˜±ã€‚å…¶æ ¹æœ¬åŸå› åœ¨äºï¼š</p><ul><li>RWMutexçš„å†™é”ä¼˜å…ˆæœºåˆ¶ä¼šé˜»æ­¢æ–°çš„è¯»é”è·å–</li><li>è¯»é”é‡å…¥åœ¨å†™é”ç­‰å¾…æ—¶ä¼šè¢«é˜»å¡ï¼Œå½¢æˆå¾ªç¯ç­‰å¾…</li></ul><p>è§£å†³æ­¤ç±»é—®é¢˜çš„å…³é”®æ˜¯ç†è§£RWMutexçš„å®ç°åŸç†ï¼Œåˆç†è®¾è®¡é”çš„ä½¿ç”¨æ¨¡å¼ï¼Œé¿å…é‡å…¥æƒ…å†µçš„å‘ç”Ÿã€‚</p>]]></content>
    
    
    <categories>
      
      <category>Goå¹¶å‘ç¼–ç¨‹</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Go</tag>
      
      <tag>RWMutex</tag>
      
      <tag>æ­»é”</tag>
      
      <tag>å¹¶å‘ç¼–ç¨‹</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>å®ç°é«˜æ€§èƒ½çš„æœ¬åœ°ç¼“å­˜åº“</title>
    <link href="/2024/08/05/local-cache-go-impl/"/>
    <url>/2024/08/05/local-cache-go-impl/</url>
    
    <content type="html"><![CDATA[<blockquote><p>åœ¨æ—¥å¸¸é«˜æµé‡åœºæ™¯ä¸­(è¯»å¤šå†™å°‘åœºæ™¯)ï¼Œç»å¸¸ä¼šä½¿ç”¨æœ¬åœ°ç¼“å­˜æ¥åº”å¯¹çƒ­ç‚¹æµé‡ï¼Œä¿éšœç³»ç»Ÿçš„ç¨³å®šã€‚å¯æ˜¯ä½ æœ‰æ²¡æœ‰å¥½å¥‡è¿‡å®ƒåº•å±‚æ˜¯æ€ä¹ˆå®ç°çš„ï¼Ÿæ•°æ®æ˜¯å¦‚ä½•ç®¡ç†çš„ï¼Ÿå¦‚æœä½ æ¥è®¾è®¡ä¸€ä¸ªç¼“å­˜åº“ï¼Œä½ ä¼šå¦‚ä½•è®¾è®¡?</p></blockquote><span id="more"></span><h1 id="ä»–å±±ä¹‹çŸ³ï¼Œå¯ä»¥æ”»ç‰"><a href="#ä»–å±±ä¹‹çŸ³ï¼Œå¯ä»¥æ”»ç‰" class="headerlink" title="ä»–å±±ä¹‹çŸ³ï¼Œå¯ä»¥æ”»ç‰"></a>ä»–å±±ä¹‹çŸ³ï¼Œå¯ä»¥æ”»ç‰</h1><p>åœ¨å¼€å§‹ä¹‹å‰ï¼Œå€ŸåŠ©å¼€æºç¤¾åŒºäº†è§£ä¸»æµç¼“å­˜åº“çš„ç§ç±»ã€è®¾è®¡æ€æƒ³ä»¥åŠé€‚ç”¨åœºæ™¯æ˜¯ä¸€ä¸ªæ˜æ™ºçš„åšæ³•ã€‚é€šè¿‡è¿™æ ·çš„è°ƒç ”ï¼Œå¯ä»¥äº†è§£åˆ°ä¸åŒç¼“å­˜åº“çš„ç‰¹ç‚¹å’Œä¼˜åŠ¿ï¼Œå¹¶ä»ä¸­æ±²å–ç»éªŒï¼Œä»¥è®¾è®¡å‡ºç¬¦åˆè‡ªå·±éœ€æ±‚çš„ç¼“å­˜åº“ã€‚ ä¸ºäº†æ–¹ä¾¿å­¦ä¹ å’Œç†è§£ï¼Œæˆ‘å¯¹ä¸»æµåº“åšäº†è¯¦ç»†è°ƒç ”å¹¶æ•´ç†å‡ºä»¥ä¸‹å¤šç»´åº¦å¯¹æ¯”å›¾ï¼Œå¸®åŠ©ä½ æ›´æ¸…æ™°åœ°äº†è§£ä¸åŒç¼“å­˜åº“ä¹‹é—´çš„å·®å¼‚å’Œä¼˜åŠ¿ã€‚</p><p><img src="/images/go_localcaches_compare.png" alt="ä¸»æµç¼“å­˜åº“å¯¹æ¯”"><br>ä¸Šè¿°ä¸­æ¯”è¾ƒæœ‰æ„æ€çš„æ˜¯Zero-Gcè¿™ä¸ªæ¦‚å¿µï¼Œæˆ‘æ€»ç»“ä¸‹å…³é”®ä¿¡æ¯:<br><strong>å¦‚ä½•å®ç°Zero-GC?</strong></p><ol><li>å®Œå…¨é¿å…GC: é‡‡ç”¨syscall.MMapç”³è¯·å †å¤–å†…å­˜ï¼Œgcå°±ä¸ä¼šæ‰«æ</li><li>è§„é¿GCæ‰«æç­–ç•¥:</li></ol><ul><li>æ•°ç»„(å›ºå®šäº†æŒ‡é’ˆæ•°é‡) + map[uint64]uint32(éæŒ‡é’ˆ) + []byte(å‚è€ƒfreecache) </li><li>slice + éæŒ‡é’ˆçš„map + ringbuffer(å‚è€ƒbigcache)</li></ul><p><strong>å¦‚ä½•é€‰æ‹©ï¼Ÿ</strong></p><ul><li>è¯»å†™æ€§èƒ½è¦æ±‚? æ¯”å¦‚ristrettoåº•å±‚ä¾èµ–channel,Getå¾ˆå¿«ï¼Œä½†æ˜¯Setå¦‚æœæ˜¯åŒæ­¥æ¨¡å¼ï¼Œä¼šè¾ƒæ…¢éœ€è¦è¯„ä¼°ã€‚</li><li>gcæ•æ„Ÿåº¦, éœ€è¦å‹æµ‹çœ‹ä¸šåŠ¡æ˜¯å¦èƒ½æ¥å—ã€‚</li><li>è¿‡æœŸæ—¶é—´é…ç½®æ˜¯å¦çµæ´»ï¼Œæœ‰äº›åº“ç”šè‡³éƒ½ä¸æ”¯æŒè¿‡æœŸæ—¶é—´ï¼Œä¸è¿‡è¿™è¿˜å¾—å–å†³äºä½¿ç”¨åœºæ™¯éœ€è¦è‡ªè¡Œè¯„ä¼°ã€‚</li><li>ä¸šåŠ¡åŒ¹é…åº¦ï¼Œæ¯”å¦‚å¤§éƒ¨åˆ†ä¸šåŠ¡ristrettoæ›´é€‚åˆï¼Œæ”¯æŒæ³›å‹ã€ä½¿ç”¨é—¨æ§›ä½ï¼Œä¸è¿‡æœ‰ä¸€å®šçš„gcå‹åŠ›ï¼›å†æ¯”å¦‚apiCacheåœºæ™¯ï¼Œåªæ˜¯ç®€å•çš„å–å‡ºç¼“å­˜å†™socketï¼Œæ— åºåºåˆ—åŒ–ï¼Œé‚£æ›´é€‚åˆbigCacheï¼Œä¸è¿‡bigCacheè¯»çš„æ—¶å€™å­˜åœ¨å†…å­˜æ‹·è´ï¼Œéœ€è¦ç•™æ„;</li></ul><p>ç»¼ä¸Šï¼Œæ²¡æœ‰ä¸€ä¸ªç¼“å­˜åº“é€‚ç”¨äºæ‰€æœ‰åœºæ™¯å’Œé—®é¢˜, æ¯ä¸ªç¼“å­˜åº“çš„è¯ç”Ÿéƒ½æ˜¯ä¸ºäº†è§£å†³ç‰¹å®šåœºæ™¯ä¸‹çš„ç‰¹å®šé—®é¢˜, ä¸è¿‡è¿™äº›é—®é¢˜ç§ç±»ä¸å¤šä¸»è¦åˆ†ä¸ºä»¥ä¸‹å‡ ç±»:</p><ul><li>é”ç«äº‰ã€‚å…¨å±€é”å¯¼è‡´å¤§é‡è¯·æ±‚éƒ½åœ¨æŠ¢é”ã€ä¼‘çœ ï¼Œä¸¥é‡å½±å“æ€§èƒ½</li><li>æ•°æ®æ·˜æ±°ã€‚å†…å­˜èµ„æºæœ‰é™ï¼Œå¿…é¡»è¦æŒ‰ç‰¹å®šç­–ç•¥æ·˜æ±°æ•°æ®</li><li>GCé—®é¢˜ã€‚å­˜å‚¨æµ·é‡å¯¹è±¡æ—¶ï¼ŒGCæ‰«æçš„å½±å“ä¸å®¹å°è§‘</li></ul><hr><h1 id="å®è·µå‡ºçœŸçŸ¥"><a href="#å®è·µå‡ºçœŸçŸ¥" class="headerlink" title="å®è·µå‡ºçœŸçŸ¥"></a>å®è·µå‡ºçœŸçŸ¥</h1><p>æ¥ä¸‹æ¥å›´ç»•ä¸Šè¿°ä¸‰ä¸ªé—®é¢˜æ¥è®¾è®¡æˆ‘ä»¬è‡ªå·±çš„é«˜æ€§èƒ½æœ¬åœ°ç¼“å­˜åº“ã€‚</p><h2 id="è®¾è®¡ç›®æ ‡"><a href="#è®¾è®¡ç›®æ ‡" class="headerlink" title="è®¾è®¡ç›®æ ‡"></a>è®¾è®¡ç›®æ ‡</h2><ul><li>é«˜æ€§èƒ½, å‡å°‘é”ç«äº‰</li><li>ä½¿ç”¨ç®€å•ï¼Œé…ç½®ä¸èƒ½å¤ªå¤æ‚ï¼Œè¦å¼€ç®±å³ç”¨</li><li>æ”¯æŒæŒ‰keyè®¾ç½®è¿‡æœŸæ—¶é—´</li><li>æ”¯æŒè‡ªåŠ¨æ·˜æ±°(LRU)</li><li>ä¸è¦æ±‚Zero-GC, ä½†ä¹Ÿåº”è¯¥å°½é‡å‡å°‘GC</li></ul><h2 id="è®¾è®¡æ€è·¯"><a href="#è®¾è®¡æ€è·¯" class="headerlink" title="è®¾è®¡æ€è·¯"></a>è®¾è®¡æ€è·¯</h2><ul><li>é”ç«äº‰: è¯»å†™é” + æ•°æ®åˆ†ç‰‡</li><li>æ•°æ®æ·˜æ±°: LRU</li><li>é«˜æ€§èƒ½: åˆå¹¶å†™æ“ä½œ; æ‰¹é‡æ›´æ–°;</li><li>GCä¼˜åŒ–: æˆ‘ä»¬çš„ç›®æ ‡æ˜¯å‡å°‘GCï¼Œå°½é‡å‡å°‘å¯¹è±¡åˆ†é…</li></ul><h2 id="è¯¦ç»†è®¾è®¡"><a href="#è¯¦ç»†è®¾è®¡" class="headerlink" title="è¯¦ç»†è®¾è®¡"></a>è¯¦ç»†è®¾è®¡</h2><h3 id="APIè®¾è®¡"><a href="#APIè®¾è®¡" class="headerlink" title="APIè®¾è®¡"></a>APIè®¾è®¡</h3><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs golang"><br><span class="hljs-keyword">type</span> Cache <span class="hljs-keyword">interface</span> &#123;<br>Set(k <span class="hljs-type">string</span>, v any, ttl time.Duration) <span class="hljs-type">bool</span><br>Get(k <span class="hljs-type">string</span>) (v any, err <span class="hljs-type">error</span>)<br>Del(k <span class="hljs-type">string</span>)<br>Len() <span class="hljs-type">uint64</span><br>Close()<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="æ ¸å¿ƒæ•°æ®ç»“æ„"><a href="#æ ¸å¿ƒæ•°æ®ç»“æ„" class="headerlink" title="æ ¸å¿ƒæ•°æ®ç»“æ„"></a>æ ¸å¿ƒæ•°æ®ç»“æ„</h3><h4 id="cache"><a href="#cache" class="headerlink" title="cache"></a>cache</h4><p>cacheä¸­æ ¸å¿ƒç»“æ„ä¸ºstoreã€policyã€expireKeyTimersæ¨¡å—, storeè´Ÿè´£å­˜å‚¨å¼•æ“çš„å®ç°ï¼Œpolicyè´Ÿè´£æ·˜æ±°æœºåˆ¶ï¼ŒexpireKeyTimersç®¡ç†è¿‡æœŸæ¸…ç†çš„å®šæ—¶ä»»åŠ¡ï¼Œè¿™ä¸‰è€…å…±åŒç»„æˆäº†ç¼“å­˜åº“åŸºç¡€éª¨æ¶ã€‚</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs golang"><span class="hljs-keyword">type</span> cache <span class="hljs-keyword">struct</span> &#123;<br>size <span class="hljs-type">int</span><br><br>store            store   <span class="hljs-comment">// è¯»å†™é” + æ•°æ®åˆ†ç‰‡</span><br>policy           policy  <span class="hljs-comment">//é“¾è¡¨æ·˜æ±°ç­–ç•¥ï¼ŒLRUç­‰</span><br>ekt              *expireKeyTimers <span class="hljs-comment">//ç»´æŠ¤keyçš„å®šæœŸæ¸…ç†ä»»åŠ¡</span><br>accessUniqBuffer *uniqRingBuffer <span class="hljs-comment">// åˆå¹¶Getæ“ä½œï¼Œé™ä½å¯¹é“¾è¡¨çš„ç§»åŠ¨</span><br><br>accessEvtCh <span class="hljs-keyword">chan</span> []*list.Element <span class="hljs-comment">//æ‰¹é‡Getæ“ä½œï¼Œæ”¯æŒæ‰¹é‡æ›´æ–°é“¾è¡¨</span><br>updateEvtCh <span class="hljs-keyword">chan</span> *entExtendFunc  <span class="hljs-comment">//åˆå¹¶å¯¹é“¾è¡¨çš„Update</span><br>addEvtCh    <span class="hljs-keyword">chan</span> *entExtendFunc  <span class="hljs-comment">//åˆå¹¶å†™æ“ä½œ(åŒ…å«é“¾è¡¨å’Œmap)</span><br>delEvtCh    <span class="hljs-keyword">chan</span> *keyExtendFunc  <span class="hljs-comment">//åˆå¹¶å¯¹é“¾è¡¨çš„Del</span><br><br>isSync     <span class="hljs-type">bool</span> <span class="hljs-comment">//åŒæ­¥æ ‡è¯†ï¼Œä¼šé˜»å¡ç­‰å¾…è‡³å†™æˆåŠŸä¹‹å</span><br>setTimeout time.Duration <span class="hljs-comment">//é˜»å¡ç­‰å¾…è¶…æ—¶æ—¶é—´</span><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="store-å­˜å‚¨å¼•æ“å®ç°"><a href="#store-å­˜å‚¨å¼•æ“å®ç°" class="headerlink" title="store - å­˜å‚¨å¼•æ“å®ç°"></a>store - å­˜å‚¨å¼•æ“å®ç°</h4><p>store æä¾›å¢åˆ æ”¹æŸ¥çš„æ¥å£ï¼Œå¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€æ±‚å®ç°å¯¹åº”çš„æ¥å£ï¼Œæ¯”å¦‚æˆ‘ä»¬è¿™é‡Œç”¨å°±æ˜¯shardedMap, é€šè¿‡åˆ†ç‰‡æ¥é™ä½é”çš„ç²’åº¦, å‡å°‘é”ç«äº‰ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs azure">type store interface &#123;<br>    set(k string, v any)<br>    get(k string) (any, bool)<br>    del(k string)<br>    len() uint64<br>    clear()<br>&#125;<br>type shardedMap struct &#123;<br>    shards []*safeMap<br>&#125;<br>    <br>type safeMap struct &#123;<br>mu   sync.RWMutex<br>data map[string]any<br>&#125;<br><br></code></pre></td></tr></table></figure><h4 id="policy-æ·˜æ±°æœºåˆ¶"><a href="#policy-æ·˜æ±°æœºåˆ¶" class="headerlink" title="policy - æ·˜æ±°æœºåˆ¶"></a>policy - æ·˜æ±°æœºåˆ¶</h4><p>æ·˜æ±°æœºåˆ¶ä¸»è¦æ˜¯åœ¨å¯¹æ•°æ®å¢åˆ æ”¹æŸ¥æ—¶ï¼Œé€šè¿‡ä¸€å®šçš„ç­–ç•¥æ¥ç§»åŠ¨é“¾è¡¨å…ƒç´ ï¼Œä»¥ä¿è¯æ´»è·ƒçš„ç¼“å­˜é¡¹ç•™åœ¨å†…å­˜ä¸­ï¼ŒåŒæ—¶æ·˜æ±°ä¸æ´»è·ƒçš„ç¼“å­˜é¡¹ã€‚å¸¸è§æ·˜æ±°ç­–ç•¥æœ‰LRUã€LFUç­‰ã€‚LRUè¾ƒç®€å•ï¼Œå¯ä»¥é€šè¿‡æ ‡å‡†åº“ä¸­çš„listå®ç°policyæ¥å£å®ç°ã€‚</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs golang"><span class="hljs-comment">// ç¼“å­˜é¡¹ï¼ŒåŒ…å« key,value,è¿‡æœŸæ—¶é—´</span><br><span class="hljs-keyword">type</span> entry <span class="hljs-keyword">struct</span> &#123;<br>    key      <span class="hljs-type">string</span><br>    val      any<br>    expireAt time.Time<br>    mu sync.RWMutex<br>&#125;<br><span class="hljs-keyword">type</span> policy <span class="hljs-keyword">interface</span> &#123;<br>isFull() <span class="hljs-type">bool</span><br>add(*entry) (*list.Element, *list.Element) <span class="hljs-comment">// è¿”å›æ–°å¢, victim:æ·˜æ±°çš„entry</span><br>remove(*list.Element)<br>update(*entry, *list.Element)<br>renew(*list.Element)<br>batchRenew([]*list.Element)<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="expireKeyTimers-è¿‡æœŸæ—¶é—´"><a href="#expireKeyTimers-è¿‡æœŸæ—¶é—´" class="headerlink" title="expireKeyTimers - è¿‡æœŸæ—¶é—´"></a>expireKeyTimers - è¿‡æœŸæ—¶é—´</h4><p>è¿™ä¸ªæ¨¡å—ä¸»è¦ç»´æŠ¤è¿‡æœŸkeyçš„å®šæ—¶æ¸…ç†ä»»åŠ¡ã€‚åº•å±‚ä¸»è¦ä¾èµ–ç¬¬ä¸‰æ–¹<a href="https://github.com/RussellLuo/timingwheel">æ—¶é—´è½®åº“</a>æ¥ç®¡ç†å®šæ—¶ä»»åŠ¡</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs golang"><span class="hljs-keyword">type</span> expireKeyTimers <span class="hljs-keyword">struct</span> &#123;<br>mu     sync.RWMutex<br>timers <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]*timingwheel.Timer<br><br>tick      time.Duration<br>wheelSize <span class="hljs-type">int64</span><br>tw        *timingwheel.TimingWheel<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="hashå‡½æ•°é€‰å‹"><a href="#hashå‡½æ•°é€‰å‹" class="headerlink" title="hashå‡½æ•°é€‰å‹"></a>hashå‡½æ•°é€‰å‹</h3><p><a href="https://github.com/smallnest/hash-bench">å¸¸è§hashå‡½æ•°å‹æµ‹å¯¹æ¯”</a><br><img src="/images/hash_func.png" alt="å¸¸è§hashå‡½æ•°"></p><hr><p>fnv64 vs xxhash<br>æµ‹è¯•æœºå™¨: mac-m1, go benchmarkç»“æœ</p><table><thead><tr><th>hashå‡½æ•°</th><th>fnv64a</th><th>github.com&#x2F;cespare&#x2F;xxhash&#x2F;v2</th></tr></thead><tbody><tr><td>8å­—èŠ‚</td><td>5.130 ns&#x2F;op</td><td>8.817 ns&#x2F;op</td></tr><tr><td>16å­—èŠ‚</td><td>7.928 ns&#x2F;op</td><td>7.464 ns&#x2F;op</td></tr><tr><td>32å­—èŠ‚</td><td>17.17 ns&#x2F;op</td><td>14.22 ns&#x2F;op</td></tr></tbody></table><h3 id="é«˜æ€§èƒ½ä¼˜åŒ–"><a href="#é«˜æ€§èƒ½ä¼˜åŒ–" class="headerlink" title="é«˜æ€§èƒ½ä¼˜åŒ–"></a>é«˜æ€§èƒ½ä¼˜åŒ–</h3><h4 id="å†™æ“ä½œ"><a href="#å†™æ“ä½œ" class="headerlink" title="å†™æ“ä½œ"></a>å†™æ“ä½œ</h4><p><strong>éš”ç¦»:</strong>  æŒ‰channeléš”ç¦»å¢ã€åˆ ã€æ”¹<br><strong>åŒæ­¥è½¬å¼‚æ­¥:</strong>  é“¾è¡¨å¹¶å‘å†™æ“ä½œï¼Œæ”¹ä¸ºå¼‚æ­¥å•åç¨‹æ›´æ–°<br><strong>æ”¯æŒéé˜»å¡</strong></p><h4 id="è¯»æ“ä½œ"><a href="#è¯»æ“ä½œ" class="headerlink" title="è¯»æ“ä½œ"></a>è¯»æ“ä½œ</h4><p><strong>æ‰¹é‡æ“ä½œ:</strong> é‡‡ç”¨ringbufferï¼Œæ‰¹é‡æ›´æ–°é“¾è¡¨</p><h4 id="å†…å­˜ä¼˜åŒ–"><a href="#å†…å­˜ä¼˜åŒ–" class="headerlink" title="å†…å­˜ä¼˜åŒ–"></a>å†…å­˜ä¼˜åŒ–</h4><p>é‡‡ç”¨sync.Poolæ± åŒ–ringbufferå¯¹è±¡ï¼Œé¿å…é¢‘ç¹åˆ›å»ºå¯¹è±¡</p><h2 id="å‹æµ‹å¯¹æ¯”"><a href="#å‹æµ‹å¯¹æ¯”" class="headerlink" title="å‹æµ‹å¯¹æ¯”"></a>å‹æµ‹å¯¹æ¯”</h2><p><a href="https://github.com/codingWhat/armory/tree/main/cache/localcache">ä»£ç åœ°å€</a><br>åŒæ­¥æ¨¡å¼:</p><table><thead><tr><th>å‹æµ‹case</th><th>æ“ä½œæ¬¡æ•°</th><th>å•æ¬¡è€—æ—¶ (ns&#x2F;op)</th><th>å†…å­˜åˆ†é… (B&#x2F;op)</th><th>åˆ†é…æ¬¡æ•°</th></tr></thead><tbody><tr><td>BenchmarkSyncMapSetParallelForStruct-10</td><td>1,576,032</td><td>719.3</td><td>76</td><td>5</td></tr><tr><td><strong>BenchmarkRistrettoSetParallelForStruct-10</strong></td><td>716,690</td><td>1,642</td><td>369</td><td>11</td></tr><tr><td>BenchmarkFreeCacheSetParallelForStruct-10</td><td>2,122,884</td><td>562.7</td><td>61</td><td>4</td></tr><tr><td>BenchmarkBigCacheSetParallelForStruct-10</td><td>2,206,600</td><td>546.9</td><td>200</td><td>4</td></tr><tr><td><strong>BenchmarkLCSetParallelForStruct-10</strong></td><td>914,626</td><td>1,279</td><td>282</td><td>9</td></tr><tr><td>BenchmarkSyncMapGetParallelForStruct-10</td><td>3,933,157</td><td>305.5</td><td>24</td><td>1</td></tr><tr><td>BenchmarkFreeCacheGetParallelForStruct-10</td><td>2,159,518</td><td>577.2</td><td>263</td><td>7</td></tr><tr><td>BenchmarkBigCacheGetParallelForStruct-10</td><td>2,218,573</td><td>539.1</td><td>279</td><td>8</td></tr><tr><td><strong>BenchmarkRistrettoGetParallelForStruct-10</strong></td><td>3,195,711</td><td>379.0</td><td>31</td><td>1</td></tr><tr><td><strong>BenchmarkLCGetParallelForStruct-10</strong></td><td>2,233,429</td><td>530.5</td><td>31</td><td>2</td></tr></tbody></table><p>æ€»ç»“:</p><ul><li>è¯»å–æ€§èƒ½: LC å’Œ SyncMap åœ¨è¯»å–æ“ä½œä¸­è¡¨ç°æœ€ä½³ï¼Œå…·æœ‰è¾ƒä½çš„è€—æ—¶å’Œå†…å­˜åˆ†é…ã€‚</li><li>å†™å…¥æ€§èƒ½: BigCache å’Œ FreeCache åœ¨å†™å…¥æ“ä½œä¸­è¡¨ç°è¾ƒå¥½ï¼ŒLCã€Ristrettoå› ä¸ºchannelç¼˜æ•…ï¼Œå†™å…¥æ€§èƒ½è¾ƒå·®ã€‚</li><li>å†…å­˜æ•ˆç‡: SyncMap&#x2F;Ristretto åœ¨Getæ“ä½œä¸­çš„å†…å­˜åˆ†é…æœ€ä½ï¼ŒFreeCacheåœ¨Setæ“ä½œä¸­å†…å­˜åˆ†é…æœ€ä½, æ•´ä½“ä¸ŠsyncMapå ç”¨æœ€ä½ã€‚</li></ul><p>éåŒæ­¥æ¨¡å¼:<br>è¯»ã€å†™ã€è€—æ—¶ã€å†…å­˜åˆ†é…é€æ¸æ¥è¿‘ä¸»æµåº“çš„, ä½†æ˜¯å†™å­˜åœ¨å¤±è´¥çš„æ¦‚ç‡ï¼Œéœ€è¦æŒ‰åœºæ™¯æƒè¡¡ã€‚</p><table><thead><tr><th>å‹æµ‹case</th><th>æ“ä½œæ¬¡æ•°</th><th>å•æ¬¡è€—æ—¶ (ns&#x2F;op)</th><th>å†…å­˜åˆ†é… (B&#x2F;op)</th><th>åˆ†é…æ¬¡æ•° (allocs&#x2F;op)</th></tr></thead><tbody><tr><td>BenchmarkSyncMapSetParallelForStruct-10</td><td>1256974</td><td>958.8</td><td>78</td><td>5</td></tr><tr><td><strong>BenchmarkRistrettoSetParallelForStruct-10</strong></td><td>2372764</td><td>505.6</td><td>143</td><td>4</td></tr><tr><td>BenchmarkFreeCacheSetParallelForStruct-10</td><td>2117694</td><td>554.2</td><td>61</td><td>4</td></tr><tr><td>BenchmarkBigCacheSetParallelForStruct-10</td><td>2130927</td><td>547.5</td><td>206</td><td>4</td></tr><tr><td><strong>BenchmarkLCSetParallelForStruct-10</strong></td><td>2115037</td><td>567.1</td><td>158</td><td>6</td></tr><tr><td>BenchmarkSyncMapGetParallelForStruct-10</td><td>3854450</td><td>305.2</td><td>23</td><td>1</td></tr><tr><td>BenchmarkFreeCacheGetParallelForStruct-10</td><td>2152428</td><td>560.6</td><td>263</td><td>7</td></tr><tr><td>BenchmarkBigCacheGetParallelForStruct-10</td><td>2202607</td><td>539.5</td><td>279</td><td>8</td></tr><tr><td><strong>BenchmarkRistrettoGetParallelForStruct-10</strong></td><td>3445798</td><td>349.7</td><td>31</td><td>1</td></tr><tr><td><strong>BenchmarkLCGetParallelForStruct-10</strong></td><td>2453848</td><td>505.4</td><td>30</td><td>2</td></tr></tbody></table><h2 id="æœªæ¥å±•æœ›"><a href="#æœªæ¥å±•æœ›" class="headerlink" title="æœªæ¥å±•æœ›"></a>æœªæ¥å±•æœ›</h2><p>ç»§ç»­ä¼˜åŒ–å†™åœºæ™¯ä¸‹ï¼Œä¸´æ—¶å¯¹è±¡çš„ç®¡ç†ï¼Œå‡å°‘è€—æ—¶æ“ä½œå’Œé¢‘ç¹çš„å†…å­˜ç”³è¯·ã€‚</p>]]></content>
    
    
    
    <tags>
      
      <tag>GO</tag>
      
      <tag>æœ¬åœ°ç¼“å­˜</tag>
      
      <tag>LRU</tag>
      
      <tag>é«˜æ€§èƒ½</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>æœåŠ¡é«˜å¯ç”¨æ²»ç†ç³»åˆ—ï¼ˆä¸€ï¼‰ï¼šSREç†è®ºåŸºç¡€ä¸åº¦é‡ä½“ç³»</title>
    <link href="/2024/07/28/service-avaliable/"/>
    <url>/2024/07/28/service-avaliable/</url>
    
    <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡æ˜¯æœåŠ¡é«˜å¯ç”¨æ²»ç†ç³»åˆ—çš„ç¬¬ä¸€ç¯‡ï¼Œé‡ç‚¹ä»‹ç»SREç†è®ºåŸºç¡€ã€å¯ç”¨æ€§åº¦é‡ä½“ç³»å’Œç›‘æ§å‘Šè­¦è®¾è®¡ã€‚ç³»åˆ—ç¬¬äºŒç¯‡å°†æ·±å…¥æ¢è®¨å…·ä½“çš„æŠ€æœ¯å®ç°å’Œæ¶æ„è®¾è®¡ã€‚</p></blockquote><h1 id="æœåŠ¡é«˜å¯ç”¨æ²»ç†ç³»åˆ—ï¼ˆä¸€ï¼‰ï¼šSREç†è®ºåŸºç¡€ä¸åº¦é‡ä½“ç³»"><a href="#æœåŠ¡é«˜å¯ç”¨æ²»ç†ç³»åˆ—ï¼ˆä¸€ï¼‰ï¼šSREç†è®ºåŸºç¡€ä¸åº¦é‡ä½“ç³»" class="headerlink" title="æœåŠ¡é«˜å¯ç”¨æ²»ç†ç³»åˆ—ï¼ˆä¸€ï¼‰ï¼šSREç†è®ºåŸºç¡€ä¸åº¦é‡ä½“ç³»"></a>æœåŠ¡é«˜å¯ç”¨æ²»ç†ç³»åˆ—ï¼ˆä¸€ï¼‰ï¼šSREç†è®ºåŸºç¡€ä¸åº¦é‡ä½“ç³»</h1><h2 id="æ ¸å¿ƒæ¦‚å¿µå®šä¹‰"><a href="#æ ¸å¿ƒæ¦‚å¿µå®šä¹‰" class="headerlink" title="æ ¸å¿ƒæ¦‚å¿µå®šä¹‰"></a>æ ¸å¿ƒæ¦‚å¿µå®šä¹‰</h2><h3 id="æœåŠ¡å¯ç”¨æ€§çš„é‡åŒ–æŒ‡æ ‡"><a href="#æœåŠ¡å¯ç”¨æ€§çš„é‡åŒ–æŒ‡æ ‡" class="headerlink" title="æœåŠ¡å¯ç”¨æ€§çš„é‡åŒ–æŒ‡æ ‡"></a>æœåŠ¡å¯ç”¨æ€§çš„é‡åŒ–æŒ‡æ ‡</h3><p>æœåŠ¡å¯ç”¨æ€§åœ¨å·¥ç¨‹å®è·µä¸­é€šå¸¸é‡‡ç”¨ä»¥ä¸‹å…¬å¼è¿›è¡Œé‡åŒ–ï¼š</p><figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gcode">å¯ç”¨æ€§ = MTTF / <span class="hljs-comment">(MTTR + MTTF)</span> Ã— <span class="hljs-number">100</span><span class="hljs-meta">%</span><br></code></pre></td></tr></table></figure><p><strong>å…³é”®æŒ‡æ ‡è§£é‡Šï¼š</strong></p><ul><li>**MTTF (Mean Time To Failure)**ï¼šå¹³å‡æ— æ•…éšœæ—¶é—´ï¼Œè¡¡é‡ç³»ç»Ÿç¨³å®šæ€§çš„æ ¸å¿ƒæŒ‡æ ‡</li><li>**MTTR (Mean Time To Repair)**ï¼šå¹³å‡æ•…éšœä¿®å¤æ—¶é—´ï¼Œåæ˜ ç³»ç»Ÿæ•…éšœæ¢å¤èƒ½åŠ›</li><li>**MTBF (Mean Time Between Failures)**ï¼šå¹³å‡æ•…éšœé—´éš”æ—¶é—´ï¼ŒMTBF &#x3D; MTTF + MTTR</li></ul><p><strong>æŒ‡æ ‡æ„ä¹‰ï¼š</strong></p><ul><li>MTTFè¶Šé•¿è¡¨ç¤ºç³»ç»Ÿç¨³å®šæ€§è¶Šå¥½ï¼Œæ•…éšœå‘ç”Ÿé¢‘ç‡è¶Šä½</li><li>MTTRè¶ŠçŸ­è¡¨ç¤ºç³»ç»Ÿå®¹é”™èƒ½åŠ›è¶Šå¼ºï¼Œæ•…éšœæ¢å¤é€Ÿåº¦è¶Šå¿«<br><img src="/images/available_metric.png" alt="MTTFã€MTTRã€MTBF"></li></ul><h2 id="æœåŠ¡å¯ç”¨æ€§çš„ä¸šåŠ¡ä»·å€¼"><a href="#æœåŠ¡å¯ç”¨æ€§çš„ä¸šåŠ¡ä»·å€¼" class="headerlink" title="æœåŠ¡å¯ç”¨æ€§çš„ä¸šåŠ¡ä»·å€¼"></a>æœåŠ¡å¯ç”¨æ€§çš„ä¸šåŠ¡ä»·å€¼</h2><p>æœåŠ¡å¯ç”¨æ€§ç›´æ¥å…³ç³»åˆ°ä¸šåŠ¡è¿ç»­æ€§å’Œç”¨æˆ·ä½“éªŒï¼Œå…¶å½±å“å…·æœ‰å¤šç»´åº¦çš„ä¼ å¯¼æ•ˆåº”ï¼š</p><h3 id="ç”¨æˆ·ä½“éªŒå±‚é¢"><a href="#ç”¨æˆ·ä½“éªŒå±‚é¢" class="headerlink" title="ç”¨æˆ·ä½“éªŒå±‚é¢"></a>ç”¨æˆ·ä½“éªŒå±‚é¢</h3><ul><li><strong>ç”¨æˆ·æµå¤±</strong>ï¼šé¢‘ç¹çš„æœåŠ¡ä¸­æ–­å¯¼è‡´ç”¨æˆ·ä¿¡ä»»åº¦ä¸‹é™ï¼Œæœ€ç»ˆå¯¼è‡´ç”¨æˆ·æµå¤±</li><li><strong>å“ç‰Œè®¤çŸ¥</strong>ï¼šç³»ç»Ÿç¨³å®šæ€§ç›´æ¥å½±å“å“ç‰Œåœ¨ç”¨æˆ·å¿ƒä¸­çš„å¯é æ€§è®¤çŸ¥</li><li><strong>ä½¿ç”¨é»æ€§</strong>ï¼šä¸ç¨³å®šçš„æœåŠ¡ä½“éªŒä¼šé™ä½ç”¨æˆ·çš„ä½¿ç”¨é¢‘ç‡å’Œä¾èµ–åº¦</li></ul><h3 id="å•†ä¸šä»·å€¼å±‚é¢"><a href="#å•†ä¸šä»·å€¼å±‚é¢" class="headerlink" title="å•†ä¸šä»·å€¼å±‚é¢"></a>å•†ä¸šä»·å€¼å±‚é¢</h3><ul><li><strong>ç›´æ¥æ”¶å…¥æŸå¤±</strong>ï¼šæœåŠ¡ä¸­æ–­æœŸé—´çš„äº¤æ˜“æŸå¤±å’Œè®¢å•æµå¤±</li><li><strong>é—´æ¥æˆæœ¬å¢åŠ </strong>ï¼šå®¢æœå¤„ç†æŠ•è¯‰ã€æŠ€æœ¯å›¢é˜ŸåŠ ç­ä¿®å¤çš„äººåŠ›æˆæœ¬</li><li><strong>å¸‚åœºç«äº‰åŠ›</strong>ï¼šåœ¨åŒè´¨åŒ–ç«äº‰ä¸­ï¼Œç³»ç»Ÿç¨³å®šæ€§æˆä¸ºå…³é”®å·®å¼‚åŒ–ä¼˜åŠ¿</li><li><strong>åˆè§„é£é™©</strong>ï¼šå¯¹äºé‡‘èã€åŒ»ç–—ç­‰è¡Œä¸šï¼ŒæœåŠ¡ä¸­æ–­å¯èƒ½é¢ä¸´ç›‘ç®¡å¤„ç½š</li></ul><h3 id="æŠ€æœ¯å›¢é˜Ÿå½±å“"><a href="#æŠ€æœ¯å›¢é˜Ÿå½±å“" class="headerlink" title="æŠ€æœ¯å›¢é˜Ÿå½±å“"></a>æŠ€æœ¯å›¢é˜Ÿå½±å“</h3><ul><li><strong>ç ”å‘æ•ˆç‡</strong>ï¼šé¢‘ç¹çš„çº¿ä¸Šæ•…éšœæ‰“æ–­æ­£å¸¸çš„å¼€å‘èŠ‚å¥</li><li><strong>å›¢é˜Ÿå£«æ°”</strong>ï¼šé•¿æœŸçš„æ•…éšœå‹åŠ›å½±å“å›¢é˜Ÿçš„å·¥ä½œç§¯ææ€§</li><li><strong>æŠ€æœ¯å€ºåŠ¡</strong>ï¼šä¸ºå¿«é€Ÿä¿®å¤è€Œå¼•å…¥çš„ä¸´æ—¶æ–¹æ¡ˆå¯èƒ½ç´¯ç§¯æŠ€æœ¯å€ºåŠ¡</li></ul><p>å› æ­¤ï¼Œ<strong>æœåŠ¡å¯ç”¨æ€§æ˜¯æŠ€æœ¯å›¢é˜Ÿçš„æ ¸å¿ƒKPIä¹‹ä¸€ï¼Œéœ€è¦ä»ç»„ç»‡æ¶æ„ã€æŠ€æœ¯æ¶æ„ã€æµç¨‹è§„èŒƒç­‰å¤šä¸ªç»´åº¦è¿›è¡Œç³»ç»Ÿæ€§ä¿éšœ</strong>ã€‚</p><h2 id="æ•…éšœåˆ†ç±»ä¸æ ¹å› åˆ†æ"><a href="#æ•…éšœåˆ†ç±»ä¸æ ¹å› åˆ†æ" class="headerlink" title="æ•…éšœåˆ†ç±»ä¸æ ¹å› åˆ†æ"></a>æ•…éšœåˆ†ç±»ä¸æ ¹å› åˆ†æ</h2><p><img src="/images/sa_fail_type.png" alt="æ•…éšœç§ç±»"></p><p>æ ¹æ®æ•…éšœè§¦å‘æœºåˆ¶å’Œå½±å“èŒƒå›´ï¼Œç³»ç»Ÿæ•…éšœå¯åˆ†ä¸ºä»¥ä¸‹äº”ä¸ªä¸»è¦ç±»åˆ«ï¼š</p><h3 id="1-å˜æ›´ç±»æ•…éšœï¼ˆä¸»åŠ¨è§¦å‘ï¼‰"><a href="#1-å˜æ›´ç±»æ•…éšœï¼ˆä¸»åŠ¨è§¦å‘ï¼‰" class="headerlink" title="1. å˜æ›´ç±»æ•…éšœï¼ˆä¸»åŠ¨è§¦å‘ï¼‰"></a>1. å˜æ›´ç±»æ•…éšœï¼ˆä¸»åŠ¨è§¦å‘ï¼‰</h3><ul><li><strong>ä»£ç å‘å¸ƒ</strong>ï¼šæ–°åŠŸèƒ½ä¸Šçº¿å¼•å…¥çš„bugæˆ–å…¼å®¹æ€§é—®é¢˜</li><li><strong>é…ç½®å˜æ›´</strong>ï¼šæ•°æ®åº“é…ç½®ã€æœåŠ¡é…ç½®ä¿®æ”¹å¯¼è‡´çš„å¼‚å¸¸</li><li><strong>åŸºç¡€è®¾æ–½å˜æ›´</strong>ï¼šç½‘ç»œã€å­˜å‚¨ã€è®¡ç®—èµ„æºè°ƒæ•´å¼•èµ·çš„é—®é¢˜</li></ul><h3 id="2-å®¹é‡ç±»æ•…éšœï¼ˆè¢«åŠ¨è§¦å‘ï¼‰"><a href="#2-å®¹é‡ç±»æ•…éšœï¼ˆè¢«åŠ¨è§¦å‘ï¼‰" class="headerlink" title="2. å®¹é‡ç±»æ•…éšœï¼ˆè¢«åŠ¨è§¦å‘ï¼‰"></a>2. å®¹é‡ç±»æ•…éšœï¼ˆè¢«åŠ¨è§¦å‘ï¼‰</h3><ul><li><strong>æµé‡çªå¢</strong>ï¼šçªå‘æµé‡è¶…è¿‡ç³»ç»Ÿå¤„ç†èƒ½åŠ›</li><li><strong>èµ„æºä¸è¶³</strong>ï¼šCPUã€å†…å­˜ã€ç£ç›˜ã€ç½‘ç»œå¸¦å®½ç“¶é¢ˆ</li><li><strong>ä¾èµ–æœåŠ¡è¿‡è½½</strong>ï¼šä¸‹æ¸¸æœåŠ¡å“åº”å»¶è¿Ÿæˆ–æ‹’ç»æœåŠ¡</li></ul><h3 id="3-ä¾èµ–ç±»æ•…éšœï¼ˆå¤–éƒ¨å› ç´ ï¼‰"><a href="#3-ä¾èµ–ç±»æ•…éšœï¼ˆå¤–éƒ¨å› ç´ ï¼‰" class="headerlink" title="3. ä¾èµ–ç±»æ•…éšœï¼ˆå¤–éƒ¨å› ç´ ï¼‰"></a>3. ä¾èµ–ç±»æ•…éšœï¼ˆå¤–éƒ¨å› ç´ ï¼‰</h3><ul><li><strong>ç¬¬ä¸‰æ–¹æœåŠ¡å¼‚å¸¸</strong>ï¼šæ”¯ä»˜ã€çŸ­ä¿¡ã€CDNç­‰å¤–éƒ¨æœåŠ¡æ•…éšœ</li><li><strong>åŸºç¡€è®¾æ–½æ•…éšœ</strong>ï¼šäº‘æœåŠ¡å•†ã€IDCã€ç½‘ç»œè¿è¥å•†é—®é¢˜</li><li><strong>æ•°æ®åº“å¼‚å¸¸</strong>ï¼šä¸»ä»åˆ‡æ¢ã€è¿æ¥æ± è€—å°½ã€æ…¢æŸ¥è¯¢</li></ul><h3 id="4-ç¯å¢ƒç±»æ•…éšœï¼ˆä¸å¯æŠ—åŠ›ï¼‰"><a href="#4-ç¯å¢ƒç±»æ•…éšœï¼ˆä¸å¯æŠ—åŠ›ï¼‰" class="headerlink" title="4. ç¯å¢ƒç±»æ•…éšœï¼ˆä¸å¯æŠ—åŠ›ï¼‰"></a>4. ç¯å¢ƒç±»æ•…éšœï¼ˆä¸å¯æŠ—åŠ›ï¼‰</h3><ul><li><strong>ç¡¬ä»¶æ•…éšœ</strong>ï¼šæœåŠ¡å™¨ã€ç½‘ç»œè®¾å¤‡ã€å­˜å‚¨è®¾å¤‡æŸå</li><li><strong>è‡ªç„¶ç¾å®³</strong>ï¼šæœºæˆ¿æ–­ç”µã€ç½‘ç»œä¸­æ–­ã€åœ°éœ‡ç­‰æç«¯æƒ…å†µ</li></ul><h3 id="5-äººä¸ºç±»æ•…éšœï¼ˆæ“ä½œå¤±è¯¯ï¼‰"><a href="#5-äººä¸ºç±»æ•…éšœï¼ˆæ“ä½œå¤±è¯¯ï¼‰" class="headerlink" title="5. äººä¸ºç±»æ•…éšœï¼ˆæ“ä½œå¤±è¯¯ï¼‰"></a>5. äººä¸ºç±»æ•…éšœï¼ˆæ“ä½œå¤±è¯¯ï¼‰</h3><ul><li><strong>è¯¯æ“ä½œ</strong>ï¼šé”™è¯¯çš„è¿ç»´å‘½ä»¤ã€æ•°æ®è¯¯åˆ é™¤</li><li><strong>æƒé™é—®é¢˜</strong>ï¼šè®¿é—®æ§åˆ¶é…ç½®é”™è¯¯</li><li><strong>æµç¨‹è¿è§„</strong>ï¼šæœªç»æµ‹è¯•çš„ç´§æ€¥ä¸Šçº¿</li></ul><p><strong>æ•…éšœé¢„é˜²ç­–ç•¥ï¼š</strong> å˜æ›´ç±»æ•…éšœå¯é€šè¿‡å®Œå–„çš„CI&#x2F;CDæµç¨‹å’Œç°åº¦å‘å¸ƒæœºåˆ¶é¢„é˜²ï¼›å…¶ä»–ç±»å‹æ•…éšœéœ€è¦é€šè¿‡ç›‘æ§å‘Šè­¦ã€å®¹é‡è§„åˆ’ã€å®¹é”™è®¾è®¡ç­‰æ‰‹æ®µé™ä½å½±å“ã€‚</p><h1 id="å¯ç”¨æ€§åº¦é‡ä½“ç³»"><a href="#å¯ç”¨æ€§åº¦é‡ä½“ç³»" class="headerlink" title="å¯ç”¨æ€§åº¦é‡ä½“ç³»"></a>å¯ç”¨æ€§åº¦é‡ä½“ç³»</h1><p><img src="/images/sa_formula.png" alt="å¯ç”¨æ€§è¡¡é‡"></p><h2 id="MTTRç»†åŒ–åˆ†è§£"><a href="#MTTRç»†åŒ–åˆ†è§£" class="headerlink" title="MTTRç»†åŒ–åˆ†è§£"></a>MTTRç»†åŒ–åˆ†è§£</h2><p>å¹³å‡æ•…éšœä¿®å¤æ—¶é—´(MTTR)æ˜¯å¯ç”¨æ€§ä¼˜åŒ–çš„æ ¸å¿ƒæŒ‡æ ‡ï¼Œå¯è¿›ä¸€æ­¥åˆ†è§£ä¸ºä¸‰ä¸ªå­é˜¶æ®µï¼š</p><h3 id="MTTI-Mean-Time-To-Identify-æ•…éšœå‘ç°æ—¶é—´"><a href="#MTTI-Mean-Time-To-Identify-æ•…éšœå‘ç°æ—¶é—´" class="headerlink" title="MTTI (Mean Time To Identify) - æ•…éšœå‘ç°æ—¶é—´"></a>MTTI (Mean Time To Identify) - æ•…éšœå‘ç°æ—¶é—´</h3><p><strong>å®šä¹‰ï¼š</strong> ä»æ•…éšœå‘ç”Ÿåˆ°è¢«ç›‘æ§ç³»ç»Ÿæˆ–äººå‘˜å‘ç°çš„å¹³å‡æ—¶é—´</p><p><strong>å½±å“å› ç´ ï¼š</strong></p><ul><li>ç›‘æ§è¦†ç›–åº¦å’Œå‘Šè­¦ç­–ç•¥çš„å®Œå–„ç¨‹åº¦</li><li>å‘Šè­¦é˜ˆå€¼è®¾ç½®çš„åˆç†æ€§</li><li>å¤šæ¸ é“æ•…éšœå‘ç°æœºåˆ¶ï¼ˆå†…éƒ¨ç›‘æ§ã€ç”¨æˆ·åé¦ˆã€èˆ†æƒ…ç›‘æ§ï¼‰</li></ul><p><strong>ä¼˜åŒ–æ–¹å‘ï¼š</strong></p><ul><li>å»ºç«‹ç«‹ä½“åŒ–ç›‘æ§ä½“ç³»ï¼ˆåŸºç¡€è®¾æ–½ã€åº”ç”¨ã€ä¸šåŠ¡æŒ‡æ ‡ï¼‰</li><li>å®ç°æ™ºèƒ½å‘Šè­¦ï¼Œå‡å°‘è¯¯æŠ¥å’Œæ¼æŠ¥</li><li>å»ºç«‹ç”¨æˆ·åé¦ˆå¿«é€Ÿå“åº”æœºåˆ¶</li></ul><h3 id="MTTK-Mean-Time-To-Know-æ•…éšœå®šä½æ—¶é—´"><a href="#MTTK-Mean-Time-To-Know-æ•…éšœå®šä½æ—¶é—´" class="headerlink" title="MTTK (Mean Time To Know) - æ•…éšœå®šä½æ—¶é—´"></a>MTTK (Mean Time To Know) - æ•…éšœå®šä½æ—¶é—´</h3><p><strong>å®šä¹‰ï¼š</strong> ä»æ•…éšœè¢«å‘ç°åˆ°ç¡®å®šæ ¹æœ¬åŸå› çš„å¹³å‡æ—¶é—´</p><p><strong>åŒ…å«ç¯èŠ‚ï¼š</strong></p><ul><li>æ•…éšœåˆ†çº§å’Œè´£ä»»äººç¡®å®š</li><li>ä¸šåŠ¡å½±å“èŒƒå›´è¯„ä¼°</li><li>æŠ€æœ¯æ ¹å› åˆ†æå’Œå®šä½</li></ul><p><strong>ä¼˜åŒ–æ–¹å‘ï¼š</strong></p><ul><li>å®Œå–„æ•…éšœå“åº”æµç¨‹å’Œè´£ä»»çŸ©é˜µ</li><li>å»ºè®¾åˆ†å¸ƒå¼é“¾è·¯è¿½è¸ªå’Œæ—¥å¿—èšåˆç³»ç»Ÿ</li><li>æ„å»ºæ•…éšœçŸ¥è¯†åº“å’Œè¯Šæ–­å·¥å…·</li></ul><h3 id="MTTS-Mean-Time-To-Solve-æ•…éšœè§£å†³æ—¶é—´"><a href="#MTTS-Mean-Time-To-Solve-æ•…éšœè§£å†³æ—¶é—´" class="headerlink" title="MTTS (Mean Time To Solve) - æ•…éšœè§£å†³æ—¶é—´"></a>MTTS (Mean Time To Solve) - æ•…éšœè§£å†³æ—¶é—´</h3><p><strong>å®šä¹‰ï¼š</strong> ä»ç¡®å®šæ•…éšœåŸå› åˆ°å®Œå…¨ä¿®å¤å¹¶éªŒè¯çš„å¹³å‡æ—¶é—´</p><p><strong>å…³é”®ç¯èŠ‚ï¼š</strong></p><ul><li>ä¿®å¤æ–¹æ¡ˆåˆ¶å®šå’Œè¯„ä¼°</li><li>ä»£ç ä¿®å¤æˆ–é…ç½®è°ƒæ•´</li><li>å‘å¸ƒéƒ¨ç½²å’Œæ•ˆæœéªŒè¯</li></ul><p><strong>ä¼˜åŒ–æ–¹å‘ï¼š</strong></p><ul><li>å»ºç«‹å¿«é€Ÿå›æ»šå’Œçƒ­ä¿®å¤æœºåˆ¶</li><li>å®Œå–„è‡ªåŠ¨åŒ–éƒ¨ç½²å’ŒéªŒè¯æµç¨‹</li><li>é¢„æ¡ˆåº“å»ºè®¾å’Œæ¼”ç»ƒ</li></ul><p><img src="/images/sa_mttr_detail.png" alt="MTTRç»†èŠ‚"></p><p><strong>å…¬å¼å…³ç³»ï¼š</strong> MTTR &#x3D; MTTI + MTTK + MTTSï¼Œä¼˜åŒ–ä»»ä¸€ç¯èŠ‚éƒ½èƒ½æå‡æ•´ä½“å¯ç”¨æ€§ã€‚</p><h2 id="å¯ç”¨æ€§æå‡ç­–ç•¥"><a href="#å¯ç”¨æ€§æå‡ç­–ç•¥" class="headerlink" title="å¯ç”¨æ€§æå‡ç­–ç•¥"></a>å¯ç”¨æ€§æå‡ç­–ç•¥</h2><p>åŸºäºå¯ç”¨æ€§é‡åŒ–å…¬å¼åˆ†æï¼Œæå‡ç³»ç»Ÿå¯ç”¨æ€§å­˜åœ¨ä¸¤ä¸ªæ ¸å¿ƒä¼˜åŒ–æ–¹å‘ï¼š</p><h3 id="æˆ˜ç•¥ç›®æ ‡"><a href="#æˆ˜ç•¥ç›®æ ‡" class="headerlink" title="æˆ˜ç•¥ç›®æ ‡"></a>æˆ˜ç•¥ç›®æ ‡</h3><ol><li><strong>å¢åŠ MTTF</strong>ï¼šé€šè¿‡é¢„é˜²æ€§æªæ–½å‡å°‘æ•…éšœå‘ç”Ÿé¢‘ç‡</li><li><strong>ç¼©çŸ­MTTR</strong>ï¼šé€šè¿‡å¿«é€Ÿå“åº”æœºåˆ¶å‡å°‘æ•…éšœæ¢å¤æ—¶é—´</li></ol><h3 id="å…·ä½“å®æ–½è·¯å¾„"><a href="#å…·ä½“å®æ–½è·¯å¾„" class="headerlink" title="å…·ä½“å®æ–½è·¯å¾„"></a>å…·ä½“å®æ–½è·¯å¾„</h3><ul><li><strong>æ•…éšœé¢„é˜²</strong>ï¼šä»æºå¤´å‡å°‘æ•…éšœæ•°é‡ï¼Œæé«˜ç³»ç»Ÿç¨³å®šæ€§</li><li><strong>å¿«é€Ÿå‘ç°</strong>ï¼šç¼©çŸ­MTTIï¼Œå®ç°æ•…éšœçš„ç§’çº§æ„ŸçŸ¥</li><li><strong>é«˜æ•ˆå®šä½</strong>ï¼šç¼©çŸ­MTTKï¼Œå¿«é€Ÿç¡®å®šæ•…éšœæ ¹å› </li><li><strong>æ•æ·ä¿®å¤</strong>ï¼šç¼©çŸ­MTTSï¼Œå®ç°æ•…éšœçš„å¿«é€Ÿæ¢å¤</li></ul><p><img src="/images/sa_pre_handle_fail_and_fail_identify_solve.png" alt="æå‡å¯ç”¨æ€§"></p><h3 id="å…¨ç”Ÿå‘½å‘¨æœŸä¿éšœä½“ç³»"><a href="#å…¨ç”Ÿå‘½å‘¨æœŸä¿éšœä½“ç³»" class="headerlink" title="å…¨ç”Ÿå‘½å‘¨æœŸä¿éšœä½“ç³»"></a>å…¨ç”Ÿå‘½å‘¨æœŸä¿éšœä½“ç³»</h3><p>ç»“åˆè½¯ä»¶ç ”å‘ç”Ÿå‘½å‘¨æœŸï¼Œå»ºç«‹**â€äº‹å‰é¢„é˜²ã€äº‹ä¸­å“åº”ã€äº‹åæ”¹è¿›â€**çš„ä¸‰é˜¶æ®µå¯ç”¨æ€§ä¿éšœä½“ç³»ï¼š</p><ul><li><strong>äº‹å‰é˜¶æ®µ</strong>ï¼šé€šè¿‡æ¶æ„è®¾è®¡ã€ä»£ç è´¨é‡ã€æµ‹è¯•éªŒè¯ç­‰æ‰‹æ®µé¢„é˜²æ•…éšœ</li><li><strong>äº‹ä¸­é˜¶æ®µ</strong>ï¼šé€šè¿‡ç›‘æ§å‘Šè­¦ã€å¿«é€Ÿå“åº”ã€åº”æ€¥å¤„ç½®ç­‰æ‰‹æ®µå¿«é€Ÿæ¢å¤</li><li><strong>äº‹åé˜¶æ®µ</strong>ï¼šé€šè¿‡æ•…éšœå¤ç›˜ã€æ ¹å› åˆ†æã€æµç¨‹æ”¹è¿›ç­‰æ‰‹æ®µé¿å…é‡å¤</li></ul><h3 id="äº‹å‰é¢„é˜²ï¼šæ„å»ºé«˜å¯ç”¨æ¶æ„åŸºç¡€"><a href="#äº‹å‰é¢„é˜²ï¼šæ„å»ºé«˜å¯ç”¨æ¶æ„åŸºç¡€" class="headerlink" title="äº‹å‰é¢„é˜²ï¼šæ„å»ºé«˜å¯ç”¨æ¶æ„åŸºç¡€"></a>äº‹å‰é¢„é˜²ï¼šæ„å»ºé«˜å¯ç”¨æ¶æ„åŸºç¡€</h3><p><img src="/images/sa_pre_online.png" alt="ä¸Šçº¿å‰ + ä¸Šçº¿ä¸­"></p><h4 id="1-ä»£ç è´¨é‡ä¿éšœ"><a href="#1-ä»£ç è´¨é‡ä¿éšœ" class="headerlink" title="1. ä»£ç è´¨é‡ä¿éšœ"></a>1. ä»£ç è´¨é‡ä¿éšœ</h4><p><strong>é™æ€ä»£ç åˆ†æï¼š</strong></p><ul><li>å»ºç«‹ç»Ÿä¸€çš„ç¼–ç è§„èŒƒå’Œæœ€ä½³å®è·µ</li><li>é›†æˆSonarQubeç­‰å·¥å…·è¿›è¡Œä»£ç è´¨é‡é—¨ç¦</li><li>é…ç½®ESLintã€Checkstyleç­‰é™æ€æ£€æŸ¥å·¥å…·</li></ul><p><strong>Code Reviewæœºåˆ¶ï¼š</strong></p><ul><li>å¼ºåˆ¶ä»£ç å®¡æŸ¥ï¼Œè‡³å°‘éœ€è¦ä¸€ä½èµ„æ·±å·¥ç¨‹å¸ˆæ‰¹å‡†</li><li>é‡ç‚¹å…³æ³¨å¼‚å¸¸å¤„ç†ã€èµ„æºé‡Šæ”¾ã€å¹¶å‘å®‰å…¨ç­‰å…³é”®é€»è¾‘</li><li>å»ºç«‹Review Checklistï¼Œç¡®ä¿å®¡æŸ¥æ ‡å‡†åŒ–</li></ul><h4 id="2-é«˜å¯ç”¨æ¶æ„è®¾è®¡"><a href="#2-é«˜å¯ç”¨æ¶æ„è®¾è®¡" class="headerlink" title="2. é«˜å¯ç”¨æ¶æ„è®¾è®¡"></a>2. é«˜å¯ç”¨æ¶æ„è®¾è®¡</h4><p><strong>ç³»ç»Ÿè§£è€¦ï¼š</strong></p><ul><li><strong>å¼‚æ­¥å¤„ç†</strong>ï¼šé‡‡ç”¨æ¶ˆæ¯é˜Ÿåˆ—(Kafka&#x2F;RabbitMQ)å®ç°ç³»ç»Ÿé—´è§£è€¦</li><li><strong>å‰Šå³°å¡«è°·</strong>ï¼šé€šè¿‡ç¼“å†²æœºåˆ¶å¹³æ»‘æµé‡æ³¢åŠ¨</li><li><strong>æœåŠ¡æ‹†åˆ†</strong>ï¼šæŒ‰ä¸šåŠ¡åŸŸè¿›è¡Œå¾®æœåŠ¡æ‹†åˆ†ï¼Œé¿å…å•ç‚¹æ•…éšœ</li></ul><p><strong>å¯æ‰©å±•æ€§è®¾è®¡ï¼š</strong></p><ul><li><strong>æ— çŠ¶æ€åŒ–</strong>ï¼šåº”ç”¨å±‚æ— çŠ¶æ€ï¼Œæ”¯æŒæ°´å¹³æ‰©å±•</li><li><strong>åˆ†å±‚æ¶æ„</strong>ï¼šæ¸…æ™°çš„åˆ†å±‚è®¾è®¡ï¼Œä¾¿äºå±€éƒ¨ä¼˜åŒ–å’Œæ•…éšœéš”ç¦»</li><li><strong>æ•°æ®åˆ†ç‰‡</strong>ï¼šæ•°æ®åº“åˆ†åº“åˆ†è¡¨ï¼Œé¿å…å•åº“æˆä¸ºç“¶é¢ˆ</li></ul><h4 id="3-å®¹é”™æœºåˆ¶è®¾è®¡"><a href="#3-å®¹é”™æœºåˆ¶è®¾è®¡" class="headerlink" title="3. å®¹é”™æœºåˆ¶è®¾è®¡"></a>3. å®¹é”™æœºåˆ¶è®¾è®¡</h4><p><strong>æµé‡æ§åˆ¶ï¼š</strong></p><ul><li><strong>é™æµ</strong>ï¼šåŸºäºä»¤ç‰Œæ¡¶&#x2F;æ¼æ¡¶ç®—æ³•å®ç°æ¥å£çº§é™æµ</li><li><strong>ç†”æ–­</strong>ï¼šCircuit Breakeræ¨¡å¼ï¼Œå¿«é€Ÿå¤±è´¥é¿å…é›ªå´©</li><li><strong>é™çº§</strong>ï¼šæ ¸å¿ƒåŠŸèƒ½ä¼˜å…ˆï¼Œéæ ¸å¿ƒåŠŸèƒ½å¯é™çº§å¤„ç†</li></ul><p><strong>é‡è¯•ä¸éš”ç¦»ï¼š</strong></p><ul><li><strong>æ™ºèƒ½é‡è¯•</strong>ï¼šæŒ‡æ•°é€€é¿ç®—æ³•ï¼Œé¿å…é‡è¯•é£æš´</li><li><strong>èµ„æºéš”ç¦»</strong>ï¼šçº¿ç¨‹æ± ã€è¿æ¥æ± éš”ç¦»ï¼Œé¿å…ç›¸äº’å½±å“</li><li><strong>æ•…éšœéš”ç¦»</strong>ï¼šæ•…éšœåŸŸéš”ç¦»ï¼Œé¿å…æ•…éšœæ‰©æ•£</li></ul><p><strong>å…¼å®¹æ€§ä¿éšœï¼š</strong></p><ul><li><strong>å‘å‰å…¼å®¹</strong>ï¼šAPIç‰ˆæœ¬åŒ–ç®¡ç†ï¼Œä¿è¯å†å²ç‰ˆæœ¬å¯ç”¨</li><li><strong>ç°åº¦å…¼å®¹</strong>ï¼šæ–°è€ç‰ˆæœ¬å¹¶å­˜æœŸé—´çš„å…¼å®¹æ€§å¤„ç†</li></ul><blockquote><p>å…·ä½“çš„æŠ€æœ¯å®ç°å’Œæ¶æ„è®¾è®¡è¯¦è§ç³»åˆ—ç¬¬äºŒç¯‡ï¼š<a href="https://codingwhat.github.io/2024/07/17/service-high-available-governance/">ã€ŠæœåŠ¡é«˜å¯ç”¨æ²»ç†ç³»åˆ—ï¼ˆäºŒï¼‰ï¼šæŠ€æœ¯å®ç°ä¸æ¶æ„è®¾è®¡å®æˆ˜ã€‹</a></p></blockquote><h4 id="4-å®¹é‡è§„åˆ’ä¸è¯„ä¼°"><a href="#4-å®¹é‡è§„åˆ’ä¸è¯„ä¼°" class="headerlink" title="4. å®¹é‡è§„åˆ’ä¸è¯„ä¼°"></a>4. å®¹é‡è§„åˆ’ä¸è¯„ä¼°</h4><p><strong>æµé‡é¢„æµ‹ï¼š</strong></p><ul><li><strong>å†å²æ•°æ®åˆ†æ</strong>ï¼šåŸºäºå†å²æµé‡æ¨¡å¼è¿›è¡Œè¶‹åŠ¿é¢„æµ‹</li><li><strong>ä¸šåŠ¡æ´»åŠ¨è¯„ä¼°</strong>ï¼šæå‰è¯†åˆ«è¥é”€æ´»åŠ¨ã€èŠ‚å‡æ—¥ç­‰æµé‡å³°å€¼</li><li><strong>å®¹é‡å»ºæ¨¡</strong>ï¼šå»ºç«‹å®¹é‡æ¨¡å‹ï¼Œé‡åŒ–èµ„æºéœ€æ±‚</li></ul><p><strong>å¼¹æ€§ä¼¸ç¼©ï¼š</strong></p><ul><li><strong>æ°´å¹³æ‰©å±•</strong>ï¼šåŸºäºCPUã€å†…å­˜ã€QPSç­‰æŒ‡æ ‡è‡ªåŠ¨æ‰©ç¼©å®¹</li><li><strong>å‚ç›´æ‰©å±•</strong>ï¼šå•æœºèµ„æºçš„åŠ¨æ€è°ƒæ•´</li><li><strong>é¢„ç•™ç¼“å†²</strong>ï¼šä¿æŒ20-30%çš„å®¹é‡bufferåº”å¯¹çªå‘æµé‡</li></ul><h4 id="5-æµ‹è¯•éªŒè¯ä½“ç³»"><a href="#5-æµ‹è¯•éªŒè¯ä½“ç³»" class="headerlink" title="5. æµ‹è¯•éªŒè¯ä½“ç³»"></a>5. æµ‹è¯•éªŒè¯ä½“ç³»</h4><p><strong>æµ‹è¯•é‡‘å­—å¡”ï¼š</strong></p><ul><li><strong>å•å…ƒæµ‹è¯•</strong>ï¼šè¦†ç›–ç‡&gt;80%ï¼Œä¿è¯æ ¸å¿ƒé€»è¾‘æ­£ç¡®æ€§</li><li><strong>é›†æˆæµ‹è¯•</strong>ï¼šéªŒè¯æœåŠ¡é—´åä½œçš„æ­£ç¡®æ€§</li><li><strong>ç«¯åˆ°ç«¯æµ‹è¯•</strong>ï¼šæ¨¡æ‹ŸçœŸå®ç”¨æˆ·åœºæ™¯è¿›è¡ŒåŠŸèƒ½éªŒè¯</li></ul><p><strong>ä¸“é¡¹æµ‹è¯•ï¼š</strong></p><ul><li><strong>æ€§èƒ½æµ‹è¯•</strong>ï¼šè´Ÿè½½æµ‹è¯•ã€å‹åŠ›æµ‹è¯•ã€ç¨³å®šæ€§æµ‹è¯•</li><li><strong>å…¼å®¹æ€§æµ‹è¯•</strong>ï¼šè·¨ç‰ˆæœ¬ã€è·¨å¹³å°ã€è·¨æµè§ˆå™¨å…¼å®¹æ€§</li><li><strong>æ··æ²Œå·¥ç¨‹</strong>ï¼šä¸»åŠ¨æ³¨å…¥æ•…éšœï¼ŒéªŒè¯ç³»ç»Ÿå®¹é”™èƒ½åŠ›</li></ul><h4 id="6-å˜æ›´ç®¡æ§æœºåˆ¶"><a href="#6-å˜æ›´ç®¡æ§æœºåˆ¶" class="headerlink" title="6. å˜æ›´ç®¡æ§æœºåˆ¶"></a>6. å˜æ›´ç®¡æ§æœºåˆ¶</h4><p><strong>å‘å¸ƒç­–ç•¥ï¼š</strong></p><ul><li><strong>è“ç»¿éƒ¨ç½²</strong>ï¼šæ— ç¼åˆ‡æ¢ï¼Œå¿«é€Ÿå›æ»š</li><li><strong>é‡‘ä¸é›€å‘å¸ƒ</strong>ï¼šå°æµé‡éªŒè¯ï¼Œé€æ­¥æ”¾é‡</li><li><strong>åˆ†æ‰¹å‘å¸ƒ</strong>ï¼šæŒ‰æœºæˆ¿ã€æŒ‰æ¯”ä¾‹åˆ†æ‰¹å‘å¸ƒ</li></ul><p><strong>ä¸‰é¡¹åŸºæœ¬åŸåˆ™ï¼š</strong></p><ul><li><strong>å¯ç›‘æ§</strong>ï¼šå®æ—¶ç›‘æ§å…³é”®æŒ‡æ ‡ï¼ŒåŠæ—¶å‘ç°å¼‚å¸¸</li><li><strong>å¯ç°åº¦</strong>ï¼šæ”¯æŒç°åº¦å‘å¸ƒï¼Œæ§åˆ¶å½±å“èŒƒå›´</li><li><strong>å¯å›æ»š</strong>ï¼šä¸€é”®å›æ»šæœºåˆ¶ï¼Œå¿«é€Ÿæ¢å¤æœåŠ¡</li></ul><h3 id="äº‹ä¸­å“åº”ï¼šå¿«é€Ÿæ•…éšœå¤„ç½®æœºåˆ¶"><a href="#äº‹ä¸­å“åº”ï¼šå¿«é€Ÿæ•…éšœå¤„ç½®æœºåˆ¶" class="headerlink" title="äº‹ä¸­å“åº”ï¼šå¿«é€Ÿæ•…éšœå¤„ç½®æœºåˆ¶"></a>äº‹ä¸­å“åº”ï¼šå¿«é€Ÿæ•…éšœå¤„ç½®æœºåˆ¶</h3><p><img src="/images/sa_fail_identify.png" alt="æ•…éšœç›‘æµ‹"></p><h4 id="1-æ•…éšœå‘ç°æœºåˆ¶-MTTIä¼˜åŒ–"><a href="#1-æ•…éšœå‘ç°æœºåˆ¶-MTTIä¼˜åŒ–" class="headerlink" title="1. æ•…éšœå‘ç°æœºåˆ¶ (MTTIä¼˜åŒ–)"></a>1. æ•…éšœå‘ç°æœºåˆ¶ (MTTIä¼˜åŒ–)</h4><p><strong>å†…éƒ¨ç›‘æ§ä½“ç³»ï¼š</strong></p><ul><li><strong>åŸºç¡€è®¾æ–½ç›‘æ§</strong>ï¼šCPUã€å†…å­˜ã€ç£ç›˜ã€ç½‘ç»œç­‰èµ„æºæŒ‡æ ‡</li><li><strong>åº”ç”¨å±‚ç›‘æ§</strong>ï¼šQPSã€å“åº”æ—¶é—´ã€é”™è¯¯ç‡ã€çº¿ç¨‹æ± çŠ¶æ€</li><li><strong>ä¸šåŠ¡æŒ‡æ ‡ç›‘æ§</strong>ï¼šè®¢å•é‡ã€æ”¯ä»˜æˆåŠŸç‡ã€ç”¨æˆ·æ´»è·ƒåº¦ç­‰æ ¸å¿ƒä¸šåŠ¡æŒ‡æ ‡</li><li><strong>æ—¥å¿—ç›‘æ§</strong>ï¼šé”™è¯¯æ—¥å¿—ã€å¼‚å¸¸å †æ ˆçš„å®æ—¶åˆ†æ</li></ul><p><strong>å¤–éƒ¨æ„ŸçŸ¥æ¸ é“ï¼š</strong></p><ul><li><strong>ç”¨æˆ·åé¦ˆ</strong>ï¼šå®¢æœç³»ç»Ÿã€åé¦ˆå¹³å°çš„å®æ—¶ç›‘æ§</li><li><strong>èˆ†æƒ…ç›‘æ§</strong>ï¼šç¤¾äº¤åª’ä½“ã€æ–°é—»åª’ä½“çš„è´Ÿé¢ä¿¡æ¯ç›‘æ§</li><li><strong>ç¬¬ä¸‰æ–¹ç›‘æ§</strong>ï¼šå¤–éƒ¨æ‹¨æµ‹ã€ç”¨æˆ·è¡Œä¸ºåˆ†æ</li></ul><h4 id="2-æ•…éšœå®šä½æœºåˆ¶-MTTKä¼˜åŒ–"><a href="#2-æ•…éšœå®šä½æœºåˆ¶-MTTKä¼˜åŒ–" class="headerlink" title="2. æ•…éšœå®šä½æœºåˆ¶ (MTTKä¼˜åŒ–)"></a>2. æ•…éšœå®šä½æœºåˆ¶ (MTTKä¼˜åŒ–)</h4><p><strong>å¯è§‚æµ‹æ€§ä¸‰è¦ç´ ï¼š</strong></p><ul><li><strong>Metrics</strong>ï¼šæ—¶é—´åºåˆ—æŒ‡æ ‡ï¼Œå¿«é€Ÿå®šä½æ€§èƒ½é—®é¢˜</li><li><strong>Logging</strong>ï¼šç»“æ„åŒ–æ—¥å¿—ï¼Œè¯¦ç»†è®°å½•è¯·æ±‚å¤„ç†è¿‡ç¨‹</li><li><strong>Tracing</strong>ï¼šåˆ†å¸ƒå¼é“¾è·¯è¿½è¸ªï¼Œç«¯åˆ°ç«¯è¯·æ±‚é“¾è·¯å¯è§†åŒ–</li></ul><h4 id="3-æ•…éšœå¤„ç½®æœºåˆ¶-MTTSä¼˜åŒ–"><a href="#3-æ•…éšœå¤„ç½®æœºåˆ¶-MTTSä¼˜åŒ–" class="headerlink" title="3. æ•…éšœå¤„ç½®æœºåˆ¶ (MTTSä¼˜åŒ–)"></a>3. æ•…éšœå¤„ç½®æœºåˆ¶ (MTTSä¼˜åŒ–)</h4><p><img src="/images/sa_fail_solve.png" alt="æ•…éšœè§£å†³"></p><p><strong>åº”æ€¥å“åº”ç­–ç•¥ï¼š</strong></p><ul><li><strong>å›æ»š</strong>ï¼šä¸€é”®å›æ»šåˆ°æœ€è¿‘ç¨³å®šç‰ˆæœ¬</li><li><strong>ä¸‹çº¿</strong>ï¼šæ‘˜é™¤æ•…éšœèŠ‚ç‚¹ï¼Œé¿å…å½±å“æ•´ä½“æœåŠ¡</li><li><strong>æ‰©å®¹</strong>ï¼šæ°´å¹³æ‰©å±•è®¡ç®—èµ„æºï¼Œåº”å¯¹æµé‡æ´ªå³°</li><li><strong>åˆ‡æ¢</strong>ï¼šä¸»å¤‡åˆ‡æ¢ã€å¤šæœºæˆ¿å®¹ç¾åˆ‡æ¢</li><li><strong>é™æµ</strong>ï¼šåŸºäºæœåŠ¡ã€æ¥å£ã€ç”¨æˆ·ç­‰ç»´åº¦çš„ç²¾ç»†åŒ–é™æµ</li><li><strong>ç†”æ–­</strong>ï¼šè‡ªåŠ¨æˆ–æ‰‹åŠ¨ç†”æ–­å¼‚å¸¸ä¾èµ–ï¼Œé˜²æ­¢æ•…éšœä¼ æ’­</li><li><strong>é™çº§</strong>ï¼šå…³é—­éæ ¸å¿ƒåŠŸèƒ½ï¼Œä¿éšœæ ¸å¿ƒä¸šåŠ¡æ­£å¸¸è¿è¡Œ</li><li><strong>çƒ­ä¿®å¤</strong>ï¼šåœ¨çº¿ä»£ç ä¿®å¤ï¼Œæ— éœ€é‡å¯æœåŠ¡</li></ul><h3 id="äº‹åæ”¹è¿›ï¼šæ•…éšœå¤ç›˜ä¸æŒç»­ä¼˜åŒ–"><a href="#äº‹åæ”¹è¿›ï¼šæ•…éšœå¤ç›˜ä¸æŒç»­ä¼˜åŒ–" class="headerlink" title="äº‹åæ”¹è¿›ï¼šæ•…éšœå¤ç›˜ä¸æŒç»­ä¼˜åŒ–"></a>äº‹åæ”¹è¿›ï¼šæ•…éšœå¤ç›˜ä¸æŒç»­ä¼˜åŒ–</h3><h4 id="1-æ•…éšœå¤ç›˜æµç¨‹"><a href="#1-æ•…éšœå¤ç›˜æµç¨‹" class="headerlink" title="1. æ•…éšœå¤ç›˜æµç¨‹"></a>1. æ•…éšœå¤ç›˜æµç¨‹</h4><p><strong>æ—¶é—´çº¿é‡å»ºï¼š</strong></p><ul><li><strong>æ•…éšœå‘ç”Ÿæ—¶é—´</strong>ï¼šç²¾ç¡®åˆ°åˆ†é’Ÿçº§çš„æ•…éšœæ—¶é—´çº¿</li><li><strong>å…³é”®æ“ä½œè®°å½•</strong>ï¼šæ¯ä¸ªå¤„ç½®åŠ¨ä½œçš„æ—¶é—´ç‚¹å’Œè´Ÿè´£äºº</li><li><strong>å½±å“èŒƒå›´è¯„ä¼°</strong>ï¼šç”¨æˆ·å½±å“æ•°é‡ã€ä¸šåŠ¡æŸå¤±é‡åŒ–</li><li><strong>æ¢å¤æ—¶é—´èŠ‚ç‚¹</strong>ï¼šå„é˜¶æ®µæ¢å¤æƒ…å†µçš„è¯¦ç»†è®°å½•</li></ul><p><strong>æ ¹å› åˆ†æ (5 Whysæ–¹æ³•)ï¼š</strong></p><ul><li><strong>è¡¨é¢ç°è±¡</strong>ï¼šç”¨æˆ·çœ‹åˆ°çš„æ•…éšœè¡¨ç°</li><li><strong>ç›´æ¥åŸå› </strong>ï¼šå¯¼è‡´æ•…éšœçš„ç›´æ¥æŠ€æœ¯åŸå› </li><li><strong>æ ¹æœ¬åŸå› </strong>ï¼šä¸ºä»€ä¹ˆä¼šå‘ç”Ÿè¿™ä¸ªæŠ€æœ¯åŸå› </li><li><strong>ç®¡ç†åŸå› </strong>ï¼šæµç¨‹ã€åˆ¶åº¦ã€å·¥å…·å±‚é¢çš„ç¼ºå¤±</li><li><strong>æ–‡åŒ–åŸå› </strong>ï¼šç»„ç»‡å’Œæ–‡åŒ–å±‚é¢çš„æ·±å±‚æ¬¡é—®é¢˜</li></ul><h4 id="2-çŸ¥è¯†æ²‰æ·€ä¸ä¼ æ‰¿"><a href="#2-çŸ¥è¯†æ²‰æ·€ä¸ä¼ æ‰¿" class="headerlink" title="2. çŸ¥è¯†æ²‰æ·€ä¸ä¼ æ‰¿"></a>2. çŸ¥è¯†æ²‰æ·€ä¸ä¼ æ‰¿</h4><p><strong>æ–‡æ¡£æ²‰æ·€ï¼š</strong></p><ul><li><strong>æ•…éšœæ¡ˆä¾‹åº“</strong>ï¼šå…¸å‹æ•…éšœæ¡ˆä¾‹å’Œå¤„ç†ç»éªŒ</li><li><strong>åº”æ€¥é¢„æ¡ˆ</strong>ï¼šä¸åŒç±»å‹æ•…éšœçš„æ ‡å‡†å¤„ç½®æµç¨‹</li><li><strong>æŠ€æœ¯æ–¹æ¡ˆåº“</strong>ï¼šç»è¿‡éªŒè¯çš„æŠ€æœ¯è§£å†³æ–¹æ¡ˆ</li><li><strong>æœ€ä½³å®è·µ</strong>ï¼šå›¢é˜Ÿåœ¨å®è·µä¸­æ€»ç»“çš„æœ€ä½³å®è·µ</li></ul><p><img src="/images/sa_process.png" alt="ç¨³å®šæ€§å„ç¯èŠ‚"></p><h1 id="æœåŠ¡è´¨é‡æŒ‡æ ‡ä½“ç³»ä¸SREå®è·µ"><a href="#æœåŠ¡è´¨é‡æŒ‡æ ‡ä½“ç³»ä¸SREå®è·µ" class="headerlink" title="æœåŠ¡è´¨é‡æŒ‡æ ‡ä½“ç³»ä¸SREå®è·µ"></a>æœåŠ¡è´¨é‡æŒ‡æ ‡ä½“ç³»ä¸SREå®è·µ</h1><h2 id="SLA-SLO-SLIä¸‰è¦ç´ "><a href="#SLA-SLO-SLIä¸‰è¦ç´ " class="headerlink" title="SLA&#x2F;SLO&#x2F;SLIä¸‰è¦ç´ "></a>SLA&#x2F;SLO&#x2F;SLIä¸‰è¦ç´ </h2><p>åœ¨ç°ä»£SRE(Site Reliability Engineering)å®è·µä¸­ï¼ŒæœåŠ¡è´¨é‡ç®¡ç†å›´ç»•ä¸‰ä¸ªæ ¸å¿ƒæ¦‚å¿µå±•å¼€ï¼š</p><h3 id="SLA-Service-Level-Agreement-æœåŠ¡ç­‰çº§åè®®"><a href="#SLA-Service-Level-Agreement-æœåŠ¡ç­‰çº§åè®®" class="headerlink" title="SLA (Service Level Agreement) - æœåŠ¡ç­‰çº§åè®®"></a>SLA (Service Level Agreement) - æœåŠ¡ç­‰çº§åè®®</h3><p><strong>å®šä¹‰ï¼š</strong> ä¸ç”¨æˆ·æˆ–å®¢æˆ·ç­¾ç½²çš„æ­£å¼åè®®ï¼Œæ˜ç¡®æœåŠ¡è´¨é‡æ‰¿è¯ºå’Œè¿çº¦è´£ä»»</p><p><strong>ç‰¹ç‚¹ï¼š</strong></p><ul><li><strong>æ³•å¾‹çº¦æŸåŠ›</strong>ï¼šå…·æœ‰åˆåŒæ•ˆåŠ›ï¼Œè¿çº¦éœ€è¦æ‰¿æ‹…ç»æµè´£ä»»</li><li><strong>å¤–éƒ¨æ‰¿è¯º</strong>ï¼šé¢å‘å®¢æˆ·çš„æ­£å¼æ‰¿è¯º</li><li><strong>å•†ä¸šå¯¼å‘</strong>ï¼šå¹³è¡¡ç”¨æˆ·æœŸæœ›å’Œæˆæœ¬æŠ•å…¥</li></ul><p><strong>ç¤ºä¾‹ï¼š</strong> <a href="https://cloud.tencent.com/document/product/301/103169#63ee1985-f56f-4629-afbf-cafde690ca64">è…¾è®¯äº‘SLAåè®®</a>è§„å®šäº‘æœåŠ¡å™¨æœˆåº¦å¯ç”¨æ€§99.95%ï¼Œä¸è¾¾æ ‡æŒ‰æ¯”ä¾‹èµ”å¿ã€‚</p><h3 id="SLO-Service-Level-Objective-æœåŠ¡ç­‰çº§ç›®æ ‡"><a href="#SLO-Service-Level-Objective-æœåŠ¡ç­‰çº§ç›®æ ‡" class="headerlink" title="SLO (Service Level Objective) - æœåŠ¡ç­‰çº§ç›®æ ‡"></a>SLO (Service Level Objective) - æœåŠ¡ç­‰çº§ç›®æ ‡</h3><p><strong>å®šä¹‰ï¼š</strong> å†…éƒ¨è®¾å®šçš„æœåŠ¡è´¨é‡ç›®æ ‡ï¼Œæ˜¯å…·ä½“çš„ã€å¯é‡åŒ–çš„æŒ‡æ ‡é˜ˆå€¼</p><h3 id="SLI-Service-Level-Indicator-æœåŠ¡ç­‰çº§æŒ‡ç¤ºå™¨"><a href="#SLI-Service-Level-Indicator-æœåŠ¡ç­‰çº§æŒ‡ç¤ºå™¨" class="headerlink" title="SLI (Service Level Indicator) - æœåŠ¡ç­‰çº§æŒ‡ç¤ºå™¨"></a>SLI (Service Level Indicator) - æœåŠ¡ç­‰çº§æŒ‡ç¤ºå™¨</h3><p><strong>å®šä¹‰ï¼š</strong> ç”¨äºè¡¡é‡æœåŠ¡è´¨é‡çš„å…·ä½“æŒ‡æ ‡ï¼Œæ˜¯å¯è§‚æµ‹å’Œå¯é‡åŒ–çš„æŠ€æœ¯æŒ‡æ ‡</p><p><strong>ä¸‰è€…å…³ç³»ç¤ºä¾‹ï¼š</strong></p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">SLI</span>: APIè¯·æ±‚æˆåŠŸç‡<br><span class="hljs-attribute">SLO</span>: APIè¯·æ±‚æˆåŠŸç‡ â‰¥ <span class="hljs-number">99</span>.<span class="hljs-number">9</span>%<br><span class="hljs-attribute">SLA</span>: æœˆåº¦APIè¯·æ±‚æˆåŠŸç‡ä½äº<span class="hljs-number">99</span>.<span class="hljs-number">5</span>%æ—¶ï¼ŒæŒ‰æœåŠ¡è´¹ç”¨<span class="hljs-number">10</span>%èµ”å¿<br></code></pre></td></tr></table></figure><h2 id="æœåŠ¡è´¨é‡æŒ‡æ ‡åˆ¶å®šæ–¹æ³•è®º"><a href="#æœåŠ¡è´¨é‡æŒ‡æ ‡åˆ¶å®šæ–¹æ³•è®º" class="headerlink" title="æœåŠ¡è´¨é‡æŒ‡æ ‡åˆ¶å®šæ–¹æ³•è®º"></a>æœåŠ¡è´¨é‡æŒ‡æ ‡åˆ¶å®šæ–¹æ³•è®º</h2><h3 id="â€œå‡ ä¸ª9â€çš„é€‰æ‹©ä¸æ˜¯æ‹è„‘è¢‹å†³å®š"><a href="#â€œå‡ ä¸ª9â€çš„é€‰æ‹©ä¸æ˜¯æ‹è„‘è¢‹å†³å®š" class="headerlink" title="â€œå‡ ä¸ª9â€çš„é€‰æ‹©ä¸æ˜¯æ‹è„‘è¢‹å†³å®š"></a>â€œå‡ ä¸ª9â€çš„é€‰æ‹©ä¸æ˜¯æ‹è„‘è¢‹å†³å®š</h3><p>ä¸åŒå¯ç”¨æ€§ç­‰çº§å¯¹åº”çš„å¹´åº¦åœæœºæ—¶é—´ï¼š</p><ul><li>**99.9%**ï¼šå¹´åœæœºæ—¶é—´çº¦8.77å°æ—¶</li><li>**99.99%**ï¼šå¹´åœæœºæ—¶é—´çº¦52.6åˆ†é’Ÿ</li><li>**99.999%**ï¼šå¹´åœæœºæ—¶é—´çº¦5.26åˆ†é’Ÿ</li></ul><h3 id="SLIæŒ‡æ ‡é€‰æ‹©åŸåˆ™"><a href="#SLIæŒ‡æ ‡é€‰æ‹©åŸåˆ™" class="headerlink" title="SLIæŒ‡æ ‡é€‰æ‹©åŸåˆ™"></a>SLIæŒ‡æ ‡é€‰æ‹©åŸåˆ™</h3><p><strong>æ³¨æ„ï¼š</strong> ä¼ ç»Ÿçš„â€æœåŠ¡å¯ç”¨æ—¶é—´â€æŒ‡æ ‡å­˜åœ¨æ­§ä¹‰ï¼ˆå‚è€ƒ<a href="https://sre.google/sre-book/embracing-risk/">Google SRE: æ‹¥æŠ±é£é™©</a>ï¼‰ï¼Œå®é™…å·¥ç¨‹ä¸­æ›´å¤šé‡‡ç”¨é¢å‘ç”¨æˆ·ä½“éªŒçš„SLIã€‚</p><p><strong>å¸¸è§SLIæŒ‡æ ‡ç±»å‹ï¼š</strong></p><p><strong>1. å¯ç”¨æ€§æŒ‡æ ‡</strong>ï¼šè¯·æ±‚æˆåŠŸç‡ã€å¥åº·æ£€æŸ¥æˆåŠŸç‡<br><strong>2. å»¶è¿ŸæŒ‡æ ‡</strong>ï¼šP99å“åº”æ—¶é—´ã€P95å“åº”æ—¶é—´<br><strong>3. ååé‡æŒ‡æ ‡</strong>ï¼šQPSå¤„ç†èƒ½åŠ›ã€å¹¶å‘è¿æ¥æ•°<br><strong>4. è´¨é‡æŒ‡æ ‡</strong>ï¼šæ•°æ®å‡†ç¡®æ€§ã€åŠŸèƒ½å®Œæ•´æ€§</p><p><strong>ä¸šåŠ¡åœºæ™¯çš„SLIé€‰æ‹©ï¼š</strong></p><ul><li><strong>APIç½‘å…³æœåŠ¡</strong>ï¼šä¸»è¦å…³æ³¨è¯·æ±‚æˆåŠŸç‡ã€P99å»¶è¿Ÿã€QPSåå</li><li><strong>æ¶ˆæ¯æ¨é€ç³»ç»Ÿ</strong>ï¼šä¸»è¦å…³æ³¨æ¨é€åˆ°è¾¾ç‡ã€æ¨é€å»¶è¿Ÿã€æ¨é€æˆåŠŸç‡</li><li><strong>æ•°æ®å¤„ç†æœåŠ¡</strong>ï¼šä¸»è¦å…³æ³¨æ•°æ®å¤„ç†å‡†ç¡®ç‡ã€å¤„ç†å»¶è¿Ÿã€ååé‡</li><li><strong>å®æ—¶éŸ³è§†é¢‘æœåŠ¡</strong>ï¼šä¸»è¦å…³æ³¨è¿æ¥æˆåŠŸç‡ã€éŸ³è§†é¢‘è´¨é‡ã€å»¶è¿Ÿ</li></ul><h3 id="é”™è¯¯é¢„ç®—æœºåˆ¶"><a href="#é”™è¯¯é¢„ç®—æœºåˆ¶" class="headerlink" title="é”™è¯¯é¢„ç®—æœºåˆ¶"></a>é”™è¯¯é¢„ç®—æœºåˆ¶</h3><p><strong>é”™è¯¯é¢„ç®—è®¡ç®—ï¼š</strong></p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs abnf">é”™è¯¯é¢„ç®— <span class="hljs-operator">=</span> (<span class="hljs-number">1</span> - SLO) Ã— æ€»è¯·æ±‚é‡<br></code></pre></td></tr></table></figure><p><strong>é”™è¯¯é¢„ç®—çš„ä½œç”¨ï¼š</strong></p><ul><li><strong>äº§å“è¿­ä»£å†³ç­–</strong>ï¼šé¢„ç®—å……è¶³æ—¶å¯ä»¥å¿«é€Ÿè¿­ä»£æ–°åŠŸèƒ½</li><li><strong>ç¨³å®šæ€§æŠ•å…¥</strong>ï¼šé¢„ç®—ä¸è¶³æ—¶ä¼˜å…ˆæŠ•å…¥ç¨³å®šæ€§æ”¹è¿›</li><li><strong>é£é™©è¯„ä¼°</strong>ï¼šé‡åŒ–æ–°åŠŸèƒ½å‘å¸ƒçš„é£é™©æˆæœ¬</li></ul><h2 id="ç³»åˆ—æ€»ç»“ä¸ä¸‹ç¯‡é¢„å‘Š"><a href="#ç³»åˆ—æ€»ç»“ä¸ä¸‹ç¯‡é¢„å‘Š" class="headerlink" title="ç³»åˆ—æ€»ç»“ä¸ä¸‹ç¯‡é¢„å‘Š"></a>ç³»åˆ—æ€»ç»“ä¸ä¸‹ç¯‡é¢„å‘Š</h2><p>æœ¬æ–‡ä½œä¸ºæœåŠ¡é«˜å¯ç”¨æ²»ç†ç³»åˆ—çš„ç¬¬ä¸€ç¯‡ï¼Œå»ºç«‹äº†å®Œæ•´çš„SREç†è®ºåŸºç¡€ï¼š</p><h3 id="æ ¸å¿ƒè¦ç‚¹å›é¡¾"><a href="#æ ¸å¿ƒè¦ç‚¹å›é¡¾" class="headerlink" title="æ ¸å¿ƒè¦ç‚¹å›é¡¾"></a>æ ¸å¿ƒè¦ç‚¹å›é¡¾</h3><ol><li><strong>é‡åŒ–åº¦é‡ä½“ç³»</strong>ï¼šåŸºäºMTTF&#x2F;MTTRæ„å»ºçš„å¯ç”¨æ€§è®¡ç®—æ¨¡å‹</li><li><strong>SLOæŒ‡æ ‡ä½“ç³»</strong>ï¼šSLI&#x2F;SLO&#x2F;SLAä¸‰å±‚æœåŠ¡è´¨é‡ç®¡ç†æ¡†æ¶  </li><li><strong>é”™è¯¯é¢„ç®—æœºåˆ¶</strong>ï¼šå¹³è¡¡è¿­ä»£é€Ÿåº¦ä¸ç¨³å®šæ€§çš„é‡åŒ–å·¥å…·</li><li><strong>æ•…éšœåˆ†ç±»æ–¹æ³•</strong>ï¼šå˜æ›´ç±»ã€å®¹é‡ç±»ã€ä¾èµ–ç±»ã€ç¯å¢ƒç±»ã€äººä¸ºç±»äº”å¤§æ•…éšœæº</li><li><strong>ä¸‰é˜¶æ®µä¿éšœä½“ç³»</strong>ï¼šäº‹å‰é¢„é˜²ã€äº‹ä¸­å“åº”ã€äº‹åæ”¹è¿›çš„å®Œæ•´é—­ç¯</li></ol><h3 id="å®è·µä»·å€¼"><a href="#å®è·µä»·å€¼" class="headerlink" title="å®è·µä»·å€¼"></a>å®è·µä»·å€¼</h3><ul><li><strong>ä¸ºæŠ€æœ¯å†³ç­–æä¾›é‡åŒ–ä¾æ®</strong>ï¼šé€šè¿‡é”™è¯¯é¢„ç®—æŒ‡å¯¼åŠŸèƒ½å‘å¸ƒä¸ç¨³å®šæ€§æŠ•å…¥çš„å¹³è¡¡</li><li><strong>å»ºç«‹ç»Ÿä¸€çš„å¯é æ€§è¯­è¨€</strong>ï¼šå›¢é˜Ÿé—´åŸºäºSLOè¿›è¡Œåä½œå’Œè´£ä»»è¾¹ç•Œåˆ’åˆ†</li><li><strong>æ„å»ºæŒç»­æ”¹è¿›æœºåˆ¶</strong>ï¼šé€šè¿‡æ•…éšœå¤ç›˜å’Œåº¦é‡åé¦ˆé©±åŠ¨ç³»ç»Ÿæ¼”è¿›</li></ul><h3 id="ä¸‹ç¯‡å†…å®¹é¢„å‘Š"><a href="#ä¸‹ç¯‡å†…å®¹é¢„å‘Š" class="headerlink" title="ä¸‹ç¯‡å†…å®¹é¢„å‘Š"></a>ä¸‹ç¯‡å†…å®¹é¢„å‘Š</h3><p>ç³»åˆ—ç¬¬äºŒç¯‡ã€ŠæŠ€æœ¯å®ç°ä¸æ¶æ„è®¾è®¡å®æˆ˜ã€‹å°†æ·±å…¥æ¢è®¨ï¼š</p><ul><li><strong>å•èŠ‚ç‚¹é˜²æŠ¤æœºåˆ¶</strong>ï¼šé™æµã€ç†”æ–­ã€è¶…æ—¶ã€é™çº§ã€é‡è¯•çš„å·¥ç¨‹å®ç°</li><li><strong>åˆ†å¸ƒå¼æ¶æ„è®¾è®¡</strong>ï¼šåŒåŸåŒæ´»ã€å¼‚åœ°å¤šæ´»ã€å•å…ƒåŒ–æ¶æ„çš„æŠ€æœ¯æ–¹æ¡ˆ</li><li><strong>å·¥ç¨‹å®è·µéªŒè¯</strong>ï¼šæ··æ²Œå·¥ç¨‹ã€å…¨é“¾è·¯å‹æµ‹çš„å®æ–½æ–¹æ³•</li></ul><p>ç†è®ºæŒ‡å¯¼å®è·µï¼Œå®è·µéªŒè¯ç†è®ºã€‚æŒæ¡äº†æœ¬ç¯‡çš„SREç†è®ºåŸºç¡€åï¼Œä¸‹ç¯‡å°†ä¸ºæ‚¨å±•ç¤ºå¦‚ä½•å°†è¿™äº›ç†å¿µè½¬åŒ–ä¸ºå…·ä½“çš„æŠ€æœ¯å®ç°ã€‚</p><h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ul><li><a href="https://sre.google/sre-book/embracing-risk/">ã€ŠGoogle SRE: æ‹¥æŠ±é£é™©ã€‹</a></li><li><a href="https://codingwhat.github.io/2024/07/17/service-high-available-governance/">ã€ŠæœåŠ¡é«˜å¯ç”¨æ²»ç†ç³»åˆ—ï¼ˆäºŒï¼‰ï¼šæŠ€æœ¯å®ç°ä¸æ¶æ„è®¾è®¡å®æˆ˜ã€‹</a></li></ul>]]></content>
    
    
    <categories>
      
      <category>ç³»ç»Ÿæ¶æ„</category>
      
      <category>æœåŠ¡æ²»ç†</category>
      
    </categories>
    
    
    <tags>
      
      <tag>é«˜å¯ç”¨æ²»ç†</tag>
      
      <tag>SRE</tag>
      
      <tag>æœåŠ¡ç­‰çº§ç›®æ ‡</tag>
      
      <tag>é”™è¯¯é¢„ç®—</tag>
      
      <tag>å¯è§‚æµ‹æ€§</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>æœåŠ¡é«˜å¯ç”¨æ²»ç†ç³»åˆ—ï¼ˆäºŒï¼‰ï¼šæŠ€æœ¯å®ç°ä¸æ¶æ„è®¾è®¡å®æˆ˜</title>
    <link href="/2024/07/17/service-high-available-governance/"/>
    <url>/2024/07/17/service-high-available-governance/</url>
    
    <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡æ˜¯æœåŠ¡é«˜å¯ç”¨æ²»ç†ç³»åˆ—çš„ç¬¬äºŒç¯‡ï¼ŒåŸºäºç³»åˆ—ç¬¬ä¸€ç¯‡çš„SREç†è®ºåŸºç¡€ï¼Œæ·±å…¥æ¢è®¨å•èŠ‚ç‚¹é˜²æŠ¤æœºåˆ¶åˆ°åˆ†å¸ƒå¼æ¶æ„çš„å…·ä½“å®ç°ã€‚æ¶µç›–é™æµã€ç†”æ–­ã€è¶…æ—¶æ§åˆ¶ã€é™çº§ã€é‡è¯•ç­‰å…³é”®æŠ€æœ¯çš„å·¥ç¨‹å®è·µï¼Œä¸ºåç«¯å·¥ç¨‹å¸ˆæä¾›å®Œæ•´çš„æŠ€æœ¯å®ç°æŒ‡å—ã€‚</p></blockquote><span id="more"></span><h1 id="æŠ€æœ¯å®ç°åŸºç¡€"><a href="#æŠ€æœ¯å®ç°åŸºç¡€" class="headerlink" title="æŠ€æœ¯å®ç°åŸºç¡€"></a>æŠ€æœ¯å®ç°åŸºç¡€</h1><blockquote><p>æœ¬æ–‡åŸºäºç³»åˆ—ç¬¬ä¸€ç¯‡ä»‹ç»çš„SREç†è®ºåŸºç¡€ï¼Œé‡ç‚¹è®²è§£å…·ä½“çš„æŠ€æœ¯å®ç°ã€‚å»ºè®®å…ˆé˜…è¯»ï¼š<a href="https://codingwhat.github.io/2024/07/28/service-avaliable/">ã€ŠæœåŠ¡é«˜å¯ç”¨æ²»ç†ç³»åˆ—ï¼ˆä¸€ï¼‰ï¼šSREç†è®ºåŸºç¡€ä¸åº¦é‡ä½“ç³»ã€‹</a></p></blockquote><h2 id="SLOæŒ‡æ ‡ä½“ç³»å®æˆ˜é…ç½®"><a href="#SLOæŒ‡æ ‡ä½“ç³»å®æˆ˜é…ç½®" class="headerlink" title="SLOæŒ‡æ ‡ä½“ç³»å®æˆ˜é…ç½®"></a>SLOæŒ‡æ ‡ä½“ç³»å®æˆ˜é…ç½®</h2><p>åŸºäºç³»åˆ—ç¬¬ä¸€ç¯‡ä»‹ç»çš„SLI&#x2F;SLO&#x2F;SLAä½“ç³»ç†è®ºï¼Œæœ¬èŠ‚é‡ç‚¹ä»‹ç»å…·ä½“çš„é…ç½®å®ç°å’Œå·¥ç¨‹å®è·µã€‚</p><h3 id="SLIæŒ‡æ ‡é€‰æ‹©ä¸ä¸šåŠ¡åœºæ™¯åŒ¹é…"><a href="#SLIæŒ‡æ ‡é€‰æ‹©ä¸ä¸šåŠ¡åœºæ™¯åŒ¹é…" class="headerlink" title="SLIæŒ‡æ ‡é€‰æ‹©ä¸ä¸šåŠ¡åœºæ™¯åŒ¹é…"></a>SLIæŒ‡æ ‡é€‰æ‹©ä¸ä¸šåŠ¡åœºæ™¯åŒ¹é…</h3><h4 id="ç”¨æˆ·æ„ŸçŸ¥ç»´åº¦åˆ†æ"><a href="#ç”¨æˆ·æ„ŸçŸ¥ç»´åº¦åˆ†æ" class="headerlink" title="ç”¨æˆ·æ„ŸçŸ¥ç»´åº¦åˆ†æ"></a>ç”¨æˆ·æ„ŸçŸ¥ç»´åº¦åˆ†æ</h4><p><strong>åŸºäºä¸šåŠ¡ç‰¹å¾çš„æŒ‡æ ‡ä¼˜å…ˆçº§è®¾è®¡</strong>ï¼š</p><table><thead><tr><th>ä¸šåŠ¡åœºæ™¯</th><th>æ ¸å¿ƒå…³æ³¨æŒ‡æ ‡</th><th>æ¬¡è¦æŒ‡æ ‡</th><th>é€‰æ‹©ä¾æ®</th></tr></thead><tbody><tr><td><strong>ç”µå•†ä¸‹å•</strong></td><td>æˆåŠŸç‡ &gt; å»¶è¿Ÿ &gt; ååé‡</td><td>é”™è¯¯ç±»å‹åˆ†å¸ƒ</td><td>ç”¨æˆ·å¯¹å¤±è´¥é›¶å®¹å¿ï¼Œå»¶è¿Ÿå½±å“è½¬åŒ–ç‡</td></tr><tr><td><strong>å†…å®¹æ¨è</strong></td><td>å»¶è¿Ÿ &gt; æˆåŠŸç‡ &gt; å‡†ç¡®æ€§</td><td>ç¼“å­˜å‘½ä¸­ç‡</td><td>å»¶è¿Ÿç›´æ¥å½±å“ç”¨æˆ·ä½“éªŒå’Œç•™å­˜</td></tr><tr><td><strong>æ”¯ä»˜äº¤æ˜“</strong></td><td>æˆåŠŸç‡ &#x3D; ä¸€è‡´æ€§ &gt; å»¶è¿Ÿ</td><td>é‡å¤å¤„ç†ç‡</td><td>èµ„é‡‘å®‰å…¨å’Œå‡†ç¡®æ€§ä¼˜å…ˆ</td></tr><tr><td><strong>æœç´¢æœåŠ¡</strong></td><td>å»¶è¿Ÿ &gt; ç›¸å…³æ€§ &gt; æˆåŠŸç‡</td><td>ç´¢å¼•æ–°é²œåº¦</td><td>æœç´¢å»¶è¿Ÿç›´æ¥å½±å“ç”¨æˆ·ç•™å­˜</td></tr><tr><td><strong>è¯„è®ºäº’åŠ¨</strong></td><td>å»¶è¿Ÿ &gt; æˆåŠŸç‡ &gt; å†…å®¹è´¨é‡</td><td>å®¡æ ¸é€šè¿‡ç‡</td><td>å®æ—¶äº’åŠ¨ä½“éªŒï¼Œå¶å‘å¤±è´¥å¯é‡è¯•</td></tr></tbody></table><h4 id="è¯¦ç»†æŒ‡æ ‡é…ç½®å†³ç­–è§£æ"><a href="#è¯¦ç»†æŒ‡æ ‡é…ç½®å†³ç­–è§£æ" class="headerlink" title="è¯¦ç»†æŒ‡æ ‡é…ç½®å†³ç­–è§£æ"></a>è¯¦ç»†æŒ‡æ ‡é…ç½®å†³ç­–è§£æ</h4><p><strong>ç”µå•†è®¢å•APIçš„SLIè®¾è®¡å®ä¾‹</strong>ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># åŸºäºä¸šåŠ¡åœºæ™¯çš„SLIæŒ‡æ ‡è®¾è®¡</span><br><span class="hljs-attr">order_api_sli:</span><br>  <span class="hljs-attr">availability:</span><br>    <span class="hljs-comment"># ã€çª—å£é€‰æ‹©5minçš„å†³ç­–ä¾æ®ã€‘</span><br>    <span class="hljs-comment"># 1åˆ†é’Ÿï¼šè¿‡äºæ•æ„Ÿï¼Œç½‘ç»œæŠ–åŠ¨å¯¼è‡´è¯¯æŠ¥</span><br>    <span class="hljs-comment"># 10åˆ†é’Ÿï¼šååº”è¿Ÿé’ï¼Œæ•…éšœå½±å“é¢æ‰©å¤§  </span><br>    <span class="hljs-comment"># 5åˆ†é’Ÿï¼šå¹³è¡¡ç‚¹ï¼Œèƒ½åœ¨5åˆ†é’Ÿå†…å‘ç°99%çœŸå®æ•…éšœ</span><br>    <span class="hljs-attr">success_criteria:</span> <span class="hljs-string">&quot;status_code in [200, 201, 202] AND latency &lt; 1000ms&quot;</span><br>    <span class="hljs-attr">measurement_window:</span> <span class="hljs-string">&quot;5min&quot;</span><br>    <span class="hljs-attr">rationale:</span> <span class="hljs-string">|</span><br><span class="hljs-string">      æˆåŠŸå®šä¹‰åŒ…å«å»¶è¿Ÿçº¦æŸçš„åŸå› ï¼š</span><br><span class="hljs-string">      - è¶…è¿‡1sçš„è®¢å•å“åº”ï¼Œ78%ç”¨æˆ·ä¼šæ”¾å¼ƒæ“ä½œï¼ˆå®é™…A/Bæµ‹è¯•æ•°æ®ï¼‰</span><br><span class="hljs-string">      - çŠ¶æ€ç 2xxä½†è¶…æ—¶ï¼Œç”¨æˆ·æ„ŸçŸ¥ä¸ºå¤±è´¥</span><br><span class="hljs-string">      - ä¸šåŠ¡æˆåŠŸ = æŠ€æœ¯æˆåŠŸ + ç”¨æˆ·ä½“éªŒ</span><br><span class="hljs-string"></span>    <br>  <span class="hljs-attr">latency:</span><br>    <span class="hljs-comment"># ã€P95é€‰æ‹©è€ŒéP99çš„åŸå› ã€‘</span><br>    <span class="hljs-comment"># P99ï¼šå—å°‘æ•°é•¿å°¾è¯·æ±‚å½±å“ï¼Œæ³¢åŠ¨å¤§ï¼Œä¸åˆ©äºç¨³å®šå‘Šè­¦</span><br>    <span class="hljs-comment"># P95ï¼šè¦†ç›–95%ç”¨æˆ·ä½“éªŒï¼Œæœ‰5%å®¹é”™ç¼“å†²ï¼Œä»£è¡¨æ€§å¼º</span><br>    <span class="hljs-comment"># P90ï¼šè¦†ç›–ä¸å¤Ÿå…¨é¢ï¼Œå¯èƒ½é—æ¼é‡è¦æ€§èƒ½é—®é¢˜</span><br>    <span class="hljs-attr">percentile:</span> <span class="hljs-string">&quot;P95&quot;</span><br>    <span class="hljs-attr">threshold:</span> <span class="hljs-string">&quot;200ms&quot;</span>  <br>    <span class="hljs-attr">measurement_window:</span> <span class="hljs-string">&quot;5min&quot;</span><br>    <span class="hljs-attr">calculation_detail:</span> <span class="hljs-string">|</span><br><span class="hljs-string">      200msé˜ˆå€¼çš„å·¥ç¨‹è®¡ç®—ï¼š</span><br><span class="hljs-string">      - ç”¨æˆ·æ„ŸçŸ¥ç ”ç©¶ï¼š&lt;100msæå¿«ï¼Œ100-300mså¯æ¥å—ï¼Œ&gt;300mså¡é¡¿</span><br><span class="hljs-string">      - ç³»ç»Ÿè°ƒç”¨é“¾è·¯ï¼šå‚æ•°æ ¡éªŒ(10ms) + åº“å­˜æŸ¥è¯¢(50ms) + </span><br><span class="hljs-string">        ä»·æ ¼è®¡ç®—(30ms) + è®¢å•å…¥åº“(80ms) + ç½‘ç»œå¼€é”€(30ms) = 200ms</span><br><span class="hljs-string">      - é¢„ç•™20%æ€§èƒ½æŠ–åŠ¨ç©ºé—´</span><br><span class="hljs-string"></span>      <br>  <span class="hljs-attr">error_rate:</span><br>    <span class="hljs-comment"># ã€0.1%é˜ˆå€¼çš„ç²¾ç¡®è®¡ç®—ã€‘</span><br>    <span class="hljs-comment"># SLOç›®æ ‡99.95% = 0.05%é”™è¯¯é¢„ç®—</span><br>    <span class="hljs-comment"># å‘Šè­¦é˜ˆå€¼è®¾ä¸º0.1% = 2å€å®‰å…¨è¾¹é™…</span><br>    <span class="hljs-comment"># é¿å…æ¥è¿‘é¢„ç®—è€—å°½æ‰å‘Šè­¦çš„è¢«åŠ¨å“åº”</span><br>    <span class="hljs-attr">calculation:</span> <span class="hljs-string">&quot;(5xx_errors + timeouts) / total_requests&quot;</span><br>    <span class="hljs-attr">threshold:</span> <span class="hljs-string">&quot;&lt; 0.1%&quot;</span><br>    <span class="hljs-attr">measurement_window:</span> <span class="hljs-string">&quot;5min&quot;</span><br>    <span class="hljs-attr">error_classification:</span> <span class="hljs-string">|</span><br><span class="hljs-string">      é”™è¯¯è®¡ç®—è§„åˆ™ï¼š</span><br><span class="hljs-string">      - 4xxä¸è®¡å…¥ï¼šå®¢æˆ·ç«¯é—®é¢˜ï¼ŒéæœåŠ¡è´¨é‡</span><br><span class="hljs-string">      - 5xxè®¡å…¥ï¼šæœåŠ¡ç«¯æ•…éšœï¼Œå½±å“å¯ç”¨æ€§</span><br><span class="hljs-string">      - timeoutè®¡å…¥ï¼šç”¨æˆ·æ„ŸçŸ¥å¤±è´¥ï¼Œç­‰åŒæœåŠ¡é”™è¯¯</span><br><span class="hljs-string">      - é™æµæ‹’ç»ï¼šè®¡å…¥ï¼Œå› ä¸ºå½±å“ç”¨æˆ·ä½“éªŒ</span><br></code></pre></td></tr></table></figure><h4 id="è¯„è®ºæœåŠ¡çš„SLIè®¾è®¡æ¡ˆä¾‹"><a href="#è¯„è®ºæœåŠ¡çš„SLIè®¾è®¡æ¡ˆä¾‹" class="headerlink" title="è¯„è®ºæœåŠ¡çš„SLIè®¾è®¡æ¡ˆä¾‹"></a>è¯„è®ºæœåŠ¡çš„SLIè®¾è®¡æ¡ˆä¾‹</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># è¯„è®ºäº’åŠ¨åœºæ™¯çš„æŒ‡æ ‡æƒé‡è®¾è®¡</span><br><span class="hljs-attr">comment_api_sli:</span><br>  <span class="hljs-attr">latency:</span><br>    <span class="hljs-comment"># è¯„è®ºäº’åŠ¨å¯¹å»¶è¿Ÿæå…¶æ•æ„Ÿ</span><br>    <span class="hljs-attr">percentile:</span> <span class="hljs-string">&quot;P95&quot;</span><br>    <span class="hljs-attr">threshold:</span> <span class="hljs-string">&quot;150ms&quot;</span>  <span class="hljs-comment"># æ¯”è®¢å•æ›´ä¸¥æ ¼</span><br>    <span class="hljs-attr">weight:</span> <span class="hljs-number">35</span><span class="hljs-string">%</span><br>    <span class="hljs-attr">rationale:</span> <span class="hljs-string">|</span><br><span class="hljs-string">      è¯„è®ºå»¶è¿Ÿå½±å“åˆ†æï¼š</span><br><span class="hljs-string">      - å‘è¯„è®ºï¼š&gt;200msç”¨æˆ·æ„Ÿè§‰&quot;å¡&quot;ï¼Œå½±å“è¡¨è¾¾æ¬²æœ›</span><br><span class="hljs-string">      - çœ‹è¯„è®ºï¼š&gt;150msé¡µé¢åŠ è½½ä½“éªŒå·®</span><br><span class="hljs-string">      - å®æ—¶æ€§è¦æ±‚ï¼šç¤¾äº¤äº’åŠ¨çš„å³æ—¶åé¦ˆéœ€æ±‚</span><br><span class="hljs-string"></span>      <br>  <span class="hljs-attr">availability:</span><br>    <span class="hljs-attr">success_criteria:</span> <span class="hljs-string">&quot;status_code in [200, 201] AND latency &lt; 500ms&quot;</span><br>    <span class="hljs-attr">threshold:</span> <span class="hljs-string">&quot;99.9%&quot;</span>  <span class="hljs-comment"># æ¯”è®¢å•ç¨å®½æ¾</span><br>    <span class="hljs-attr">weight:</span> <span class="hljs-number">25</span><span class="hljs-string">%</span><br>    <span class="hljs-attr">rationale:</span> <span class="hljs-string">|</span><br><span class="hljs-string">      å¯ç”¨æ€§è¦æ±‚åˆ†æï¼š</span><br><span class="hljs-string">      - è¯„è®ºå¤±è´¥ç”¨æˆ·å¯é‡è¯•ï¼Œå®¹å¿åº¦ç›¸å¯¹è¾ƒé«˜</span><br><span class="hljs-string">      - ä½†é¢‘ç¹å¤±è´¥ä¼šå½±å“ç”¨æˆ·æ´»è·ƒåº¦</span><br><span class="hljs-string">      - ç›¸æ¯”äº¤æ˜“ï¼Œå¯¹å¼ºä¸€è‡´æ€§è¦æ±‚è¾ƒä½</span><br><span class="hljs-string"></span>      <br>  <span class="hljs-attr">content_quality:</span><br>    <span class="hljs-comment"># å†…å®¹è´¨é‡æŒ‡æ ‡</span><br>    <span class="hljs-attr">metric:</span> <span class="hljs-string">&quot;high_quality_comment_rate&quot;</span><br>    <span class="hljs-attr">calculation:</span> <span class="hljs-string">&quot;(æ€»è¯„è®ºæ•° - åƒåœ¾è¯„è®ºæ•° - é‡å¤å†…å®¹æ•°) / æ€»è¯„è®ºæ•°&quot;</span><br>    <span class="hljs-attr">threshold:</span> <span class="hljs-string">&quot;95%&quot;</span><br>    <span class="hljs-attr">weight:</span> <span class="hljs-number">20</span><span class="hljs-string">%</span><br>    <span class="hljs-attr">rationale:</span> <span class="hljs-string">|</span><br><span class="hljs-string">      å†…å®¹è´¨é‡å…³æ³¨ç‚¹ï¼š</span><br><span class="hljs-string">      - åƒåœ¾è¯„è®ºè¿‡æ»¤ï¼šå¹¿å‘Šã€åˆ·å±ã€æ— æ„ä¹‰å­—ç¬¦</span><br><span class="hljs-string">      - é‡å¤å†…å®¹æ£€æµ‹ï¼šåŒç”¨æˆ·çŸ­æ—¶é—´å†…é‡å¤å‘å¸ƒ</span><br><span class="hljs-string">      - æ¶æ„å†…å®¹è¯†åˆ«ï¼šè¾±éª‚ã€ä»‡æ¨è¨€è®ºã€è¿æ³•ä¿¡æ¯</span><br><span class="hljs-string">      - ä¸šåŠ¡ä»·å€¼ï¼šä¼˜è´¨è¯„è®ºæå‡ç”¨æˆ·å‚ä¸åº¦</span><br><span class="hljs-string"></span>      <br>  <span class="hljs-attr">moderation_efficiency:</span><br>    <span class="hljs-comment"># å®¡æ ¸é€šè¿‡ç‡æŒ‡æ ‡</span><br>    <span class="hljs-attr">metric:</span> <span class="hljs-string">&quot;auto_approval_rate&quot;</span><br>    <span class="hljs-attr">calculation:</span> <span class="hljs-string">&quot;è‡ªåŠ¨å®¡æ ¸é€šè¿‡æ•° / æ€»æäº¤è¯„è®ºæ•°&quot;</span><br>    <span class="hljs-attr">threshold:</span> <span class="hljs-string">&quot;90%&quot;</span><br>    <span class="hljs-attr">weight:</span> <span class="hljs-number">15</span><span class="hljs-string">%</span><br>    <span class="hljs-attr">rationale:</span> <span class="hljs-string">|</span><br><span class="hljs-string">      å®¡æ ¸æ•ˆç‡æ„ä¹‰ï¼š</span><br><span class="hljs-string">      - å‡å°‘äººå·¥å®¡æ ¸æˆæœ¬ï¼Œæå‡è¿è¥æ•ˆç‡</span><br><span class="hljs-string">      - å¿«é€Ÿå‘å¸ƒä½“éªŒï¼Œé™ä½ç”¨æˆ·ç­‰å¾…æ—¶é—´</span><br><span class="hljs-string">      - åˆè§„é£é™©æ§åˆ¶ï¼Œå¹³è¡¡æ•ˆç‡ä¸å®‰å…¨</span><br><span class="hljs-string">      - è¯¯åˆ¤ç‡æ§åˆ¶ï¼šè‡ªåŠ¨å®¡æ ¸å‡†ç¡®ç‡&gt;98%</span><br><span class="hljs-string"></span>      <br>  <span class="hljs-attr">data_integrity:</span><br>    <span class="hljs-comment"># æ•°æ®å®Œæ•´æ€§æŒ‡æ ‡</span><br>    <span class="hljs-attr">metric:</span> <span class="hljs-string">&quot;complete_response_rate&quot;</span><br>    <span class="hljs-attr">calculation:</span> <span class="hljs-string">&quot;å®Œæ•´è¿”å›è¯„è®ºæ•° / åº”è¿”å›è¯„è®ºæ€»æ•°&quot;</span><br>    <span class="hljs-attr">threshold:</span> <span class="hljs-string">&quot;99.5%&quot;</span><br>    <span class="hljs-attr">weight:</span> <span class="hljs-number">5</span><span class="hljs-string">%</span><br>    <span class="hljs-attr">rationale:</span> <span class="hljs-string">|</span><br><span class="hljs-string">      æ•°æ®å®Œæ•´æ€§åŒ…å«ï¼š</span><br><span class="hljs-string">      - è¯„è®ºå†…å®¹å®Œæ•´ï¼ˆä¸æˆªæ–­ã€ä¸ä¹±ç ï¼‰</span><br><span class="hljs-string">      - å…ƒæ•°æ®é½å…¨ï¼ˆä½œè€…ã€æ—¶é—´ã€ç‚¹èµæ•°ï¼‰</span><br><span class="hljs-string">      - å…³è”å…³ç³»æ­£ç¡®ï¼ˆå›å¤å±‚çº§ã€å¼•ç”¨å…³ç³»ï¼‰</span><br></code></pre></td></tr></table></figure><p><strong>é…ç½®éƒ¨ç½²è¯´æ˜</strong>ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># 1. ç›‘æ§ç³»ç»Ÿé…ç½® (Prometheus + Grafana)</span><br><span class="hljs-comment"># æ–‡ä»¶ä½ç½®: /etc/prometheus/sli-rules.yml</span><br><span class="hljs-attr">groups:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">comment_service_sli</span><br>    <span class="hljs-attr">rules:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">record:</span> <span class="hljs-string">comment_latency_p95</span><br>        <span class="hljs-attr">expr:</span> <span class="hljs-string">histogram_quantile(0.95,</span> <span class="hljs-string">rate(http_request_duration_seconds_bucket&#123;service=&quot;comment&quot;&#125;[5m]))</span><br>      <br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">record:</span> <span class="hljs-string">comment_availability_rate</span>  <br>        <span class="hljs-attr">expr:</span> <span class="hljs-string">rate(http_requests_total&#123;service=&quot;comment&quot;,code=~&quot;2..&quot;&#125;[5m])</span> <span class="hljs-string">/</span> <span class="hljs-string">rate(http_requests_total&#123;service=&quot;comment&quot;&#125;[5m])</span><br>        <br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">record:</span> <span class="hljs-string">comment_quality_rate</span><br>        <span class="hljs-attr">expr:</span> <span class="hljs-string">rate(comment_approved_total[5m])</span> <span class="hljs-string">/</span> <span class="hljs-string">rate(comment_submitted_total[5m])</span><br><br><span class="hljs-comment"># 2. åº”ç”¨ä»£ç é…ç½® (GoæœåŠ¡ç¤ºä¾‹)</span><br><span class="hljs-comment"># æ–‡ä»¶ä½ç½®: configs/sli.yaml</span><br><span class="hljs-attr">sli_config:</span><br>  <span class="hljs-attr">comment_service:</span><br>    <span class="hljs-attr">metrics:</span><br>      <span class="hljs-attr">latency:</span><br>        <span class="hljs-attr">percentile:</span> <span class="hljs-number">95</span><br>        <span class="hljs-attr">threshold_ms:</span> <span class="hljs-number">150</span><br>      <span class="hljs-attr">quality:</span><br>        <span class="hljs-attr">threshold_rate:</span> <span class="hljs-number">0.95</span><br>        <span class="hljs-attr">spam_detection_enabled:</span> <span class="hljs-literal">true</span><br>      <span class="hljs-attr">moderation:</span><br>        <span class="hljs-attr">auto_approval_threshold:</span> <span class="hljs-number">0.90</span><br><br><span class="hljs-comment"># 3. å¾®æœåŠ¡æ¡†æ¶é…ç½® (å¦‚Istio Service Mesh)</span><br><span class="hljs-comment"># æ–‡ä»¶ä½ç½®: k8s/istio/comment-sli.yaml</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">networking.istio.io/v1alpha3</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ServiceMonitor</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">comment-sli-monitor</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">matchLabels:</span><br>      <span class="hljs-attr">app:</span> <span class="hljs-string">comment-service</span><br>  <span class="hljs-attr">endpoints:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">port:</span> <span class="hljs-string">metrics</span><br>    <span class="hljs-attr">path:</span> <span class="hljs-string">/metrics</span><br>    <span class="hljs-attr">interval:</span> <span class="hljs-string">30s</span><br></code></pre></td></tr></table></figure><h4 id="çª—å£å¤§å°çš„æŠ€æœ¯å†³ç­–"><a href="#çª—å£å¤§å°çš„æŠ€æœ¯å†³ç­–" class="headerlink" title="çª—å£å¤§å°çš„æŠ€æœ¯å†³ç­–"></a>çª—å£å¤§å°çš„æŠ€æœ¯å†³ç­–</h4><p><strong>æ—¶é—´çª—å£é€‰æ‹©æ¡†æ¶</strong>ï¼š</p><table><thead><tr><th>çª—å£å¤§å°</th><th>æ•…éšœæ£€æµ‹é€Ÿåº¦</th><th>å™ªå£°è¿‡æ»¤</th><th>æœ€å°æ ·æœ¬é‡</th><th>é€‚ç”¨åœºæ™¯</th></tr></thead><tbody><tr><td><strong>1åˆ†é’Ÿ</strong></td><td>æå¿«(60s)</td><td>å·®</td><td>QPS&gt;2</td><td>äº¤æ˜“æ”¯ä»˜ç­‰é›¶å®¹å¿åœºæ™¯</td></tr><tr><td><strong>5åˆ†é’Ÿ</strong></td><td>å¿«(300s)</td><td>å¥½</td><td>QPS&gt;0.5</td><td>é€šç”¨APIç›‘æ§</td></tr><tr><td><strong>15åˆ†é’Ÿ</strong></td><td>ä¸­ç­‰(900s)</td><td>å¾ˆå¥½</td><td>QPS&gt;0.1</td><td>ä½é¢‘ä½†é‡è¦çš„æœåŠ¡</td></tr><tr><td><strong>1å°æ—¶</strong></td><td>æ…¢(3600s)</td><td>æå¥½</td><td>ä»»æ„</td><td>SLOåˆè§„æ€§è·Ÿè¸ª</td></tr></tbody></table><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs golang"><span class="hljs-comment">// çª—å£å¤§å°çš„æ•°å­¦å†³ç­–æ¨¡å‹</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">CalculateOptimalWindow</span><span class="hljs-params">(qps <span class="hljs-type">float64</span>, mttrTarget time.Duration, noiseLevel <span class="hljs-type">float64</span>)</span></span> time.Duration &#123;<br>    <span class="hljs-comment">// ç»Ÿè®¡æ˜¾è‘—æ€§ï¼šè‡³å°‘éœ€è¦30ä¸ªæ ·æœ¬</span><br>    minSamples := <span class="hljs-number">30</span><br>    minWindow := time.Duration(<span class="hljs-type">float64</span>(minSamples)/qps) * time.Second<br>    <br>    <span class="hljs-comment">// å™ªå£°è¿‡æ»¤ï¼šå™ªå£°æ°´å¹³è¶Šé«˜ï¼Œéœ€è¦è¶Šé•¿çª—å£å¹³æ»‘</span><br>    noiseWindow := time.Duration(noiseLevel * <span class="hljs-number">600</span>) * time.Second<br>    <br>    <span class="hljs-comment">// æ•…éšœå“åº”ï¼šçª—å£ä¸èƒ½è¶…è¿‡MTTRç›®æ ‡çš„1/3</span><br>    maxWindow := mttrTarget / <span class="hljs-number">3</span><br>    <br>    <span class="hljs-comment">// å–çº¦æŸæ¡ä»¶çš„ä¸­ä½æ•°</span><br>    windows := []time.Duration&#123;minWindow, noiseWindow, maxWindow&#125;<br>    sort.Slice(windows, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(i, j <span class="hljs-type">int</span>)</span></span> <span class="hljs-type">bool</span> &#123; <span class="hljs-keyword">return</span> windows[i] &lt; windows[j] &#125;)<br>    <br>    <span class="hljs-keyword">return</span> windows[<span class="hljs-number">1</span>] <span class="hljs-comment">// è¿”å›ä¸­ä½æ•°ä½œä¸ºæœ€ä¼˜çª—å£</span><br>&#125;<br></code></pre></td></tr></table></figure><p><strong>å…³é”®å‘Šè­¦é…ç½®è®¾è®¡åŸç†</strong>ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># å‘Šè­¦é˜µåˆ—è®¾è®¡ - åŸºäºé”™è¯¯é¢„ç®—ç‡ƒå°½ç‡</span><br><span class="hljs-attr">alerts:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">&quot;availability_burn_fast&quot;</span><br>    <span class="hljs-attr">condition:</span> <span class="hljs-string">&quot;availability &lt; 99.5% over 2min&quot;</span>  <span class="hljs-comment"># å¿«é€Ÿç‡ƒå°½æ£€æµ‹</span><br>    <span class="hljs-attr">severity:</span> <span class="hljs-string">&quot;critical&quot;</span><br>    <span class="hljs-attr">design_rationale:</span> <span class="hljs-string">|</span><br><span class="hljs-string">      ã€ä¸ºä»€ä¹ˆ99.5%ï¼Ÿã€‘</span><br><span class="hljs-string">      - SLOç›®æ ‡99.95%ï¼Œæœˆåº¦é”™è¯¯é¢„ç®—0.05%</span><br><span class="hljs-string">      - 99.5%æ„å‘³ç€ç‡ƒå°½ç‡ä¸º10å€ (0.5% / 0.05% = 10)</span><br><span class="hljs-string">      - 10å€ç‡ƒå°½é€Ÿåº¦ä¸‹ï¼Œ3å°æ—¶è€—å°½æ•´æœˆé¢„ç®—</span><br><span class="hljs-string"></span>      <br>      <span class="hljs-string">ã€ä¸ºä»€ä¹ˆ2åˆ†é’Ÿçª—å£ï¼Ÿã€‘</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">å¿«é€Ÿæ£€æµ‹ä¸¥é‡æ•…éšœï¼Œé¿å…å¤§é‡é¢„ç®—æŸå¤±</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-number">2</span><span class="hljs-string">åˆ†é’Ÿè¯¯æŠ¥æ¦‚ç‡&lt;1%ï¼ŒåŸºäºå†å²æ•°æ®ç»Ÿè®¡</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">ç»™å›¢é˜Ÿäº‰å–æŠ¢æ•‘æ—¶é—´ï¼Œè§¦å‘ç´§æ€¥å“åº”æµç¨‹</span><br>    <br>    <span class="hljs-attr">action:</span> <span class="hljs-string">&quot;ç«‹å³é¡µé¢å‘¼å«ï¼Œå¯åŠ¨P0æ•…éšœå¤„ç†æµç¨‹&quot;</span><br>    <br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">&quot;availability_burn_slow&quot;</span> <br>    <span class="hljs-attr">condition:</span> <span class="hljs-string">&quot;availability &lt; 99.8% over 1hour&quot;</span>  <span class="hljs-comment"># ç¼“æ…¢ç‡ƒå°½æ£€æµ‹</span><br>    <span class="hljs-attr">severity:</span> <span class="hljs-string">&quot;warning&quot;</span><br>    <span class="hljs-attr">design_rationale:</span> <span class="hljs-string">|</span><br><span class="hljs-string">      ã€ä¸ºä»€ä¹ˆ99.8%ï¼Ÿã€‘</span><br><span class="hljs-string">      - ç‡ƒå°½ç‡ä¸º4å€ (0.2% / 0.05% = 4)</span><br><span class="hljs-string">      - 4å€é€Ÿåº¦ä¸‹ï¼Œ7.5å¤©è€—å°½æœˆé¢„ç®—ï¼Œæœ‰å¤„ç†æ—¶é—´</span><br><span class="hljs-string"></span>      <br>      <span class="hljs-string">ã€ä¸ºä»€ä¹ˆ1å°æ—¶çª—å£ï¼Ÿã€‘</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">è¿‡æ»¤çŸ­æœŸæ³¢åŠ¨ï¼Œå…³æ³¨æŒç»­æ€§é—®é¢˜</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-number">1</span><span class="hljs-string">å°æ—¶è¶³ä»¥ç¡®è®¤è¶‹åŠ¿ï¼Œé¿å…è¯¯æŠ¥</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">ç»™å›¢é˜Ÿæ—¶é—´åˆ†ææ ¹å› å’Œåˆ¶å®šå¯¹ç­–</span><br>      <br>    <span class="hljs-attr">action:</span> <span class="hljs-string">&quot;å‘é€å·¥å•ï¼Œ24å°æ—¶å†…åˆ†æå¤„ç†&quot;</span><br>    <br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">&quot;latency_degradation&quot;</span><br>    <span class="hljs-attr">condition:</span> <span class="hljs-string">&quot;P95_latency &gt; 500ms over 5min&quot;</span><br>    <span class="hljs-attr">severity:</span> <span class="hljs-string">&quot;warning&quot;</span>  <br>    <span class="hljs-attr">design_rationale:</span> <span class="hljs-string">|</span><br><span class="hljs-string">      ã€ä¸ºä»€ä¹ˆ500msï¼Ÿã€‘</span><br><span class="hljs-string">      - SLOç›®æ ‡P95&lt;200msï¼Œ500msæ˜¯2.5å€æ¶åŒ–</span><br><span class="hljs-string">      - è¶…è¿‡500msæ—¶ï¼Œç”¨æˆ·æ„ŸçŸ¥æ˜æ˜¾ï¼ŒæŠ•è¯‰å¢åŠ </span><br><span class="hljs-string">      - ä¸ºä¸¥é‡æ€§èƒ½é—®é¢˜æä¾›é¢„è­¦ç¼“å†²</span><br><span class="hljs-string"></span>      <br>      <span class="hljs-string">ã€ä¸ºä»€ä¹ˆ5åˆ†é’Ÿï¼Ÿã€‘</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">å»¶è¿Ÿæ³¢åŠ¨æ¯”å¯ç”¨æ€§æ›´é¢‘ç¹ï¼Œéœ€è¦å¹³æ»‘</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-number">5</span><span class="hljs-string">åˆ†é’Ÿè¶³ä»¥ç¡®è®¤æ€§èƒ½é—®é¢˜çš„æŒç»­æ€§</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">ä¸å¯ç”¨æ€§æŒ‡æ ‡çª—å£ä¿æŒä¸€è‡´ï¼Œä¾¿äºå…³è”åˆ†æ</span><br>      <br>    <span class="hljs-attr">action:</span> <span class="hljs-string">&quot;æ€§èƒ½å›¢é˜Ÿä»‹å…¥ï¼Œæ’æŸ¥æ€§èƒ½ç“¶é¢ˆ&quot;</span><br></code></pre></td></tr></table></figure><p><strong>å‘Šè­¦é˜ˆå€¼è®¾è®¡çš„æ•°å­¦æ¨¡å‹</strong>ï¼š</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs golang"><span class="hljs-comment">// ç‡ƒå°½ç‡å‘Šè­¦é˜ˆå€¼è®¡ç®—</span><br><span class="hljs-keyword">type</span> BurnRateAlert <span class="hljs-keyword">struct</span> &#123;<br>    SLOTarget     <span class="hljs-type">float64</span> <span class="hljs-comment">// å¦‚0.9995 (99.95%)</span><br>    BurnRate      <span class="hljs-type">float64</span> <span class="hljs-comment">// ç‡ƒå°½å€æ•°ï¼Œå¦‚10å€</span><br>    WindowSize    time.Duration<br>    AlertSeverity <span class="hljs-type">string</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(b *BurnRateAlert)</span></span> CalculateThreshold() <span class="hljs-type">float64</span> &#123;<br>    errorBudget := <span class="hljs-number">1</span> - b.SLOTarget           <span class="hljs-comment">// 0.0005 (0.05%)</span><br>    burnErrorRate := errorBudget * b.BurnRate <span class="hljs-comment">// 0.005 (0.5%)</span><br>    alertThreshold := <span class="hljs-number">1</span> - burnErrorRate      <span class="hljs-comment">// 0.995 (99.5%)</span><br>    <span class="hljs-keyword">return</span> alertThreshold<br>&#125;<br><br><span class="hljs-comment">// å‘Šè­¦çª—å£å¤§å°å†³ç­–</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(b *BurnRateAlert)</span></span> OptimalWindow() time.Duration &#123;<br>    <span class="hljs-comment">// é«˜ç‡ƒå°½ç‡ = çŸ­çª—å£ï¼Œå¿«é€Ÿæ£€æµ‹</span><br>    <span class="hljs-comment">// ä½ç‡ƒå°½ç‡ = é•¿çª—å£ï¼Œå‡å°‘è¯¯æŠ¥</span><br>    <span class="hljs-keyword">if</span> b.BurnRate &gt;= <span class="hljs-number">10</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">2</span> * time.Minute<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> b.BurnRate &gt;= <span class="hljs-number">4</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span> * time.Hour  <br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">6</span> * time.Hour<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="é«˜çº§ç›‘æ§å‘Šè­¦é…ç½®"><a href="#é«˜çº§ç›‘æ§å‘Šè­¦é…ç½®" class="headerlink" title="é«˜çº§ç›‘æ§å‘Šè­¦é…ç½®"></a>é«˜çº§ç›‘æ§å‘Šè­¦é…ç½®</h2><blockquote><p>ç›‘æ§å‘Šè­¦çš„åŸºç¡€åŸç†å’Œç‡ƒå°½ç‡æ¦‚å¿µå·²åœ¨ç³»åˆ—ç¬¬ä¸€ç¯‡è¯¦ç»†ä»‹ç»ï¼Œæœ¬èŠ‚é‡ç‚¹è®²è§£å…·ä½“çš„é…ç½®å®ç°å’Œä¼˜åŒ–æŠ€å·§ã€‚</p></blockquote><h3 id="å‘Šè­¦é˜ˆå€¼åŠ¨æ€ä¼˜åŒ–"><a href="#å‘Šè­¦é˜ˆå€¼åŠ¨æ€ä¼˜åŒ–" class="headerlink" title="å‘Šè­¦é˜ˆå€¼åŠ¨æ€ä¼˜åŒ–"></a>å‘Šè­¦é˜ˆå€¼åŠ¨æ€ä¼˜åŒ–</h3><p><strong>1. åŸºäºå†å²æ•°æ®çš„æ™ºèƒ½é˜ˆå€¼</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># P95å»¶è¿ŸåŠ¨æ€é˜ˆå€¼è®¡ç®—</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">calculate_dynamic_threshold</span>(<span class="hljs-params">historical_p95, days=<span class="hljs-number">30</span></span>):<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    åŸºäºæœ€è¿‘30å¤©P95å»¶è¿Ÿè®¡ç®—åŠ¨æ€å‘Šè­¦é˜ˆå€¼</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    mean_p95 = np.mean(historical_p95)<br>    std_p95 = np.std(historical_p95)<br>    <br>    <span class="hljs-comment"># è®¾ç½®ä¸º å‡å€¼ + 2å€æ ‡å‡†å·®ï¼Œè¦†ç›–95%çš„æ­£å¸¸æƒ…å†µ</span><br>    dynamic_threshold = mean_p95 + <span class="hljs-number">2</span> * std_p95<br>    <br>    <span class="hljs-comment"># è®¾ç½®åˆç†çš„ä¸Šä¸‹ç•Œ</span><br>    min_threshold = <span class="hljs-number">100</span>  <span class="hljs-comment"># æœ€å°100ms</span><br>    max_threshold = <span class="hljs-number">2000</span> <span class="hljs-comment"># æœ€å¤§2s</span><br>    <br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">max</span>(min_threshold, <span class="hljs-built_in">min</span>(dynamic_threshold, max_threshold))<br></code></pre></td></tr></table></figure><p><strong>2. ä¸šåŠ¡å½±å“åº¦åŠ æƒå‘Šè­¦</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># æ ¹æ®ä¸šåŠ¡é‡è¦æ€§è®¾ç½®å·®å¼‚åŒ–å‘Šè­¦</span><br><span class="hljs-attr">business_weighted_alerts:</span><br>  <span class="hljs-attr">core_business:</span>  <span class="hljs-comment"># æ ¸å¿ƒä¸šåŠ¡ï¼šä¸‹å•ã€æ”¯ä»˜</span><br>    <span class="hljs-attr">availability_threshold:</span> <span class="hljs-number">99.95</span><span class="hljs-string">%</span><br>    <span class="hljs-attr">latency_threshold:</span> <span class="hljs-string">200ms</span><br>    <span class="hljs-attr">alert_delay:</span> <span class="hljs-string">1min</span><br>    <br>  <span class="hljs-attr">important_business:</span>  <span class="hljs-comment"># é‡è¦ä¸šåŠ¡ï¼šå•†å“æµè§ˆã€ç”¨æˆ·ç™»å½•  </span><br>    <span class="hljs-attr">availability_threshold:</span> <span class="hljs-number">99.9</span><span class="hljs-string">%</span><br>    <span class="hljs-attr">latency_threshold:</span> <span class="hljs-string">500ms</span><br>    <span class="hljs-attr">alert_delay:</span> <span class="hljs-string">3min</span><br>    <br>  <span class="hljs-attr">auxiliary_business:</span>  <span class="hljs-comment"># è¾…åŠ©ä¸šåŠ¡ï¼šæ¨èã€è¯„è®º</span><br>    <span class="hljs-attr">availability_threshold:</span> <span class="hljs-number">99.5</span><span class="hljs-string">%</span><br>    <span class="hljs-attr">latency_threshold:</span> <span class="hljs-string">1000ms</span>  <br>    <span class="hljs-attr">alert_delay:</span> <span class="hljs-string">10min</span><br></code></pre></td></tr></table></figure><h1 id="å•èŠ‚ç‚¹ç¨³å®šæ€§ä¿éšœ"><a href="#å•èŠ‚ç‚¹ç¨³å®šæ€§ä¿éšœ" class="headerlink" title="å•èŠ‚ç‚¹ç¨³å®šæ€§ä¿éšœ"></a>å•èŠ‚ç‚¹ç¨³å®šæ€§ä¿éšœ</h1><h2 id="å•èŠ‚ç‚¹åœºæ™¯ä¸‹çš„æŒ‘æˆ˜"><a href="#å•èŠ‚ç‚¹åœºæ™¯ä¸‹çš„æŒ‘æˆ˜" class="headerlink" title="å•èŠ‚ç‚¹åœºæ™¯ä¸‹çš„æŒ‘æˆ˜"></a>å•èŠ‚ç‚¹åœºæ™¯ä¸‹çš„æŒ‘æˆ˜</h2><p>å•èŠ‚ç‚¹éƒ¨ç½²é¢ä¸´çš„æ ¸å¿ƒé—®é¢˜ï¼š</p><ul><li><strong>æµé‡å†²å‡»</strong>ï¼šç¬æ—¶æµé‡è¶…è¿‡èŠ‚ç‚¹å¤„ç†èƒ½åŠ›ï¼Œè¶…å‡ºSLOè®¾è®¡å®¹é‡</li><li><strong>ä¾èµ–æ•…éšœ</strong>ï¼šä¸‹æ¸¸æœåŠ¡ä¸å¯ç”¨å¯¼è‡´çº§è”å¤±è´¥ï¼Œè¿åé”™è¯¯é¢„ç®—</li><li><strong>èµ„æºè€—å°½</strong>ï¼šCPUã€å†…å­˜ã€è¿æ¥æ•°ç­‰èµ„æºè€—å°½ï¼Œç›´æ¥å½±å“å¯ç”¨æ€§æŒ‡æ ‡</li><li><strong>æ…¢æŸ¥è¯¢å½±å“</strong>ï¼šä¸ªåˆ«è¯·æ±‚å¤„ç†æ—¶é—´è¿‡é•¿ï¼Œæ‹–ç´¯æ•´ä½“P95å»¶è¿Ÿ</li></ul><p>åŸºäºå‰è¿°SLOä½“ç³»ï¼Œå•èŠ‚ç‚¹éœ€è¦å»ºç«‹å¤šå±‚é˜²æŠ¤æœºåˆ¶ç¡®ä¿æŒ‡æ ‡è¾¾æˆã€‚</p><h2 id="é™æµï¼šæµé‡æ§åˆ¶çš„ç¬¬ä¸€é“é˜²çº¿"><a href="#é™æµï¼šæµé‡æ§åˆ¶çš„ç¬¬ä¸€é“é˜²çº¿" class="headerlink" title="é™æµï¼šæµé‡æ§åˆ¶çš„ç¬¬ä¸€é“é˜²çº¿"></a>é™æµï¼šæµé‡æ§åˆ¶çš„ç¬¬ä¸€é“é˜²çº¿</h2><p><img src="/images/limiter.png" alt="é™æµæ¨¡å‹"></p><p>é™æµæ˜¯ä¿æŠ¤ç³»ç»Ÿå…å—æµé‡å†²å‡»çš„é¦–è¦æ‰‹æ®µï¼Œ<strong>ç›´æ¥å…³è”SLOæŒ‡æ ‡è¾¾æˆ</strong>ï¼š</p><ul><li><strong>ä¿æŠ¤å¯ç”¨æ€§</strong>ï¼šé˜²æ­¢è¿‡è½½å¯¼è‡´çš„æœåŠ¡æ‹’ç»ï¼Œç»´æŒ99.95%å¯ç”¨æ€§ç›®æ ‡</li><li><strong>æ§åˆ¶å»¶è¿Ÿ</strong>ï¼šç¡®ä¿å¤„ç†èƒ½åŠ›å†…çš„è¯·æ±‚èƒ½æ»¡è¶³P95&lt;200msçš„å»¶è¿Ÿè¦æ±‚  </li><li><strong>èŠ‚çº¦é”™è¯¯é¢„ç®—</strong>ï¼šé¿å…å› æµé‡å†²å‡»å¯¼è‡´çš„å¤§é‡é”™è¯¯ï¼Œä¿æŠ¤æœˆåº¦é”™è¯¯é¢„ç®—</li></ul><h3 id="é™æµç®—æ³•å¯¹æ¯”"><a href="#é™æµç®—æ³•å¯¹æ¯”" class="headerlink" title="é™æµç®—æ³•å¯¹æ¯”"></a>é™æµç®—æ³•å¯¹æ¯”</h3><table><thead><tr><th>ç®—æ³•</th><th>ç‰¹ç‚¹</th><th>é€‚ç”¨åœºæ™¯</th><th>ä¼˜ç¼ºç‚¹</th></tr></thead><tbody><tr><td>å›ºå®šçª—å£</td><td>å®ç°ç®€å•</td><td>æµé‡ç›¸å¯¹å¹³ç¨³</td><td>ä¸´ç•Œçªå‘é—®é¢˜</td></tr><tr><td>æ»‘åŠ¨çª—å£</td><td>å¹³æ»‘é™æµ</td><td>ç²¾ç¡®æ§åˆ¶éœ€æ±‚</td><td>å†…å­˜æ¶ˆè€—è¾ƒå¤§</td></tr><tr><td>ä»¤ç‰Œæ¡¶</td><td>å…è®¸çªå‘</td><td>åº”å¯¹æµé‡æ³¢åŠ¨</td><td>å‚æ•°è°ƒä¼˜å¤æ‚</td></tr><tr><td>æ¼æ¡¶</td><td>å¹³æ»‘è¾“å‡º</td><td>ä¿æŠ¤ä¸‹æ¸¸</td><td>æ— æ³•åº”å¯¹çªå‘</td></tr></tbody></table><h3 id="é™æµå±‚æ¬¡è®¾è®¡"><a href="#é™æµå±‚æ¬¡è®¾è®¡" class="headerlink" title="é™æµå±‚æ¬¡è®¾è®¡"></a>é™æµå±‚æ¬¡è®¾è®¡</h3><figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs gcode">å®¢æˆ·ç«¯é™æµ <span class="hljs-comment">(é˜²åˆ·ã€é¢„ä¿æŠ¤)</span><br>    â†“<br>APIç½‘å…³é™æµ <span class="hljs-comment">(ç§Ÿæˆ·çº§ã€APIçº§)</span><br>    â†“  <br>æœåŠ¡ç«¯é™æµ <span class="hljs-comment">(å®ä¾‹çº§ã€æ–¹æ³•çº§)</span><br>    â†“<br>æ•°æ®åº“é™æµ <span class="hljs-comment">(è¿æ¥æ± ã€æ…¢æŸ¥è¯¢)</span><br></code></pre></td></tr></table></figure><p>è¯¦ç»†å®ç°å¯å‚è€ƒï¼š<a href="https://codingwhat.github.io/2024/07/09/limiter-in-action/">ã€Šé™æµå®æˆ˜ã€‹</a></p><h2 id="ç†”æ–­ï¼šæ•…éšœéš”ç¦»ä¸å¿«é€Ÿæ¢å¤"><a href="#ç†”æ–­ï¼šæ•…éšœéš”ç¦»ä¸å¿«é€Ÿæ¢å¤" class="headerlink" title="ç†”æ–­ï¼šæ•…éšœéš”ç¦»ä¸å¿«é€Ÿæ¢å¤"></a>ç†”æ–­ï¼šæ•…éšœéš”ç¦»ä¸å¿«é€Ÿæ¢å¤</h2><h3 id="ç†”æ–­æœºåˆ¶çš„ä»·å€¼"><a href="#ç†”æ–­æœºåˆ¶çš„ä»·å€¼" class="headerlink" title="ç†”æ–­æœºåˆ¶çš„ä»·å€¼"></a>ç†”æ–­æœºåˆ¶çš„ä»·å€¼</h3><p>ç†”æ–­å™¨é€šè¿‡<strong>å¿«é€Ÿå¤±è´¥</strong>å’Œ<strong>æ•…éšœéš”ç¦»</strong>æå‡ç³»ç»Ÿå¯ç”¨æ€§ï¼Œ<strong>ç›´æ¥æœåŠ¡äºSLOç›®æ ‡</strong>ï¼š</p><ol><li><strong>èµ„æºä¿æŠ¤</strong>ï¼šé¿å…æ— æ•ˆè¯·æ±‚æ¶ˆè€—ç³»ç»Ÿèµ„æºï¼Œé˜²æ­¢çº¿ç¨‹æ± è€—å°½å½±å“P95å»¶è¿Ÿ</li><li><strong>æ•…éšœéš”ç¦»</strong>ï¼šé˜»æ­¢æ•…éšœå‘ä¸Šæ¸¸ä¼ æ’­ï¼Œé¿å…çº§è”å¤±è´¥ç ´åå¯ç”¨æ€§</li><li><strong>å¿«é€Ÿæ¢å¤</strong>ï¼šé€šè¿‡æ¢æµ‹æœºåˆ¶å¿«é€Ÿæ„ŸçŸ¥æœåŠ¡æ¢å¤ï¼Œå‡å°‘é”™è¯¯é¢„ç®—æ¶ˆè€—</li><li><strong>é™çº§å…œåº•</strong>ï¼šä¸ºä¸šåŠ¡æä¾›å¤‡é€‰æ–¹æ¡ˆï¼Œä¿è¯æ ¸å¿ƒåŠŸèƒ½å¯ç”¨æ€§ä¸ä½äºSLOåŸºçº¿</li></ol><h3 id="æ–­è·¯å™¨æ¶æ„åˆ†ç±»"><a href="#æ–­è·¯å™¨æ¶æ„åˆ†ç±»" class="headerlink" title="æ–­è·¯å™¨æ¶æ„åˆ†ç±»"></a>æ–­è·¯å™¨æ¶æ„åˆ†ç±»</h3><table><thead><tr><th>ç±»å‹</th><th>ä»£è¡¨äº§å“</th><th>æ ¸å¿ƒç‰¹ç‚¹</th><th>é€‚ç”¨åœºæ™¯</th></tr></thead><tbody><tr><td>ä¼ ç»Ÿæ–­è·¯å™¨</td><td>Hystrixã€Sentinel</td><td>åŸºäºé˜ˆå€¼çš„çŠ¶æ€æœº</td><td>æ˜ç¡®æ•…éšœæ¨¡å¼çš„åœºæ™¯</td></tr><tr><td>è‡ªé€‚åº”æ–­è·¯å™¨</td><td>Google SRE Breaker</td><td>åŠ¨æ€é˜ˆå€¼ç®—æ³•</td><td>å¤æ‚å¤šå˜çš„ç”Ÿäº§ç¯å¢ƒ</td></tr></tbody></table><h3 id="ä¼ ç»Ÿæ–­è·¯å™¨"><a href="#ä¼ ç»Ÿæ–­è·¯å™¨" class="headerlink" title="ä¼ ç»Ÿæ–­è·¯å™¨"></a>ä¼ ç»Ÿæ–­è·¯å™¨</h3><p><img src="/images/circuit_breaker.png" alt="ä¼ ç»Ÿæ–­è·¯å™¨"><br>ç½‘ä¸Šä»‹ç»æ–­è·¯å™¨çš„æ–‡ç« å¾ˆå¤š, æœ¬æ–‡åå®æˆ˜è¿™é‡Œå°±ä¸è¯¦ç»†ä»‹ç»äº†, æˆ‘è¿™é‡ŒæŒ‘é‡ç‚¹ä»‹ç»<br><strong>çŠ¶æ€æœºåŸç†:</strong><br>å®ƒæ˜¯ä¸€ä¸ªçŠ¶æ€æœºæ¨¡å‹ï¼Œé€šè¿‡çŠ¶æ€åˆ‡æ¢å¤„ç†æ•…éšœå‡å°‘å¯¹ä¸»è°ƒçš„å½±å“ï¼Œä¸»è¦åŒ…å«ä¸‰ç§çŠ¶æ€:æ‰“å¼€(Open)ã€åŠæ‰“å¼€(Half-Open)ã€å…³é—­(Closed)</p><h4 id="çŠ¶æ€æœºè½¬æ¢é€»è¾‘"><a href="#çŠ¶æ€æœºè½¬æ¢é€»è¾‘" class="headerlink" title="çŠ¶æ€æœºè½¬æ¢é€»è¾‘"></a>çŠ¶æ€æœºè½¬æ¢é€»è¾‘</h4><pre><code class=" mermaid">stateDiagram-v2    [*] --&gt; Closed    Closed --&gt; Open: é”™è¯¯ç‡/æ…¢è°ƒç”¨ç‡è¶…é˜ˆå€¼    Open --&gt; HalfOpen: ç­‰å¾…çª—å£ç»“æŸ    HalfOpen --&gt; Closed: æ¢æµ‹æˆåŠŸ    HalfOpen --&gt; Open: æ¢æµ‹å¤±è´¥</code></pre><p><strong>çŠ¶æ€è½¬æ¢è¯¦ç»†é€»è¾‘</strong>ï¼š</p><ol><li><strong>Closed â†’ Open</strong>ï¼šç»Ÿè®¡çª—å£å†…é”™è¯¯ç‡æˆ–æ…¢è°ƒç”¨ç‡è¶…è¿‡é˜ˆå€¼</li><li><strong>Open â†’ Half-Open</strong>ï¼šç­‰å¾…æŒ‡å®šæ—¶é—´çª—å£åè¿›å…¥æ¢æµ‹çŠ¶æ€</li><li><strong>Half-Open â†’ Closed</strong>ï¼šæ¢æµ‹è¯·æ±‚æˆåŠŸç‡è¾¾åˆ°æ¢å¤é˜ˆå€¼</li><li><strong>Half-Open â†’ Open</strong>ï¼šæ¢æµ‹å¤±è´¥ï¼Œé‡æ–°è¿›å…¥ç†”æ–­çŠ¶æ€</li></ol><p><strong>å…³é”®å‚æ•°é…ç½®</strong>ï¼š</p><ul><li><strong>é™é»˜æ•°</strong>ï¼šè§¦å‘ç†”æ–­çš„æœ€å°è¯·æ±‚é‡ï¼Œé¿å…å°æµé‡è¯¯è§¦å‘</li><li><strong>é”™è¯¯ç‡é˜ˆå€¼</strong>ï¼šé€šå¸¸è®¾ç½®ä¸º20%-50%</li><li><strong>æ—¶é—´çª—å£</strong>ï¼šOpençŠ¶æ€æŒç»­æ—¶é—´ï¼Œå»ºè®®5-30ç§’</li><li><strong>æ¢æµ‹æ¯”ä¾‹</strong>ï¼šHalf-OpençŠ¶æ€ä¸‹çš„æµé‡æ¯”ä¾‹</li></ul><p>æ–­è·¯å™¨çš„ä¼˜ç‚¹åœ¨äºå®ƒæä¾›äº†ä¸°å¯Œçš„é…ç½®é€‰é¡¹ï¼Œå¯ä»¥æ ¹æ®å…·ä½“éœ€æ±‚æ¥è®¾ç½®é”™è¯¯ç‡ã€æ…¢è°ƒç”¨æ¯”ä¾‹ã€é”™è¯¯æ•°ç­‰æŒ‡æ ‡ã€‚ç„¶è€Œï¼Œç”±äºé…ç½®é¡¹è¾ƒå¤šï¼Œå‡†ç¡®åœ°é…ç½®è¿™äº›å€¼å¯èƒ½ä¼šæœ‰ä¸€å®šçš„æŒ‘æˆ˜ã€‚</p><details><summary> hystrix-goå®ç°</summary><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs golang"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;fmt&quot;</span><br><span class="hljs-string">&quot;net/http&quot;</span><br><span class="hljs-string">&quot;time&quot;</span><br><br><span class="hljs-string">&quot;github.com/afex/hystrix-go/hystrix&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-comment">// è®¾ç½®ä¸€ä¸ªå‘½ä»¤åä¸º&quot;callOutRPC&quot;çš„æ–­è·¯å™¨</span><br>hystrix.ConfigureCommand(<span class="hljs-string">&quot;callOutRPC&quot;</span>, hystrix.CommandConfig&#123;<br>Timeout:                <span class="hljs-type">int</span>(<span class="hljs-number">3</span> * time.Second), <span class="hljs-comment">// rpcè°ƒç”¨è¶…æ—¶æ—¶é—´</span><br>MaxConcurrentRequests:  <span class="hljs-number">10</span>,                   <span class="hljs-comment">// å¹¶å‘è¯·æ±‚10ä¸ªï¼Œç”¨chanelæ§åˆ¶</span><br>SleepWindow:            <span class="hljs-number">5000</span>,                 <span class="hljs-comment">//å•ä½ms, open-&gt;half open ç¡çœ çª—å£</span><br>RequestVolumeThreshold: <span class="hljs-number">10</span>,                   <span class="hljs-comment">// é™é»˜æ•°ï¼Œè¿™é‡Œå°±æ˜¯é”™è¯¯æ•°å¿…é¡»è¦&gt;=10ä¸ª</span><br>ErrorPercentThreshold:  <span class="hljs-number">30</span>,                   <span class="hljs-comment">//é”™è¯¯ç‡é˜ˆå€¼</span><br>&#125;)<br><br>_ = hystrix.Do(<span class="hljs-string">&quot;callOutRPC&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> <span class="hljs-type">error</span> &#123;<br><span class="hljs-comment">// å°è¯•è°ƒç”¨è¿œç«¯æœåŠ¡</span><br>_, err := http.Get(<span class="hljs-string">&quot;https://www.1baidu.com&quot;</span>)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> err<br>&#125;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(err <span class="hljs-type">error</span>)</span></span> <span class="hljs-type">error</span> &#123;<br><span class="hljs-comment">// å¿«é€Ÿå¤±è´¥æ—¶çš„å›è°ƒå‡½æ•°</span><br>fmt.Println(<span class="hljs-string">&quot;call rpc failed. now calling fallback logic&quot;</span>)<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;)<br>&#125;<br></code></pre></td></tr></table></figure></details><details><summary>sentinel-goå®ç°</summary><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs golang"><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span> <span class="hljs-params">()</span></span> &#123;<br>    <span class="hljs-keyword">if</span> err := InitCircuitBreaker(); err != <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-built_in">panic</span>(err)<br>    &#125;<br>    <br>e, b := sentinel.Entry(<span class="hljs-string">&quot;calleeSrv&quot;</span>)<br><span class="hljs-keyword">if</span> b != <span class="hljs-literal">nil</span> &#123;<br>    <span class="hljs-comment">// è§¦å‘ç†”æ–­</span><br>    <span class="hljs-comment">// metricä¸ŠæŠ¥</span><br><span class="hljs-keyword">return</span> ret, b<br>&#125;<br>err := callOutRpc()<br>e.Exit(base.WithError(err))<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">callOutRpc</span><span class="hljs-params">()</span></span> <span class="hljs-type">error</span> &#123;<br>    time.Sleep(<span class="hljs-number">1</span> * time.Second)<br>    <span class="hljs-keyword">return</span> errors.New(<span class="hljs-string">&quot;happend error&quot;</span>)<br>&#125;<br><span class="hljs-comment">// InitCircuitBreaker åˆå§‹åŒ–æ–­è·¯å™¨</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">InitCircuitBreaker</span><span class="hljs-params">()</span></span> <span class="hljs-type">error</span> &#123;<br>err := sentinel.InitDefault()<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> err<br>&#125;<br>defaultRules := []*circuitbreaker.Rule&#123;<br>&#123;<br>Resource:                     <span class="hljs-string">&quot;calleeSrv&quot;</span>,                  <span class="hljs-comment">// åå­—</span><br>Strategy:                     circuitbreaker.SlowRequestRatio, <span class="hljs-comment">// æ…¢æŸ¥è¯¢</span><br>RetryTimeoutMs:               <span class="hljs-number">5000</span>,                            <span class="hljs-comment">// 5såå°è¯•æ¢å¤ï¼Œè¿›å…¥halfçŠ¶æ€</span><br>MinRequestAmount:             <span class="hljs-number">100</span>,                             <span class="hljs-comment">// é™é»˜æ•° Opençš„å‰ç½®æ¡ä»¶, 100ï¼Œä¸»è¦é’ˆå¯¹çƒ­ç‚¹</span><br>StatIntervalMs:               <span class="hljs-number">2000</span>,                            <span class="hljs-comment">// 2sé’Ÿæ…¢æŸ¥è¯¢æ¯”ä¾‹ä¸è¶…è¿‡0.4</span><br>StatSlidingWindowBucketCount: <span class="hljs-number">100</span>,                             <span class="hljs-comment">// æ¯ä¸ªæ ¼å­ 20ms</span><br>MaxAllowedRtMs:               <span class="hljs-number">130</span>,                             <span class="hljs-comment">// (120 + 10(buffer)))æ¯«ç§’ä»¥å¤–ç®—æ…¢æŸ¥è¯¢</span><br>Threshold:                    <span class="hljs-number">0.5</span>,                             <span class="hljs-comment">// 5sé’Ÿæ…¢æŸ¥è¯¢æ¯”ä¾‹ä¸è¶…è¿‡0.4</span><br>ProbeNum:                     <span class="hljs-number">10</span>,<br>&#125;,<br>&#125;<br>circuitbreaker.RegisterStateChangeListeners(&amp;stateChangeTestListener&#123;&#125;)<br>_, err = circuitbreaker.LoadRules(defaultRules)<br><span class="hljs-keyword">return</span> err<br>&#125;<br><br><span class="hljs-keyword">type</span> stateChangeTestListener <span class="hljs-keyword">struct</span> &#123;<br>&#125;<br><br><span class="hljs-comment">// OnTransformToClosed è½¬æ¢è‡³å…³é—­çŠ¶æ€å›è°ƒå‡½æ•°</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *stateChangeTestListener)</span></span> OnTransformToClosed(prev circuitbreaker.State, rule circuitbreaker.Rule) &#123;<br>CircuitBreakerClosed.Inc()<br>log.Infof(<span class="hljs-string">&quot;rule.strategy: %+v, From %s to Closed, time: %v\n&quot;</span>, rule.Strategy, prev.String(),<br>util.FormatTimeMillis(util.CurrentTimeMillis()))<br><br>&#125;<br><br><span class="hljs-comment">// OnTransformToOpen è½¬æ¢è‡³å¼€å¯çŠ¶æ€å›è°ƒå‡½æ•°</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *stateChangeTestListener)</span></span> OnTransformToOpen(prev circuitbreaker.State, rule circuitbreaker.Rule,<br>snapshot <span class="hljs-keyword">interface</span>&#123;&#125;) &#123;<br>CircuitBreakerOpen.Inc()<br>log.Infof(<span class="hljs-string">&quot;rule.strategy: %+v, From %s to Open, snapshot: %.2f, time: %v\n&quot;</span>, rule.Strategy, prev.String(),<br>snapshot, util.FormatTimeMillis(util.CurrentTimeMillis()))<br>&#125;<br><br><span class="hljs-comment">// OnTransformToHalfOpen è½¬æ¢è‡³åŠå¼€çŠ¶æ€å›è°ƒå‡½æ•°</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *stateChangeTestListener)</span></span> OnTransformToHalfOpen(prev circuitbreaker.State, rule circuitbreaker.Rule) &#123;<br>CircuitBreakerHalfOpen.Inc()<br>log.Infof(<span class="hljs-string">&quot;rule.strategy: %+v, From %s to Half-Open, time: %v\n&quot;</span>, rule.Strategy, prev.String(),<br>util.FormatTimeMillis(util.CurrentTimeMillis()))<br>&#125;<br></code></pre></td></tr></table></figure></details><h3 id="è‡ªé€‚åº”æ–­è·¯å™¨ï¼šGoogle-SREæ–¹æ¡ˆ"><a href="#è‡ªé€‚åº”æ–­è·¯å™¨ï¼šGoogle-SREæ–¹æ¡ˆ" class="headerlink" title="è‡ªé€‚åº”æ–­è·¯å™¨ï¼šGoogle SREæ–¹æ¡ˆ"></a>è‡ªé€‚åº”æ–­è·¯å™¨ï¼šGoogle SREæ–¹æ¡ˆ</h3><p><img src="/images/sre_breaker.png" alt="è°·æ­Œè‡ªé€‚åº”æ–­è·¯å™¨-æ ¸å¿ƒç®—æ³•"></p><p>ä¼ ç»Ÿæ–­è·¯å™¨çš„<strong>å›ºå®šæ—¶é—´çª—å£</strong>å­˜åœ¨å±€é™æ€§ï¼š</p><ul><li>æœåŠ¡å·²æ¢å¤ä½†ä»éœ€ç­‰å¾…çª—å£ç»“æŸ</li><li>æ— æ³•æ ¹æ®å®æ—¶çŠ¶å†µåŠ¨æ€è°ƒæ•´ç­–ç•¥</li><li>åœ¨ç½‘ç»œæŠ–åŠ¨åœºæ™¯ä¸‹å¯ç”¨æ€§ä¸ä½³</li></ul><p>Google SREæå‡ºçš„<strong>è‡ªé€‚åº”é™æµç®—æ³•</strong>ï¼š</p><figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs lisp">f(<span class="hljs-name">x</span>) = max(<span class="hljs-number">0</span>, (<span class="hljs-name">requests</span> - K Ã— accepts) / (<span class="hljs-name">requests</span> + <span class="hljs-number">1</span>))<br></code></pre></td></tr></table></figure><p><strong>ç®—æ³•å‚æ•°è§£æ</strong>ï¼š</p><ul><li><code>requests</code>ï¼šæ€»è¯·æ±‚æ•°ï¼ˆæ»‘åŠ¨çª—å£å†…ï¼‰</li><li><code>accepts</code>ï¼šæˆåŠŸè¯·æ±‚æ•°ï¼ˆæ»‘åŠ¨çª—å£å†…ï¼‰  </li><li><code>K</code>ï¼šæŸ”æ€§ç³»æ•°ï¼Œæ§åˆ¶ç†”æ–­æ•æ„Ÿåº¦</li><li><code>f(x)</code>ï¼šå½“å‰è¯·æ±‚çš„æ‹’ç»æ¦‚ç‡</li></ul><h4 id="æŸ”æ€§ç³»æ•°Kçš„ä½œç”¨æœºåˆ¶"><a href="#æŸ”æ€§ç³»æ•°Kçš„ä½œç”¨æœºåˆ¶" class="headerlink" title="æŸ”æ€§ç³»æ•°Kçš„ä½œç”¨æœºåˆ¶"></a>æŸ”æ€§ç³»æ•°Kçš„ä½œç”¨æœºåˆ¶</h4><table><thead><tr><th>Kå€¼èŒƒå›´</th><th>ç†”æ–­ç‰¹æ€§</th><th>é€‚ç”¨åœºæ™¯</th><th>æ‹’ç»æ¦‚ç‡è®¡ç®—</th></tr></thead><tbody><tr><td>K &lt; 1</td><td>åˆšæ€§ç†”æ–­</td><td>ä¸¥æ ¼ä¿æŠ¤</td><td>f(x) &gt; 0 (æ— æ•…éšœæ—¶ä¹Ÿæ‹’ç»)</td></tr><tr><td>K &#x3D; 1</td><td>å¹³è¡¡ç­–ç•¥</td><td>é€šç”¨åœºæ™¯</td><td>f(x) &#x3D; 0 (æ— æ•…éšœæ—¶ä¸æ‹’ç»)</td></tr><tr><td>K &gt; 1</td><td>æŸ”æ€§ç†”æ–­</td><td>å®¹é”™åœºæ™¯</td><td>å®¹å¿éƒ¨åˆ†å¤±è´¥</td></tr></tbody></table><p><strong>å®é™…è¡¨ç°åˆ†æ</strong>ï¼š</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs stylus">æ­£å¸¸çŠ¶æ€: accepts â‰ˆ requests<br>â†’ <span class="hljs-built_in">f</span>(<span class="hljs-attribute">x</span>) â‰ˆ <span class="hljs-built_in">max</span>(<span class="hljs-number">0</span>, (requests - KÃ—requests)/(requests+<span class="hljs-number">1</span>))<br>â†’ å½“Kâ‰¥<span class="hljs-number">1</span>æ—¶ï¼Œ<span class="hljs-built_in">f</span>(<span class="hljs-attribute">x</span>) â‰ˆ <span class="hljs-number">0</span>ï¼Œä¸æ‹’ç»è¯·æ±‚<br><br>æ•…éšœçŠ¶æ€: accepts &lt; requests  <br>â†’ <span class="hljs-built_in">f</span>(<span class="hljs-attribute">x</span>) = <span class="hljs-built_in">max</span>(<span class="hljs-number">0</span>, (requests - KÃ—accepts)/(requests+<span class="hljs-number">1</span>))<br>â†’ éšç€æˆåŠŸç‡ä¸‹é™ï¼Œæ‹’ç»æ¦‚ç‡å¢åŠ <br></code></pre></td></tr></table></figure><p><strong>ä¼˜åŠ¿æ€»ç»“</strong>ï¼š</p><ul><li><strong>æ— é…ç½®è´Ÿæ‹…</strong>ï¼šä»…éœ€è°ƒèŠ‚Kå€¼ï¼Œé¿å…å¤æ‚å‚æ•°é…ç½®</li><li><strong>å®æ—¶å“åº”</strong>ï¼šåŸºäºæ»‘åŠ¨çª—å£å®æ—¶è®¡ç®—ï¼Œå“åº”é€Ÿåº¦å¿«</li><li><strong>è‡ªé€‚åº”æ€§</strong>ï¼šæ ¹æ®å®é™…æˆåŠŸç‡åŠ¨æ€è°ƒæ•´æ‹’ç»æ¦‚ç‡</li></ul><p><strong>æ€»ç»“:</strong></p><ul><li>å°‘äº†å¾ˆå¤šè‡ªå®šä¹‰é…ç½®ï¼Œå¼€å‘åªéœ€è¦è°ƒèŠ‚Kè¿™ä¸ªå˜é‡; Kè¶Šå°è¶Šæ¿€è¿›</li><li>å®æ—¶æ€§æ›´å¥½ç‚¹ï¼Œä¸ä¼šæœ‰å›ºå®šçš„ç­‰å¾…çª—å£</li></ul><p><strong>ä»£ç å®ç°</strong><br>å¯ä»¥å‚è€ƒ<a href="https://github.com/go-kratos/kratos/blob/v1.0.x/pkg/net/netutil/breaker/sre_breaker.go">Bç«™å®ç°</a></p><p><img src="/images/bilibili_sre.png" alt="Bç«™ä½¿ç”¨æ•ˆæœ"></p><h2 id="è¶…æ—¶æ§åˆ¶ï¼šæ—¶é—´è¾¹ç•Œç®¡ç†"><a href="#è¶…æ—¶æ§åˆ¶ï¼šæ—¶é—´è¾¹ç•Œç®¡ç†" class="headerlink" title="è¶…æ—¶æ§åˆ¶ï¼šæ—¶é—´è¾¹ç•Œç®¡ç†"></a>è¶…æ—¶æ§åˆ¶ï¼šæ—¶é—´è¾¹ç•Œç®¡ç†</h2><h3 id="è¶…æ—¶æ§åˆ¶çš„æ ¸å¿ƒä»·å€¼"><a href="#è¶…æ—¶æ§åˆ¶çš„æ ¸å¿ƒä»·å€¼" class="headerlink" title="è¶…æ—¶æ§åˆ¶çš„æ ¸å¿ƒä»·å€¼"></a>è¶…æ—¶æ§åˆ¶çš„æ ¸å¿ƒä»·å€¼</h3><p><strong>èµ„æºç®¡ç†è§’åº¦</strong>ï¼š</p><ul><li>é˜²æ­¢çº¿ç¨‹&#x2F;åç¨‹é•¿æ—¶é—´å ç”¨ï¼Œå¯¼è‡´èµ„æºè€—å°½</li><li>æ§åˆ¶æ•°æ®åº“è¿æ¥æ± ã€HTTPè¿æ¥æ± çš„ä½¿ç”¨æ—¶é•¿</li><li>é¿å…å†…å­˜æ³„æ¼å’Œæ–‡ä»¶æè¿°ç¬¦æ³„æ¼</li></ul><p><strong>æ•…éšœä¼ æ’­è§’åº¦</strong>ï¼š</p><ul><li>å¿«é€Ÿå¤±è´¥ï¼Œé¿å…æ•…éšœå‘ä¸Šæ¸¸æ‰©æ•£</li><li>å‡å°‘çº§è”è¶…æ—¶å¯¼è‡´çš„æœåŠ¡é›ªå´©</li><li>ä¿éšœç³»ç»Ÿæ•´ä½“å“åº”æ—¶é—´SLA</li></ul><h3 id="è¶…æ—¶ç­–ç•¥åˆ†ç±»"><a href="#è¶…æ—¶ç­–ç•¥åˆ†ç±»" class="headerlink" title="è¶…æ—¶ç­–ç•¥åˆ†ç±»"></a>è¶…æ—¶ç­–ç•¥åˆ†ç±»</h3><table><thead><tr><th>ç­–ç•¥ç±»å‹</th><th>å®ç°æ–¹å¼</th><th>ä¼˜åŠ¿</th><th>åŠ£åŠ¿</th><th>é€‚ç”¨åœºæ™¯</th></tr></thead><tbody><tr><td>å›ºå®šè¶…æ—¶</td><td>é™æ€é…ç½®</td><td>ç®€å•å¯æ§</td><td>æ— æ³•é€‚åº”å˜åŒ–</td><td>ç¨³å®šç½‘ç»œç¯å¢ƒ</td></tr><tr><td>åŠ¨æ€è¶…æ—¶</td><td>EMAç®—æ³•</td><td>è‡ªé€‚åº”è°ƒæ•´</td><td>å®ç°å¤æ‚</td><td>ç½‘ç»œæ³¢åŠ¨è¾ƒå¤§</td></tr><tr><td>åˆ†å±‚è¶…æ—¶</td><td>é“¾è·¯ä¼ é€’</td><td>ç²¾ç¡®æ§åˆ¶</td><td>é…ç½®å¤æ‚</td><td>å¾®æœåŠ¡è°ƒç”¨é“¾</td></tr></tbody></table><h3 id="å›ºå®šè¶…æ—¶"><a href="#å›ºå®šè¶…æ—¶" class="headerlink" title="å›ºå®šè¶…æ—¶"></a>å›ºå®šè¶…æ—¶</h3><ul><li>é“¾è·¯è¶…æ—¶</li><li>æœåŠ¡å†…è¶…æ—¶</li></ul><h4 id="é“¾è·¯è¶…æ—¶ä¼ é€’æœºåˆ¶"><a href="#é“¾è·¯è¶…æ—¶ä¼ é€’æœºåˆ¶" class="headerlink" title="é“¾è·¯è¶…æ—¶ä¼ é€’æœºåˆ¶"></a>é“¾è·¯è¶…æ—¶ä¼ é€’æœºåˆ¶</h4><p><strong>åœºæ™¯è®¾å®š</strong>ï¼šè°ƒç”¨é“¾ Aâ†’Bâ†’Cï¼Œæ€»é¢„ç®—1000ms</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs makefile">æ—¶é—´è½´ç¤ºä¾‹ï¼š<br><span class="hljs-section">AæœåŠ¡: [0ms â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 300ms] å‰©ä½™700msä¼ é€’ç»™B</span><br><span class="hljs-section">BæœåŠ¡:   [300ms â”€â”€â”€â”€ 500ms] å‰©ä½™500msä¼ é€’ç»™C  </span><br><span class="hljs-section">CæœåŠ¡:     [500ms â”€â”€ 600ms] å‰©ä½™400ms</span><br><br>å…³é”®ç®—æ³•ï¼š<br>remaining_timeout = min(config_timeout, parent_deadline - current_time)<br></code></pre></td></tr></table></figure><p><strong>ä¼ é€’è§„åˆ™</strong>ï¼š</p><ol><li>æ¯å±‚æœåŠ¡è®¡ç®—å‰©ä½™æ—¶é—´ï¼š<code>deadline - current_time</code></li><li>å–æœ¬åœ°é…ç½®ä¸å‰©ä½™æ—¶é—´çš„æœ€å°å€¼</li><li>é€šè¿‡gRPCçš„<code>grpc-timeout</code>å¤´éƒ¨æˆ–HTTPå¤´éƒ¨ä¼ é€’</li></ol><p><img src="/images/timeout_propagation.png" alt="é“¾è·¯è¶…æ—¶ä¼ é€’"></p><p><strong>å¦‚ä½•ä¼ é€’?</strong></p><ul><li>grpcä¸­æ˜¯é€šè¿‡http2çš„HEADERS Frameé€ä¼ ï¼Œ <code>grpc-timeout</code> å­—æ®µ</li></ul><h4 id="æœåŠ¡å†…è¶…æ—¶ä¼˜åŒ–"><a href="#æœåŠ¡å†…è¶…æ—¶ä¼˜åŒ–" class="headerlink" title="æœåŠ¡å†…è¶…æ—¶ä¼˜åŒ–"></a>æœåŠ¡å†…è¶…æ—¶ä¼˜åŒ–</h4><p><strong>é—®é¢˜åœºæ™¯</strong>ï¼šæœåŠ¡æ€»è¶…æ—¶600msï¼Œä¸²è¡Œè°ƒç”¨A(500ms)â†’B(300ms)â†’C(100ms)</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// åŸå§‹å®ç° - å¯èƒ½è¶…æ—¶</span><br>ctx, cancel := context.WithTimeout(ctx, <span class="hljs-number">600</span>*time.Millisecond)<br><span class="hljs-keyword">defer</span> cancel()<br><br>callA(ctx) <span class="hljs-comment">// è€—æ—¶500ms</span><br>callB(ctx) <span class="hljs-comment">// é…ç½®300msä½†å®é™…åªå‰©100msï¼Œä»ç­‰å¾…300ms</span><br></code></pre></td></tr></table></figure><p><strong>ä¼˜åŒ–æ–¹æ¡ˆ</strong>ï¼šåŠ¨æ€è®¡ç®—å‰©ä½™æ—¶é—´</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">optimizedTimeout</span><span class="hljs-params">(parentCtx context.Context, configTimeout time.Duration)</span></span> time.Duration &#123;<br>    <span class="hljs-keyword">if</span> deadline, ok := parentCtx.Deadline(); ok &#123;<br>        remaining := time.Until(deadline)<br>        <span class="hljs-keyword">return</span> min(configTimeout, remaining)<br>    &#125;<br>    <span class="hljs-keyword">return</span> configTimeout<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>æ•ˆæœå¯¹æ¯”</strong>ï¼š</p><ul><li>ä¼˜åŒ–å‰ï¼šå³ä½¿å‰©ä½™10msï¼Œä»ç­‰å¾…å®Œæ•´çš„300msé…ç½®æ—¶é—´</li><li>ä¼˜åŒ–åï¼šåŠ¨æ€è°ƒæ•´ä¸ºmin(300ms, 10ms) &#x3D; 10ms<br><strong>å¦‚ä½•ä¼ é€’?</strong><details><summary> åˆ©ç”¨context.WithTimeout å®ç°</summary></li></ul><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">package main<br><br><span class="hljs-keyword">import</span> (<br>&quot;context&quot;<br>&quot;fmt&quot;<br>&quot;log&quot;<br>&quot;time&quot;<br>)<br><br>func main() &#123;<br>// åˆ›å»ºä¸€ä¸ªä¸Šä¸‹æ–‡ï¼Œå¹¶è®¾ç½®æ€»è¶…æ—¶æ—¶é—´ä¸º<span class="hljs-number">600</span>æ¯«ç§’<br>ctx, cancel := context.WithTimeout(context.Background(), <span class="hljs-number">600</span>*<span class="hljs-type">time</span>.Millisecond)<br>defer cancel()<br><br>// å¯åŠ¨Aã€Bã€Cä¸‰ä¸ªè°ƒç”¨ï¼Œå¹¶ä¼ é€’çˆ¶ä¸Šä¸‹æ–‡<br>callA(ctx)<br>callB(ctx)<br>callC(ctx)<br><br>// ç­‰å¾…<span class="hljs-number">1</span>ç§’é’Ÿï¼Œç­‰å¾…æ‰€æœ‰è°ƒç”¨å®Œæˆ<br><span class="hljs-type">time</span>.Sleep(<span class="hljs-type">time</span>.Second)<br>&#125;<br><br>func callA(parentCtx context.Context) &#123;<br>// æ ¹æ®çˆ¶ä¸Šä¸‹æ–‡çš„æˆªæ­¢æ—¶é—´è®¡ç®—Aè°ƒç”¨çš„è¶…æ—¶æ—¶é—´<br>deadline, ok := parentCtx.Deadline()<br><span class="hljs-keyword">if</span> !ok &#123;<br><span class="hljs-keyword">log</span>.Println(&quot;Parent context does not have a deadline&quot;)<br><span class="hljs-keyword">return</span><br>&#125;<br>timeout := <span class="hljs-number">500</span> * <span class="hljs-type">time</span>.Millisecond<br><span class="hljs-keyword">if</span> timeout &gt; <span class="hljs-type">time</span>.<span class="hljs-keyword">Until</span>(deadline) &amp;&amp; <span class="hljs-type">time</span>.Now().<span class="hljs-keyword">Before</span>(deadline) &#123;<br>timeout = <span class="hljs-type">time</span>.<span class="hljs-keyword">Until</span>(deadline)<br>&#125;<br>fmt.Println(&quot;callA---&gt;&quot;, <span class="hljs-type">time</span>.<span class="hljs-keyword">Until</span>(deadline))<br><br>// åˆ›å»ºä¸€ä¸ªå­ä¸Šä¸‹æ–‡ï¼Œå¹¶è®¾ç½®Aè°ƒç”¨çš„è¶…æ—¶æ—¶é—´<br>ctx, cancel := context.WithTimeout(parentCtx, timeout)<br>defer cancel()<br><br><span class="hljs-keyword">select</span> &#123;<br><span class="hljs-keyword">case</span> &lt;-<span class="hljs-type">time</span>.<span class="hljs-keyword">After</span>(<span class="hljs-number">500</span> * <span class="hljs-type">time</span>.Millisecond):<br><span class="hljs-keyword">log</span>.Println(&quot;Call A completed&quot;)<br><span class="hljs-keyword">case</span> &lt;-ctx.Done():<br><span class="hljs-keyword">log</span>.Println(&quot;Call A timed out&quot;)<br>&#125;<br>&#125;<br><br>func callB(parentCtx context.Context) &#123;<br>// æ ¹æ®çˆ¶ä¸Šä¸‹æ–‡çš„æˆªæ­¢æ—¶é—´è®¡ç®—Bè°ƒç”¨çš„è¶…æ—¶æ—¶é—´<br>deadline, ok := parentCtx.Deadline()<br><span class="hljs-keyword">if</span> !ok &#123;<br><span class="hljs-keyword">log</span>.Println(&quot;Parent context does not have a deadline&quot;)<br><span class="hljs-keyword">return</span><br>&#125;<br>fmt.Println(&quot;callB---&gt;&quot;, <span class="hljs-type">time</span>.<span class="hljs-keyword">Until</span>(deadline))<br>timeout := <span class="hljs-number">300</span> * <span class="hljs-type">time</span>.Millisecond<br><span class="hljs-keyword">if</span> timeout &gt; <span class="hljs-type">time</span>.<span class="hljs-keyword">Until</span>(deadline) &amp;&amp; <span class="hljs-type">time</span>.Now().<span class="hljs-keyword">Before</span>(deadline) &#123;<br>timeout = <span class="hljs-type">time</span>.<span class="hljs-keyword">Until</span>(deadline)<br>&#125;<br><br>// åˆ›å»ºä¸€ä¸ªå­ä¸Šä¸‹æ–‡ï¼Œå¹¶è®¾ç½®Bè°ƒç”¨çš„è¶…æ—¶æ—¶é—´<br>ctx, cancel := context.WithTimeout(parentCtx, timeout)<br>defer cancel()<br><br><span class="hljs-keyword">select</span> &#123;<br><span class="hljs-keyword">case</span> &lt;-<span class="hljs-type">time</span>.<span class="hljs-keyword">After</span>(<span class="hljs-number">300</span> * <span class="hljs-type">time</span>.Millisecond):<br><span class="hljs-keyword">log</span>.Println(&quot;Call B completed&quot;)<br><span class="hljs-keyword">case</span> &lt;-ctx.Done():<br><span class="hljs-keyword">log</span>.Println(&quot;Call B timed out&quot;)<br>&#125;<br>&#125;<br><br>func callC(parentCtx context.Context) &#123;<br>// æ ¹æ®çˆ¶ä¸Šä¸‹æ–‡çš„æˆªæ­¢æ—¶é—´è®¡ç®—Cè°ƒç”¨çš„è¶…æ—¶æ—¶é—´<br>deadline, ok := parentCtx.Deadline()<br><span class="hljs-keyword">if</span> !ok &#123;<br><span class="hljs-keyword">log</span>.Println(&quot;Parent context does not have a deadline&quot;)<br><span class="hljs-keyword">return</span><br>&#125;<br><br>timeout := <span class="hljs-number">100</span> * <span class="hljs-type">time</span>.Millisecond<br><span class="hljs-keyword">if</span> timeout &gt; <span class="hljs-type">time</span>.<span class="hljs-keyword">Until</span>(deadline) &amp;&amp; <span class="hljs-type">time</span>.Now().<span class="hljs-keyword">Before</span>(deadline) &#123;<br>timeout = <span class="hljs-type">time</span>.<span class="hljs-keyword">Until</span>(deadline)<br>&#125;<br>// åˆ›å»ºä¸€ä¸ªå­ä¸Šä¸‹æ–‡ï¼Œå¹¶è®¾ç½®Cè°ƒç”¨çš„è¶…æ—¶æ—¶é—´<br>ctx, cancel := context.WithTimeout(parentCtx, timeout)<br>defer cancel()<br><br><span class="hljs-keyword">select</span> &#123;<br><span class="hljs-keyword">case</span> &lt;-<span class="hljs-type">time</span>.<span class="hljs-keyword">After</span>(<span class="hljs-number">100</span> * <span class="hljs-type">time</span>.Millisecond):<br><span class="hljs-keyword">log</span>.Println(&quot;Call C completed&quot;)<br><span class="hljs-keyword">case</span> &lt;-ctx.Done():<br><span class="hljs-keyword">log</span>.Println(&quot;Call C timed out&quot;)<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure></details><h3 id="EMAåŠ¨æ€è¶…æ—¶ç®—æ³•"><a href="#EMAåŠ¨æ€è¶…æ—¶ç®—æ³•" class="headerlink" title="EMAåŠ¨æ€è¶…æ—¶ç®—æ³•"></a>EMAåŠ¨æ€è¶…æ—¶ç®—æ³•</h3><p><strong>ä¼ ç»Ÿé™æ€è¶…æ—¶çš„å±€é™æ€§</strong>ï¼š</p><ul><li>åŸºäºå†å²P90&#x2F;P95è®¾ç½®ï¼Œæ— æ³•é€‚åº”å®æ—¶å˜åŒ–</li><li>ç½‘ç»œæŠ–åŠ¨æ—¶äº§ç”Ÿå¤§é‡é•¿å°¾è¯·æ±‚</li><li>å›ºå®šå€¼æ— æ³•å¹³è¡¡å¯ç”¨æ€§ä¸æ€§èƒ½</li></ul><p><strong>EMAåŠ¨æ€è¶…æ—¶åŸç†</strong>ï¼š<br>é€šè¿‡æŒ‡æ•°ç§»åŠ¨å¹³å‡ç®—æ³•ï¼Œæ ¹æ®å®æ—¶å“åº”æ—¶é—´åŠ¨æ€è°ƒæ•´è¶…æ—¶é˜ˆå€¼ï¼Œåœ¨ç½‘ç»œè´¨é‡å¥½æ—¶é€‚å½“å»¶é•¿è¶…æ—¶æ—¶é—´æå‡æˆåŠŸç‡ï¼Œç½‘ç»œè´¨é‡å·®æ—¶ç¼©çŸ­è¶…æ—¶æ—¶é—´å¿«é€Ÿå¤±è´¥ã€‚<br><img src="/images/ema.png" alt="EMAåŠ¨æ€è¶…æ—¶æ§åˆ¶ç®—æ³•"></p><p><strong>ç®—æ³•æ ¸å¿ƒé€»è¾‘</strong>ï¼š</p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs abnf">å½“ EMA â‰¤ Tavg æ—¶ï¼šTdto <span class="hljs-operator">=</span> Tmax  (ç½‘ç»œè´¨é‡å¥½ï¼Œå…è®¸æ›´é•¿è¶…æ—¶)<br>å½“ EMA â‰¥ Thwm æ—¶ï¼šTdto <span class="hljs-operator">=</span> Thwm  (ç½‘ç»œè´¨é‡å·®ï¼Œä½¿ç”¨åŸºå‡†è¶…æ—¶)<br>å½“ Tavg &lt; EMA &lt; Thwm æ—¶ï¼šçº¿æ€§æ’å€¼è®¡ç®—<br></code></pre></td></tr></table></figure><p><strong>å‚æ•°è¯´æ˜</strong>ï¼š</p><ul><li><code>Tavg</code>ï¼šæœ€ä½å“åº”æ—¶é—´åŸºçº¿ï¼Œé€šå¸¸ç”¨å†å²å‡å€¼</li><li><code>Thwm</code>ï¼šè¶…æ—¶æ—¶é—´é™åˆ¶ï¼Œç¡®ä¿æœ€åæƒ…å†µä¸‹çš„å¤„ç†èƒ½åŠ›</li><li><code>Tmax</code>ï¼šæœ€å¤§å¼¹æ€§æ—¶é—´ï¼Œç½‘ç»œè‰¯å¥½æ—¶çš„å®½æ¾è¶…æ—¶</li><li><code>N</code>ï¼šå¹³æ»‘æŒ‡æ•°ï¼Œæ§åˆ¶å¯¹æ–°æ•°æ®çš„æ•æ„Ÿåº¦</li></ul><p>ä»£ç å®ç°:</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><code class="hljs golang"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;fmt&quot;</span><br><span class="hljs-string">&quot;math&quot;</span><br><span class="hljs-string">&quot;math/rand&quot;</span><br>)<br><br><span class="hljs-keyword">type</span> Ema <span class="hljs-keyword">struct</span> &#123;<br>options <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">float64</span><br>ema     <span class="hljs-type">float64</span><br>r       <span class="hljs-type">float64</span><br>&#125;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">*      Tavg: æœ€ä½å“åº”æ—¶é—´ï¼Œ ä¸€èˆ¬ç”¨å¹³å‡å“åº”æ—¶é—´æ›¿ä»£ (ms)</span><br><span class="hljs-comment">*      Thwmï¼šè¶…æ—¶æ—¶é—´é™åˆ¶ï¼Œ ç¡®ä¿æœ€åçš„æ—¶å€™ï¼Œæ‰€æœ‰è¯·æ±‚èƒ½å¤„ç†ã€‚æ­£å¸¸æ—¶æ­£ç¡®å¤„ç†çš„æˆåŠŸç‡æ»¡è¶³éœ€æ±‚ã€‚ (ms)</span><br><span class="hljs-comment">*      Tmax: æœ€å¤§å¼¹æ€§æ—¶é—´ (ms)</span><br><span class="hljs-comment">*      N: å¹³æ»‘æŒ‡æ•°ï¼Œ å¹³æ»‘å› å­å†³å®šäº†æœ€æ–°æ•°æ®çš„æƒé‡ï¼Œè¶Šå¤§ï¼Œæœ€æ–°æ•°æ®çš„æƒé‡è¶Šé«˜ï¼ŒEMAå¯¹æ•°æ®çš„å˜åŒ–æ›´åŠ æ•æ„Ÿã€‚è€Œæ—§æ•°æ®çš„æƒé‡åˆ™é€šè¿‡(1-Î±)è¿›è¡Œè¡°å‡ï¼Œéšç€æ—¶é—´çš„æ¨ç§»ï¼Œæ—§æ•°æ®çš„å½±å“é€æ¸å‡å°ã€‚</span><br><span class="hljs-comment">*/</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewEma</span><span class="hljs-params">()</span></span> *Ema &#123;<br>options = <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">float64</span>&#123;<br><span class="hljs-string">&quot;Tavg&quot;</span>: <span class="hljs-number">60</span>,<br><span class="hljs-string">&quot;Thwm&quot;</span>: <span class="hljs-number">250</span>, <span class="hljs-comment">//è¶…æ—¶æ—¶é—´</span><br><span class="hljs-string">&quot;Tmax&quot;</span>: <span class="hljs-number">500</span>, <span class="hljs-comment">//æœ€å¤§è¶…æ—¶æ—¶é—´</span><br><span class="hljs-string">&quot;N&quot;</span>:    <span class="hljs-number">50</span>,<br>&#125;<br><span class="hljs-keyword">return</span> &amp;Ema&#123;<br>options: options,<br>ema:     <span class="hljs-number">0</span>, <span class="hljs-comment">//å¹³å‡å“åº”æ—¶é—´</span><br>r:       <span class="hljs-number">2</span> / (options[<span class="hljs-string">&quot;N&quot;</span>] + <span class="hljs-number">1</span>),<br>&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(e *Ema)</span></span> Update(x <span class="hljs-type">float64</span>) <span class="hljs-type">float64</span> &#123;<br><span class="hljs-comment">// æ»¡è¶³æŒ‡æ•°æ»‘åŠ¨å¹³å‡å€¼</span><br>ema := x*e.r + e.ema*(<span class="hljs-number">1</span>-e.r)<br>e.ema = ema<br><span class="hljs-keyword">return</span> ema<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(e *Ema)</span></span> Get() <span class="hljs-type">float64</span> &#123;<br><span class="hljs-keyword">var</span> tdto <span class="hljs-type">float64</span><br><span class="hljs-keyword">if</span> e.ema &lt;= e.options[<span class="hljs-string">&quot;Tavg&quot;</span>] &#123;<br>tdto = e.options[<span class="hljs-string">&quot;Tmax&quot;</span>]<br>&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> e.ema &gt;= e.options[<span class="hljs-string">&quot;Thwm&quot;</span>] &#123;<br>tdto = e.options[<span class="hljs-string">&quot;Thwm&quot;</span>]<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>p := (e.options[<span class="hljs-string">&quot;Thwm&quot;</span>] - e.ema) / (e.options[<span class="hljs-string">&quot;Thwm&quot;</span>] - e.options[<span class="hljs-string">&quot;Tavg&quot;</span>])<br>tdto = e.options[<span class="hljs-string">&quot;Thwm&quot;</span>] + p*(e.options[<span class="hljs-string">&quot;Tmax&quot;</span>]-e.options[<span class="hljs-string">&quot;Thwm&quot;</span>])<br>&#125;<br><span class="hljs-keyword">return</span> math.Abs(tdto)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>ema := NewEma()<br><br><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100</span>; i++ &#123;<br>a := rand.Float64() * <span class="hljs-number">200</span><br>e := ema.Update(a)<br>t := ema.Get()<br>fmt.Println(a, e, t)<br>&#125;<br><br><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100</span>; i++ &#123;<br>a := rand.Float64()*<span class="hljs-number">200</span> + <span class="hljs-number">500</span><br>e := ema.Update(a)<br>t := ema.Get()<br>fmt.Println(a, e, t)<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>ä½¿ç”¨åœºæ™¯ä¸å‚æ•°è°ƒä¼˜</strong>ï¼š</p><table><thead><tr><th>é“¾è·¯ç±»å‹</th><th>Tavg</th><th>Thwm</th><th>Tmax</th><th>è°ƒä¼˜ç›®æ ‡</th></tr></thead><tbody><tr><td>å…³é”®é“¾è·¯</td><td>50ms</td><td>500ms</td><td>1000ms</td><td>å®¹å¿ç½‘ç»œæŠ–åŠ¨ï¼Œé¿å…è¯¯æ€</td></tr><tr><td>éå…³é”®é“¾è·¯</td><td>30ms</td><td>200ms</td><td>300ms</td><td>å¿«é€Ÿå¤±è´¥ï¼ŒèŠ‚çœèµ„æº</td></tr><tr><td>æ‰¹å¤„ç†é“¾è·¯</td><td>100ms</td><td>2000ms</td><td>5000ms</td><td>å¹³è¡¡ååä¸å»¶è¿Ÿ</td></tr></tbody></table><h3 id="è¶…æ—¶æ—¶é—´è®¾å®šæœ€ä½³å®è·µ"><a href="#è¶…æ—¶æ—¶é—´è®¾å®šæœ€ä½³å®è·µ" class="headerlink" title="è¶…æ—¶æ—¶é—´è®¾å®šæœ€ä½³å®è·µ"></a>è¶…æ—¶æ—¶é—´è®¾å®šæœ€ä½³å®è·µ</h3><p><strong>é™æ€è¶…æ—¶è®¾å®š</strong>ï¼š</p><ul><li><strong>æ–°æœåŠ¡</strong>ï¼šåŸºäºå‹æµ‹æ•°æ®çš„P95 + 20%å®‰å…¨è¾¹ç•Œ</li><li><strong>å­˜é‡æœåŠ¡</strong>ï¼šåˆ†æ30å¤©å†…P99æ•°æ®ï¼Œæ’é™¤å¼‚å¸¸æ¯›åˆº</li><li><strong>å…³é”®é“¾è·¯</strong>ï¼šP90 + ç½‘ç»œRTT + å®‰å…¨è¾¹ç•Œ</li></ul><p><strong>ç›‘æ§æŒ‡æ ‡</strong>ï¼š</p><ul><li>è¶…æ—¶ç‡æ§åˆ¶åœ¨0.1%-1%ä¹‹é—´</li><li>å¹³å‡å“åº”æ—¶é—´&#x2F;è¶…æ—¶æ—¶é—´æ¯”å€¼åœ¨0.3-0.6ä¹‹é—´</li><li>è¶…æ—¶åˆ†å¸ƒé›†ä¸­åœ¨å°‘æ•°æ…¢æŸ¥è¯¢åœºæ™¯</li></ul><h2 id="é™çº§"><a href="#é™çº§" class="headerlink" title="é™çº§"></a>é™çº§</h2><p>é™çº§ä¸€èˆ¬æœ‰ä»¥ä¸‹å‡ ç§ç­–ç•¥</p><ul><li>ä¸€è‡´æ€§é™çº§ï¼Œå¼ºä¸€è‡´å˜å¼±ä¸€è‡´</li><li>åŠŸèƒ½é™çº§ï¼Œä¸‹çº¿éæ ¸å¿ƒåŠŸèƒ½</li><li>ç”¨æˆ·ä½“éªŒé™çº§, ä¸å±•ç¤ºç”¨æˆ·æ ‡ç­¾ã€ä¸ªæ€§åŒ–ä¿¡æ¯ç­‰</li><li>åŒæ­¥è½¬å¼‚æ­¥ï¼ŒåŒæ­¥é€»è¾‘è½¬åŒ–ä¸ºå¼‚æ­¥ï¼Œä¼šæœ‰äº›å»¶è¿Ÿ</li></ul><p>é™çº§ä¸€èˆ¬éƒ½å’Œé™æµã€ç†”æ–­æ”¾åœ¨ä¸€èµ·è®¨è®ºï¼Œé€‚åˆå…·ä½“é—®é¢˜å…·ä½“åˆ†æï¼Œæœ¬è´¨æ˜¯æä¾›æœ‰æŸæœåŠ¡ã€‚è¿™é‡Œå°±ä¸å¤šä»‹ç»ç†è®ºå†…å®¹ï¼Œæˆ‘ç»™å¤§å®¶ä¸¾å‡ ä¸ªå®é™…åœºæ™¯ï¼Œæ„Ÿå—ä¸‹å³å¯ã€‚</p><ol><li>åŒ11ä¸ºäº†èŠ‚çœèµ„æºï¼Œtbæˆ–pddä¼šæš‚æ—¶å…³é—­é€€è´§åŠŸèƒ½</li><li>è§†é¢‘å¹³å°æ¨èé¡µä¼šç¼“å­˜é¦–é¡µçš„æ•°æ®ï¼Œé˜²æ­¢è¿›æ¥å°±æ˜¯ç™½é¡µ</li><li>è¯„è®ºåˆ—è¡¨é‡Œæœ‰ç”¨æˆ·çš„å„ç§ä¿¡æ¯ï¼Œæ¯”å¦‚å‹‹ç« ç­‰èº«ä»½ä¿¡æ¯ï¼Œå¦‚æœè·å–å¤±è´¥è¿™é‡Œè¿”å›ç©º</li><li>è¿˜æœ‰ä¸€äº›è®¡æ•°åœºæ™¯ï¼Œappè¯„è®º&#x2F;ç‚¹èµï¼Œå¦‚æœæ˜¯åŒæ­¥æ“ä½œï¼Œå¾ˆå®¹æ˜“å› ä¸ºç½‘ç»œé—®é¢˜ç›´æ¥æŠ¥é”™ä½“éªŒä¸å¥½ã€‚ä¸€èˆ¬éƒ½æ˜¯å¼‚æ­¥é™é»˜æäº¤ï¼Œé¡µé¢åšå‡æ˜¾ã€‚</li></ol><h2 id="é‡è¯•"><a href="#é‡è¯•" class="headerlink" title="é‡è¯•"></a>é‡è¯•</h2><h3 id="é‡è¯•è¯†åˆ«"><a href="#é‡è¯•è¯†åˆ«" class="headerlink" title="é‡è¯•è¯†åˆ«"></a>é‡è¯•è¯†åˆ«</h3><p>å¯ä»¥é€šè¿‡http staus codeè¯†åˆ«é”™è¯¯ç±»å‹ï¼Œæ¯”å¦‚4xxç±»å‹æ˜æ˜¾å°±æ˜¯è¯·æ±‚æœ‰é—®é¢˜å°±åˆ«é‡è¯•äº†ï¼›è¿˜æœ‰äº›æƒ…å†µå¯èƒ½éœ€è¦æ ¹æ®å“åº”ä¸­codeç å»è¯†åˆ«ï¼Œæ¯”å¦‚å‚æ•°é”™è¯¯ã€é‰´æƒå¤±è´¥ç­‰ä¹Ÿä¸åº”è¯¥é‡è¯•ã€‚</p><h3 id="é‡è¯•ç­–ç•¥"><a href="#é‡è¯•ç­–ç•¥" class="headerlink" title="é‡è¯•ç­–ç•¥"></a>é‡è¯•ç­–ç•¥</h3><p>ç¡®è®¤é‡è¯•ä¹‹å, é¦–å…ˆè¦é™åˆ¶é‡è¯•çš„æ¯”ä¾‹ï¼Œå…¶æ¬¡é‡ç‚¹å…³æ³¨é‡è¯•æ¬¡æ•°å’Œé‡è¯•é—´éš”ï¼Œé‡è¯•é—´éš”æˆ‘ä»¬å¯ä»¥é‡‡ç”¨ä»¥ä¸‹ç­–ç•¥:</p><ul><li>å›ºå®šé—´éš”, interval: base; å®ç°ç®€å•ä½†æ˜¯è¿™ç§ç­–ç•¥å¾ˆå®¹æ˜“å‡ºç°é‡è¯•æ³¢å³°</li><li>éšæœºé—´éš”, interval: base + rand; æ‰“æ•£é‡è¯•æ—¶é—´ï¼Œå‡å°‘é‡è¯•æ³¢å³°ï¼›è™½ç„¶æ¯ä¸ªè¯·æ±‚é‡è¯•æ—¶é—´ä¸ä¸€æ ·ï¼Œä½†æ˜¯ä¸‹æ¸¸å¦‚æœçŸ­æ—¶é—´å†…ä¸èƒ½æ¢å¤ï¼Œå°±ä¼šæ”¶åˆ°å¤§é‡è¯·æ±‚å¯èƒ½ä¼šé€ æˆæœåŠ¡é›ªå´©ã€‚</li><li>éšæœº + æŒ‡æ•°é€€é¿, interval: (exp)^retryNum + rand; å‡å°‘äº†é‡è¯•æ³¢å³°ä»¥åŠå¯¹ä¸‹æ¸¸çš„é‡è¯•å‹åŠ›ï¼›è¶…æ—¶é…ç½®éœ€è¦æ³¨æ„ï¼Œä¸è¦å½±å“æ ¸å¿ƒé“¾è·¯çš„è€—æ—¶</li></ul><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs golang"><br><span class="hljs-keyword">type</span> RetryStrategy <span class="hljs-type">int</span><br><br><span class="hljs-keyword">const</span> (<br>Fixed  RetryStrategy = <span class="hljs-number">0</span> <span class="hljs-comment">// å›ºå®šå€¼, n, n, n...</span><br>Linear RetryStrategy = <span class="hljs-number">1</span> <span class="hljs-comment">// çº¿æ€§, n, 2n, 3n...</span><br>Exp    RetryStrategy = <span class="hljs-number">2</span> <span class="hljs-comment">// æŒ‡æ•°, n, 2n, 4n, 8n...</span><br>Rand   RetryStrategy = <span class="hljs-number">3</span> <span class="hljs-comment">// éšæœº, [n, 2n]</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">sleep</span><span class="hljs-params">(i, milliSec <span class="hljs-type">int</span>, s RetryStrategy)</span></span> time.Duration &#123;<br>n := milliSec<br><span class="hljs-keyword">switch</span> s &#123;<br><span class="hljs-keyword">case</span> Linear:<br>n = i*milliSec + milliSec<br><span class="hljs-keyword">case</span> Exp:<br>n = <span class="hljs-type">int</span>(math.Pow(<span class="hljs-number">2</span>, <span class="hljs-type">float64</span>(i))) * milliSec<br><span class="hljs-keyword">case</span> Rand:<br>n = rand.Intn(milliSec+<span class="hljs-number">1</span>) + milliSec<br><span class="hljs-keyword">default</span>:<br>&#125;<br><span class="hljs-keyword">return</span> time.Millisecond * time.Duration(n)<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="å¯¹å†²ç­–ç•¥"><a href="#å¯¹å†²ç­–ç•¥" class="headerlink" title="å¯¹å†²ç­–ç•¥"></a>å¯¹å†²ç­–ç•¥</h3><p>è¿™ä¸ªæ¦‚å¿µæºè‡ªGRPC, æ˜¯æŒ‡åœ¨ä¸ç­‰å¾…å“åº”çš„æƒ…å†µä¸‹ä¸»è°ƒä¸»åŠ¨å‘é€å¤šä¸ªè¯·æ±‚ï¼Œæœ¬è´¨æ˜¯æ›´åŠ æ¿€è¿›çš„é‡è¯•ã€‚ é€‚ç”¨äºä¸€äº›æµé‡ä¸å¤§çš„åœºæ™¯ï¼Œå¯ä»¥ç¼“è§£çŸ­æš‚ç½‘ç»œæŠ–åŠ¨å¯¼è‡´çš„é•¿å°¾è¯·æ±‚ï¼Œä¸è¿‡ä¸€å®šç¡®è®¤å¥½é‡è¯•å¯¹ä¸‹æ¸¸è´Ÿè½½çš„å½±å“ã€‚<br>å¦‚ä¸‹å›¾ï¼Œå‡è®¾ä¸»è°ƒå’Œè¢«è°ƒè¶…æ—¶æ—¶é—´ä¸º60msï¼Œç¬¬ä¸€ä¸ªè¯·æ±‚å‘å‡ºä¹‹åä¼šè§¦å‘ä¸€ä¸ª10mså®šæ—¶å™¨, å‡è®¾ä¸»è°ƒåœ¨10mså†…æ²¡æœ‰æ”¶åˆ°å“åº”ï¼Œå®šæ—¶å™¨å°±ä¼šè§¦å‘ç«‹å³å‘é€é‡è¯•è¯·æ±‚ï¼Œå¦‚æœé‡è¯•è¯·æ±‚å“åº”å…ˆè¿”å›äº†ï¼Œå°±ä¼šç«‹å³è¿”å›ï¼Œç¬¬ä¸€ä¸ªè¯·æ±‚çš„å“åº”ä¼šè¢«ä¸»è°ƒä¸¢å¼ƒã€‚<br><img src="/images/hedging.png" alt="å¯¹å†²æ¨¡å‹"></p><details> <summary>å¯¹å†²æ¨¡æ‹Ÿå®ç°</summary><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><code class="hljs golang"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br><br>request, err := http.NewRequest(<span class="hljs-string">&quot;Get&quot;</span>, <span class="hljs-string">&quot;http://www.baidu.com&quot;</span>, <span class="hljs-literal">nil</span>)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-built_in">panic</span>(err)<br>&#125;<br>hedged, err := retryHedged(request, <span class="hljs-number">3</span>, <span class="hljs-number">10</span>*time.Millisecond, <span class="hljs-number">10</span>*time.Second, Backoff)<br>fmt.Println(hedged, err)<br>&#125;<br><br><span class="hljs-keyword">type</span> RetryStrategy <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(<span class="hljs-type">int</span>)</span></span> time.Duration<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Backoff</span><span class="hljs-params">(retryNum <span class="hljs-type">int</span>)</span></span> time.Duration &#123;<br><span class="hljs-keyword">return</span> time.Duration(retryNum*<span class="hljs-number">2</span>+<span class="hljs-number">2</span>) * time.Millisecond<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">retryHedged</span><span class="hljs-params">(req *http.Request, maxRetries <span class="hljs-type">int</span>, hedgeDelay time.Duration, reqTimeout time.Duration, rs RetryStrategy)</span></span> (*http.Response, <span class="hljs-type">error</span>) &#123;<br><span class="hljs-keyword">var</span> (<br>originalBody []<span class="hljs-type">byte</span><br>err          <span class="hljs-type">error</span><br>)<br><span class="hljs-keyword">if</span> req != <span class="hljs-literal">nil</span> &amp;&amp; req.Body != <span class="hljs-literal">nil</span> &#123;<br>originalBody, err = copyBody(req.Body)<br>&#125;<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>&#125;<br><br>AttemptLimit := maxRetries<br><span class="hljs-keyword">if</span> AttemptLimit &lt;= <span class="hljs-number">0</span> &#123;<br>AttemptLimit = <span class="hljs-number">1</span><br>&#125;<br><br>client := http.Client&#123;<br>Timeout: reqTimeout,<br>&#125;<br><br><span class="hljs-comment">// æ¯æ¬¡è¯·æ±‚copyæ–°çš„request</span><br>copyRequest := <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> (request *http.Request) &#123;<br>request = req.Clone(req.Context())<br><span class="hljs-keyword">if</span> request.Body != <span class="hljs-literal">nil</span> &#123;<br>resetBody(request, originalBody)<br>&#125;<br><span class="hljs-keyword">return</span><br>&#125;<br><br>multiplexCh := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span> &#123;<br>resp  *http.Response<br>err   <span class="hljs-type">error</span><br>retry <span class="hljs-type">int</span><br>&#125;)<br><br>totalSentRequests := &amp;sync.WaitGroup&#123;&#125;<br>allRequestsBackCh := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>&#123;&#125;)<br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>totalSentRequests.Wait()<br><span class="hljs-built_in">close</span>(allRequestsBackCh)<br>&#125;()<br><span class="hljs-keyword">var</span> resp *http.Response<br><br><span class="hljs-keyword">var</span> (<br>canHedge   <span class="hljs-type">uint32</span><br>readyHedge = <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>&#123;&#125;)<br>)<br><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; AttemptLimit; i++ &#123;<br>totalSentRequests.Add(<span class="hljs-number">1</span>)<br><br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(i <span class="hljs-type">int</span>)</span></span> &#123;<br><span class="hljs-keyword">if</span> atomic.CompareAndSwapUint32(&amp;canHedge, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>) &#123;<br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>&lt;-time.After(hedgeDelay)<br>readyHedge &lt;- <span class="hljs-keyword">struct</span>&#123;&#125;&#123;&#125;<br>&#125;()<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>&lt;-readyHedge<br>time.Sleep(rs(i))<br>&#125;<br><span class="hljs-comment">// æ ‡è®°å·²ç»æ‰§è¡Œå®Œ</span><br><span class="hljs-keyword">defer</span> totalSentRequests.Done()<br>req = copyRequest()<br>resp, err = client.Do(req)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>fmt.Printf(<span class="hljs-string">&quot;error sending the first time: %v\n&quot;</span>, err)<br>&#125;<br><span class="hljs-comment">// é‡è¯• 500 ä»¥ä¸Šçš„é”™è¯¯ç </span><br><span class="hljs-keyword">if</span> err == <span class="hljs-literal">nil</span> &amp;&amp; resp.StatusCode &lt; <span class="hljs-number">500</span> &#123;<br>multiplexCh &lt;- <span class="hljs-keyword">struct</span> &#123;<br>resp  *http.Response<br>err   <span class="hljs-type">error</span><br>retry <span class="hljs-type">int</span><br>&#125;&#123;resp: resp, err: err, retry: i&#125;<br><span class="hljs-keyword">return</span><br>&#125;<br><span class="hljs-comment">// å¦‚æœæ­£åœ¨é‡è¯•ï¼Œé‚£ä¹ˆé‡Šæ”¾fd</span><br><span class="hljs-keyword">if</span> resp != <span class="hljs-literal">nil</span> &#123;<br>resp.Body.Close()<br>&#125;<br><span class="hljs-comment">// é‡ç½®body</span><br><span class="hljs-keyword">if</span> req.Body != <span class="hljs-literal">nil</span> &#123;<br>resetBody(req, originalBody)<br>&#125;<br>&#125;(i)<br>&#125;<br><br><span class="hljs-keyword">select</span> &#123;<br><span class="hljs-keyword">case</span> res := &lt;-multiplexCh:<br><span class="hljs-keyword">return</span> res.resp, res.err<br><span class="hljs-keyword">case</span> &lt;-allRequestsBackCh:<br><span class="hljs-comment">// åˆ°è¿™é‡Œï¼Œè¯´æ˜å…¨éƒ¨çš„ goroutine éƒ½æ‰§è¡Œå®Œæ¯•ï¼Œä½†æ˜¯éƒ½è¯·æ±‚å¤±è´¥äº†</span><br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, errors.New(<span class="hljs-string">&quot;all req finishï¼Œbut all fail&quot;</span>)<br>&#125;<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">copyBody</span><span class="hljs-params">(src io.ReadCloser)</span></span> ([]<span class="hljs-type">byte</span>, <span class="hljs-type">error</span>) &#123;<br>b, err := io.ReadAll(src)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>&#125;<br>src.Close()<br><span class="hljs-keyword">return</span> b, <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">resetBody</span><span class="hljs-params">(request *http.Request, originalBody []<span class="hljs-type">byte</span>)</span></span> &#123;<br>request.Body = io.NopCloser(bytes.NewBuffer(originalBody))<br>request.GetBody = <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> (io.ReadCloser, <span class="hljs-type">error</span>) &#123;<br><span class="hljs-keyword">return</span> io.NopCloser(bytes.NewBuffer(originalBody)), <span class="hljs-literal">nil</span><br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure></details><h3 id="é‡è¯•æ€»ç»“"><a href="#é‡è¯•æ€»ç»“" class="headerlink" title="é‡è¯•æ€»ç»“"></a>é‡è¯•æ€»ç»“</h3><ol><li>æ˜ç¡®å¥½å“ªäº›æƒ…å†µä¸‹æ‰èƒ½é‡è¯•</li><li><font color="red"> é‡è¯•åªåœ¨å½“å‰å±‚. </font> å½“é‡è¯•å¤±è´¥æ—¶ï¼Œåº”è¯¥çº¦å®šå…¨å±€é”™è¯¯ç ï¼Œâ€œno need retryâ€ é¿å…åŠè”é‡è¯•</li><li>ä¸€å®šæ³¨æ„<font color="red">éšæœºåŒ–é‡è¯•é—´éš”æ—¶é—´</font>ï¼Œé¿å…é‡è¯•æ³¢å³°</li><li>ä¸‹æ¸¸ä¸€å®šæ˜¯å¹‚ç­‰çš„ï¼Œä¸èƒ½äº§ç”Ÿå‰¯ä½œç”¨</li></ol><h1 id="åˆ†å¸ƒå¼æ¶æ„é«˜å¯ç”¨è®¾è®¡"><a href="#åˆ†å¸ƒå¼æ¶æ„é«˜å¯ç”¨è®¾è®¡" class="headerlink" title="åˆ†å¸ƒå¼æ¶æ„é«˜å¯ç”¨è®¾è®¡"></a>åˆ†å¸ƒå¼æ¶æ„é«˜å¯ç”¨è®¾è®¡</h1><p>å•èŠ‚ç‚¹é˜²æŠ¤æœºåˆ¶è§£å†³äº†æœåŠ¡å†…éƒ¨çš„ç¨³å®šæ€§é—®é¢˜ï¼Œä½†é¢å¯¹æ›´é«˜çš„å¯ç”¨æ€§è¦æ±‚ï¼ˆå¦‚99.99%ï¼‰ï¼Œéœ€è¦ä»æ¶æ„å±‚é¢æ¶ˆé™¤å•ç‚¹æ•…éšœã€‚åˆ†å¸ƒå¼é«˜å¯ç”¨è®¾è®¡é€šè¿‡<strong>å†—ä½™</strong>ã€<strong>æ•…éšœè½¬ç§»</strong>ã€<strong>è´Ÿè½½åˆ†æ•£</strong>ç­‰æ‰‹æ®µï¼Œå°†SLOç›®æ ‡çš„å®ç°ä»å•ç‚¹èƒ½åŠ›æå‡ä¸ºç³»ç»Ÿæ€§èƒ½åŠ›ã€‚</p><h2 id="å†—ä½™æ¶æ„ä½“ç³»è®¾è®¡"><a href="#å†—ä½™æ¶æ„ä½“ç³»è®¾è®¡" class="headerlink" title="å†—ä½™æ¶æ„ä½“ç³»è®¾è®¡"></a>å†—ä½™æ¶æ„ä½“ç³»è®¾è®¡</h2><h3 id="æ¶æ„æ¼”è¿›è·¯å¾„ä¸é€‚ç”¨åœºæ™¯"><a href="#æ¶æ„æ¼”è¿›è·¯å¾„ä¸é€‚ç”¨åœºæ™¯" class="headerlink" title="æ¶æ„æ¼”è¿›è·¯å¾„ä¸é€‚ç”¨åœºæ™¯"></a>æ¶æ„æ¼”è¿›è·¯å¾„ä¸é€‚ç”¨åœºæ™¯</h3><table><thead><tr><th>æ¶æ„æ¨¡å¼</th><th>RTOç›®æ ‡</th><th>RPOç›®æ ‡</th><th>å®ç°å¤æ‚åº¦</th><th>æˆæœ¬æ¯”ä¾‹</th><th>é€‚ç”¨åœºæ™¯</th></tr></thead><tbody><tr><td>åŒåŸç¾å¤‡</td><td>4-24å°æ—¶</td><td>1-4å°æ—¶</td><td>ä½</td><td>1.5å€</td><td>ä¼ ç»Ÿä¼ä¸šã€åˆè§„è¦æ±‚</td></tr><tr><td>åŒåŸåŒæ´»</td><td>ç§’çº§</td><td>è¿‘å®æ—¶</td><td>ä¸­</td><td>2å€</td><td>é‡‘èã€ç”µå•†æ ¸å¿ƒ</td></tr><tr><td>ä¸¤åœ°ä¸‰ä¸­å¿ƒ</td><td>åˆ†é’Ÿçº§</td><td>åˆ†é’Ÿçº§</td><td>é«˜</td><td>3å€</td><td>é“¶è¡Œã€ä¿é™©</td></tr><tr><td>å¼‚åœ°åŒæ´»</td><td>ç§’çº§</td><td>ç§’çº§</td><td>æé«˜</td><td>4-5å€</td><td>äº’è”ç½‘å¤´éƒ¨</td></tr></tbody></table><h3 id="åŒåŸåŒæ´»æ¶æ„æ·±å…¥è®¾è®¡"><a href="#åŒåŸåŒæ´»æ¶æ„æ·±å…¥è®¾è®¡" class="headerlink" title="åŒåŸåŒæ´»æ¶æ„æ·±å…¥è®¾è®¡"></a>åŒåŸåŒæ´»æ¶æ„æ·±å…¥è®¾è®¡</h3><p><img src="/images/two_idc.png" alt="åŒä¸­å¿ƒæ¶æ„"></p><p><strong>æ ¸å¿ƒè®¾è®¡åŸåˆ™</strong>ï¼š</p><ol><li><strong>æ•°æ®ä¸€è‡´æ€§ä¿è¯</strong>ï¼šé‡‡ç”¨å¼ºåŒæ­¥å¤åˆ¶+åˆ†å¸ƒå¼äº‹åŠ¡ç¡®ä¿æ•°æ®ä¸€è‡´æ€§</li><li><strong>æµé‡åˆ†æµç­–ç•¥</strong>ï¼šåŸºäºç”¨æˆ·IDã€åœ°ç†ä½ç½®ç­‰ç»´åº¦è¿›è¡Œæµé‡åˆ†é…  </li><li><strong>æ•…éšœæ£€æµ‹åˆ‡æ¢</strong>ï¼šäºšç§’çº§æ•…éšœæ£€æµ‹ï¼Œç§’çº§æµé‡åˆ‡æ¢</li><li><strong>å®¹é‡è§„åˆ’</strong>ï¼šæ¯ä¸ªæœºæˆ¿æ‰¿è½½70%ä¸šåŠ¡å®¹é‡ï¼Œé¢„ç•™30%å®¹é”™ç©ºé—´</li></ol><p><strong>æŠ€æœ¯å®ç°ç»†èŠ‚</strong>ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># åŒåŸåŒæ´»é…ç½®ç¤ºä¾‹</span><br><span class="hljs-attr">dual_active_config:</span><br>  <span class="hljs-attr">traffic_distribution:</span><br>    <span class="hljs-string">æœºæˆ¿A:</span> <span class="hljs-number">50</span><span class="hljs-string">%</span>    <span class="hljs-comment"># æ­£å¸¸æƒ…å†µä¸‹æµé‡åˆ†é…</span><br>    <span class="hljs-string">æœºæˆ¿B:</span> <span class="hljs-number">50</span><span class="hljs-string">%</span><br>    <br>  <span class="hljs-attr">failover_strategy:</span><br>    <span class="hljs-attr">detection_interval:</span> <span class="hljs-string">500ms</span>    <span class="hljs-comment"># å¥åº·æ£€æŸ¥é—´éš”</span><br>    <span class="hljs-attr">failure_threshold:</span> <span class="hljs-number">3</span>         <span class="hljs-comment"># è¿ç»­å¤±è´¥æ¬¡æ•°</span><br>    <span class="hljs-attr">recovery_threshold:</span> <span class="hljs-number">5</span>        <span class="hljs-comment"># æ¢å¤æ£€æµ‹æ¬¡æ•°</span><br>    <span class="hljs-attr">traffic_shift_speed:</span> <span class="hljs-number">10</span><span class="hljs-string">%/sec</span> <span class="hljs-comment"># æµé‡åˆ‡æ¢é€Ÿåº¦</span><br>    <br>  <span class="hljs-attr">data_sync:</span><br>    <span class="hljs-attr">replication_mode:</span> <span class="hljs-string">&quot;sync&quot;</span>     <span class="hljs-comment"># å¼ºåŒæ­¥å¤åˆ¶</span><br>    <span class="hljs-attr">max_lag_threshold:</span> <span class="hljs-string">1ms</span>       <span class="hljs-comment"># æœ€å¤§å»¶è¿Ÿé˜ˆå€¼</span><br>    <span class="hljs-attr">conflict_resolution:</span> <span class="hljs-string">&quot;timestamp_priority&quot;</span> <span class="hljs-comment"># å†²çªè§£å†³ç­–ç•¥</span><br></code></pre></td></tr></table></figure><p><strong>åˆ†å±‚å®ç°æ¶æ„</strong>ï¼š</p><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs crmsh">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”<br>â”‚    æœºæˆ¿A        â”‚      æœºæˆ¿B      â”‚<br>â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤<br>â”‚  LB (<span class="hljs-number">50</span>%)      â”‚   LB (<span class="hljs-number">50</span>%)     â”‚  â† æµé‡å±‚<br>â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤<br>â”‚  API Gateway   â”‚  API Gateway   â”‚  â† æ¥å…¥å±‚  <br>â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤<br>â”‚  å¾®æœåŠ¡é›†ç¾¤     â”‚   å¾®æœåŠ¡é›†ç¾¤    â”‚  â† ä¸šåŠ¡å±‚<br>â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤<br>â”‚  Redis Cluster â”‚ Redis Cluster  â”‚  â† ç¼“å­˜å±‚<br>â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤<br>â”‚  MySQL <span class="hljs-keyword">Master</span>  <span class="hljs-title">â”‚ MySQL</span> <span class="hljs-keyword">Master</span>   <span class="hljs-title">â”‚  â† å­˜å‚¨å±‚</span><br><span class="hljs-title">â”‚      â†•         â”‚       â†•        â”‚</span><br><span class="hljs-title">â”‚  å¼ºåŒæ­¥å¤åˆ¶     â”‚   å¼ºåŒæ­¥å¤åˆ¶    â”‚</span><br><span class="hljs-title">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br></code></pre></td></tr></table></figure><h3 id="å¼‚åœ°åŒæ´»æ¶æ„è¯¦ç»†è®¾è®¡"><a href="#å¼‚åœ°åŒæ´»æ¶æ„è¯¦ç»†è®¾è®¡" class="headerlink" title="å¼‚åœ°åŒæ´»æ¶æ„è¯¦ç»†è®¾è®¡"></a>å¼‚åœ°åŒæ´»æ¶æ„è¯¦ç»†è®¾è®¡</h3><p><strong>é¢ä¸´çš„æ ¸å¿ƒæŒ‘æˆ˜</strong>ï¼š</p><ol><li><strong>ç½‘ç»œå»¶è¿Ÿ</strong>ï¼šè·¨åœ°åŸŸRTTé€šå¸¸20-100msï¼Œå½±å“åŒæ­¥æ€§èƒ½</li><li><strong>æ•°æ®ä¸€è‡´æ€§</strong>ï¼šCAPå®šç†çº¦æŸä¸‹çš„ä¸€è‡´æ€§ä¸å¯ç”¨æ€§æƒè¡¡</li><li><strong>è„‘è£‚é£é™©</strong>ï¼šç½‘ç»œåˆ†åŒºæ—¶çš„åŒå†™å†²çªé—®é¢˜</li><li><strong>æˆæœ¬æ§åˆ¶</strong>ï¼šå¼‚åœ°å¸¦å®½ã€æœºæˆ¿æˆæœ¬æ˜¾è‘—å¢åŠ </li></ol><p><strong>Google Spanneræ¶æ„å€Ÿé‰´</strong>ï¼š</p><figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs mathematica">å…¨çƒåˆ†å¸ƒå¼æ¶æ„è®¾è®¡ï¼š<br>â”Œâ”€â”€â”€ åŒ—äº¬æœºæˆ¿ â”€â”€â”€â”€â”    â”Œâ”€â”€â”€ ä¸Šæµ·æœºæˆ¿ â”€â”€â”€â”€â”    â”Œâ”€â”€â”€ å¹¿å·æœºæˆ¿ â”€â”€â”€â”€â”<br>â”‚  <span class="hljs-built_in">Write</span> <span class="hljs-built_in">Region</span>  â”‚â—„â”€â”€â–ºâ”‚  <span class="hljs-built_in">Read</span> <span class="hljs-built_in">Region</span>   â”‚â—„â”€â”€â–ºâ”‚  <span class="hljs-built_in">Read</span> <span class="hljs-built_in">Region</span>   â”‚<br>â”‚  <span class="hljs-variable">TrueTime</span>åŒæ­¥  â”‚    â”‚  åªè¯»å‰¯æœ¬       â”‚    â”‚  åªè¯»å‰¯æœ¬       â”‚<br>â”‚  <span class="hljs-variable">Paxos</span> <span class="hljs-variable">Leader</span>  â”‚    â”‚  <span class="hljs-variable">Paxos</span> <span class="hljs-variable">Follower</span>â”‚    â”‚  <span class="hljs-variable">Paxos</span> <span class="hljs-variable">Follower</span>â”‚<br>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜<br>         â–²                     â–²                     â–²<br>         â””â”€â”€â”€â”€â”€â”€â”€ åŸå­é’ŸåŒæ­¥ <span class="hljs-variable">GPS</span>æ—¶é’ŸåŒæ­¥ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜<br></code></pre></td></tr></table></figure><p><strong>å®ç°æ–¹æ¡ˆ</strong>ï¼š</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs golang"><span class="hljs-comment">// å¼‚åœ°åŒæ´»æ•°æ®åŒæ­¥ç®¡ç†å™¨</span><br><span class="hljs-keyword">type</span> CrossRegionSyncManager <span class="hljs-keyword">struct</span> &#123;<br>    regions          []<span class="hljs-type">string</span><br>    syncMode         SyncMode  <span class="hljs-comment">// ASYNC, SYNC, SEMI_SYNC</span><br>    conflictResolver ConflictResolver<br>    replicationLag   <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]time.Duration<br>&#125;<br><br><span class="hljs-keyword">type</span> SyncMode <span class="hljs-type">int</span><br><span class="hljs-keyword">const</span> (<br>    ASYNC     SyncMode = <span class="hljs-literal">iota</span> <span class="hljs-comment">// å¼‚æ­¥å¤åˆ¶ï¼Œæ€§èƒ½æœ€ä¼˜ä½†å¯èƒ½ä¸¢å¤±æ•°æ®</span><br>    SEMI_SYNC                 <span class="hljs-comment">// åŠåŒæ­¥ï¼Œå¹³è¡¡æ€§èƒ½ä¸ä¸€è‡´æ€§  </span><br>    SYNC                      <span class="hljs-comment">// å¼ºåŒæ­¥ï¼Œç¡®ä¿ä¸€è‡´æ€§ä½†å½±å“æ€§èƒ½</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(m *CrossRegionSyncManager)</span></span> WriteWithConsistency(key <span class="hljs-type">string</span>, value <span class="hljs-keyword">interface</span>&#123;&#125;) <span class="hljs-type">error</span> &#123;<br>    <span class="hljs-keyword">switch</span> m.syncMode &#123;<br>    <span class="hljs-keyword">case</span> SYNC:<br>        <span class="hljs-keyword">return</span> m.syncWriteAllRegions(key, value)<br>    <span class="hljs-keyword">case</span> SEMI_SYNC:<br>        <span class="hljs-keyword">return</span> m.semiSyncWrite(key, value)<br>    <span class="hljs-keyword">case</span> ASYNC:<br>        <span class="hljs-keyword">return</span> m.asyncWriteWithCallback(key, value)<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-comment">// å¼ºåŒæ­¥å†™å…¥ - ç¡®ä¿æ‰€æœ‰åœ°åŸŸå†™å…¥æˆåŠŸ</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(m *CrossRegionSyncManager)</span></span> syncWriteAllRegions(key <span class="hljs-type">string</span>, value <span class="hljs-keyword">interface</span>&#123;&#125;) <span class="hljs-type">error</span> &#123;<br>    <span class="hljs-keyword">var</span> wg sync.WaitGroup<br>    errors := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-type">error</span>, <span class="hljs-built_in">len</span>(m.regions))<br>    <br>    <span class="hljs-keyword">for</span> _, region := <span class="hljs-keyword">range</span> m.regions &#123;<br>        wg.Add(<span class="hljs-number">1</span>)<br>        <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(region <span class="hljs-type">string</span>)</span></span> &#123;<br>            <span class="hljs-keyword">defer</span> wg.Done()<br>            <span class="hljs-keyword">if</span> err := m.writeToRegion(region, key, value); err != <span class="hljs-literal">nil</span> &#123;<br>                errors &lt;- fmt.Errorf(<span class="hljs-string">&quot;region %s write failed: %v&quot;</span>, region, err)<br>            &#125;<br>        &#125;(region)<br>    &#125;<br>    <br>    wg.Wait()<br>    <span class="hljs-built_in">close</span>(errors)<br>    <br>    <span class="hljs-comment">// å¦‚æœä»»ä½•ä¸€ä¸ªåœ°åŸŸå†™å…¥å¤±è´¥ï¼Œæ•´ä¸ªæ“ä½œå¤±è´¥</span><br>    <span class="hljs-keyword">for</span> err := <span class="hljs-keyword">range</span> errors &#123;<br>        <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>            <span class="hljs-keyword">return</span> err<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="å•å…ƒåŒ–æ¶æ„è®¾è®¡å®è·µ"><a href="#å•å…ƒåŒ–æ¶æ„è®¾è®¡å®è·µ" class="headerlink" title="å•å…ƒåŒ–æ¶æ„è®¾è®¡å®è·µ"></a>å•å…ƒåŒ–æ¶æ„è®¾è®¡å®è·µ</h3><p><strong>å•å…ƒåŒ–æ‹†åˆ†åŸåˆ™</strong>ï¼š</p><ol><li><strong>ä¸šåŠ¡è‡ªåŒ…å«</strong>ï¼šå•å…ƒå†…å®Œæˆå®Œæ•´ä¸šåŠ¡æµç¨‹ï¼Œé¿å…è·¨å•å…ƒè°ƒç”¨</li><li><strong>æ•°æ®è·¯ç”±ä¸€è‡´æ€§</strong>ï¼šåŒä¸€ç”¨æˆ·çš„æ‰€æœ‰æ“ä½œè·¯ç”±åˆ°åŒä¸€å•å…ƒ</li><li><strong>æ•…éšœéš”ç¦»</strong>ï¼šå•å…ƒæ•…éšœä¸å½±å“å…¶ä»–å•å…ƒæ­£å¸¸è¿è¡Œ</li><li><strong>å¼¹æ€§æ‰©å®¹</strong>ï¼šå¯æ ¹æ®ä¸šåŠ¡å¢é•¿åŠ¨æ€å¢åŠ å•å…ƒ</li></ol><p><img src="/images/set_arch.png" alt="å•å…ƒåŒ–æ¶æ„"></p><p><strong>å•å…ƒè·¯ç”±ç­–ç•¥è®¾è®¡</strong>ï¼š</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs golang"><span class="hljs-comment">// å•å…ƒè·¯ç”±å™¨å®ç°</span><br><span class="hljs-keyword">type</span> UnitRouter <span class="hljs-keyword">struct</span> &#123;<br>    units           []Unit<br>    routingStrategy RoutingStrategy<br>    loadBalancer   LoadBalancer<br>&#125;<br><br><span class="hljs-keyword">type</span> RoutingStrategy <span class="hljs-keyword">interface</span> &#123;<br>    Route(userID <span class="hljs-type">string</span>, request Request) (*Unit, <span class="hljs-type">error</span>)<br>&#125;<br><br><span class="hljs-comment">// ä¸€è‡´æ€§å“ˆå¸Œè·¯ç”±ç­–ç•¥  </span><br><span class="hljs-keyword">type</span> ConsistentHashRouting <span class="hljs-keyword">struct</span> &#123;<br>    hashRing *ConsistentHashRing<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(r *ConsistentHashRouting)</span></span> Route(userID <span class="hljs-type">string</span>, request Request) (*Unit, <span class="hljs-type">error</span>) &#123;<br>    <span class="hljs-comment">// åŸºäºç”¨æˆ·IDçš„ä¸€è‡´æ€§å“ˆå¸Œ</span><br>    hash := crc32.ChecksumIEEE([]<span class="hljs-type">byte</span>(userID))<br>    unit := r.hashRing.GetNode(hash)<br>    <span class="hljs-keyword">return</span> unit.(*Unit), <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-comment">// åœ°ç†ä½ç½®è·¯ç”±ç­–ç•¥</span><br><span class="hljs-keyword">type</span> GeographicRouting <span class="hljs-keyword">struct</span> &#123;<br>    regionUnits <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>][]*Unit<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(r *GeographicRouting)</span></span> Route(userID <span class="hljs-type">string</span>, request Request) (*Unit, <span class="hljs-type">error</span>) &#123;<br>    <span class="hljs-comment">// æ ¹æ®ç”¨æˆ·IPè·å–åœ°ç†ä½ç½®</span><br>    region := getRegionByIP(request.RemoteIP)<br>    units := r.regionUnits[region]<br>    <br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(units) == <span class="hljs-number">0</span> &#123;<br>        <span class="hljs-comment">// é™çº§åˆ°é»˜è®¤åœ°åŸŸ</span><br>        units = r.regionUnits[<span class="hljs-string">&quot;default&quot;</span>]<br>    &#125;<br>    <br>    <span class="hljs-comment">// åœ¨åŒåœ°åŸŸå•å…ƒä¸­è¿›è¡Œè´Ÿè½½å‡è¡¡</span><br>    <span class="hljs-keyword">return</span> selectUnitByLoad(units), <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure><p><strong>å•å…ƒæ¶æ„åˆ†å±‚è®¾è®¡</strong>ï¼š</p><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs gherkin">ä¸šåŠ¡å±‚åˆ†å•å…ƒæ¶æ„ï¼š<br>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ RZone-1 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ RZone-2 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”<br>â”‚  ç”¨æˆ·A:  è®¢å•|<span class="hljs-string">æ”¯ä»˜</span>|<span class="hljs-string">åº“å­˜</span>|<span class="hljs-string">ç‰©æµ      â”‚ â”‚  ç”¨æˆ·B:  è®¢å•</span>|<span class="hljs-string">æ”¯ä»˜</span>|<span class="hljs-string">åº“å­˜</span>|<span class="hljs-string">ç‰©æµ      â”‚</span><br><span class="hljs-string">â”‚  MySQL: user_shard_1             â”‚ â”‚  MySQL: user_shard_2             â”‚  </span><br><span class="hljs-string">â”‚  Redis: cache_cluster_1          â”‚ â”‚  Redis: cache_cluster_2          â”‚</span><br><span class="hljs-string">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="hljs-string">              â–²                                       â–²</span><br><span class="hljs-string">              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ GZone â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="hljs-string">                     â”‚ å•†å“ä¿¡æ¯ </span>|<span class="hljs-string"> ä»·æ ¼é…ç½® â”‚</span><br><span class="hljs-string">                     â”‚ å…¨å±€å…±äº«ï¼Œåªè¯»å±…å¤š â”‚</span><br><span class="hljs-string"></span><br><span class="hljs-string">              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ CZone â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  </span><br><span class="hljs-string">                     â”‚ ä¿ƒé”€é…ç½® </span>|<span class="hljs-string"> åŸå¸‚é…ç½® â”‚</span><br><span class="hljs-string">                     â”‚ æŒ‰åŸå¸‚åˆ†ç‰‡ï¼Œè¯»å†™åˆ†ç¦»â”‚</span><br></code></pre></td></tr></table></figure><p><strong>å®¹é‡è§„åˆ’ä¸æ‰©å®¹ç­–ç•¥</strong>ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># å•å…ƒå®¹é‡è§„åˆ’é…ç½®</span><br><span class="hljs-attr">unit_capacity_planning:</span><br>  <span class="hljs-attr">single_unit_capacity:</span><br>    <span class="hljs-attr">max_users:</span> <span class="hljs-number">1000000</span>        <span class="hljs-comment"># å•å•å…ƒæœ€å¤§ç”¨æˆ·æ•°</span><br>    <span class="hljs-attr">max_qps:</span> <span class="hljs-number">10000</span>           <span class="hljs-comment"># å•å•å…ƒæœ€å¤§QPS</span><br>    <span class="hljs-attr">storage_limit:</span> <span class="hljs-string">&quot;1TB&quot;</span>      <span class="hljs-comment"># å•å•å…ƒå­˜å‚¨é™åˆ¶</span><br>    <br>  <span class="hljs-attr">expansion_strategy:</span><br>    <span class="hljs-attr">cpu_threshold:</span> <span class="hljs-number">70</span><span class="hljs-string">%</span>        <span class="hljs-comment"># CPUä½¿ç”¨ç‡é˜ˆå€¼</span><br>    <span class="hljs-attr">memory_threshold:</span> <span class="hljs-number">80</span><span class="hljs-string">%</span>     <span class="hljs-comment"># å†…å­˜ä½¿ç”¨ç‡é˜ˆå€¼</span><br>    <span class="hljs-attr">storage_threshold:</span> <span class="hljs-number">85</span><span class="hljs-string">%</span>    <span class="hljs-comment"># å­˜å‚¨ä½¿ç”¨ç‡é˜ˆå€¼</span><br>    <br>  <span class="hljs-attr">migration_strategy:</span><br>    <span class="hljs-attr">split_method:</span> <span class="hljs-string">&quot;range_split&quot;</span> <span class="hljs-comment"># åˆ†ç‰‡æ–¹å¼ï¼šrange_split, hash_split</span><br>    <span class="hljs-attr">migration_speed:</span> <span class="hljs-string">&quot;100MB/s&quot;</span>  <span class="hljs-comment"># æ•°æ®è¿ç§»é€Ÿåº¦</span><br>    <span class="hljs-attr">consistency_check:</span> <span class="hljs-literal">true</span>      <span class="hljs-comment"># è¿ç§»è¿‡ç¨‹ä¸­ä¸€è‡´æ€§æ£€æŸ¥</span><br></code></pre></td></tr></table></figure><h2 id="æ•…éšœè½¬ç§»ä¸è‡ªæ„ˆæœºåˆ¶"><a href="#æ•…éšœè½¬ç§»ä¸è‡ªæ„ˆæœºåˆ¶" class="headerlink" title="æ•…éšœè½¬ç§»ä¸è‡ªæ„ˆæœºåˆ¶"></a>æ•…éšœè½¬ç§»ä¸è‡ªæ„ˆæœºåˆ¶</h2><h3 id="å¤šå±‚çº§æ•…éšœè½¬ç§»ç­–ç•¥"><a href="#å¤šå±‚çº§æ•…éšœè½¬ç§»ç­–ç•¥" class="headerlink" title="å¤šå±‚çº§æ•…éšœè½¬ç§»ç­–ç•¥"></a>å¤šå±‚çº§æ•…éšœè½¬ç§»ç­–ç•¥</h3><p><strong>1. DNSå±‚æ•…éšœè½¬ç§»</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># DNSæ•…éšœè½¬ç§»é…ç½®</span><br><span class="hljs-attr">dns_failover:</span><br>  <span class="hljs-attr">primary_region:</span> <span class="hljs-string">&quot;beijing&quot;</span><br>  <span class="hljs-attr">backup_regions:</span> [<span class="hljs-string">&quot;shanghai&quot;</span>, <span class="hljs-string">&quot;guangzhou&quot;</span>]<br>  <span class="hljs-attr">health_check:</span><br>    <span class="hljs-attr">interval:</span> <span class="hljs-string">30s</span><br>    <span class="hljs-attr">timeout:</span> <span class="hljs-string">5s</span><br>    <span class="hljs-attr">failure_threshold:</span> <span class="hljs-number">3</span><br>  <span class="hljs-attr">ttl:</span> <span class="hljs-string">60s</span>  <span class="hljs-comment"># é™ä½TTLåŠ å¿«æ•…éšœåˆ‡æ¢</span><br></code></pre></td></tr></table></figure><p><strong>2. APIç½‘å…³æ•…éšœè½¬ç§»</strong><br>ç½‘å…³å®ç°åŒºåŸŸçº§æ•…éšœæ£€æµ‹å’Œè‡ªåŠ¨åˆ‡æ¢ï¼š</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs golang"><span class="hljs-keyword">type</span> RegionFailoverManager <span class="hljs-keyword">struct</span> &#123;<br>    regions         []Region<br>    healthChecker   HealthChecker<br>    trafficManager TrafficManager<br>    failoverPolicy FailoverPolicy<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(m *RegionFailoverManager)</span></span> HandleFailover(failedRegion <span class="hljs-type">string</span>) <span class="hljs-type">error</span> &#123;<br>    <span class="hljs-comment">// 1. æ ‡è®°æ•…éšœåŒºåŸŸä¸å¯ç”¨</span><br>    m.regions[failedRegion].SetStatus(UNAVAILABLE)<br>    <br>    <span class="hljs-comment">// 2. é‡æ–°åˆ†é…æµé‡åˆ°å¥åº·åŒºåŸŸ</span><br>    healthyRegions := m.getHealthyRegions()<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(healthyRegions) == <span class="hljs-number">0</span> &#123;<br>        <span class="hljs-keyword">return</span> errors.New(<span class="hljs-string">&quot;no healthy regions available&quot;</span>)<br>    &#125;<br>    <br>    <span class="hljs-comment">// 3. æŒ‰å®¹é‡æ¯”ä¾‹é‡æ–°åˆ†é…æµé‡</span><br>    <span class="hljs-keyword">return</span> m.trafficManager.RedistributeTraffic(healthyRegions)<br>&#125;<br><br><span class="hljs-comment">// æ•…éšœæ¢å¤æ£€æµ‹</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(m *RegionFailoverManager)</span></span> CheckRecovery() &#123;<br>    <span class="hljs-keyword">for</span> _, region := <span class="hljs-keyword">range</span> m.regions &#123;<br>        <span class="hljs-keyword">if</span> region.Status == UNAVAILABLE &#123;<br>            <span class="hljs-keyword">if</span> m.healthChecker.IsHealthy(region) &#123;<br>                <span class="hljs-comment">// æ¸è¿›å¼æµé‡æ¢å¤</span><br>                m.trafficManager.GradualRecovery(region, <span class="hljs-number">5</span>) <span class="hljs-comment">// 5%å¼€å§‹</span><br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>3. å®¢æˆ·ç«¯æ™ºèƒ½é‡è¯•</strong><br>å®¢æˆ·ç«¯å®ç°åŸºäºå»¶è¿Ÿæ„ŸçŸ¥çš„åŒºåŸŸé€‰æ‹©ï¼š</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs golang"><span class="hljs-keyword">type</span> IntelligentClient <span class="hljs-keyword">struct</span> &#123;<br>    regions        []<span class="hljs-type">string</span><br>    latencyTracker <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]time.Duration<br>    circuitBreaker <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]*CircuitBreaker<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *IntelligentClient)</span></span> SelectRegion() <span class="hljs-type">string</span> &#123;<br>    <span class="hljs-comment">// ä¼˜å…ˆé€‰æ‹©å»¶è¿Ÿæœ€ä½ä¸”å¥åº·çš„åŒºåŸŸ</span><br>    bestRegion := <span class="hljs-string">&quot;&quot;</span><br>    minLatency := time.Hour<br>    <br>    <span class="hljs-keyword">for</span> _, region := <span class="hljs-keyword">range</span> c.regions &#123;<br>        <span class="hljs-keyword">if</span> c.circuitBreaker[region].IsAvailable() &#123;<br>            <span class="hljs-keyword">if</span> latency := c.latencyTracker[region]; latency &lt; minLatency &#123;<br>                minLatency = latency<br>                bestRegion = region<br>            &#125;<br>        &#125;<br>    &#125;<br>    <br>    <span class="hljs-keyword">return</span> bestRegion<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="è‡ªé€‚åº”é™æµä¸é‡è¯•"><a href="#è‡ªé€‚åº”é™æµä¸é‡è¯•" class="headerlink" title="è‡ªé€‚åº”é™æµä¸é‡è¯•"></a>è‡ªé€‚åº”é™æµä¸é‡è¯•</h3><p><strong>åŸºäºæˆåŠŸç‡çš„åŠ¨æ€é‡è¯•çª—å£</strong>ï¼š</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs golang"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;fmt&quot;</span><br><span class="hljs-string">&quot;math/rand&quot;</span><br>)<br><br><span class="hljs-keyword">type</span> RetryLimiter <span class="hljs-keyword">struct</span> &#123;<br>CurRetryWindowSize <span class="hljs-type">int</span> <span class="hljs-comment">//é‡è¯•çª—å£</span><br>CurUsedQuota       <span class="hljs-type">int</span><br>&#125;<br><br><span class="hljs-comment">// GetRetryQuota è·å–é‡è¯•é…é¢</span><br><span class="hljs-comment">// succRate æ»‘çª—ç»Ÿè®¡æœ€è¿‘æˆåŠŸç‡ï¼Œæ¯”å¦‚æœ€è¿‘5s</span><br><span class="hljs-comment">// retryProbeNum: é‡è¯•æ¬¡æ•°</span><br><span class="hljs-comment">// reqIdx: æœ¬åœ°è¯·æ±‚æ€»æ¬¡æ•°</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(l *RetryLimiter)</span></span> GetRetryQuota(succRate <span class="hljs-type">float64</span>, retryProbeNum <span class="hljs-type">int</span>, reqIdx <span class="hljs-type">int</span>) <span class="hljs-type">int</span> &#123;<br><span class="hljs-keyword">if</span> succRate &gt; <span class="hljs-number">0.9</span> &#123;<br><span class="hljs-keyword">if</span> retryProbeNum &gt;= l.CurRetryWindowSize &#123;<br><span class="hljs-comment">// å–å½“å‰è¯·æ±‚æµé‡1%ä½œä¸ºå¢é‡ï¼ŒåŒæ—¶minå‡½æ•°ç¡®ä¿çª—å£è°ƒæ•´çš„å¢é‡ä¸è¶…è¿‡å½“å‰çª—å£å¤§å°ï¼Œä¿æŒè°ƒæ•´çš„å¹³ç¨³æ€§</span><br>l.CurRetryWindowSize = l.CurRetryWindowSize + max(min(<span class="hljs-number">1</span>*reqIdx/<span class="hljs-number">100</span>, l.CurRetryWindowSize), <span class="hljs-number">1</span>)<br>&#125;<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>l.CurRetryWindowSize = max(<span class="hljs-number">1</span>, l.CurRetryWindowSize/<span class="hljs-number">2</span>)<br>&#125;<br><br><span class="hljs-keyword">return</span> l.CurRetryWindowSize<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">min</span><span class="hljs-params">(a, b <span class="hljs-type">int</span>)</span></span> <span class="hljs-type">int</span> &#123;<br><span class="hljs-keyword">if</span> a &lt; b &#123;<br><span class="hljs-keyword">return</span> a<br>&#125;<br><span class="hljs-keyword">return</span> b<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">max</span><span class="hljs-params">(a, b <span class="hljs-type">int</span>)</span></span> <span class="hljs-type">int</span> &#123;<br><span class="hljs-keyword">if</span> a &gt; b &#123;<br><span class="hljs-keyword">return</span> a<br>&#125;<br><span class="hljs-keyword">return</span> b<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br><br>l := RetryLimiter&#123;<br>CurRetryWindowSize: <span class="hljs-number">10</span>,<br>&#125;<br><br><span class="hljs-keyword">for</span> i := <span class="hljs-number">1</span>; i &lt; <span class="hljs-number">100</span>; i++ &#123;<br>succRate := <span class="hljs-type">float64</span>(i) * <span class="hljs-number">0.1</span><br><span class="hljs-keyword">if</span> i &gt; <span class="hljs-number">50</span> &#123;<br>succRate *= <span class="hljs-number">0.1</span><br>&#125;<br><span class="hljs-comment">//retryNum := rand.Int() % 10</span><br>retryProbeNum := rand.Int() % <span class="hljs-number">40</span><br>fmt.Println(<span class="hljs-string">&quot;req:&quot;</span>, i, <span class="hljs-string">&quot;, succRate:&quot;</span>, succRate, <span class="hljs-string">&quot;, get retry quota:&quot;</span>, l.GetRetryQuota(succRate, retryProbeNum, i))<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="è´Ÿè½½å‡è¡¡"><a href="#è´Ÿè½½å‡è¡¡" class="headerlink" title="è´Ÿè½½å‡è¡¡"></a>è´Ÿè½½å‡è¡¡</h2><h3 id="å‰ç«¯è´Ÿè½½å‡è¡¡"><a href="#å‰ç«¯è´Ÿè½½å‡è¡¡" class="headerlink" title="å‰ç«¯è´Ÿè½½å‡è¡¡"></a>å‰ç«¯è´Ÿè½½å‡è¡¡</h3><p>è¿™éƒ¨åˆ†å€Ÿé‰´è‡ªã€ŠGoogle SREã€‹ï¼Œä¸»è¦æ˜¯é€šè¿‡DNSå’ŒMaglevé›†ç¾¤å»å®ç°åˆ†æµ, ç®€å•æ¥è¯´è¯·æ±‚å…ˆé€šè¿‡DNSæ‹¿åˆ°æ¥å…¥å±‚å¤–ç½‘ip, ä¹‹åå‘èµ·VIPè¯·æ±‚åˆ°MaglevèŠ‚ç‚¹ä¸Š(VIPåŸºäºkeepalive), Maglevä¹Ÿæ˜¯4å±‚è½¯ä»¶è´Ÿè½½å’ŒLVSç±»ä¼¼,æœ‰å…´è¶£å¯ä»¥çœ‹ä¸‹<a href="https://www.manjusaka.blog/posts/2020/05/22/a-simple-introduction-about-maglev/index.html">è¿™ç¯‡æ–‡ç« </a><br><img src="/images/maglev.png" alt="Google-maglevè´Ÿè½½å‡è¡¡"></p><p>å›½å†…ç”¨lvså±…å¤šï¼Œå¤§ä½“ä¹Ÿç±»ä¼¼:<br><img src="/images/fe_lb.png" alt="å‰ç«¯è´Ÿè½½å‡è¡¡"></p><h3 id="æ•°æ®ä¸­å¿ƒå†…è´Ÿè½½å‡è¡¡"><a href="#æ•°æ®ä¸­å¿ƒå†…è´Ÿè½½å‡è¡¡" class="headerlink" title="æ•°æ®ä¸­å¿ƒå†…è´Ÿè½½å‡è¡¡"></a>æ•°æ®ä¸­å¿ƒå†…è´Ÿè½½å‡è¡¡</h3><p><strong>Subset(å­é›†ç®—æ³•é™åˆ¶æµ·é‡è¿æ¥)</strong><br>åœ¨å¾®æœåŠ¡æ¶æ„ä¸‹ï¼ŒæœåŠ¡ä¹‹é—´ä¸ä»…ä¼šæœ‰â€œæ­£å¸¸çš„â€rpcè°ƒç”¨ï¼Œä¹Ÿä¼šæœ‰å¿ƒè·³è¯·æ±‚æ¢æµ‹ä¾èµ–æœåŠ¡çš„å­˜æ´»ã€‚é—®é¢˜æ¥äº†å‡è®¾å½“å‰æœåŠ¡ä¾èµ–çš„ä¸‹æ¸¸æœåŠ¡å¾ˆå¤šï¼Œå¹¶ä¸”å¦‚æœä¸‹æ¸¸åˆæ˜¯å†—ä½™äº†å¤šä¸ªé›†ç¾¤ï¼Œé‚£ä¹ˆåŠ¿å¿…éœ€è¦å»ºç«‹å¤§é‡çš„tcpè¿æ¥(è¿æ¥æ•°&#x3D;clients*backends)ï¼Œå†åŠ ä¸Šåç»­éœ€è¦ä¼šæœ‰å¤§é‡çš„å¿ƒè·³åŒ…ï¼Œå ç”¨äº†å¤§é‡cpuèµ„æºï¼Œé¢å¯¹æµ·é‡è¿æ¥clientè¯¥å¦‚ä½•å¤„ç†?<br><img src="/images/google_subset.png" alt="å­é›†ç®—æ³•"></p><p><strong>å¸¸è§ç­–ç•¥</strong></p><ul><li>è½®è®­</li><li>æœ€å°‘è¿æ¥æ•°(inflight)</li><li>è½®è®­åŠ æƒ,(æˆåŠŸ+ï¼Œå¤±è´¥-) + cpuä½¿ç”¨ç‡</li><li>[the choice of two] (<a href="https://medium.com/the-intuition-project/load-balancing-the-intuition-behind-the-power-of-two-random-choices-6de2e139ac2f">https://medium.com/the-intuition-project/load-balancing-the-intuition-behind-the-power-of-two-random-choices-6de2e139ac2f</a>)</li></ul><p><strong>è½®è®­:</strong><br>ç†æƒ³æƒ…å†µä¸‹æµé‡è¢«å¹³å‡åˆ†é…ä¹‹åï¼Œä¸‹æ¸¸èŠ‚ç‚¹ä¹‹é—´çš„cpuè´Ÿè½½å·®å¼‚åº”è¯¥éƒ½ä¸ç›¸ä¸Šä¸‹ï¼Œå¯æ˜¯å®é™…æƒ…å†µæ˜¯èŠ‚ç‚¹ä¹‹é—´çš„è´Ÿè½½å·®å¼‚å¯èƒ½ä¼šå¾ˆå¤§ï¼Œå¯¼è‡´å¾ˆå¤šèµ„æºè¢«æµªè´¹ï¼ŒåŸå› å¦‚ä¸‹:</p><ul><li>è¯·æ±‚å¤„ç†æˆæœ¬ä¸ä¸€è‡´</li><li>æœºå™¨èµ„æº&#x2F;é…ç½®ä¸ä¸€è‡´</li><li>æ€§èƒ½å› ç´ : GC<br>å› æ­¤è½®è®­åœ¨ç”Ÿäº§ç¯å¢ƒå¾ˆå°‘ä¼šä½¿ç”¨ï¼Œæ¯•ç«ŸçœŸå®ç¯å¢ƒçš„è¯·æ±‚å¤„ç†æˆæœ¬ä¸€å®šæ˜¯ä¸å‡è¡¡çš„ã€‚</li></ul><p><strong>æœ€å°‘è¿æ¥æ•°(inflight)</strong><br>ç»Ÿè®¡æ¯ä¸ªè¿æ¥çš„inflightè¯·æ±‚æ•°, è¯·æ±‚è½¬å‘åˆ°è¯·æ±‚æœ€å°‘çš„èŠ‚ç‚¹ä¸Šã€‚ä½†è¿˜æ˜¯å­˜åœ¨è¯·æ±‚å¤„ç†æˆæœ¬çš„é—®é¢˜ï¼Œè™½ç„¶æŸäº›èŠ‚ç‚¹è¿æ¥æ•°å°‘ï¼Œä½†æ˜¯ä¸‡ä¸€æœ‰ä¸ªè¯·æ±‚æˆæœ¬å¾ˆé«˜ï¼Œè¿˜æ˜¯å¯¼è‡´è´Ÿè½½ä¸å‡è¡¡ã€‚</p><p><strong>åŠ æƒè½®è®­</strong><br>ä»¥ä¸Šä¸¤ç§è´Ÿè½½å‡è¡¡éƒ½æ˜¯ä»clientç«¯å‡ºå‘ï¼Œæ²¡æœ‰ä»ä¸‹æ¸¸è´Ÿè½½å»è€ƒè™‘ï¼Œå¯¼è‡´ä¸‹æ¸¸è´Ÿè½½ä¸å‡ã€‚æ‰€ä»¥è½®è®­åŠ æƒçš„å®ç°æ€è·¯æ˜¯ä¾æ®è¯·æ±‚<strong>å“åº”ç»“æœ</strong>[æˆåŠŸ&#x2F;å¤±è´¥]ä»¥åŠä¸‹æ¸¸æœåŠ¡<strong>cpuä½¿ç”¨ç‡</strong>æ¥åŠ¨æ€æ§åˆ¶èŠ‚ç‚¹æƒé‡(cpuä½¿ç”¨ç‡æ˜¯é€šè¿‡rpcå›æŠ¥è·å–)ã€‚</p><p><strong>best of two random choices</strong><br>åŠ æƒè½®è®­çš„è®¾è®¡ç”±äºâ€œä¿¡æ¯æ»åâ€å­˜åœ¨â€œç¾Šç¾¤æ•ˆåº”â€é—®é¢˜ï¼ŒåŸå› æœ‰2ç‚¹, ç¬¬ä¸€clientè‡³å°‘éœ€è¦1ä¸ªRTTæ‰èƒ½æ‹¿åˆ°cpuä½¿ç”¨ç‡ï¼Œå­˜åœ¨ç½‘ç»œã€å…ˆåè¯·æ±‚å»¶è¿Ÿã€‚ç¬¬äºŒâ€œå®šæœŸâ€æ›´æ–°èŠ‚ç‚¹æƒé‡ã€‚å› æ­¤clientä»¥ä¸ºæ‹¿åˆ°äº†æœ€ä¼˜èŠ‚ç‚¹ï¼Œä½†å®é™…è¯·æ±‚çš„æ˜¯â€œå·²ç»ä»ä¸é¥±å’Œå˜é¥±å’Œâ€çš„èŠ‚ç‚¹ï¼Œå¯¼è‡´å¤§é‡è¯·æ±‚è¶…æ—¶&#x2F;æ‹’ç»ã€‚<br>best of two random choicesï¼Œåˆ™é‡‡ç”¨äº†å¸¦æ—¶é—´è¡°å‡çš„æŒ‡æ•°è¡°å‡(exponentially weighted moving average)[å¸¦ç³»æ•°çš„æŒ‡æ•°è¡°å‡]ï¼Œå¼•å…¥äº†inflightï¼Œlagä½œä¸ºè´Ÿè½½å‡è¡¡çš„å‚è€ƒ</p><p><img src="/images/two_of_random_choices.png" alt="two_of_random_choices"><br><strong>ç®—æ³•å®ç°</strong><br><a href="https://github.com/go-kratos/kratos/blob/4a93aa9b8d5dca550cc60a0c51c4726f83a2e6f8/pkg/net/rpc/warden/balancer/p2c/p2c.go">Bç«™å®ç°</a><br><img src="/images/two_of_random_choices_algo.png" alt="ç®—æ³•å®ç°"></p><h2 id="åˆ†å¸ƒå¼é™æµ"><a href="#åˆ†å¸ƒå¼é™æµ" class="headerlink" title="åˆ†å¸ƒå¼é™æµ"></a>åˆ†å¸ƒå¼é™æµ</h2><ul><li>å³æ—¶æ¶ˆè´¹å³æ—¶ç»“ç®—</li><li>å…ˆæ¶ˆè´¹åç»“ç®—</li><li>é¢„åˆ†é…<br>è¿™éƒ¨åˆ†å†…å®¹å°±ä¸é‡å¤äº†ï¼Œç›´æ¥çœ‹<a href="https://codingwhat.github.io/2024/07/09/limiter-in-action/">é™æµå®æˆ˜</a></li></ul><h2 id="éš”ç¦»"><a href="#éš”ç¦»" class="headerlink" title="éš”ç¦»"></a>éš”ç¦»</h2><ul><li>åŠ¨é™éš”ç¦»</li><li>çº¿ç¨‹éš”ç¦»</li><li>è¿›ç¨‹éš”ç¦»(å®¹å™¨éƒ¨ç½²)</li><li>ç§Ÿæˆ·éš”ç¦»</li><li>æ ¸å¿ƒéš”ç¦»</li><li>è¯»å†™éš”ç¦»</li><li>çƒ­ç‚¹éš”ç¦»</li><li>é›†ç¾¤éš”ç¦»</li></ul><h3 id="åŠ¨é™éš”ç¦»"><a href="#åŠ¨é™éš”ç¦»" class="headerlink" title="åŠ¨é™éš”ç¦»"></a>åŠ¨é™éš”ç¦»</h3><ul><li>é™æ€èµ„æº, CDNç¼“å­˜htmlã€cssç­‰é™æ€èµ„æº</li><li>åŠ¨æ€èµ„æºï¼Œæ¥å£è·å–</li></ul><h3 id="çº¿ç¨‹éš”ç¦»"><a href="#çº¿ç¨‹éš”ç¦»" class="headerlink" title="çº¿ç¨‹éš”ç¦»"></a>çº¿ç¨‹éš”ç¦»</h3><ul><li>javaä¼šé€šè¿‡ä¸åŒçº¿ç¨‹æ± å¤„ç†è¯·æ±‚ï¼Œåˆ’åˆ†cpuèµ„æº</li><li>Goä¸é€‚ç”¨ï¼ŒGoè°ƒåº¦æ¨¡å‹å°±ä¼šå¤ç”¨çº¿ç¨‹ï¼Œæ— æ³•åšéš”ç¦»ï¼Œåªèƒ½æ§åˆ¶goroutineä¸ªæ•°</li></ul><h3 id="è¿›ç¨‹éš”ç¦»"><a href="#è¿›ç¨‹éš”ç¦»" class="headerlink" title="è¿›ç¨‹éš”ç¦»"></a>è¿›ç¨‹éš”ç¦»</h3><ul><li>ç›®å‰å¾®æœåŠ¡æ¶æ„åŸºäºå®¹å™¨éƒ¨ç½²ï¼Œéƒ½æ˜¯ç‹¬ç«‹è¿›ç¨‹ã€cpuã€å†…å­˜èµ„æºäº’ä¸å½±å“</li></ul><h3 id="ç§Ÿæˆ·éš”ç¦»"><a href="#ç§Ÿæˆ·éš”ç¦»" class="headerlink" title="ç§Ÿæˆ·éš”ç¦»"></a>ç§Ÿæˆ·éš”ç¦»</h3><ul><li>ä¸åŒç§Ÿæˆ·è¯·æ±‚çš„ä¸åŒæœåŠ¡&#x2F;å­˜å‚¨</li></ul><h3 id="æ ¸å¿ƒéš”ç¦»"><a href="#æ ¸å¿ƒéš”ç¦»" class="headerlink" title="æ ¸å¿ƒéš”ç¦»"></a>æ ¸å¿ƒéš”ç¦»</h3><p>æ ¸å¿ƒéš”ç¦»é€šå¸¸æ˜¯æŒ‡å°†èµ„æºæŒ‰ç…§ <code>æ ¸å¿ƒä¸šåŠ¡</code> ä¸ <code>éæ ¸å¿ƒä¸šåŠ¡</code> è¿›è¡Œåˆ’åˆ†ï¼Œä¼˜å…ˆä¿éšœ <code>æ ¸å¿ƒä¸šåŠ¡</code> çš„ç¨³å®šè¿è¡Œ<br>æ ¸å¿ƒ&#x2F;éæ ¸å¿ƒæ•…éšœåŸŸçš„å·®å¼‚éš”ç¦»ï¼ˆæœºå™¨èµ„æºã€ä¾èµ–èµ„æºï¼‰  </p><p>æ ¸å¿ƒä¸šåŠ¡å¯ä»¥æ­å»ºå¤šé›†ç¾¤é€šè¿‡å†—ä½™èµ„æºæ¥æå‡ååå’Œå®¹ç¾èƒ½åŠ›</p><p>æŒ‰ç…§æœåŠ¡çš„æ ¸å¿ƒç¨‹åº¦è¿›è¡Œåˆ†çº§<br>1çº§ï¼šç³»ç»Ÿä¸­æœ€å…³é”®çš„æœåŠ¡ï¼Œå¦‚æœå‡ºç°æ•…éšœä¼šå¯¼è‡´ç”¨æˆ·æˆ–ä¸šåŠ¡äº§ç”Ÿé‡å¤§æŸå¤±<br>2çº§ï¼šå¯¹äºä¸šåŠ¡éå¸¸é‡è¦ï¼Œå¦‚æœå‡ºç°æ•…éšœä¼šå¯¼è‡´ç”¨æˆ·ä½“éªŒå—åˆ°å½±å“ï¼Œä½†ä¸ä¼šå¯¼è‡´ç³»ç»Ÿå®Œå…¨æ— æ³•ä½¿ç”¨<br>3çº§ï¼šä¼šå¯¹ç”¨æˆ·é€ æˆè¾ƒå°çš„å½±å“ï¼Œä¸å®¹æ˜“æ³¨æ„æˆ–å¾ˆéš¾å‘ç°<br>4çº§ï¼šå³ä½¿å¤±è´¥ï¼Œä¹Ÿä¸ä¼šå¯¹ç”¨æˆ·ä½“éªŒé€ æˆå½±å“  </p><h3 id="è¯»å†™éš”ç¦»"><a href="#è¯»å†™éš”ç¦»" class="headerlink" title="è¯»å†™éš”ç¦»"></a>è¯»å†™éš”ç¦»</h3><ul><li>å­˜å‚¨è¯»å†™åˆ†ç¦»(redis&#x2F;mysql&#x2F;es)</li><li>åº”ç”¨å±‚è¯»å†™åˆ†ç¦»ï¼ŒCQRS</li><li>äº‹ä»¶é©±åŠ¨ï¼Œå†™æ“ä½œä¹‹åå‘å¸ƒäº‹ä»¶ï¼Œè¯»æœåŠ¡ç›‘å¬ä¿®æ”¹</li></ul><h3 id="çƒ­ç‚¹éš”ç¦»"><a href="#çƒ­ç‚¹éš”ç¦»" class="headerlink" title="çƒ­ç‚¹éš”ç¦»"></a>çƒ­ç‚¹éš”ç¦»</h3><ul><li>å®æ—¶ç»Ÿè®¡ + çƒ­ç‚¹è¯†åˆ« + å¤šçº§ç¼“å­˜ </li><li>çƒ­ç‚¹ç›‘æ§</li></ul><h3 id="é›†ç¾¤éš”ç¦»"><a href="#é›†ç¾¤éš”ç¦»" class="headerlink" title="é›†ç¾¤éš”ç¦»"></a>é›†ç¾¤éš”ç¦»</h3><p>æ¯ä¸ªæœåŠ¡éƒ¨ç½²ç‹¬ç«‹çš„é›†ç¾¤</p><h1 id="å·¥ç¨‹å®è·µä¸å·¥å…·ç”Ÿæ€"><a href="#å·¥ç¨‹å®è·µä¸å·¥å…·ç”Ÿæ€" class="headerlink" title="å·¥ç¨‹å®è·µä¸å·¥å…·ç”Ÿæ€"></a>å·¥ç¨‹å®è·µä¸å·¥å…·ç”Ÿæ€</h1><p>å‰è¿°ç« èŠ‚ä»ç†è®ºè®¾è®¡åˆ°æŠ€æœ¯å®ç°ï¼Œæ„å»ºäº†å®Œæ•´çš„é«˜å¯ç”¨æ²»ç†ä½“ç³»ã€‚ä½†<strong>è®¾è®¡å†å®Œç¾ï¼Œä¸ç»å®æˆ˜éªŒè¯å°±æ˜¯çº¸ä¸Šè°ˆå…µ</strong>ã€‚æœ¬ç« èšç„¦å·¥ç¨‹å®è·µï¼Œé€šè¿‡æ··æ²Œå·¥ç¨‹ã€å…¨é“¾è·¯å‹æµ‹ç­‰æ‰‹æ®µéªŒè¯ç³»ç»ŸéŸ§æ€§ï¼Œé€šè¿‡å¯è§‚æµ‹æ€§å»ºè®¾ç¡®ä¿SLOç›®æ ‡çš„æŒç»­è¾¾æˆã€‚</p><h2 id="æ··æ²Œå·¥ç¨‹ï¼šä¸»åŠ¨æ•…éšœå‘ç°"><a href="#æ··æ²Œå·¥ç¨‹ï¼šä¸»åŠ¨æ•…éšœå‘ç°" class="headerlink" title="æ··æ²Œå·¥ç¨‹ï¼šä¸»åŠ¨æ•…éšœå‘ç°"></a>æ··æ²Œå·¥ç¨‹ï¼šä¸»åŠ¨æ•…éšœå‘ç°</h2><h3 id="æ··æ²Œå·¥ç¨‹å®æ–½æ¡†æ¶"><a href="#æ··æ²Œå·¥ç¨‹å®æ–½æ¡†æ¶" class="headerlink" title="æ··æ²Œå·¥ç¨‹å®æ–½æ¡†æ¶"></a>æ··æ²Œå·¥ç¨‹å®æ–½æ¡†æ¶</h3><p>æ··æ²Œå·¥ç¨‹é€šè¿‡ä¸»åŠ¨æ³¨å…¥æ•…éšœéªŒè¯ç³»ç»ŸéŸ§æ€§ï¼Œæ ¸å¿ƒå®è·µåŒ…æ‹¬ï¼š</p><p><strong>1. æ•…éšœæ³¨å…¥ç±»å‹</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">chaos_experiments:</span><br>  <span class="hljs-attr">network_chaos:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">network_delay:</span> <span class="hljs-string">&quot;100ms-1000ms&quot;</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">packet_loss:</span> <span class="hljs-string">&quot;1%-10%&quot;</span>  <br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">network_partition:</span> <span class="hljs-string">&quot;split-brain&quot;</span><br>    <br>  <span class="hljs-attr">resource_chaos:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">cpu_stress:</span> <span class="hljs-string">&quot;80%-100%&quot;</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">memory_stress:</span> <span class="hljs-string">&quot;90%-95%&quot;</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">disk_io_stress:</span> <span class="hljs-string">&quot;high_latency&quot;</span><br>    <br>  <span class="hljs-attr">service_chaos:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">pod_kill:</span> <span class="hljs-string">&quot;random_kill&quot;</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">service_unavailable:</span> <span class="hljs-string">&quot;dependency_failure&quot;</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">database_slow:</span> <span class="hljs-string">&quot;connection_timeout&quot;</span><br></code></pre></td></tr></table></figure><p><strong>2. å®éªŒè®¾è®¡åŸåˆ™</strong></p><ul><li><strong>å‡è®¾é©±åŠ¨</strong>ï¼šåŸºäºæ˜ç¡®å‡è®¾è®¾è®¡å®éªŒ</li><li><strong>å½±å“èŒƒå›´æ§åˆ¶</strong>ï¼šä»å°èŒƒå›´å¼€å§‹ï¼Œé€æ­¥æ‰©å¤§</li><li><strong>ç›‘æ§ä¿éšœ</strong>ï¼šå®æ—¶ç›‘æ§å…³é”®æŒ‡æ ‡ï¼ŒåŠæ—¶æ­¢æŸ</li><li><strong>è‡ªåŠ¨åŒ–å›æ»š</strong>ï¼šå¼‚å¸¸æƒ…å†µä¸‹è‡ªåŠ¨ç»ˆæ­¢å®éªŒ</li></ul><h2 id="å…¨é“¾è·¯å‹æµ‹ï¼šç”Ÿäº§çº§éªŒè¯"><a href="#å…¨é“¾è·¯å‹æµ‹ï¼šç”Ÿäº§çº§éªŒè¯" class="headerlink" title="å…¨é“¾è·¯å‹æµ‹ï¼šç”Ÿäº§çº§éªŒè¯"></a>å…¨é“¾è·¯å‹æµ‹ï¼šç”Ÿäº§çº§éªŒè¯</h2><h3 id="å‹æµ‹ä½“ç³»å»ºè®¾"><a href="#å‹æµ‹ä½“ç³»å»ºè®¾" class="headerlink" title="å‹æµ‹ä½“ç³»å»ºè®¾"></a>å‹æµ‹ä½“ç³»å»ºè®¾</h3><p><strong>å‹æµ‹æµç¨‹è®¾è®¡</strong>ï¼š</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs">å‹æµ‹é“¾è·¯ï¼š<br>æµé‡æ„å»º â†’ æ•°æ®éš”ç¦» â†’ å‹æµ‹æ‰§è¡Œ â†’ å®æ—¶ç›‘æ§ â†’ ç»“æœåˆ†æ<br>    â†“         â†“         â†“         â†“         â†“<br>æµé‡å½•åˆ¶   å½±å­åº“è¡¨   æ¸è¿›åŠ å‹   å¤šç»´æŒ‡æ ‡   ç“¶é¢ˆè¯†åˆ«<br>æµé‡å›æ”¾   æ ‡è¯†é€ä¼    å³°å€¼ä¿æŒ   å¼‚å¸¸æ£€æµ‹   å®¹é‡è§„åˆ’<br></code></pre></td></tr></table></figure><p><strong>å½±å­åº“è¡¨å®ç°</strong>ï¼š</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs golang"><span class="hljs-comment">// å½±å­è¡¨è·¯ç”±å™¨</span><br><span class="hljs-keyword">type</span> ShadowTableRouter <span class="hljs-keyword">struct</span> &#123;<br>    normalTables <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">string</span><br>    shadowTables <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">string</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(r *ShadowTableRouter)</span></span> GetTableName(table <span class="hljs-type">string</span>, isLoadTest <span class="hljs-type">bool</span>) <span class="hljs-type">string</span> &#123;<br>    <span class="hljs-keyword">if</span> isLoadTest &#123;<br>        <span class="hljs-keyword">if</span> shadowTable, exists := r.shadowTables[table]; exists &#123;<br>            <span class="hljs-keyword">return</span> shadowTable<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> r.normalTables[table]<br>&#125;<br><br><span class="hljs-comment">// å‹æµ‹æµé‡æ ‡è¯†</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(r *ShadowTableRouter)</span></span> IsLoadTestRequest(headers <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">string</span>) <span class="hljs-type">bool</span> &#123;<br>    <span class="hljs-keyword">return</span> headers[<span class="hljs-string">&quot;X-Load-Test&quot;</span>] == <span class="hljs-string">&quot;true&quot;</span><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="å¯è§‚æµ‹æ€§å»ºè®¾"><a href="#å¯è§‚æµ‹æ€§å»ºè®¾" class="headerlink" title="å¯è§‚æµ‹æ€§å»ºè®¾"></a>å¯è§‚æµ‹æ€§å»ºè®¾</h2><h3 id="ç»Ÿä¸€ç›‘æ§ä½“ç³»"><a href="#ç»Ÿä¸€ç›‘æ§ä½“ç³»" class="headerlink" title="ç»Ÿä¸€ç›‘æ§ä½“ç³»"></a>ç»Ÿä¸€ç›‘æ§ä½“ç³»</h3><p><strong>å››ä¸ªé»„é‡‘ä¿¡å·ï¼ˆGoogle SREï¼‰</strong>ï¼š</p><ol><li><strong>å»¶è¿Ÿï¼ˆLatencyï¼‰</strong>ï¼šè¯·æ±‚å“åº”æ—¶é—´åˆ†å¸ƒ</li><li><strong>æµé‡ï¼ˆTrafficï¼‰</strong>ï¼šç³»ç»Ÿæ‰¿è½½çš„è¯·æ±‚é‡</li><li><strong>é”™è¯¯ï¼ˆErrorsï¼‰</strong>ï¼šå¤±è´¥è¯·æ±‚çš„æ¯”ä¾‹</li><li><strong>é¥±å’Œåº¦ï¼ˆSaturationï¼‰</strong>ï¼šç³»ç»Ÿèµ„æºä½¿ç”¨æƒ…å†µ</li></ol><p><strong>ç›‘æ§æŒ‡æ ‡å±‚æ¬¡</strong>ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">monitoring_layers:</span><br>  <span class="hljs-attr">business_metrics:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">order_success_rate</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">payment_conversion_rate</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">user_login_success_rate</span><br>    <br>  <span class="hljs-attr">application_metrics:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">api_response_time</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">database_connection_pool</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">cache_hit_rate</span><br>    <br>  <span class="hljs-attr">infrastructure_metrics:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">cpu_utilization</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">memory_usage</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">network_bandwidth</span><br>    <br>  <span class="hljs-attr">custom_metrics:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">error_budget_consumption</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">slo_compliance_rate</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">incident_resolution_time</span><br></code></pre></td></tr></table></figure><h1 id="æ€»ç»“ä¸æœ€ä½³å®è·µ"><a href="#æ€»ç»“ä¸æœ€ä½³å®è·µ" class="headerlink" title="æ€»ç»“ä¸æœ€ä½³å®è·µ"></a>æ€»ç»“ä¸æœ€ä½³å®è·µ</h1><p>æœ¬æ–‡æ„å»ºäº†ä»ç†è®ºåŸºç¡€åˆ°å·¥ç¨‹å®è·µçš„å®Œæ•´é«˜å¯ç”¨æ²»ç†ä½“ç³»ï¼š</p><ul><li><strong>åŸºç¡€ä½“ç³»</strong>ï¼šä»¥SLOä¸ºæ ¸å¿ƒçš„æŒ‡æ ‡è®¾è®¡å’Œç›‘æ§å‘Šè­¦ï¼Œå»ºç«‹æ²»ç†çš„åº¦é‡åŸºå‡†</li><li><strong>å•èŠ‚ç‚¹é˜²æŠ¤</strong>ï¼šé€šè¿‡é™æµã€ç†”æ–­ã€è¶…æ—¶ã€é™çº§ã€é‡è¯•äº”å¤§æœºåˆ¶ï¼Œç¡®ä¿å•ç‚¹ç¨³å®šæ€§</li><li><strong>åˆ†å¸ƒå¼æ¶æ„</strong>ï¼šé€šè¿‡å†—ä½™ã€æ•…éšœè½¬ç§»ã€è´Ÿè½½å‡è¡¡ç­‰æ‰‹æ®µï¼Œæ¶ˆé™¤å•ç‚¹æ•…éšœé£é™©</li><li><strong>å·¥ç¨‹å®è·µ</strong>ï¼šé€šè¿‡æ··æ²Œå·¥ç¨‹ã€å‹æµ‹éªŒè¯ã€å¯è§‚æµ‹æ€§å»ºè®¾ï¼Œç¡®ä¿ç†è®ºè½åœ°</li></ul><h2 id="é«˜å¯ç”¨æ²»ç†å®æ–½è·¯å¾„"><a href="#é«˜å¯ç”¨æ²»ç†å®æ–½è·¯å¾„" class="headerlink" title="é«˜å¯ç”¨æ²»ç†å®æ–½è·¯å¾„"></a>é«˜å¯ç”¨æ²»ç†å®æ–½è·¯å¾„</h2><h3 id="æˆç†Ÿåº¦æ¨¡å‹"><a href="#æˆç†Ÿåº¦æ¨¡å‹" class="headerlink" title="æˆç†Ÿåº¦æ¨¡å‹"></a>æˆç†Ÿåº¦æ¨¡å‹</h3><table><thead><tr><th>æˆç†Ÿåº¦ç­‰çº§</th><th>é˜²æŠ¤èƒ½åŠ›</th><th>æŠ€æœ¯ç‰¹å¾</th><th>é€‚ç”¨è§„æ¨¡</th><th>å…¸å‹ä»£è¡¨</th></tr></thead><tbody><tr><td><strong>Level 1</strong></td><td>åŸºç¡€é˜²æŠ¤</td><td>é™æµã€è¶…æ—¶ã€é‡è¯•</td><td>å°å‹ç³»ç»Ÿ</td><td>åˆ›ä¸šå…¬å¸</td></tr><tr><td><strong>Level 2</strong></td><td>æ•…éšœéš”ç¦»</td><td>ç†”æ–­ã€é™çº§ã€ç›‘æ§</td><td>ä¸­å‹ç³»ç»Ÿ</td><td>ä¼ ç»Ÿä¼ä¸š</td></tr><tr><td><strong>Level 3</strong></td><td>åŒºåŸŸå®¹ç¾</td><td>åŒåŸåŒæ´»ã€æ•…éšœè½¬ç§»</td><td>å¤§å‹ç³»ç»Ÿ</td><td>äº’è”ç½‘å…¬å¸</td></tr><tr><td><strong>Level 4</strong></td><td>å…¨çƒåˆ†å¸ƒ</td><td>å¼‚åœ°å¤šæ´»ã€æ™ºèƒ½è°ƒåº¦</td><td>è¶…å¤§è§„æ¨¡</td><td>ç§‘æŠ€å·¨å¤´</td></tr></tbody></table><h3 id="å®æ–½ä¼˜å…ˆçº§å»ºè®®"><a href="#å®æ–½ä¼˜å…ˆçº§å»ºè®®" class="headerlink" title="å®æ–½ä¼˜å…ˆçº§å»ºè®®"></a>å®æ–½ä¼˜å…ˆçº§å»ºè®®</h3><p><strong>ç¬¬ä¸€é˜¶æ®µï¼šå»ºç«‹åŸºç¡€é˜²æŠ¤</strong></p><ol><li>å®æ–½é™æµä¿æŠ¤ï¼šAPIçº§åˆ«å’Œå®ä¾‹çº§åˆ«é™æµ</li><li>é…ç½®è¶…æ—¶æ§åˆ¶ï¼šè®¾ç½®åˆç†çš„è¶…æ—¶æ—¶é—´</li><li>éƒ¨ç½²ç›‘æ§å‘Šè­¦ï¼šå»ºç«‹åŸºç¡€çš„å¯è§‚æµ‹æ€§</li></ol><p><strong>ç¬¬äºŒé˜¶æ®µï¼šæ•…éšœéš”ç¦»æœºåˆ¶</strong></p><ol><li>ç†”æ–­å™¨éƒ¨ç½²ï¼šå¯¹å…³é”®ä¾èµ–å®æ–½ç†”æ–­ä¿æŠ¤</li><li>é™çº§ç­–ç•¥ï¼šæ ¸å¿ƒåŠŸèƒ½çš„æœ‰æŸæœåŠ¡è®¾è®¡</li><li>é”™è¯¯é¢„ç®—ï¼šå»ºç«‹SLOä½“ç³»å’Œç‡ƒå°½ç‡ç›‘æ§</li></ol><p><strong>ç¬¬ä¸‰é˜¶æ®µï¼šæ¶æ„å®¹ç¾å‡çº§</strong></p><ol><li>åŒåŸåŒæ´»ï¼šå®ç°åŒºåŸŸçº§æ•…éšœå®¹å¿</li><li>æ•°æ®åŒæ­¥ï¼šå¼ºä¸€è‡´æ€§æˆ–æœ€ç»ˆä¸€è‡´æ€§é€‰æ‹©</li><li>è‡ªåŠ¨æ•…éšœè½¬ç§»ï¼šç§’çº§åˆ‡æ¢èƒ½åŠ›</li></ol><p><strong>ç¬¬å››é˜¶æ®µï¼šå…¨é“¾è·¯ä¼˜åŒ–</strong></p><ol><li>å•å…ƒåŒ–æ‹†åˆ†ï¼šä¸šåŠ¡è‡ªåŒ…å«çš„å•å…ƒè®¾è®¡</li><li>å…¨çƒåˆ†å¸ƒï¼šå¼‚åœ°å¤šæ´»æ¶æ„</li><li>æ™ºèƒ½è°ƒåº¦ï¼šåŸºäºMLçš„æ•…éšœé¢„æµ‹å’Œè‡ªæ„ˆ</li></ol><h3 id="å…³é”®æˆåŠŸå› ç´ "><a href="#å…³é”®æˆåŠŸå› ç´ " class="headerlink" title="å…³é”®æˆåŠŸå› ç´ "></a>å…³é”®æˆåŠŸå› ç´ </h3><p><strong>æŠ€æœ¯å±‚é¢</strong>ï¼š</p><ul><li><strong>æ¸è¿›å¼æ¼”è¿›</strong>ï¼šé¿å…å¤§çˆ†ç‚¸å¼æ”¹é€ ï¼Œé‡‡ç”¨æ¸è¿›å¼æ¼”è¿›</li><li><strong>åº¦é‡é©±åŠ¨</strong>ï¼šå»ºç«‹å®Œå–„çš„æŒ‡æ ‡ä½“ç³»ï¼Œæ•°æ®é©±åŠ¨å†³ç­–</li><li><strong>è‡ªåŠ¨åŒ–ä¼˜å…ˆ</strong>ï¼šå‡å°‘äººå·¥å¹²é¢„ï¼Œæå‡å“åº”é€Ÿåº¦</li></ul><p><strong>ç»„ç»‡å±‚é¢</strong>ï¼š</p><ul><li><strong>SREæ–‡åŒ–</strong>ï¼šå»ºç«‹å¯é æ€§å·¥ç¨‹å¸ˆè§’è‰²å’Œé”™è¯¯é¢„ç®—æ–‡åŒ–</li><li><strong>è·¨å›¢é˜Ÿåä½œ</strong>ï¼šå¼€å‘ã€è¿ç»´ã€æµ‹è¯•å›¢é˜Ÿçš„ç´§å¯†é…åˆ</li><li><strong>æŒç»­æ”¹è¿›</strong>ï¼šé€šè¿‡äº‹åå¤ç›˜å’Œæ··æ²Œå·¥ç¨‹æŒç»­æå‡</li></ul><p><strong>ä¸šåŠ¡å±‚é¢</strong>ï¼š</p><ul><li><strong>æˆæœ¬æ•ˆç›Šå¹³è¡¡</strong>ï¼šæ ¹æ®ä¸šåŠ¡é‡è¦æ€§ç¡®å®šæŠ•å…¥æ°´å¹³</li><li><strong>ç”¨æˆ·ä½“éªŒä¼˜å…ˆ</strong>ï¼šå¯ç”¨æ€§æå‡æœ€ç»ˆæœåŠ¡äºç”¨æˆ·ä½“éªŒ</li><li><strong>åˆè§„æ€§è€ƒè™‘</strong>ï¼šæ»¡è¶³è¡Œä¸šç›‘ç®¡å’Œåˆè§„è¦æ±‚</li></ul><p>é«˜å¯ç”¨æ²»ç†æ˜¯ä¸€ä¸ªç³»ç»Ÿæ€§å·¥ç¨‹ï¼Œéµå¾ªâ€<strong>ç†è®ºæŒ‡å¯¼â†’æŠ€æœ¯å®ç°â†’æ¶æ„ä¿éšœâ†’å®è·µéªŒè¯</strong>â€œçš„å®Œæ•´é—­ç¯ã€‚ä»SLOä½“ç³»çš„é¡¶å±‚è®¾è®¡ï¼Œåˆ°å•èŠ‚ç‚¹å’Œåˆ†å¸ƒå¼çš„æŠ€æœ¯é˜²æŠ¤ï¼Œå†åˆ°æ··æ²Œå·¥ç¨‹çš„å®æˆ˜éªŒè¯ï¼Œæ„æˆäº†é¢å‘ä¸šåŠ¡è¿ç»­æ€§çš„å®Œæ•´è§£å†³æ–¹æ¡ˆã€‚</p><p><strong>æ ¸å¿ƒç†å¿µ</strong>ï¼šå¯ç”¨æ€§ä¸æ˜¯æŠ€æœ¯é—®é¢˜ï¼Œè€Œæ˜¯ä¸šåŠ¡é—®é¢˜ã€‚æ‰€æœ‰æŠ€æœ¯æ‰‹æ®µéƒ½åº”æœåŠ¡äºä¸šåŠ¡è¿ç»­æ€§å’Œç”¨æˆ·ä½“éªŒï¼Œé€šè¿‡ç²¾ç¡®çš„åº¦é‡ä½“ç³»ç¡®ä¿æŠ•å…¥äº§å‡ºçš„æœ€ä¼˜å¹³è¡¡ã€‚</p>]]></content>
    
    
    <categories>
      
      <category>ç³»ç»Ÿæ¶æ„</category>
      
      <category>æœåŠ¡æ²»ç†</category>
      
    </categories>
    
    
    <tags>
      
      <tag>é«˜å¯ç”¨æ²»ç†</tag>
      
      <tag>å¾®æœåŠ¡æ²»ç†</tag>
      
      <tag>åˆ†å¸ƒå¼ç³»ç»Ÿ</tag>
      
      <tag>é™æµç†”æ–­</tag>
      
      <tag>æ¶æ„è®¾è®¡</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>é™æµå®æˆ˜</title>
    <link href="/2024/07/09/limiter-in-action/"/>
    <url>/2024/07/09/limiter-in-action/</url>
    
    <content type="html"><![CDATA[<blockquote><p>æœ‰ç»éªŒçš„å¼€å‘è€…éƒ½çŸ¥é“å³ä¾¿äº‹å‰åšäº†ä¸åŒè§„æ¨¡çš„å®¹é‡æ¨¡å‹ï¼Œä½†æ˜¯è¿˜æ˜¯æ²¡åŠæ³•å‡†ç¡®é¢„æµ‹æœªçŸ¥çš„å¤–éƒ¨æµé‡ï¼Œå› æ­¤æœåŠ¡å¿…é¡»å¾—é‡‡å–è‡ªä¿æŠ¤ç­–ç•¥ï¼Œä¸¢å¼ƒæ‰éƒ¨åˆ†æµé‡æ¥ä¿éšœæœåŠ¡çš„ç¨³å®šæ€§ã€‚</p></blockquote><span id="more"></span><p>æ¥ä¸‹æ¥æˆ‘ä»¬ä¼šå›´ç»•é™æ€ã€åŠ¨æ€ä»¥åŠé›†ç¾¤é™æµå»è®²è§£é™æµåœ¨ä¸åŒåœºæ™¯ä¸‹çš„å·¥ç¨‹å®è·µã€‚</p><h1 id="é™æ€é™æµ"><a href="#é™æ€é™æµ" class="headerlink" title="é™æ€é™æµ"></a>é™æ€é™æµ</h1><p><a href="golang.org/x/time/rate">æ ‡å‡†åº“-ä»¤ç‰Œæ¡¶</a>, åº”å¯¹å°è§„æ¨¡çªå‘æµé‡;<br><a href="https://github.com/uber-go/ratelimit">Uber-æ¼æ¡¶</a>, åŒ€é€Ÿé™æµ; çªå‘æµé‡ä¸¢å¼ƒé‡å¤š; !!è¿™ä¸ªåº“(v0.3.0)æœ‰bug<a href="https://colobu.com/2023/12/05/two-bugs-of-uber-ratelimit/">ç‚¹å‡»</a><br>æ»‘åŠ¨çª—å£, ç²¾åº¦é«˜; å ç”¨å†…å­˜<br>å›ºå®šçª—å£, å®ç°ç®€å•; ä¸ç²¾å‡†ï¼Œå­˜åœ¨è¾¹ç•Œé—®é¢˜</p><p>æ€»ç»“:</p><ul><li>å®ç°ç®€å•</li><li>åŸºäºQPSé™æµé™æ€é™æµ, æ— æ³•æ ¹æ®æœåŠ¡çš„è´Ÿè½½åŠ¨æ€é™æµ  </li><li>é™æµé˜ˆå€¼ä¸å¥½é…ç½®(è¯·æ±‚çš„å¤„ç†æˆæœ¬ä¸ä¸€è‡´)  </li><li>èŠ‚ç‚¹æ‰©ç¼©, éœ€è¦é‡æ–°è®¾ç½®</li></ul><h2 id="åŠ¨æ‰‹å®è·µ-ä»¤ç‰Œæ¡¶"><a href="#åŠ¨æ‰‹å®è·µ-ä»¤ç‰Œæ¡¶" class="headerlink" title="åŠ¨æ‰‹å®è·µ-ä»¤ç‰Œæ¡¶"></a>åŠ¨æ‰‹å®è·µ-ä»¤ç‰Œæ¡¶</h2><p>æ ¸å¿ƒé€»è¾‘æºè‡ªæ ‡å‡†åº“çš„rateåŒ…</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> TokenBucket <span class="hljs-keyword">struct</span> &#123;<br>rate       <span class="hljs-type">float64</span>    <span class="hljs-comment">// ä»¤ç‰Œæ·»åŠ åˆ°æ¡¶ä¸­çš„é€Ÿç‡ã€‚</span><br>burst      <span class="hljs-type">int</span>        <span class="hljs-comment">// æ¡¶çš„æœ€å¤§å®¹é‡ã€‚</span><br>tokens     <span class="hljs-type">float64</span>    <span class="hljs-comment">// å½“å‰æ¡¶ä¸­çš„ä»¤ç‰Œæ•°é‡ã€‚</span><br>lastUpdate time.Time  <span class="hljs-comment">// ä¸Šæ¬¡æ›´æ–°ä»¤ç‰Œæ•°é‡çš„æ—¶é—´ã€‚</span><br>mu         sync.Mutex <span class="hljs-comment">// äº’æ–¥é”ï¼Œç¡®ä¿çº¿ç¨‹å®‰å…¨ã€‚</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(tb *TokenBucket)</span></span> tokensFromDuration(d time.Duration) <span class="hljs-type">float64</span> &#123;<br><span class="hljs-comment">// Split the integer and fractional parts ourself to minimize rounding errors.</span><br><span class="hljs-comment">// See golang.org/issues/34861.</span><br>sec := <span class="hljs-type">float64</span>(d/time.Second) * tb.rate<br>nsec := <span class="hljs-type">float64</span>(d%time.Second) * tb.rate<br><span class="hljs-keyword">return</span> sec + nsec/<span class="hljs-number">1e9</span><br>&#125;<br><br><span class="hljs-comment">// NewTokenBucket åˆ›å»ºä¸€ä¸ªæ–°çš„ä»¤ç‰Œæ¡¶ï¼Œç»™å®šä»¤ç‰Œæ·»åŠ é€Ÿç‡å’Œæ¡¶çš„å®¹é‡ã€‚</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewTokenBucket</span><span class="hljs-params">(rate <span class="hljs-type">float64</span>, b <span class="hljs-type">int</span>)</span></span> *TokenBucket &#123;<br><span class="hljs-keyword">return</span> &amp;TokenBucket&#123;<br>rate:   rate,<br>burst:  b,<br>tokens: <span class="hljs-number">0</span>,<br>&#125;<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(tb *TokenBucket)</span></span> durationFromTokens(tokens <span class="hljs-type">float64</span>) time.Duration &#123;<br>seconds := tokens / tb.rate<br><span class="hljs-keyword">return</span> time.Nanosecond * time.Duration(<span class="hljs-number">1e9</span>*seconds)<br>&#125;<br><br><span class="hljs-comment">// Allow æ£€æŸ¥æ˜¯å¦å¯ä»¥ä»æ¡¶ä¸­å–å‡ºä¸€ä¸ªä»¤ç‰Œã€‚å¦‚æœå¯ä»¥ï¼Œå®ƒå–å‡ºä¸€ä¸ªä»¤ç‰Œå¹¶è¿”å› trueã€‚</span><br><span class="hljs-comment">// å¦‚æœä¸å¯ä»¥ï¼Œå®ƒè¿”å› falseã€‚</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(tb *TokenBucket)</span></span> Allow() <span class="hljs-type">bool</span> &#123;<br>tb.mu.Lock()<br><span class="hljs-keyword">defer</span> tb.mu.Unlock()<br><br>now := time.Now()<br><span class="hljs-comment">// è®¡ç®—ï¼ˆå¯ç”Ÿæˆä»¤ç‰Œæ•°)æ‰€éœ€è¦çš„æ—¶é—´ï¼Œburstä»¤ç‰Œæ¡¶å®¹é‡ï¼Œtokens: å½“å‰å­˜åœ¨çš„ä»¤ç‰Œä¸ªæ•°</span><br>maxElapsed := tb.durationFromTokens(<span class="hljs-type">float64</span>(tb.burst) - tb.tokens)<br>elapsed := now.Sub(tb.lastUpdate)<br><span class="hljs-keyword">if</span> elapsed &gt; maxElapsed &#123;<br>elapsed = maxElapsed<br>&#125;<br><br><span class="hljs-comment">// è®¡ç®—ç”Ÿæˆçš„ä»¤ç‰Œ</span><br>delta := tb.tokensFromDuration(elapsed)<br>tokens := tb.tokens + delta<br><span class="hljs-keyword">if</span> burst := <span class="hljs-type">float64</span>(tb.burst); tokens &gt; burst &#123;<br>tokens = burst<br>&#125;<br>tokens--<br><span class="hljs-keyword">var</span> waitDuration time.Duration<br><span class="hljs-keyword">if</span> tokens &lt; <span class="hljs-number">0</span> &#123;<br><span class="hljs-comment">//è¯´æ˜å–ä¸åˆ°1ä¸ªtoken, é‚£å°±è®¡ç®—å–åˆ°1ä¸ªtokenæ‰€éœ€è¦çš„ç­‰å¾…æ—¶é—´</span><br>waitDuration = tb.durationFromTokens(-tokens)<br>&#125;<br>ok := <span class="hljs-number">1</span> &lt;= tb.burst &amp;&amp; waitDuration &lt;= <span class="hljs-number">0</span><br><span class="hljs-keyword">if</span> ok &#123;<br>tb.lastUpdate = now<br>tb.tokens = tokens<br>&#125;<br><span class="hljs-keyword">return</span> ok<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>tokenBucket := NewTokenBucket(<span class="hljs-number">2.0</span>, <span class="hljs-number">1.0</span>)<br>      success := <span class="hljs-number">0</span><br>      reject := <span class="hljs-number">0</span><br><span class="hljs-keyword">for</span> &#123;<br><span class="hljs-keyword">if</span> tokenBucket.Allow() &#123;<br>fmt.Println(time.Now().Format(<span class="hljs-string">&quot;15:04:05&quot;</span>), <span class="hljs-string">&quot;, è¯·æ±‚é€šè¿‡\n&quot;</span>)<br>success++<br>&#125;<span class="hljs-keyword">else</span> &#123;<br>    reject++<br>&#125;<br>&#125;<br><br>fmt.Println(success, <span class="hljs-string">&quot;&lt;======&gt;&quot;</span>, reject)<br>&#125;<br></code></pre></td></tr></table></figure><p>tips:<br>Sleepç²¾å‡†é—®é¢˜æœ‰å…´è¶£å¯ä»¥çœ‹çœ‹[è¿™ç¯‡æ–‡ç« ](<a href="https://colobu.com/2023/12/07/more-precise-sleep/%EF%BC%89">https://colobu.com/2023/12/07/more-precise-sleep/ï¼‰</a></p><h1 id="åŠ¨æ€é™æµ"><a href="#åŠ¨æ€é™æµ" class="headerlink" title="åŠ¨æ€é™æµ"></a>åŠ¨æ€é™æµ</h1><p>é€šè¿‡å®ä¾‹çš„è´Ÿè½½æƒ…å†µ(é‡‡æ ·çª—å£å†…çš„cpuä½¿ç”¨ç‡&#x2F;load1)è¿›è¡ŒåŠ¨æ€è®¾ç½®é™æµé˜ˆå€¼ï¼Œè®©æœåŠ¡ä¿æŒé«˜æ°´ä½é«˜æ•ˆè¿è¡Œã€‚</p><h2 id="å¼€æºå®ç°"><a href="#å¼€æºå®ç°" class="headerlink" title="å¼€æºå®ç°"></a>å¼€æºå®ç°</h2><p><a href="https://github.com/go-kratos/aegis/tree/main/ratelimit/bbr">Bç«™-BBR</a><br><a href="https://github.com/alibaba/sentinel-golang/wiki/%E7%B3%BB%E7%BB%9F%E8%87%AA%E9%80%82%E5%BA%94%E6%B5%81%E6%8E%A7">sentinel-go</a><br><a href="https://queue.acm.org/appendices/codel.html">Co-DEL</a><br><a href="https://github.com/go-kratos/kratos/blob/4a93aa9b8d5dca550cc60a0c51c4726f83a2e6f8/pkg/container/queue/aqm/codel.go">Bç«™-Codel</a></p><h2 id="å®ç°åŸç†"><a href="#å®ç°åŸç†" class="headerlink" title="å®ç°åŸç†"></a>å®ç°åŸç†</h2><p>1.Bç«™-BBR: ä½¿ç”¨æ»‘åŠ¨çª—å£ç»Ÿè®¡æˆåŠŸæ•°ã€å“åº”æ—¶é—´ï¼›é€šè¿‡æ»‘çª—è®¡ç®—å¹³å‡å“åº”æ—¶é—´ï¼Œæ ¹æ®åˆ©ç‰¹å°”æ³•åˆ™è®¡ç®—QPSï¼Œå½“CPUä½¿ç”¨ç‡æ»¡è¶³é˜ˆå€¼æ—¶ï¼ŒåŠ¨æ€è®¾ç½®é™æµé˜ˆå€¼ã€‚<br><code>QPS = (MaxPass(çª—å£å†…æœ€å¤§æˆåŠŸè¯·æ±‚æ•°) * MinRt(å¹³å‡å“åº”å»¶æ—¶:ms) * BucketsPerSecond(1sçš„æ¡¶ä¸ªæ•°) /1000.0)</code></p><p>2.Sentinel-go: åŸç†å’ŒBç«™ç±»ä¼¼ï¼Œä¸è¿‡ä½¿ç”¨æ—¶load1(å®æ—¶æ€§è¾ƒè¾ƒå·®, 1åˆ†é’Ÿå†…çš„è´Ÿè½½)<br>3.Co-DEL: ä¼ ç»ŸFIFOåœ¨æµ·é‡è¯·æ±‚åœºæ™¯ä¸‹ä¼šå‡ºç°å¤§é‡è¯·æ±‚â€œé¥¿æ­»â€çš„æƒ…å†µ, è€Œcodelå¾ˆå¥½çš„è§„é¿äº†è¿™ä¸ªé—®é¢˜ï¼Œcodelä¼šæ¸…ç†è¶…æ—¶è¯·æ±‚å¹¶ä¸”è‡ªåŠ¨æ‹’ç»ã€‚<a href="https://github.com/LyricTian/kratos/blob/bd2d576848f44f7bf4eb7c9420b36093fa4f8ef7/pkg/container/queue/aqm/codel.go">Bç«™çš„å®ç°</a>æœ‰2ä¸ªå®¹å¿çª—å£, å®¹å¿çª—å£æœŸé—´è¯·æ±‚è¿˜æ˜¯ä¼šè¢«æ”¾è¡Œ, è¶…è¿‡çª—å£çš„æ‰ä¼šè¢«æ‹’ç»ã€‚</p><p>æ€»ç»“</p><ul><li>ç²¾ç¡®é™æµ, åŠ¨æ€è°ƒæ•´é˜ˆå€¼, å’ŒæœåŠ¡è´Ÿè½½æ­£ç›¸å…³; ä½†æ˜¯å®ç°å¤æ‚ï¼Œéœ€è¦é¢å¤–èµ„æºç»Ÿè®¡CPUä½¿ç”¨ç‡ã€QPSååç­‰; é™äºæ¥å£è°ƒç”¨ï¼Œåœºæ™¯å°‘</li><li>è¯·æ±‚åˆ†ä¼˜å…ˆçº§(ç”¨æˆ·çº¬åº¦)ï¼Œå¯æŒ‰ä¼˜å…ˆçº§ä¸¢å¼ƒã€å¯ä»¥å­˜åœ¨ä¸€å®šè¶…å–ã€‚</li><li>æ‹’ç»è¯·æ±‚ä¹Ÿéœ€è¦æˆæœ¬, clietç«¯éœ€è¦æˆªæµ(ç›´æ¥å¾€ä¸ŠæŠ›æˆ–è€…é‡è¯•å…¶ä»–èŠ‚ç‚¹)</li></ul><h2 id="å®¢æˆ·ç«¯èŠ‚æµ"><a href="#å®¢æˆ·ç«¯èŠ‚æµ" class="headerlink" title="å®¢æˆ·ç«¯èŠ‚æµ"></a>å®¢æˆ·ç«¯èŠ‚æµ</h2><p>ä¸»è¦æœ‰ä»¥ä¸‹ä¸¤ç§åœºæ™¯<br>1.ç”¨æˆ·å®¢æˆ·ç«¯ç–¯ç‹‚é‡è¯•ï¼›å®¢æˆ·ç«¯éœ€è¦éšæœºé€€é¿é‡è¯•<br>2.ä¸‹æ¸¸è¿‡è½½, è¿”å›â€è¶…å‡ºé…é¢ï¼Œæ‹’ç»è¯·æ±‚â€; ä¸»è°ƒå¯ä»¥æŒ‰æ¦‚ç‡æ‹’ç»è¯·æ±‚; <a href="https://sre.google/sre-book/handling-overload/">ç®—æ³•</a><br><img src="/images/adaptive_throttling.png" alt="è‡ªé€‚åº”é™æµ"></p><h1 id="é›†ç¾¤é™æµ"><a href="#é›†ç¾¤é™æµ" class="headerlink" title="é›†ç¾¤é™æµ"></a>é›†ç¾¤é™æµ</h1><p>ä¸ºä»€ä¹ˆè¦ç”¨é›†ç¾¤é™æµï¼Ÿåœ¨åˆ†å¸ƒå¼åœºæ™¯ä¸‹å•æœºé™æµæœ‰2ä¸ªç¼ºé™·ï¼š</p><ul><li>å½“é™æµé…é¢&gt;èŠ‚ç‚¹æ•°ï¼Œå•æœºé™æµå°±ä¸èƒ½é™åˆ¶äº†ï¼›æ¯”å¦‚100ä¸ªèŠ‚ç‚¹ï¼Œ50QPSï¼Œæ­¤æ—¶æ›´é€‚åˆé›†ç¾¤é™æµ</li><li>å½“æµé‡ä¸å‡æ—¶ï¼Œå•æœºé™æµä¼šå‡ºç°è¯¯é™; æ¯”å¦‚50ä¸ªèŠ‚ç‚¹ï¼Œ100QPSï¼Œæ­¤æ—¶å•èŠ‚ç‚¹2QPSï¼Œä½†å¦‚æœæµé‡ä¸å‡ï¼Œæ²¡è¾¾åˆ°é˜ˆå€¼å°±æ‹’ç»è¯·æ±‚äº†</li></ul><h2 id="é™æµæ¨¡å¼"><a href="#é™æµæ¨¡å¼" class="headerlink" title="é™æµæ¨¡å¼"></a>é™æµæ¨¡å¼</h2><ul><li>å•æ¬¡åˆ†é…ï¼Œå³æ—¶æ¶ˆè´¹å³æ—¶ç»“ç®—</li><li>æ‰¹æ¬¡åˆ†é…ï¼Œå…ˆæ¶ˆè´¹åç»“ç®—</li><li>æ‰¹æ¬¡åˆ†é…ï¼Œé¢„å…ˆåˆ†é…æ¶ˆè´¹</li></ul><h3 id="å•æ¬¡åˆ†é…-å³æ—¶æ¶ˆè´¹å³æ—¶ç»“ç®—-å¼ºä¸€è‡´"><a href="#å•æ¬¡åˆ†é…-å³æ—¶æ¶ˆè´¹å³æ—¶ç»“ç®—-å¼ºä¸€è‡´" class="headerlink" title="å•æ¬¡åˆ†é… å³æ—¶æ¶ˆè´¹å³æ—¶ç»“ç®— å¼ºä¸€è‡´"></a><font color="green">å•æ¬¡åˆ†é…</font> å³æ—¶æ¶ˆè´¹å³æ—¶ç»“ç®— å¼ºä¸€è‡´</h3><ul><li>ç²¾å‡†é™æµï¼Œä¼šå¢åŠ ä¸šåŠ¡å»¶è¿Ÿ</li><li>åŸºäºredis,sentinelå®ç°</li><li>ç§’æ€ç­‰å¯¹ç²¾å‡†æ€§è¦æ±‚è¾ƒé«˜çš„ç»†ç²’åº¦é™æµ</li></ul><h3 id="æ‰¹æ¬¡åˆ†é…-æœ€ç»ˆä¸€è‡´-æ€§èƒ½é«˜ï¼Œä½†å‡†ç¡®æ€§ä¼šé™ä½"><a href="#æ‰¹æ¬¡åˆ†é…-æœ€ç»ˆä¸€è‡´-æ€§èƒ½é«˜ï¼Œä½†å‡†ç¡®æ€§ä¼šé™ä½" class="headerlink" title="æ‰¹æ¬¡åˆ†é…  æœ€ç»ˆä¸€è‡´, æ€§èƒ½é«˜ï¼Œä½†å‡†ç¡®æ€§ä¼šé™ä½"></a><font color="green">æ‰¹æ¬¡åˆ†é…</font>  æœ€ç»ˆä¸€è‡´, æ€§èƒ½é«˜ï¼Œä½†å‡†ç¡®æ€§ä¼šé™ä½</h3><p><font color="black">å®ç°åŸç†:</font><br><font color="orange">æœ¬åœ°å¼‚æ­¥è¯·æ±‚é™æµæœåŠ¡è·å–é…é¢(quota)ï¼Œæœ¬åœ°é‡‡ç”¨é™æ€é™æµç®—æ³•</font></p><p>ä¸€èˆ¬éƒ½æ˜¯å®¢æˆ·ç«¯(LRUçª—å£)é™æµ + å®¢æˆ·ç«¯å®šæœŸä¸ŠæŠ¥(msçº§)é…é¢åˆ°é™æµå™¨ + é™æµå™¨å“åº”å®¢æˆ·ç«¯å‰©ä½™é…é¢ + å®¢æˆ·ç«¯é‡æ–°è®¡ç®—é™æµé¢</p><ul><li>é¢„åˆ†é…åæ¶ˆè´¹; Youtube doorman; æœ¬åœ°é™æµï¼Œå¦‚æœæµé‡ä¸å‡ä¼šæœ‰è¯¯é™;é€‚ç”¨æœåŠ¡çº§é™æµï¼Œè¯»å†™åˆ†ç¦»çš„æ¥å£çº§é™æµ</li><li>å…ˆæ¶ˆè´¹åç»“ç®—; é˜¿é‡ŒAHAS; å®¢æˆ·ç«¯åŸºäºå‰©ä½™æ•´ä½“é…é¢è¿›è¡Œæ‰£é™¤ï¼Œä¸å†è¿›è¡Œå‡æ‘Šï¼Œè§£å†³è¯¯é™é—®é¢˜ï¼Œä½†å¯èƒ½ä¼šæœ‰è¶…é™; æœåŠ¡&#x2F;æ¥å£é™æµç­‰å…è®¸ä¸€å®šè¯¯å·®çš„é™æµåœºæ™¯</li></ul><p>å…ˆæ¶ˆè´¹åç»“ç®—:</p><ol><li>clientå¼‚æ­¥å®šæœŸ(30ms)åŒæ­¥é™æµserverç»“ç®—,</li><li>è¯·æ±‚ä¸€è‡´æ€§hashåˆ°å¯¹åº”çš„é™æµserverä¸Šï¼Œ</li><li>é™æµserverä¸‹å‘æ‰€æœ‰å‰©ä½™é…é¢</li></ol><p>å­˜åœ¨é—®é¢˜:<br>å‡è®¾10ä¸ªclient,QPSé™æµ1000ï¼Œ æ¯ä¸ªèŠ‚ç‚¹QPSï¼š100, åœ¨30mså†…æ¶ˆè€—äº†100é…é¢ï¼Œå®é™…æ”¾è¡Œè¯·æ±‚: 10 * 1000ä¸ªè¯·æ±‚ã€‚<br>ä¼˜åŒ–ï¼š</p><ul><li>è°ƒæ•´ä¸ŠæŠ¥å‘¨æœŸï¼Œé™ä½å‘¨æœŸ+å‘¨æœŸéšæœºåŒ–(é˜²æ­¢ä¸ŠæŠ¥é£æš´)</li><li>æ¯ä¸ªçª—å£éƒ½å•ç‹¬ä¸ŠæŠ¥, æ€§èƒ½æœ‰æŸ, å¯¹hashåˆ°åŒä¸€èŠ‚ç‚¹çš„çª—å£åˆå¹¶æ‰¹é‡ä¸ŠæŠ¥</li><li>åŒæ­¥é™æµé›†ç¾¤å¤±è´¥ï¼Œé™çº§ä¸ºå•æœºé™æµï¼Œæ€»é…é¢&#x2F;å®¢æˆ·ç«¯æ•°(client)</li></ul><p><a href="https://sentinelguard.io/zh-cn/docs/cluster-flow-control.html">setinel</a>é›†ç¾¤é™æµ(äº‘ä¸Šç‰ˆæœ¬ AHAS Sentinel)</p><p><img src="/images/sentinel_limit_center.png" alt="é›†ä¸­å¼"><br><img src="/images/sentinel_limit_embedded.png" alt="åµŒå…¥å¼"></p><h2 id="é™æµç­–ç•¥"><a href="#é™æµç­–ç•¥" class="headerlink" title="é™æµç­–ç•¥"></a>é™æµç­–ç•¥</h2><ul><li>å¤šçº§é™æµ(ç½‘å…³å±‚ã€åº”ç”¨å±‚ã€æœåŠ¡å±‚ã€æ•°æ®å±‚)</li><li>åŠ¨æ€é˜ˆå€¼è°ƒæ•´(è´Ÿè½½é«˜é™ä½æƒé‡)</li><li>å¤šçº§ç»´åº¦(ip,è®¾å¤‡) + ä¸šåŠ¡ä¾§è§„åˆ™(å‘è¯„é™åˆ¶)</li></ul><h2 id="é‡è¦æ€§-æœåŠ¡åˆ†çº§"><a href="#é‡è¦æ€§-æœåŠ¡åˆ†çº§" class="headerlink" title="é‡è¦æ€§-æœåŠ¡åˆ†çº§"></a>é‡è¦æ€§-æœåŠ¡åˆ†çº§</h2><p>åœ¨å¯¹æœåŠ¡è¿›è¡Œé™æµæ—¶ï¼Œå¯ä»¥å¼•å…¥æ›´ç»†çš„ç²’åº¦-<strong>Criticality</strong>æ¥æŒ‰ä¼˜å…ˆçº§ä¸¢å¼ƒæµé‡,<br>CRITICAL_PLUS, æœ€é«˜ä¼˜å…ˆçº§ï¼Œå½±å“é¢:ç”¨æˆ·å¯è§ï¼Œä¸¥é‡ï¼›å®¹é‡è®¾ç½®éœ€å……è¶³<br>CRITICAL, æ¬¡ä¼˜å…ˆçº§ï¼Œå½±å“é¢:ç”¨æˆ·å¯è§ï¼Œä¸å¦‚Plusä¸¥é‡ï¼›å®¹é‡è®¾ç½®éœ€å……è¶³<br>SHEDDABLE_PLUS, å¼‚æ­¥ä»»åŠ¡ï¼Œå¯å®šæœŸé‡è¯•<br>SHEDDABLEï¼Œæœ€ä½ä¼˜å…ˆçº§ï¼Œæ¥å—ä¸å¯ç”¨</p><p><font color="red">Criticality åº”è¯¥åœ¨æœåŠ¡è°ƒç”¨é“¾ä¸­é€çº§ä¼ é€’ä¸‹å»ã€‚</font></p>]]></content>
    
    
    
    <tags>
      
      <tag>GO</tag>
      
      <tag>å¯ç”¨æ€§æ²»ç†</tag>
      
      <tag>é™æµ</tag>
      
      <tag>å•æœºé™æµ</tag>
      
      <tag>é›†ç¾¤é™æµ</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Goè¯­è¨€GMPè°ƒåº¦å™¨æ·±åº¦è§£æ</title>
    <link href="/2023/08/09/gmp-understanding/"/>
    <url>/2023/08/09/gmp-understanding/</url>
    
    <content type="html"><![CDATA[<h2 id="è°ƒåº¦å™¨å‘å±•å†ç¨‹"><a href="#è°ƒåº¦å™¨å‘å±•å†ç¨‹" class="headerlink" title="è°ƒåº¦å™¨å‘å±•å†ç¨‹"></a>è°ƒåº¦å™¨å‘å±•å†ç¨‹</h2><p>Goè¯­è¨€è°ƒåº¦å™¨çš„æ ¸å¿ƒèŒè´£æ˜¯é€šè¿‡é«˜æ•ˆçš„çº¿ç¨‹å¤ç”¨æœºåˆ¶æ¥æ‰§è¡Œå¤§é‡çš„Goroutineã€‚å½“å‰çš„GMPæ¨¡å‹æ˜¯ç»è¿‡å¤šæ¬¡è¿­ä»£ä¼˜åŒ–çš„ç»“æœã€‚</p><h3 id="æ—©æœŸGMæ¨¡å‹çš„é™åˆ¶"><a href="#æ—©æœŸGMæ¨¡å‹çš„é™åˆ¶" class="headerlink" title="æ—©æœŸGMæ¨¡å‹çš„é™åˆ¶"></a>æ—©æœŸGMæ¨¡å‹çš„é™åˆ¶</h3><p>æ—©æœŸè°ƒåº¦å™¨é‡‡ç”¨GMäºŒå…ƒæ¨¡å‹ï¼Œå­˜åœ¨ä»¥ä¸‹æ€§èƒ½ç“¶é¢ˆï¼š</p><ol><li><strong>å…¨å±€é”ç«äº‰</strong>ï¼šæ‰€æœ‰Mï¼ˆMachineï¼‰ç«äº‰åŒä¸€ä¸ªå…¨å±€è¿è¡Œé˜Ÿåˆ—ï¼Œéšç€Goroutineæ•°é‡å¢é•¿ï¼Œé”ç«äº‰æ„ˆå‘ä¸¥é‡</li><li><strong>CPUåˆ©ç”¨ç‡ä½</strong>ï¼šMæ‰§è¡Œç³»ç»Ÿè°ƒç”¨æˆ–é˜»å¡æ“ä½œæ—¶ä¼šä¼‘çœ ï¼Œç»‘å®šåœ¨è¯¥Mä¸Šçš„Goroutineæ— æ³•è¢«å…¶ä»–Mæ¥ç®¡</li><li><strong>è°ƒåº¦å¼€é”€å¤§</strong>ï¼šé¢‘ç¹çš„å…¨å±€é˜Ÿåˆ—è®¿é—®å¯¼è‡´ç¼“å­˜misså’Œä¸Šä¸‹æ–‡åˆ‡æ¢å¼€é”€</li></ol><h3 id="GMPæ¨¡å‹çš„ä¼˜åŠ¿"><a href="#GMPæ¨¡å‹çš„ä¼˜åŠ¿" class="headerlink" title="GMPæ¨¡å‹çš„ä¼˜åŠ¿"></a>GMPæ¨¡å‹çš„ä¼˜åŠ¿</h3><p>ä¸ºè§£å†³ä¸Šè¿°é—®é¢˜ï¼ŒGoå›¢é˜Ÿé‡æ–°è®¾è®¡äº†è°ƒåº¦å™¨æ¶æ„ï¼Œå¼•å…¥Processorï¼ˆPï¼‰æ¦‚å¿µï¼Œå½¢æˆäº†å½“å‰çš„GMPä¸‰å…ƒæ¨¡å‹ï¼Œå®ç°äº†ï¼š</p><ul><li>æœ¬åœ°é˜Ÿåˆ—å‡å°‘é”ç«äº‰</li><li>Work-Stealingè´Ÿè½½å‡è¡¡</li><li>ç³»ç»Ÿè°ƒç”¨æ—¶çš„P-Mè§£ç»‘æœºåˆ¶</li></ul><h2 id="è°ƒåº¦å™¨æ ¸å¿ƒæ¦‚å¿µ"><a href="#è°ƒåº¦å™¨æ ¸å¿ƒæ¦‚å¿µ" class="headerlink" title="è°ƒåº¦å™¨æ ¸å¿ƒæ¦‚å¿µ"></a>è°ƒåº¦å™¨æ ¸å¿ƒæ¦‚å¿µ</h2><h3 id="Processor-P"><a href="#Processor-P" class="headerlink" title="Processor (P)"></a>Processor (P)</h3><p>Processoræ˜¯GMPæ¨¡å‹çš„æ ¸å¿ƒåˆ›æ–°ï¼Œæ‰¿æ‹…ä»¥ä¸‹å…³é”®èŒè´£ï¼š</p><h4 id="æ ¸å¿ƒåŠŸèƒ½"><a href="#æ ¸å¿ƒåŠŸèƒ½" class="headerlink" title="æ ¸å¿ƒåŠŸèƒ½"></a>æ ¸å¿ƒåŠŸèƒ½</h4><ol><li><strong>æœ¬åœ°è¿è¡Œé˜Ÿåˆ—ç®¡ç†</strong>ï¼šæ¯ä¸ªPç»´æŠ¤ç‹¬ç«‹çš„æœ¬åœ°è¿è¡Œé˜Ÿåˆ—ï¼ˆ<code>runq</code>ï¼‰ï¼Œé¿å…å…¨å±€é”ç«äº‰</li><li><strong>åŠ¨æ€ç»‘å®šæœºåˆ¶</strong>ï¼šå½“Må› ç³»ç»Ÿè°ƒç”¨æˆ–é˜»å¡æ“ä½œä¼‘çœ æ—¶ï¼ŒPä¸Mè§£ç»‘ï¼Œå¯»æ‰¾ç©ºé—²Mç»§ç»­æ‰§è¡Œé˜Ÿåˆ—ä¸­çš„Goroutine</li><li><strong>è°ƒåº¦ä¸Šä¸‹æ–‡</strong>ï¼šä¿å­˜è°ƒåº¦ç›¸å…³çš„å…ƒæ•°æ®å’ŒçŠ¶æ€ä¿¡æ¯</li></ol><h4 id="Pçš„çŠ¶æ€è½¬æ¢"><a href="#Pçš„çŠ¶æ€è½¬æ¢" class="headerlink" title="Pçš„çŠ¶æ€è½¬æ¢"></a>Pçš„çŠ¶æ€è½¬æ¢</h4><p>Påœ¨è¿è¡Œæ—¶ä¼šåœ¨ä»¥ä¸‹çŠ¶æ€é—´è½¬æ¢ï¼š</p><ul><li><code>_Pidle</code>ï¼šç©ºé—²çŠ¶æ€ï¼Œç­‰å¾…ç»‘å®šM</li><li><code>_Prunning</code>ï¼šè¿è¡ŒçŠ¶æ€ï¼Œå·²ç»‘å®šMå¹¶åœ¨æ‰§è¡ŒGoroutine</li><li><code>_Psyscall</code>ï¼šç³»ç»Ÿè°ƒç”¨çŠ¶æ€ï¼ŒMæ­£åœ¨æ‰§è¡Œç³»ç»Ÿè°ƒç”¨</li><li><code>_Pgcstop</code>ï¼šGCåœæ­¢çŠ¶æ€ï¼Œæš‚åœè°ƒåº¦ç­‰å¾…GCå®Œæˆ</li><li><code>_Pdead</code>ï¼šæ­»äº¡çŠ¶æ€ï¼ŒPè¢«é”€æ¯</li></ul><p><img src="/images/gmp_p_status.png" alt="gmp_p_status"></p><h3 id="Goroutine-G"><a href="#Goroutine-G" class="headerlink" title="Goroutine (G)"></a>Goroutine (G)</h3><p>Goroutineæ˜¯Goè¯­è¨€çš„ç”¨æˆ·çº§çº¿ç¨‹ï¼Œå…·æœ‰è½»é‡çº§å’Œé«˜å¹¶å‘ç‰¹æ€§ã€‚</p><h4 id="åŸºæœ¬çŠ¶æ€æ¨¡å‹"><a href="#åŸºæœ¬çŠ¶æ€æ¨¡å‹" class="headerlink" title="åŸºæœ¬çŠ¶æ€æ¨¡å‹"></a>åŸºæœ¬çŠ¶æ€æ¨¡å‹</h4><p>ä»è°ƒåº¦å™¨è§’åº¦ï¼ŒGoroutineå…·æœ‰ä¸‰ç§æ ¸å¿ƒçŠ¶æ€ï¼š</p><ul><li><strong>Waiting</strong>ï¼šé˜»å¡çŠ¶æ€ï¼Œç­‰å¾…I&#x2F;Oæ“ä½œæˆ–ç³»ç»Ÿè°ƒç”¨å®Œæˆ</li><li><strong>Runnable</strong>ï¼šå°±ç»ªçŠ¶æ€ï¼Œä½äºè¿è¡Œé˜Ÿåˆ—ä¸­ç­‰å¾…è°ƒåº¦</li><li><strong>Executing</strong>ï¼šæ‰§è¡ŒçŠ¶æ€ï¼Œæ­£åœ¨Mä¸Šè¿è¡Œ</li></ul><h4 id="è¯¦ç»†çŠ¶æ€è½¬æ¢"><a href="#è¯¦ç»†çŠ¶æ€è½¬æ¢" class="headerlink" title="è¯¦ç»†çŠ¶æ€è½¬æ¢"></a>è¯¦ç»†çŠ¶æ€è½¬æ¢</h4><p>Goroutineçš„å®Œæ•´ç”Ÿå‘½å‘¨æœŸåŒ…å«ä»¥ä¸‹çŠ¶æ€è½¬æ¢ï¼š</p><p><strong>åˆ›å»ºé˜¶æ®µ</strong>ï¼š<br><code>_Gidle</code>ï¼ˆç©ºé—²æ± ï¼‰ â†’ <code>_Gdead</code>ï¼ˆè¢«åˆ†é…ï¼‰ â†’ <code>_Grunnable</code>ï¼ˆåˆå§‹åŒ–å®Œæˆï¼‰ â†’ <code>_Grunning</code>ï¼ˆå¼€å§‹æ‰§è¡Œï¼‰</p><p><strong>è¿è¡Œé˜¶æ®µ</strong>ï¼š</p><ul><li><code>_Grunning</code> â†’ <code>_Gsyscall</code>ï¼ˆç³»ç»Ÿè°ƒç”¨ï¼‰ â†’ <code>_Grunning</code>ï¼ˆè°ƒç”¨è¿”å›ï¼‰</li><li><code>_Grunning</code> â†’ <code>_Gwaiting</code>ï¼ˆé˜»å¡ç­‰å¾…ï¼‰ â†’ <code>_Grunnable</code>ï¼ˆæ¡ä»¶æ»¡è¶³ï¼‰</li></ul><p><strong>é”€æ¯é˜¶æ®µ</strong>ï¼š<br>å½“Goroutineæ‰§è¡Œå®Œæ¯•æ—¶ï¼Œè°ƒç”¨é“¾ä¸ºï¼š<code>runtime.goexit1</code> â†’ <code>goexit0</code></p><ol><li>åˆ‡æ¢åˆ°G0æ ˆç©ºé—´</li><li>æ¸…ç†Goroutineæ•°æ®ç»“æ„</li><li>è§£é™¤ä¸Mçš„ç»‘å®šå…³ç³»</li><li>çŠ¶æ€ä»<code>_Grunning</code>æ›´æ–°ä¸º<code>_Gdead</code></li><li>å›æ”¶åˆ°ç©ºé—²Goroutineæ± </li></ol><p><img src="/images/g_status.png" alt="g_status"></p><h3 id="ç‰¹æ®Šå¯¹è±¡ä¸å…¨å±€ç®¡ç†"><a href="#ç‰¹æ®Šå¯¹è±¡ä¸å…¨å±€ç®¡ç†" class="headerlink" title="ç‰¹æ®Šå¯¹è±¡ä¸å…¨å±€ç®¡ç†"></a>ç‰¹æ®Šå¯¹è±¡ä¸å…¨å±€ç®¡ç†</h3><h4 id="ç³»ç»Ÿåˆå§‹å¯¹è±¡"><a href="#ç³»ç»Ÿåˆå§‹å¯¹è±¡" class="headerlink" title="ç³»ç»Ÿåˆå§‹å¯¹è±¡"></a>ç³»ç»Ÿåˆå§‹å¯¹è±¡</h4><ul><li><p><strong>M0</strong>ï¼šä¸»çº¿ç¨‹å¯¹åº”çš„Machineï¼Œå­˜å‚¨åœ¨å…¨å±€å˜é‡<code>runtime.m0</code>ä¸­</p><ul><li>è´Ÿè´£æ‰§è¡Œè¿è¡Œæ—¶åˆå§‹åŒ–æ“ä½œ</li><li>å¯åŠ¨ç¬¬ä¸€ä¸ªGoroutineï¼ˆé€šå¸¸æ˜¯<code>runtime.main</code>ï¼‰</li><li>åˆå§‹åŒ–å®Œæˆåä¸æ™®é€šMå…·æœ‰ç›¸åŒè¡Œä¸º</li></ul></li><li><p><strong>G0</strong>ï¼šæ¯ä¸ªMçš„è°ƒåº¦Goroutine</p><ul><li>ä¸“é—¨ç”¨äºæ‰§è¡Œè°ƒåº¦é€»è¾‘ï¼Œä¸æ‰§è¡Œç”¨æˆ·ä»£ç </li><li>æ‹¥æœ‰å›ºå®šå¤§å°çš„æ ˆç©ºé—´ï¼ˆé€šå¸¸8KBï¼‰</li><li>åœ¨æ‰§è¡Œç³»ç»Ÿè°ƒç”¨æˆ–è°ƒåº¦åˆ‡æ¢æ—¶æä¾›æ ˆç©ºé—´</li><li>å…¨å±€G0ç‰¹æŒ‡M0çš„è°ƒåº¦Goroutine</li></ul></li><li><p><strong>P0</strong>ï¼šé¦–ä¸ªProcessorï¼Œä¸M0ç»‘å®šå®Œæˆç³»ç»Ÿå¯åŠ¨</p></li></ul><h4 id="å…¨å±€ç®¡ç†ç»“æ„"><a href="#å…¨å±€ç®¡ç†ç»“æ„" class="headerlink" title="å…¨å±€ç®¡ç†ç»“æ„"></a>å…¨å±€ç®¡ç†ç»“æ„</h4><ul><li><strong>allgs</strong>ï¼šå…¨å±€Goroutineåˆ‡ç‰‡ï¼Œè®°å½•ç³»ç»Ÿä¸­æ‰€æœ‰Gçš„å¼•ç”¨</li><li><strong>allm</strong>ï¼šå…¨å±€Machineåˆ‡ç‰‡ï¼Œç®¡ç†æ‰€æœ‰æ“ä½œç³»ç»Ÿçº¿ç¨‹</li><li><strong>allp</strong>ï¼šå…¨å±€Processoråˆ‡ç‰‡ï¼Œç»´æŠ¤æ‰€æœ‰é€»è¾‘å¤„ç†å™¨</li><li><strong>sched</strong>ï¼šå…¨å±€è°ƒåº¦å™¨ç»“æ„ï¼ŒåŒ…å«ï¼š<ul><li>ç©ºé—²Mé˜Ÿåˆ—ï¼ˆ<code>midle</code>ï¼‰</li><li>ç©ºé—²Pé˜Ÿåˆ—ï¼ˆ<code>pidle</code>ï¼‰</li><li>å…¨å±€è¿è¡Œé˜Ÿåˆ—ï¼ˆ<code>runq</code>ï¼‰</li><li>è°ƒåº¦ç»Ÿè®¡ä¿¡æ¯</li></ul></li></ul><p><img src="/images/g0-p0-m0.png" alt="g0-p0-m0"></p><h2 id="GMPè°ƒåº¦æœºåˆ¶è¯¦è§£"><a href="#GMPè°ƒåº¦æœºåˆ¶è¯¦è§£" class="headerlink" title="GMPè°ƒåº¦æœºåˆ¶è¯¦è§£"></a>GMPè°ƒåº¦æœºåˆ¶è¯¦è§£</h2><h3 id="ç³»ç»Ÿå¯åŠ¨æµç¨‹"><a href="#ç³»ç»Ÿå¯åŠ¨æµç¨‹" class="headerlink" title="ç³»ç»Ÿå¯åŠ¨æµç¨‹"></a>ç³»ç»Ÿå¯åŠ¨æµç¨‹</h3><p>Goç¨‹åºå¯åŠ¨æ—¶æŒ‰ä»¥ä¸‹æ­¥éª¤åˆå§‹åŒ–è°ƒåº¦å™¨ï¼š</p><ol><li><strong>M0å’ŒG0åˆå§‹åŒ–</strong>ï¼šåˆ›å»ºä¸»çº¿ç¨‹M0åŠå…¶è°ƒåº¦Goroutine G0</li><li><strong>Påˆå§‹åŒ–</strong>ï¼šæ ¹æ®<code>GOMAXPROCS</code>ï¼ˆé»˜è®¤ä¸ºCPUæ ¸å¿ƒæ•°ï¼‰åˆ›å»ºç›¸åº”æ•°é‡çš„P</li><li><strong>ç»‘å®šå…³ç³»å»ºç«‹</strong>ï¼šP0ä¸M0ã€G0å»ºç«‹ç»‘å®šå…³ç³»</li><li><strong>ç©ºé—²é˜Ÿåˆ—ç®¡ç†</strong>ï¼šå‰©ä½™Pè¿›å…¥å…¨å±€ç©ºé—²é˜Ÿåˆ—ç­‰å¾…åˆ†é…</li><li><strong>å¯åŠ¨ç¬¬ä¸€ä¸ªç”¨æˆ·Goroutine</strong>ï¼šåˆ›å»ºG1æ‰§è¡Œ<code>runtime.main</code>å‡½æ•°ï¼ŒåŠ å…¥P0æœ¬åœ°é˜Ÿåˆ—</li><li><strong>è°ƒåº¦å¾ªç¯å¯åŠ¨</strong>ï¼šM0çš„G0å¼€å§‹æ‰§è¡Œè°ƒåº¦ä¸»å¾ªç¯</li></ol><h3 id="Goroutineåˆ›å»ºä¸é˜Ÿåˆ—ç®¡ç†"><a href="#Goroutineåˆ›å»ºä¸é˜Ÿåˆ—ç®¡ç†" class="headerlink" title="Goroutineåˆ›å»ºä¸é˜Ÿåˆ—ç®¡ç†"></a>Goroutineåˆ›å»ºä¸é˜Ÿåˆ—ç®¡ç†</h3><h4 id="æœ¬åœ°é˜Ÿåˆ—ç»“æ„"><a href="#æœ¬åœ°é˜Ÿåˆ—ç»“æ„" class="headerlink" title="æœ¬åœ°é˜Ÿåˆ—ç»“æ„"></a>æœ¬åœ°é˜Ÿåˆ—ç»“æ„</h4><p>æ¯ä¸ªPç»´æŠ¤ä¸¤çº§æœ¬åœ°é˜Ÿåˆ—ç»“æ„ï¼š</p><p><strong>é˜Ÿåˆ—å®¹é‡è®¾è®¡</strong>ï¼š</p><ul><li><code>runnext</code>ï¼šå•æ§½ï¼Œå­˜å‚¨ä¼˜å…ˆæ‰§è¡Œçš„Goroutine</li><li><code>runq</code>ï¼šç¯å½¢ç¼“å†²åŒºï¼Œå®¹é‡256ä¸ªGoroutine</li><li>æ€»å®¹é‡ï¼š257ä¸ªGoroutineï¼ˆ1 + 256ï¼‰</li></ul><p><strong>é˜Ÿåˆ—è¯­ä¹‰</strong>ï¼š</p><ul><li><code>runnext</code>ï¼šé«˜ä¼˜å…ˆçº§æ§½ä½ï¼Œä¸‹æ¬¡è°ƒåº¦ä¼˜å…ˆæ‰§è¡Œ</li><li><code>runq</code>ï¼šFIFOç¯å½¢é˜Ÿåˆ—ï¼ŒæŒ‰å…ˆè¿›å…ˆå‡ºé¡ºåºæ‰§è¡Œ</li></ul><h4 id="é˜Ÿåˆ—æº¢å‡ºå¤„ç†"><a href="#é˜Ÿåˆ—æº¢å‡ºå¤„ç†" class="headerlink" title="é˜Ÿåˆ—æº¢å‡ºå¤„ç†"></a>é˜Ÿåˆ—æº¢å‡ºå¤„ç†</h4><p>å½“æœ¬åœ°é˜Ÿåˆ—è¾¾åˆ°å®¹é‡ä¸Šé™æ—¶ï¼š</p><ol><li>æ–°åˆ›å»ºçš„GoroutineæŠ¢å <code>runnext</code>æ§½ä½</li><li>è¢«æŠ¢å çš„Goroutineä¸<code>runq</code>å‰åŠéƒ¨åˆ†ï¼ˆ128ä¸ªï¼‰ä¸€èµ·è½¬ç§»åˆ°å…¨å±€é˜Ÿåˆ—</li><li>è¿™ç§è®¾è®¡å¹³è¡¡äº†æœ¬åœ°è°ƒåº¦æ•ˆç‡å’Œå…¨å±€è´Ÿè½½å‡è¡¡</li></ol><p><img src="/images/g_to_p.png" alt="Goroutineå’ŒPäº¤äº’ç»†èŠ‚"></p><h4 id="åˆ›å»ºæµç¨‹"><a href="#åˆ›å»ºæµç¨‹" class="headerlink" title="åˆ›å»ºæµç¨‹"></a>åˆ›å»ºæµç¨‹</h4><p>Goroutineåˆ›å»ºé€šè¿‡ä»¥ä¸‹è°ƒç”¨é“¾å®Œæˆï¼š</p><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs livescript">go func<span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span> newproc<span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span> runqput<span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span> P.runnext/runq<br></code></pre></td></tr></table></figure><h3 id="Goroutineè°ƒåº¦ç­–ç•¥"><a href="#Goroutineè°ƒåº¦ç­–ç•¥" class="headerlink" title="Goroutineè°ƒåº¦ç­–ç•¥"></a>Goroutineè°ƒåº¦ç­–ç•¥</h3><p>è°ƒåº¦å™¨æ ¸å¿ƒé€»è¾‘ä½äº<code>runtime/proc.go</code>çš„<code>schedule()</code>â†’<code>findRunnable()</code>æ–¹æ³•ï¼Œé‡‡ç”¨å¤šçº§è°ƒåº¦ç­–ç•¥ï¼š</p><h4 id="è°ƒåº¦ä¼˜å…ˆçº§åºåˆ—"><a href="#è°ƒåº¦ä¼˜å…ˆçº§åºåˆ—" class="headerlink" title="è°ƒåº¦ä¼˜å…ˆçº§åºåˆ—"></a>è°ƒåº¦ä¼˜å…ˆçº§åºåˆ—</h4><ol><li><strong>å…¬å¹³æ€§ä¿éšœ</strong>ï¼šæ¯61æ¬¡è°ƒåº¦ï¼ˆ<code>SchedTick % 61 == 0</code>ï¼‰å¼ºåˆ¶ä»å…¨å±€é˜Ÿåˆ—è·å–ï¼Œé˜²æ­¢é¥¥é¥¿</li><li><strong>æœ¬åœ°é˜Ÿåˆ—ä¼˜å…ˆ</strong>ï¼šä»<code>runnext</code>å’Œ<code>runq</code>è·å–ï¼Œæœ€å¤§åŒ–ç¼“å­˜å±€éƒ¨æ€§</li><li><strong>å…¨å±€é˜Ÿåˆ—è¡¥å……</strong>ï¼šæœ¬åœ°é˜Ÿåˆ—ä¸ºç©ºæ—¶ä»å…¨å±€é˜Ÿåˆ—æ‰¹é‡è·å–</li><li><strong>ç½‘ç»œè½®è¯¢é›†æˆ</strong>ï¼šä»netpollè·å–å°±ç»ªçš„ç½‘ç»œGoroutineï¼Œå‰©ä½™çš„æ”¾å…¥å…¨å±€é˜Ÿåˆ—</li><li><strong>Work-Stealing</strong>ï¼šä»å…¶ä»–På·å–ä¸€åŠGoroutineï¼Œå®ç°è´Ÿè½½å‡è¡¡</li></ol><h4 id="å…¬å¹³æ€§æœºåˆ¶"><a href="#å…¬å¹³æ€§æœºåˆ¶" class="headerlink" title="å…¬å¹³æ€§æœºåˆ¶"></a>å…¬å¹³æ€§æœºåˆ¶</h4><p>ä¸ºé¿å…å…¨å±€é˜Ÿåˆ—ä¸­çš„Goroutineé•¿æœŸå¾—ä¸åˆ°è°ƒåº¦ï¼Œè°ƒåº¦å™¨å¼•å…¥å…¬å¹³æ€§è®¡æ•°å™¨ï¼š</p><ul><li><code>SchedTick</code>ï¼šæ¯æ¬¡è°ƒåº¦é€’å¢çš„å…¨å±€è®¡æ•°å™¨</li><li>å½“<code>SchedTick % 61 == 0</code>æ—¶ï¼Œå¼ºåˆ¶ä¼˜å…ˆè°ƒåº¦å…¨å±€é˜Ÿåˆ—</li><li>è¯¥æœºåˆ¶ç¡®ä¿å…¨å±€é˜Ÿåˆ—ä¸­çš„Goroutineæœ€å¤šç­‰å¾…61ä¸ªè°ƒåº¦å‘¨æœŸ</li></ul><h4 id="è°ƒåº¦æµç¨‹å›¾è§£"><a href="#è°ƒåº¦æµç¨‹å›¾è§£" class="headerlink" title="è°ƒåº¦æµç¨‹å›¾è§£"></a>è°ƒåº¦æµç¨‹å›¾è§£</h4><p><img src="/images/gmp_global_runq_random.png" alt="gmp_global_runq_probability"><br><img src="/images/gmp_local_runq.png" alt="get from local runq"><br><img src="/images/get_from_global_runq.png" alt="get_from_global_runq"><br><img src="/images/get_form_netpoll.png" alt="get_form_netpoll"><br><img src="/images/steal_from_other_p.png" alt="steal_from_other_p"></p><h3 id="Work-Stealingè´Ÿè½½å‡è¡¡æœºåˆ¶"><a href="#Work-Stealingè´Ÿè½½å‡è¡¡æœºåˆ¶" class="headerlink" title="Work-Stealingè´Ÿè½½å‡è¡¡æœºåˆ¶"></a>Work-Stealingè´Ÿè½½å‡è¡¡æœºåˆ¶</h3><p>å½“Pçš„æœ¬åœ°é˜Ÿåˆ—ä¸ºç©ºä¸”å…¨å±€é˜Ÿåˆ—ä¹Ÿæ— å¯ç”¨Goroutineæ—¶ï¼Œå¯åŠ¨Work-Stealingæœºåˆ¶å®ç°åŠ¨æ€è´Ÿè½½å‡è¡¡ã€‚</p><h4 id="å·å–ç­–ç•¥"><a href="#å·å–ç­–ç•¥" class="headerlink" title="å·å–ç­–ç•¥"></a>å·å–ç­–ç•¥</h4><ul><li><strong>éšæœºé€‰æ‹©</strong>ï¼šæœ€å¤šå°è¯•4æ¬¡ï¼Œæ¯æ¬¡éšæœºé€‰æ‹©ä¸€ä¸ªç›®æ ‡P</li><li><strong>é€‚åº”æ€§å·å–</strong>ï¼šä¼˜å…ˆä»ç¹å¿™çš„På·å–ï¼Œé¿å…å½±å“è½»è½½P</li><li><strong>æ‰¹é‡è½¬ç§»</strong>ï¼šä¸€æ¬¡å·å–ç›®æ ‡Pé˜Ÿåˆ—çš„ä¸€åŠï¼Œå‡å°‘å·å–é¢‘ç‡</li></ul><p><img src="/images/stealwork.png" alt="stealwork"></p><h4 id="æ ¸å¿ƒç®—æ³•ï¼šrunqgrab"><a href="#æ ¸å¿ƒç®—æ³•ï¼šrunqgrab" class="headerlink" title="æ ¸å¿ƒç®—æ³•ï¼šrunqgrab"></a>æ ¸å¿ƒç®—æ³•ï¼šrunqgrab</h4><p>Work-Stealingçš„å…³é”®å®ç°æ˜¯<code>runqgrab</code>å‡½æ•°ï¼Œé‡‡ç”¨æ— é”å¹¶å‘ç®—æ³•ï¼š</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs golang"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">runqgrab</span><span class="hljs-params">(pp *p, batch *[256]guintptr, batchHead <span class="hljs-type">uint32</span>, stealRunNextG <span class="hljs-type">bool</span>)</span></span> <span class="hljs-type">uint32</span> &#123;<br>    <span class="hljs-keyword">for</span> &#123;<br>        <span class="hljs-comment">// åŸå­è¯»å–é˜Ÿåˆ—å¤´å°¾æŒ‡é’ˆï¼Œç¡®ä¿å†…å­˜å¯è§æ€§</span><br>        h := atomic.LoadAcq(&amp;pp.runqhead) <span class="hljs-comment">// æ¶ˆè´¹è€…åŒæ­¥ç‚¹</span><br>        t := atomic.LoadAcq(&amp;pp.runqtail) <span class="hljs-comment">// ç”Ÿäº§è€…åŒæ­¥ç‚¹</span><br>        <br>        <span class="hljs-comment">// è®¡ç®—å¾…å·å–æ•°é‡ï¼ˆé˜Ÿåˆ—ä¸€åŠï¼‰</span><br>        n := t - h<br>        n = n - n/<span class="hljs-number">2</span><br>        <br>        <span class="hljs-comment">// æ‰¹é‡å¤åˆ¶Goroutineåˆ°å·å–è€…é˜Ÿåˆ—</span><br>        <span class="hljs-keyword">for</span> i := <span class="hljs-type">uint32</span>(<span class="hljs-number">0</span>); i &lt; n; i++ &#123;<br>            g := pp.runq[(h+i)%<span class="hljs-type">uint32</span>(<span class="hljs-built_in">len</span>(pp.runq))]<br>            batch[(batchHead+i)%<span class="hljs-type">uint32</span>(<span class="hljs-built_in">len</span>(batch))] = g<br>        &#125;<br>        <br>        <span class="hljs-comment">// CASåŸå­æ›´æ–°å¤´æŒ‡é’ˆï¼Œæäº¤å·å–æ“ä½œ</span><br>        <span class="hljs-keyword">if</span> atomic.CasRel(&amp;pp.runqhead, h, h+n) &#123;<br>            <span class="hljs-keyword">return</span> n<br>        &#125;<br>        <span class="hljs-comment">// CASå¤±è´¥è¯´æ˜å‘ç”Ÿç«äº‰ï¼Œé‡è¯•</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="ç®—æ³•ç‰¹ç‚¹"><a href="#ç®—æ³•ç‰¹ç‚¹" class="headerlink" title="ç®—æ³•ç‰¹ç‚¹"></a>ç®—æ³•ç‰¹ç‚¹</h4><ol><li><strong>æ— é”è®¾è®¡</strong>ï¼šä½¿ç”¨åŸå­æ“ä½œå’ŒCASé¿å…é”ç«äº‰</li><li><strong>å†…å­˜å±éšœ</strong>ï¼šLoadAcq&#x2F;CasRelç¡®ä¿æ­£ç¡®çš„å†…å­˜é¡ºåº</li><li><strong>å¤±è´¥é‡è¯•</strong>ï¼šCASå¤±è´¥æ—¶è‡ªåŠ¨é‡è¯•ï¼Œå¤„ç†å¹¶å‘ç«äº‰</li><li><strong>æ‰¹é‡æ“ä½œ</strong>ï¼šä¸€æ¬¡è½¬ç§»å¤šä¸ªGoroutineï¼Œæé«˜æ•ˆç‡</li></ol><h2 id="æŠ¢å å¼è°ƒåº¦æœºåˆ¶"><a href="#æŠ¢å å¼è°ƒåº¦æœºåˆ¶" class="headerlink" title="æŠ¢å å¼è°ƒåº¦æœºåˆ¶"></a>æŠ¢å å¼è°ƒåº¦æœºåˆ¶</h2><p>Goè°ƒåº¦å™¨é‡‡ç”¨æ··åˆè°ƒåº¦ç­–ç•¥ï¼Œç»“åˆåä½œå¼å’ŒæŠ¢å å¼è°ƒåº¦çš„ä¼˜åŠ¿ã€‚</p><h3 id="åä½œå¼ä¸æŠ¢å å¼å¯¹æ¯”"><a href="#åä½œå¼ä¸æŠ¢å å¼å¯¹æ¯”" class="headerlink" title="åä½œå¼ä¸æŠ¢å å¼å¯¹æ¯”"></a>åä½œå¼ä¸æŠ¢å å¼å¯¹æ¯”</h3><p><strong>åä½œå¼è°ƒåº¦</strong>ï¼š</p><ul><li>Goroutineä¸»åŠ¨è°ƒç”¨<code>runtime.Gosched()</code>è®©å‡ºCPU</li><li>åœ¨å‡½æ•°è°ƒç”¨æ—¶æ£€æŸ¥æ ˆæº¢å‡ºè§¦å‘è°ƒåº¦ç‚¹</li><li>ä¼˜ç‚¹ï¼šä¸Šä¸‹æ–‡åˆ‡æ¢å¼€é”€å°ï¼Œä»»åŠ¡æ‰§è¡Œè¿ç»­æ€§å¥½</li><li>ç¼ºç‚¹ï¼šä¾èµ–ç¨‹åºé…åˆï¼Œå¯èƒ½å¯¼è‡´æŸäº›Goroutineé•¿æœŸå ç”¨CPU</li></ul><p><strong>æŠ¢å å¼è°ƒåº¦</strong>ï¼š</p><ul><li>è¿è¡Œæ—¶ç³»ç»Ÿå¼ºåˆ¶ä¸­æ–­æ­£åœ¨æ‰§è¡Œçš„Goroutine</li><li>é€šè¿‡æ—¶é—´ç‰‡è½®è½¬å’Œä¿¡å·æœºåˆ¶å®ç°</li><li>ä¼˜ç‚¹ï¼šä¿è¯è°ƒåº¦å…¬å¹³æ€§ï¼Œé˜²æ­¢é¥¥é¥¿é—®é¢˜</li><li>ç¼ºç‚¹ï¼šé¢‘ç¹ä¸­æ–­å¢åŠ è°ƒåº¦å¼€é”€</li></ul><p><img src="/images/coop_vs_retake.png" alt="coop_vs_retake"></p><h3 id="æ€§èƒ½ç‰¹å¾åˆ†æ"><a href="#æ€§èƒ½ç‰¹å¾åˆ†æ" class="headerlink" title="æ€§èƒ½ç‰¹å¾åˆ†æ"></a>æ€§èƒ½ç‰¹å¾åˆ†æ</h3><ol><li><strong>æ‰§è¡Œå»¶è¿Ÿ</strong>ï¼šåä½œå¼è°ƒåº¦ä¸‹çŸ­ä»»åŠ¡æ‰§è¡Œå»¶è¿Ÿæ›´ä½</li><li><strong>æŠ¢å é¢‘ç‡</strong>ï¼šæŠ¢å å¼è°ƒåº¦ä¸­æ–­æ¬¡æ•°è¾ƒå¤šï¼Œå¢åŠ è°ƒåº¦å¼€é”€  </li><li><strong>å…¬å¹³æ€§æƒè¡¡</strong>ï¼šæŠ¢å è™½ç„¶å¢åŠ äº†é•¿ä»»åŠ¡çš„å»¶è¿Ÿï¼Œä½†ä¿è¯äº†çŸ­ä»»åŠ¡çš„åŠæ—¶å“åº”</li></ol><h3 id="ç³»ç»Ÿç›‘æ§çº¿ç¨‹ï¼ˆSysmonï¼‰"><a href="#ç³»ç»Ÿç›‘æ§çº¿ç¨‹ï¼ˆSysmonï¼‰" class="headerlink" title="ç³»ç»Ÿç›‘æ§çº¿ç¨‹ï¼ˆSysmonï¼‰"></a>ç³»ç»Ÿç›‘æ§çº¿ç¨‹ï¼ˆSysmonï¼‰</h3><p>Sysmonæ˜¯Goè¿è¡Œæ—¶çš„ç³»ç»Ÿçº§ç›‘æ§çº¿ç¨‹ï¼Œè¿è¡Œåœ¨ç‹¬ç«‹çš„æ“ä½œç³»ç»Ÿçº¿ç¨‹ä¸Šï¼Œä¸ç»‘å®šä»»ä½•Pï¼Œè´Ÿè´£å…¨å±€ç³»ç»Ÿç›‘æ§ä»»åŠ¡ã€‚</p><h4 id="æ ¸å¿ƒèŒè´£"><a href="#æ ¸å¿ƒèŒè´£" class="headerlink" title="æ ¸å¿ƒèŒè´£"></a>æ ¸å¿ƒèŒè´£</h4><ol><li><strong>ç½‘ç»œè½®è¯¢ï¼ˆnetpollï¼‰</strong>ï¼šæ£€æŸ¥ç½‘ç»œæ–‡ä»¶æè¿°ç¬¦äº‹ä»¶ï¼Œå°†å°±ç»ªçš„ç½‘ç»œGoroutineåŠ å…¥è°ƒåº¦é˜Ÿåˆ—</li><li><strong>æŠ¢å æ§åˆ¶ï¼ˆretakeï¼‰</strong>ï¼šç›‘æ§é•¿æ—¶é—´è¿è¡Œçš„Goroutineï¼Œè§¦å‘æŠ¢å è°ƒåº¦</li><li><strong>åƒåœ¾å›æ”¶ï¼ˆforcegcï¼‰</strong>ï¼šå®šæœŸè§¦å‘åƒåœ¾å›æ”¶ï¼Œé˜²æ­¢å†…å­˜ç§¯ç´¯</li><li><strong>å†…å­˜æ¸…ç†ï¼ˆscavengeï¼‰</strong>ï¼šå›æ”¶æœªä½¿ç”¨çš„å†…å­˜é¡µé¢ç»™æ“ä½œç³»ç»Ÿ</li></ol><h4 id="å·¥ä½œæ¨¡å¼"><a href="#å·¥ä½œæ¨¡å¼" class="headerlink" title="å·¥ä½œæ¨¡å¼"></a>å·¥ä½œæ¨¡å¼</h4><ul><li><strong>ç‹¬ç«‹çº¿ç¨‹</strong>ï¼šä¸å‚ä¸GMPè°ƒåº¦ï¼Œé¿å…è¢«é˜»å¡å½±å“ç›‘æ§åŠŸèƒ½</li><li><strong>å‘¨æœŸæ€§æ‰§è¡Œ</strong>ï¼šé‡‡ç”¨æŒ‡æ•°é€€é¿ç®—æ³•è°ƒæ•´ç›‘æ§é—´éš”ï¼Œå¹³è¡¡ç›‘æ§æ•ˆæœå’ŒCPUå¼€é”€</li><li><strong>åŠ¨æ€é—´éš”</strong>ï¼šç³»ç»Ÿç©ºé—²æ—¶å¢åŠ ç›‘æ§é—´éš”ï¼Œç¹å¿™æ—¶ç¼©çŸ­é—´éš”</li></ul><h4 id="æŠ¢å æœºåˆ¶è¯¦è§£"><a href="#æŠ¢å æœºåˆ¶è¯¦è§£" class="headerlink" title="æŠ¢å æœºåˆ¶è¯¦è§£"></a>æŠ¢å æœºåˆ¶è¯¦è§£</h4><h5 id="æŠ¢å è§¦å‘æ¡ä»¶"><a href="#æŠ¢å è§¦å‘æ¡ä»¶" class="headerlink" title="æŠ¢å è§¦å‘æ¡ä»¶"></a>æŠ¢å è§¦å‘æ¡ä»¶</h5><p>Sysmonéå†æ‰€æœ‰Pï¼Œå¯¹äºå¤„äº<code>_Prunning</code>å’Œ<code>_Psyscall</code>çŠ¶æ€çš„Pï¼Œå½“åŒæ—¶æ»¡è¶³ä»¥ä¸‹æ¡ä»¶æ—¶è§¦å‘æŠ¢å ï¼š</p><ol><li><strong>æ—¶é—´é˜ˆå€¼</strong>ï¼šPå¯¹åº”çš„Mè¿è¡Œæ—¶é—´è¶…è¿‡10msï¼ˆforcePreemptNSï¼‰</li><li><strong>é˜Ÿåˆ—éç©º</strong>ï¼šPçš„æœ¬åœ°è¿è¡Œé˜Ÿåˆ—ä¸­æœ‰å¾…è°ƒåº¦çš„Goroutine</li><li><strong>ç³»ç»Ÿç¹å¿™</strong>ï¼šæ²¡æœ‰ç©ºé—²çš„På’Œè‡ªæ—‹çš„Mï¼Œç³»ç»Ÿå¤„äºæ»¡è´Ÿè½½çŠ¶æ€</li></ol><p>è¿™äº›æ¡ä»¶ç¡®ä¿æŠ¢å åªåœ¨å¿…è¦æ—¶å‘ç”Ÿï¼Œé¿å…ä¸å¿…è¦çš„è°ƒåº¦å¼€é”€ã€‚</p><h5 id="æŠ¢å æ‰§è¡Œæµç¨‹"><a href="#æŠ¢å æ‰§è¡Œæµç¨‹" class="headerlink" title="æŠ¢å æ‰§è¡Œæµç¨‹"></a>æŠ¢å æ‰§è¡Œæµç¨‹</h5><p><strong>å¯¹äº<code>_Prunning</code>çŠ¶æ€çš„P</strong>ï¼š</p><ol><li>è°ƒç”¨<code>preemptone()</code>è®¾ç½®æŠ¢å æ ‡å¿—</li><li>è®¾ç½®<code>gp.stackguard0 = stackPreempt</code></li><li>å¦‚æœæ”¯æŒå¼‚æ­¥æŠ¢å ï¼Œå‘é€<code>SIGURG</code>ä¿¡å·</li></ol><p><strong>å¯¹äº<code>_Psyscall</code>çŠ¶æ€çš„P</strong>ï¼š</p><ol><li>æ‰§è¡ŒåŸºæœ¬æŠ¢å è®¾ç½®</li><li>è°ƒç”¨<code>handoffp()</code>å°†Pç§»äº¤ç»™å…¶ä»–M</li><li>åŸMç»§ç»­æ‰§è¡Œç³»ç»Ÿè°ƒç”¨ï¼ŒPå¯ç«‹å³æŠ•å…¥è°ƒåº¦</li></ol><h4 id="å…³é”®æºç å®ç°"><a href="#å…³é”®æºç å®ç°" class="headerlink" title="å…³é”®æºç å®ç°"></a>å…³é”®æºç å®ç°</h4><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><code class="hljs golang"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">retake</span><span class="hljs-params">(now <span class="hljs-type">int64</span>)</span></span> <span class="hljs-type">uint32</span> &#123;<br>    n := <span class="hljs-number">0</span><br>    lock(&amp;allpLock)<br>    <span class="hljs-comment">// éå†æ‰€æœ‰çš„P</span><br>    <span class="hljs-keyword">for</span> i := <span class="hljs-type">int32</span>(<span class="hljs-number">0</span>); i &lt; gomaxprocs; i++ &#123;<br>        _p_ := allp[i]<br>        <span class="hljs-keyword">if</span> _p_ == <span class="hljs-literal">nil</span> &#123;<br>            <span class="hljs-keyword">continue</span><br>        &#125;<br>        <span class="hljs-comment">// ç”¨äºsysmonçº¿ç¨‹è®°å½•è¢«ç›‘æ§Pçš„ç³»ç»Ÿè°ƒç”¨æ—¶é—´å’Œè¿è¡Œæ—¶é—´</span><br>        pd := &amp;_p_.sysmontick<br>        s := _p_.status<br>        sysretake := <span class="hljs-literal">false</span><br>        <br>        <span class="hljs-keyword">if</span> s == _Prunning || s == _Psyscall &#123;<br>            <span class="hljs-comment">// På¤„äºè¿è¡ŒçŠ¶æ€ï¼Œæ£€æŸ¥æ˜¯å¦è¿è¡Œå¾—å¤ªä¹…äº†</span><br>            t := <span class="hljs-type">int64</span>(_p_.schedtick)<br>            <span class="hljs-keyword">if</span> <span class="hljs-type">int64</span>(pd.schedtick) != t &#123;<br>                pd.schedtick = <span class="hljs-type">uint32</span>(t)<br>                pd.schedwhen = now<br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> pd.schedwhen+forcePreemptNS &lt;= now &#123;<br>                <span class="hljs-comment">// pd.schedtick == t è¯´æ˜è¿™æ®µæ—¶é—´æœªå‘ç”Ÿè¿‡è°ƒåº¦</span><br>                <span class="hljs-comment">// åŒä¸€ä¸ªgoroutineä¸€ç›´åœ¨è¿è¡Œï¼Œæ£€æŸ¥æ˜¯å¦è¿ç»­è¿è¡Œè¶…è¿‡äº†10ms</span><br>                preemptone(_p_)<br>                sysretake = <span class="hljs-literal">true</span><br>            &#125;<br>        &#125;<br>        <br>        <span class="hljs-keyword">if</span> s == _Psyscall &#123;<br>            <span class="hljs-comment">// ç³»ç»Ÿè°ƒç”¨çŠ¶æ€çš„ç‰¹æ®Šå¤„ç†</span><br>            t := <span class="hljs-type">int64</span>(_p_.syscalltick)<br>            <span class="hljs-keyword">if</span> !sysretake &amp;&amp; <span class="hljs-type">int64</span>(pd.syscalltick) != t &#123;<br>                pd.syscalltick = <span class="hljs-type">uint32</span>(t)<br>                pd.syscallwhen = now<br>                <span class="hljs-keyword">continue</span><br>            &#125;<br>            <br>            <span class="hljs-comment">// æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ä¹‹ä¸€åˆ™æŠ¢å è¯¥Pï¼š</span><br>            <span class="hljs-comment">// 1. Pçš„è¿è¡Œé˜Ÿåˆ—é‡Œé¢æœ‰ç­‰å¾…è¿è¡Œçš„goroutine</span><br>            <span class="hljs-comment">// 2. æ²¡æœ‰ç©ºé—²çš„P</span><br>            <span class="hljs-comment">// 3. ç³»ç»Ÿè°ƒç”¨æ—¶é—´è¶…è¿‡10ms</span><br>            <span class="hljs-keyword">if</span> runqempty(_p_) &amp;&amp; atomic.Load(&amp;sched.nmspinning)+atomic.Load(&amp;sched.npidle) &gt; <span class="hljs-number">0</span> &amp;&amp; <br>               pd.syscallwhen+<span class="hljs-number">10</span>*<span class="hljs-number">1000</span>*<span class="hljs-number">1000</span> &gt; now &#123;<br>                <span class="hljs-keyword">continue</span><br>            &#125;<br>            <br>            unlock(&amp;allpLock)<br>            incidlelocked(<span class="hljs-number">-1</span>)<br>            <span class="hljs-keyword">if</span> atomic.Cas(&amp;_p_.status, s, _Pidle) &#123;<br>                <span class="hljs-keyword">if</span> trace.enabled &#123;<br>                    traceGoSysBlock(_p_)<br>                    traceProcStop(_p_)<br>                &#125;<br>                n++<br>                _p_.syscalltick++<br>                <span class="hljs-comment">// å¯»æ‰¾æ–°çš„Mæ¥ç®¡P</span><br>                handoffp(_p_)<br>            &#125;<br>            incidlelocked(<span class="hljs-number">1</span>)<br>            lock(&amp;allpLock)<br>        &#125;<br>    &#125;<br>    unlock(&amp;allpLock)<br>    <span class="hljs-keyword">return</span> <span class="hljs-type">uint32</span>(n)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">preemptone</span><span class="hljs-params">(_p_ *p)</span></span> <span class="hljs-type">bool</span> &#123;<br>    mp := _p_.m.ptr()<br>    <span class="hljs-keyword">if</span> mp == <span class="hljs-literal">nil</span> || mp == getg().m &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>    &#125;<br>    gp := mp.curg<br>    <span class="hljs-keyword">if</span> gp == <span class="hljs-literal">nil</span> || gp == mp.g0 &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>    &#125;<br>    <br>    gp.preempt = <span class="hljs-literal">true</span><br>    <br>    <span class="hljs-comment">// è®¾ç½®æŠ¢å æ ‡å¿—ï¼šå°†stackguard0è®¾ç½®ä¸ºstackPreempt</span><br>    <span class="hljs-comment">// æ¯æ¬¡goroutineå‡½æ•°è°ƒç”¨éƒ½ä¼šæ£€æŸ¥æ ˆæº¢å‡ºï¼Œé€šè¿‡è¿™ç§æ–¹å¼å®ç°æŠ¢å æ£€æŸ¥</span><br>    gp.stackguard0 = stackPreempt<br>    <br>    <span class="hljs-comment">// å¦‚æœæ”¯æŒå¼‚æ­¥æŠ¢å ï¼Œå‘é€æŠ¢å ä¿¡å·</span><br>    <span class="hljs-keyword">if</span> preemptMSupported &amp;&amp; debug.asyncpreemptoff == <span class="hljs-number">0</span> &#123;<br>        _p_.preempt = <span class="hljs-literal">true</span><br>        preemptM(mp)<br>    &#125;<br>    <br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="P-Mè§£ç»‘æœºåˆ¶ï¼ˆHandoffï¼‰"><a href="#P-Mè§£ç»‘æœºåˆ¶ï¼ˆHandoffï¼‰" class="headerlink" title="P-Mè§£ç»‘æœºåˆ¶ï¼ˆHandoffï¼‰"></a>P-Mè§£ç»‘æœºåˆ¶ï¼ˆHandoffï¼‰</h3><p>å½“Goroutineå‘ç”Ÿé˜»å¡ã€ç³»ç»Ÿè°ƒç”¨æˆ–è¢«æŠ¢å æ—¶ï¼Œé‡‡ç”¨P-Mè§£ç»‘æœºåˆ¶æœ€å¤§åŒ–èµ„æºåˆ©ç”¨ç‡ã€‚</p><h4 id="æ ¸å¿ƒæ€æƒ³"><a href="#æ ¸å¿ƒæ€æƒ³" class="headerlink" title="æ ¸å¿ƒæ€æƒ³"></a>æ ¸å¿ƒæ€æƒ³</h4><ul><li><strong>Pçš„è¿ç»­æ€§</strong>ï¼šPä½œä¸ºè°ƒåº¦ä¸Šä¸‹æ–‡ï¼Œåº”å°½å¯èƒ½ä¿æŒå¿™ç¢ŒçŠ¶æ€</li><li><strong>Mçš„çµæ´»æ€§</strong>ï¼šMä½œä¸ºæ‰§è¡Œè½½ä½“ï¼Œå¯ä»¥åœ¨é˜»å¡æ—¶é‡Šæ”¾èµ„æº</li><li><strong>åŠ¨æ€ç»‘å®š</strong>ï¼šæ ¹æ®ç³»ç»Ÿè´Ÿè½½åŠ¨æ€è°ƒæ•´P-Mç»‘å®šå…³ç³»</li></ul><h4 id="å®ç°æœºåˆ¶"><a href="#å®ç°æœºåˆ¶" class="headerlink" title="å®ç°æœºåˆ¶"></a>å®ç°æœºåˆ¶</h4><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs golang"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">handoffp</span><span class="hljs-params">(_p_ *p)</span></span> &#123;<br>    <span class="hljs-comment">// å¦‚æœæœ¬åœ°æˆ–å…¨å±€é˜Ÿåˆ—æœ‰å·¥ä½œï¼Œç«‹å³åˆ†é…æ–°çš„M</span><br>    <span class="hljs-keyword">if</span> !runqempty(_p_) || sched.runqsize != <span class="hljs-number">0</span> &#123;<br>        startm(_p_, <span class="hljs-literal">false</span>)<br>        <span class="hljs-keyword">return</span><br>    &#125;<br>    <br>    <span class="hljs-comment">// ç³»ç»Ÿç¹å¿™æ—¶å¯åŠ¨è‡ªæ—‹Må¯»æ‰¾å·¥ä½œ</span><br>    <span class="hljs-keyword">if</span> atomic.Load(&amp;sched.nmspinning)+atomic.Load(&amp;sched.npidle) == <span class="hljs-number">0</span> &#123;<br>        startm(_p_, <span class="hljs-literal">true</span>) <span class="hljs-comment">// å¯åŠ¨è‡ªæ—‹M</span><br>        <span class="hljs-keyword">return</span><br>    &#125;<br>    <br>    <span class="hljs-comment">// æ— å·¥ä½œæ—¶å°†Pæ”¾å…¥ç©ºé—²é˜Ÿåˆ—</span><br>    pidleput(_p_)<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="å…³é”®ä¼˜åŒ–"><a href="#å…³é”®ä¼˜åŒ–" class="headerlink" title="å…³é”®ä¼˜åŒ–"></a>å…³é”®ä¼˜åŒ–</h4><ol><li><strong>å·¥ä½œæ£€æµ‹</strong>ï¼šä¼˜å…ˆæ£€æŸ¥æ˜¯å¦æœ‰å¾…å¤„ç†çš„Goroutine</li><li><strong>è‡ªæ—‹æœºåˆ¶</strong>ï¼šåœ¨ç³»ç»Ÿç¹å¿™æ—¶å¯åŠ¨è‡ªæ—‹Mä¸»åŠ¨å¯»æ‰¾å·¥ä½œ</li><li><strong>èµ„æºå›æ”¶</strong>ï¼šç©ºé—²æ—¶åŠæ—¶å›æ”¶Påˆ°å…¨å±€æ± ï¼Œé¿å…èµ„æºæµªè´¹</li></ol><h2 id="ä¸¤ç§æŠ¢å æœºåˆ¶å¯¹æ¯”"><a href="#ä¸¤ç§æŠ¢å æœºåˆ¶å¯¹æ¯”" class="headerlink" title="ä¸¤ç§æŠ¢å æœºåˆ¶å¯¹æ¯”"></a>ä¸¤ç§æŠ¢å æœºåˆ¶å¯¹æ¯”</h2><p>Goè°ƒåº¦å™¨å®ç°äº†ä¸¤ç§æŠ¢å æœºåˆ¶ï¼Œä»åä½œå¼é€æ­¥æ¼”è¿›åˆ°æ”¯æŒå¼‚æ­¥æŠ¢å ã€‚</p><h3 id="åŸºäºåä½œçš„æŠ¢å å¼è°ƒåº¦"><a href="#åŸºäºåä½œçš„æŠ¢å å¼è°ƒåº¦" class="headerlink" title="åŸºäºåä½œçš„æŠ¢å å¼è°ƒåº¦"></a>åŸºäºåä½œçš„æŠ¢å å¼è°ƒåº¦</h3><p>åä½œå¼æŠ¢å æ˜¯Goæ—©æœŸé‡‡ç”¨çš„æŠ¢å æœºåˆ¶ï¼Œä¾èµ–å‡½æ•°è°ƒç”¨æ—¶çš„æ ˆæ£€æŸ¥å®ç°ã€‚</p><h4 id="å®ç°åŸç†"><a href="#å®ç°åŸç†" class="headerlink" title="å®ç°åŸç†"></a>å®ç°åŸç†</h4><p>ç¼–è¯‘å™¨åœ¨æ¯ä¸ªå‡½æ•°å…¥å£æ’å…¥æ ˆæº¢å‡ºæ£€æŸ¥ä»£ç ï¼Œé€šè¿‡å¤ç”¨è¿™ä¸€æœºåˆ¶å®ç°æŠ¢å ï¼š</p><ol><li><strong>æ ˆæ£€æŸ¥å¤ç”¨</strong>ï¼šåˆ©ç”¨ç°æœ‰çš„<code>runtime.morestack</code>æ ˆæ£€æŸ¥é€»è¾‘</li><li><strong>æŠ¢å æ ‡å¿—</strong>ï¼šå°†<code>gp.stackguard0</code>è®¾ç½®ä¸º<code>stackPreempt</code>ç‰¹æ®Šå€¼</li><li><strong>ä¸»åŠ¨è®©å‡º</strong>ï¼šæ£€æµ‹åˆ°æŠ¢å æ ‡å¿—æ—¶è°ƒç”¨<code>gopreempt_m()</code>è®©å‡ºCPU</li></ol><h4 id="è§¦å‘æ¡ä»¶"><a href="#è§¦å‘æ¡ä»¶" class="headerlink" title="è§¦å‘æ¡ä»¶"></a>è§¦å‘æ¡ä»¶</h4><ul><li>Sysmonæ£€æµ‹åˆ°Goroutineè¿è¡Œæ—¶é—´è¶…è¿‡10ms</li><li>å‡½æ•°è°ƒç”¨æ—¶è§¦å‘æ ˆæ£€æŸ¥ï¼Œå‘ç°æŠ¢å æ ‡å¿—</li></ul><h4 id="å±€é™æ€§"><a href="#å±€é™æ€§" class="headerlink" title="å±€é™æ€§"></a>å±€é™æ€§</h4><p>åä½œå¼æŠ¢å å­˜åœ¨æ˜æ˜¾ç¼ºé™·ï¼š</p><ul><li><strong>ä¾èµ–å‡½æ•°è°ƒç”¨</strong>ï¼šå¦‚æœGoroutineä¸­åŒ…å«é•¿æ—¶é—´å¾ªç¯ä¸”æ— å‡½æ•°è°ƒç”¨ï¼Œæ— æ³•è¢«æŠ¢å </li><li><strong>æŠ¢å å»¶è¿Ÿ</strong>ï¼šåªèƒ½åœ¨å‡½æ•°è°ƒç”¨æ—¶æ£€æŸ¥ï¼ŒæŠ¢å æ—¶æœºä¸å¤Ÿçµæ´»</li><li><strong>GCé˜»å¡</strong>ï¼šåƒåœ¾å›æ”¶æ—¶å¯èƒ½å› ä¸ºæ— æ³•æŠ¢å æŸäº›Goroutineè€Œå»¶è¿Ÿ</li></ul><h3 id="åŸºäºä¿¡å·çš„å¼‚æ­¥æŠ¢å è°ƒåº¦"><a href="#åŸºäºä¿¡å·çš„å¼‚æ­¥æŠ¢å è°ƒåº¦" class="headerlink" title="åŸºäºä¿¡å·çš„å¼‚æ­¥æŠ¢å è°ƒåº¦"></a>åŸºäºä¿¡å·çš„å¼‚æ­¥æŠ¢å è°ƒåº¦</h3><p>Go 1.14å¼•å…¥å¼‚æ­¥æŠ¢å æœºåˆ¶ï¼Œè§£å†³åä½œå¼æŠ¢å çš„å±€é™æ€§ã€‚</p><h4 id="å®ç°åŸç†-1"><a href="#å®ç°åŸç†-1" class="headerlink" title="å®ç°åŸç†"></a>å®ç°åŸç†</h4><p>å¼‚æ­¥æŠ¢å é€šè¿‡æ“ä½œç³»ç»Ÿä¿¡å·æœºåˆ¶å®ç°å¼ºåˆ¶ä¸­æ–­ï¼š</p><ol><li><strong>ä¿¡å·æ³¨å†Œ</strong>ï¼šæ³¨å†Œ<code>SIGURG</code>ä¿¡å·å¤„ç†å‡½æ•°<code>doSigPreempt</code></li><li><strong>ä¿¡å·å‘é€</strong>ï¼šSysmoné€šè¿‡<code>preemptM()</code>å‘ç›®æ ‡Må‘é€æŠ¢å ä¿¡å·</li><li><strong>ä¸Šä¸‹æ–‡ä¿®æ”¹</strong>ï¼šä¿¡å·å¤„ç†å‡½æ•°ä¿®æ”¹è¢«ä¸­æ–­çº¿ç¨‹çš„æ‰§è¡Œä¸Šä¸‹æ–‡</li><li><strong>å¼‚æ­¥åˆ‡æ¢</strong>ï¼šå°†æ‰§è¡Œæµç¨‹é‡å®šå‘åˆ°<code>asyncPreempt</code>å‡½æ•°å®Œæˆè°ƒåº¦</li></ol><h4 id="æ ¸å¿ƒä»£ç "><a href="#æ ¸å¿ƒä»£ç " class="headerlink" title="æ ¸å¿ƒä»£ç "></a>æ ¸å¿ƒä»£ç </h4><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs golang"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">doSigPreempt</span><span class="hljs-params">(gp *g, ctxt *sigctxt)</span></span> &#123;<br>    <span class="hljs-keyword">if</span> wantAsyncPreempt(gp) &#123;<br>        <span class="hljs-keyword">if</span> ok, newpc := isAsyncSafePoint(gp, ctxt.sigpc(), ctxt.sigsp(), ctxt.siglr()); ok &#123;<br>            <span class="hljs-comment">// ä¿®æ”¹æ‰§è¡Œä¸Šä¸‹æ–‡ï¼Œæ³¨å…¥asyncPreemptè°ƒç”¨</span><br>            ctxt.pushCall(abi.FuncPCABI0(asyncPreempt), newpc)<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">asyncPreempt2</span><span class="hljs-params">()</span></span> &#123;<br>    gp := getg()<br>    gp.asyncSafePoint = <span class="hljs-literal">true</span><br>    <span class="hljs-keyword">if</span> gp.preemptStop &#123;<br>        mcall(preemptPark)  <span class="hljs-comment">// GCæŠ¢å </span><br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        mcall(gopreempt_m)  <span class="hljs-comment">// å¸¸è§„æŠ¢å </span><br>    &#125;<br>    gp.asyncSafePoint = <span class="hljs-literal">false</span><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="è§¦å‘åœºæ™¯"><a href="#è§¦å‘åœºæ™¯" class="headerlink" title="è§¦å‘åœºæ™¯"></a>è§¦å‘åœºæ™¯</h4><p>å¼‚æ­¥æŠ¢å ä¸»è¦ç”¨äºä»¥ä¸‹åœºæ™¯ï¼š</p><ol><li><strong>GCé˜¶æ®µ</strong>ï¼šåƒåœ¾å›æ”¶éœ€è¦æš‚åœæ‰€æœ‰Goroutineè¿›è¡Œæ ˆæ‰«æ</li><li><strong>è¿è¡Œæ—¶ç›‘æ§</strong>ï¼šSysmonæ£€æµ‹åˆ°é•¿æ—¶é—´è¿è¡Œçš„Goroutine</li><li><strong>ç´§æ€¥æŠ¢å </strong>ï¼šç³»ç»Ÿèµ„æºç´§å¼ æ—¶çš„å¼ºåˆ¶è°ƒåº¦</li></ol><h4 id="ä¼˜åŠ¿ä¸æ„ä¹‰"><a href="#ä¼˜åŠ¿ä¸æ„ä¹‰" class="headerlink" title="ä¼˜åŠ¿ä¸æ„ä¹‰"></a>ä¼˜åŠ¿ä¸æ„ä¹‰</h4><ul><li><strong>çœŸæ­£å¼‚æ­¥</strong>ï¼šä¸ä¾èµ–ç”¨æˆ·ä»£ç é…åˆï¼Œå¯åœ¨ä»»æ„æ‰§è¡Œç‚¹æŠ¢å </li><li><strong>GCæ•ˆç‡</strong>ï¼šå¤§å¹…æå‡åƒåœ¾å›æ”¶çš„å“åº”é€Ÿåº¦</li><li><strong>è°ƒåº¦å…¬å¹³æ€§</strong>ï¼šç¡®ä¿æ‰€æœ‰Goroutineéƒ½èƒ½è·å¾—æ‰§è¡Œæœºä¼š</li><li><strong>ç³»ç»Ÿå“åº”æ€§</strong>ï¼šæé«˜æ•´ä½“ç³»ç»Ÿçš„å®æ—¶æ€§å’Œå“åº”æ€§</li></ul><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>Goè¯­è¨€çš„GMPè°ƒåº¦å™¨ç»è¿‡å¤šå¹´æ¼”è¿›ï¼Œå·²æˆä¸ºé«˜å¹¶å‘åœºæ™¯ä¸‹çš„ä¼˜ç§€è°ƒåº¦ç³»ç»Ÿï¼š</p><h3 id="æ ¸å¿ƒä¼˜åŠ¿"><a href="#æ ¸å¿ƒä¼˜åŠ¿" class="headerlink" title="æ ¸å¿ƒä¼˜åŠ¿"></a>æ ¸å¿ƒä¼˜åŠ¿</h3><ol><li><strong>é«˜æ•ˆè°ƒåº¦</strong>ï¼šæœ¬åœ°é˜Ÿåˆ— + Work-Stealingå®ç°è´Ÿè½½å‡è¡¡</li><li><strong>æ··åˆæŠ¢å </strong>ï¼šåä½œå¼ä¸å¼‚æ­¥æŠ¢å ç›¸ç»“åˆï¼Œä¿è¯è°ƒåº¦å…¬å¹³æ€§</li><li><strong>åŠ¨æ€é€‚åº”</strong>ï¼šP-Mè§£ç»‘æœºåˆ¶æœ€å¤§åŒ–èµ„æºåˆ©ç”¨ç‡</li><li><strong>åƒåœ¾å›æ”¶é›†æˆ</strong>ï¼šä¸GCæ·±åº¦é›†æˆï¼Œæ”¯æŒä½å»¶è¿Ÿåƒåœ¾å›æ”¶</li></ol><h3 id="æ€§èƒ½ç‰¹å¾"><a href="#æ€§èƒ½ç‰¹å¾" class="headerlink" title="æ€§èƒ½ç‰¹å¾"></a>æ€§èƒ½ç‰¹å¾</h3><ul><li><strong>ä½å»¶è¿Ÿ</strong>ï¼šGoroutineåˆ›å»ºå’Œåˆ‡æ¢å¼€é”€æå°</li><li><strong>é«˜åå</strong>ï¼šæ”¯æŒç™¾ä¸‡çº§Goroutineå¹¶å‘</li><li><strong>å…¬å¹³è°ƒåº¦</strong>ï¼šé˜²æ­¢é¥¥é¥¿ï¼Œä¿è¯è°ƒåº¦å…¬å¹³æ€§</li><li><strong>è‡ªé€‚åº”</strong>ï¼šæ ¹æ®ç³»ç»Ÿè´Ÿè½½åŠ¨æ€è°ƒæ•´è°ƒåº¦ç­–ç•¥</li></ul><h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ol><li><a href="https://draveness.me/golang/docs/part3-runtime/ch06-concurrency/golang-goroutine/">Goè¯­è¨€è®¾è®¡ä¸å®ç° - è°ƒåº¦å™¨</a></li><li><a href="https://docs.google.com/document/d/1TTj4T2JO42uD5ID9e89oa0sLKhJYD0Y_kqxDv3I3XMw">Scalable Go Scheduler Design Doc</a></li><li><a href="https://medium.com/a-journey-with-go/go-asynchronous-preemption-b5194227371c">Go: Asynchronous Preemption</a></li><li><a href="https://cloud.tencent.com/developer/article/1938510">äº†è§£goåœ¨åç¨‹è°ƒåº¦ä¸Šçš„æ”¹è¿›</a></li></ol>]]></content>
    
    
    
    <tags>
      
      <tag>GO</tag>
      
      <tag>GO-GMP</tag>
      
      <tag>Goè°ƒåº¦åŸç†</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>æ·±å…¥ç†è§£Goåƒåœ¾å›æ”¶å™¨ï¼šåŸç†ã€æ¼”è¿›ä¸æ€§èƒ½ä¼˜åŒ–</title>
    <link href="/2023/07/08/Understating_GoGC/"/>
    <url>/2023/07/08/Understating_GoGC/</url>
    
    <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡æ·±å…¥åˆ†æGoè¯­è¨€åƒåœ¾å›æ”¶å™¨çš„è®¾è®¡åŸç†ã€æ¼”è¿›å†ç¨‹å’Œæ€§èƒ½ä¼˜åŒ–ç­–ç•¥ï¼Œå¸®åŠ©å¼€å‘è€…ç†è§£GCæœºåˆ¶å¹¶è¿›è¡Œæœ‰æ•ˆçš„æ€§èƒ½è°ƒä¼˜ã€‚</p></blockquote><span id="more"></span><h1 id="Goåƒåœ¾å›æ”¶å™¨æ¼”è¿›å†ç¨‹"><a href="#Goåƒåœ¾å›æ”¶å™¨æ¼”è¿›å†ç¨‹" class="headerlink" title="Goåƒåœ¾å›æ”¶å™¨æ¼”è¿›å†ç¨‹"></a>Goåƒåœ¾å›æ”¶å™¨æ¼”è¿›å†ç¨‹</h1><p>Goè¯­è¨€åƒåœ¾å›æ”¶å™¨ç»å†äº†å¤šä¸ªé‡è¦ç‰ˆæœ¬è¿­ä»£ï¼Œæ¯æ¬¡æ¼”è¿›éƒ½æ˜¾è‘—æ”¹å–„äº†GCæ€§èƒ½ï¼š</p><h2 id="å…³é”®ç‰ˆæœ¬èŠ‚ç‚¹"><a href="#å…³é”®ç‰ˆæœ¬èŠ‚ç‚¹" class="headerlink" title="å…³é”®ç‰ˆæœ¬èŠ‚ç‚¹"></a>å…³é”®ç‰ˆæœ¬èŠ‚ç‚¹</h2><p><strong>Go 1.0-1.4ï¼ˆä¸²è¡Œæ—¶ä»£ï¼‰</strong></p><ul><li><strong>ç®—æ³•</strong>ï¼šä¸²è¡Œä¸‰è‰²æ ‡è®°æ¸…æ‰«</li><li><strong>ç‰¹ç‚¹</strong>ï¼šStop-The-WorldæœŸé—´è¿›è¡Œå®Œæ•´çš„åƒåœ¾å›æ”¶</li><li><strong>æ€§èƒ½</strong>ï¼šåœé¡¿æ—¶é—´é•¿ï¼Œéšå †å¤§å°çº¿æ€§å¢é•¿</li></ul><p><strong>Go 1.5ï¼ˆå¹¶å‘çªç ´ï¼‰</strong></p><ul><li><strong>ç®—æ³•</strong>ï¼šå¹¶å‘ä¸‰è‰²æ ‡è®° + æ’å…¥å†™å±éšœ</li><li><strong>æ”¹è¿›</strong>ï¼šæ ‡è®°é˜¶æ®µä¸ç”¨æˆ·ç¨‹åºå¹¶å‘æ‰§è¡Œ</li><li><strong>æ€§èƒ½</strong>ï¼šåœé¡¿æ—¶é—´é™è‡³100msä»¥å†…</li><li><strong>æ„ä¹‰</strong>ï¼šGoè¯­è¨€å‘ä½å»¶è¿Ÿåº”ç”¨è¿ˆå‡ºé‡è¦ä¸€æ­¥</li></ul><p><strong>Go 1.8ï¼ˆæ··åˆå†™å±éšœï¼‰</strong></p><ul><li><strong>ç®—æ³•</strong>ï¼šæ··åˆå†™å±éšœï¼ˆHybrid Write Barrierï¼‰</li><li><strong>çªç ´</strong>ï¼šæ¶ˆé™¤æ ˆé‡æ‰«ï¼Œå¤§å¹…å‡å°‘STWæ—¶é—´</li><li><strong>æ€§èƒ½</strong>ï¼šåœé¡¿æ—¶é—´é™è‡³äºšæ¯«ç§’çº§åˆ«ï¼ˆ&lt;1msï¼‰</li><li><strong>ä¼˜åŠ¿</strong>ï¼šè§£å†³äº†æ’å…¥å†™å±éšœçš„æ ˆç©ºé—´é‡æ‰«é—®é¢˜</li></ul><p><strong>Go 1.17ï¼ˆå†…å­˜å½’è¿˜ä¼˜åŒ–ï¼‰</strong></p><ul><li><strong>æ”¹è¿›</strong>ï¼šé‡‡ç”¨MADV_DONTNEEDæ›¿ä»£MADV_FREE</li><li><strong>æ•ˆæœ</strong>ï¼šç«‹å³å½’è¿˜å†…å­˜ç»™æ“ä½œç³»ç»Ÿï¼Œé¿å…å†…å­˜ä½¿ç”¨é‡è¯¯æŠ¥</li><li><strong>åœºæ™¯</strong>ï¼šç‰¹åˆ«é€‚åˆå®¹å™¨åŒ–ç¯å¢ƒçš„å†…å­˜ç®¡ç†</li></ul><h1 id="Goåƒåœ¾å›æ”¶å™¨æ ¸å¿ƒåŸç†"><a href="#Goåƒåœ¾å›æ”¶å™¨æ ¸å¿ƒåŸç†" class="headerlink" title="Goåƒåœ¾å›æ”¶å™¨æ ¸å¿ƒåŸç†"></a>Goåƒåœ¾å›æ”¶å™¨æ ¸å¿ƒåŸç†</h1><h2 id="åŸºç¡€æ¶æ„"><a href="#åŸºç¡€æ¶æ„" class="headerlink" title="åŸºç¡€æ¶æ„"></a>åŸºç¡€æ¶æ„</h2><p>Goçš„åƒåœ¾å›æ”¶å™¨åŸºäº<strong>åä½œå¼</strong>å¹¶å‘è®¾è®¡ï¼Œç³»ç»Ÿä¸­å­˜åœ¨ä¸¤ç±»å…³é”®è§’è‰²ï¼š</p><ul><li><strong>Mutatorï¼ˆèµ‹å€¼å™¨ï¼‰</strong>ï¼šç”¨æˆ·ç¨‹åºï¼Œè´Ÿè´£åˆ†é…å¯¹è±¡å’Œä¿®æ”¹æŒ‡é’ˆå¼•ç”¨</li><li><strong>Collectorï¼ˆæ”¶é›†å™¨ï¼‰</strong>ï¼šåƒåœ¾å›æ”¶å™¨ï¼Œè´Ÿè´£è¯†åˆ«å’Œæ¸…ç†ä¸å¯è¾¾å¯¹è±¡</li></ul><p><strong>è®¾è®¡ç›®æ ‡</strong>ï¼šåœ¨ä¿è¯ç¨‹åºæ­£ç¡®æ€§çš„å‰æä¸‹ï¼Œæœ€å°åŒ–åœé¡¿æ—¶é—´ï¼Œå®ç°ä½å»¶è¿Ÿåƒåœ¾å›æ”¶ã€‚</p><h2 id="GCè§¦å‘æœºåˆ¶"><a href="#GCè§¦å‘æœºåˆ¶" class="headerlink" title="GCè§¦å‘æœºåˆ¶"></a>GCè§¦å‘æœºåˆ¶</h2><p>Goè¿è¡Œæ—¶é€šè¿‡å¤šç§æœºåˆ¶è‡ªåŠ¨è§¦å‘åƒåœ¾å›æ”¶ï¼š</p><h3 id="1-å †å†…å­˜å¢é•¿è§¦å‘"><a href="#1-å †å†…å­˜å¢é•¿è§¦å‘" class="headerlink" title="1. å †å†…å­˜å¢é•¿è§¦å‘"></a>1. å †å†…å­˜å¢é•¿è§¦å‘</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// å½“å †å†…å­˜å¢é•¿è¾¾åˆ°é˜ˆå€¼æ—¶è§¦å‘</span><br>NextGC = LiveHeap + LiveHeap * GOGC/<span class="hljs-number">100</span><br></code></pre></td></tr></table></figure><ul><li><strong>è§¦å‘ç‚¹</strong>ï¼š<code>mallocgc</code>å‡½æ•°ä¸­æ£€æµ‹å †å¤§å°</li><li><strong>é˜ˆå€¼è®¡ç®—</strong>ï¼šåŸºäºä¸Šæ¬¡GCåçš„å­˜æ´»å †å¤§å°å’ŒGOGCå‚æ•°</li><li><strong>é»˜è®¤å€¼</strong>ï¼šGOGC&#x3D;100ï¼Œå³å †å¤§å°ç¿»å€æ—¶è§¦å‘GC</li></ul><h3 id="2-å®šæ—¶è§¦å‘æœºåˆ¶"><a href="#2-å®šæ—¶è§¦å‘æœºåˆ¶" class="headerlink" title="2. å®šæ—¶è§¦å‘æœºåˆ¶"></a>2. å®šæ—¶è§¦å‘æœºåˆ¶</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// sysmonåç¨‹å®šæœŸæ£€æŸ¥ï¼Œé»˜è®¤2åˆ†é’ŸæœªGCåˆ™å¼ºåˆ¶è§¦å‘</span><br><span class="hljs-keyword">if</span> forcegcperiod &gt; <span class="hljs-number">0</span> &amp;&amp; lastgc+forcegcperiod &lt; now &#123;<br>    gcStart(gcTriggerTime)<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="3-æ‰‹åŠ¨è§¦å‘"><a href="#3-æ‰‹åŠ¨è§¦å‘" class="headerlink" title="3. æ‰‹åŠ¨è§¦å‘"></a>3. æ‰‹åŠ¨è§¦å‘</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs go">runtime.GC()    <span class="hljs-comment">// é˜»å¡å¼æ‰‹åŠ¨GC</span><br>runtime.ReadMemStats(&amp;m)  <span class="hljs-comment">// å¯èƒ½è§¦å‘GCä»¥è·å–å‡†ç¡®ç»Ÿè®¡</span><br></code></pre></td></tr></table></figure><h2 id="ä¸‰è‰²æ ‡è®°ç®—æ³•è¯¦è§£"><a href="#ä¸‰è‰²æ ‡è®°ç®—æ³•è¯¦è§£" class="headerlink" title="ä¸‰è‰²æ ‡è®°ç®—æ³•è¯¦è§£"></a>ä¸‰è‰²æ ‡è®°ç®—æ³•è¯¦è§£</h2><p>ä¸‰è‰²æ ‡è®°ç®—æ³•æ˜¯ç°ä»£åƒåœ¾å›æ”¶å™¨çš„æ ¸å¿ƒç®—æ³•ï¼Œé€šè¿‡é¢œè‰²çŠ¶æ€è¿½è¸ªå¯¹è±¡çš„å¯è¾¾æ€§ã€‚</p><h3 id="é¢œè‰²å®šä¹‰"><a href="#é¢œè‰²å®šä¹‰" class="headerlink" title="é¢œè‰²å®šä¹‰"></a>é¢œè‰²å®šä¹‰</h3><ul><li><strong>ç™½è‰²ï¼ˆWhiteï¼‰</strong>ï¼šæœªè¢«è®¿é—®çš„å¯¹è±¡ï¼Œæ½œåœ¨çš„åƒåœ¾å¯¹è±¡</li><li><strong>ç°è‰²ï¼ˆGrayï¼‰</strong>ï¼šå·²è®¿é—®ä½†å…¶å¼•ç”¨å¯¹è±¡æœªå®Œå…¨æ‰«æçš„å¯¹è±¡</li><li><strong>é»‘è‰²ï¼ˆBlackï¼‰</strong>ï¼šå·²è®¿é—®ä¸”å…¶æ‰€æœ‰å¼•ç”¨å¯¹è±¡éƒ½å·²æ‰«æçš„å¯¹è±¡</li></ul><h3 id="æ ‡è®°è¿‡ç¨‹"><a href="#æ ‡è®°è¿‡ç¨‹" class="headerlink" title="æ ‡è®°è¿‡ç¨‹"></a>æ ‡è®°è¿‡ç¨‹</h3><p><strong>é˜¶æ®µä¸€ï¼šæ ¹å¯¹è±¡æ‰«æ</strong></p><figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs oxygene">åˆå§‹çŠ¶æ€ï¼šæ‰€æœ‰å¯¹è±¡ä¸ºç™½è‰²<br>æ‰«ææ ¹é›†åˆï¼šå…¨å±€å˜é‡ã€goroutineæ ˆã€<span class="hljs-keyword">finalizer</span>é˜Ÿåˆ—<br>ç»“æœï¼šæ ¹å¯¹è±¡åŠå…¶ç›´æ¥å¼•ç”¨å¯¹è±¡å˜ä¸ºç°è‰²<br></code></pre></td></tr></table></figure><p><strong>é˜¶æ®µäºŒï¼šå¹¶å‘æ ‡è®°</strong></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">for</span> ç°è‰²é˜Ÿåˆ—ä¸ä¸ºç©º &#123;<br>    å¯¹è±¡ := ç°è‰²é˜Ÿåˆ—.Pop()<br>    å¯¹è±¡.é¢œè‰² = é»‘è‰²<br>    <br>    <span class="hljs-keyword">for</span> å¼•ç”¨ := <span class="hljs-keyword">range</span> å¯¹è±¡.å¼•ç”¨åˆ—è¡¨ &#123;<br>        <span class="hljs-keyword">if</span> å¼•ç”¨.é¢œè‰² == ç™½è‰² &#123;<br>            å¼•ç”¨.é¢œè‰² = ç°è‰²<br>            ç°è‰²é˜Ÿåˆ—.Push(å¼•ç”¨)<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>é˜¶æ®µä¸‰ï¼šæ¸…æ‰«å›æ”¶</strong></p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs powershell">æ‰«æå †ä¸­æ‰€æœ‰å¯¹è±¡<br>ç™½è‰²å¯¹è±¡ â†’ å›æ”¶å†…å­˜<br>é»‘è‰²å¯¹è±¡ â†’ é‡ç½®ä¸ºç™½è‰²ï¼Œå‡†å¤‡ä¸‹è½®<span class="hljs-built_in">GC</span><br></code></pre></td></tr></table></figure><h3 id="æ ¹å¯¹è±¡é›†åˆ"><a href="#æ ¹å¯¹è±¡é›†åˆ" class="headerlink" title="æ ¹å¯¹è±¡é›†åˆ"></a>æ ¹å¯¹è±¡é›†åˆ</h3><ul><li><strong>å…¨å±€å˜é‡</strong>ï¼šç¨‹åºä¸­çš„å…¨å±€å˜é‡å’ŒåŒ…çº§å˜é‡</li><li><strong>Goroutineæ ˆ</strong>ï¼šæ‰€æœ‰æ´»è·ƒgoroutineæ ˆä¸­çš„å±€éƒ¨å˜é‡</li><li><strong>Finalizeré˜Ÿåˆ—</strong>ï¼šæ³¨å†Œäº†finalizerçš„å¯¹è±¡</li><li><strong>å…¶ä»–GCæ ¹</strong>ï¼šè¿è¡Œæ—¶å†…éƒ¨æ•°æ®ç»“æ„</li></ul><h2 id="å†™å±éšœæœºåˆ¶ï¼šå¹¶å‘å®‰å…¨çš„æ ¸å¿ƒ"><a href="#å†™å±éšœæœºåˆ¶ï¼šå¹¶å‘å®‰å…¨çš„æ ¸å¿ƒ" class="headerlink" title="å†™å±éšœæœºåˆ¶ï¼šå¹¶å‘å®‰å…¨çš„æ ¸å¿ƒ"></a>å†™å±éšœæœºåˆ¶ï¼šå¹¶å‘å®‰å…¨çš„æ ¸å¿ƒ</h2><h3 id="å¹¶å‘é—®é¢˜çš„æœ¬è´¨"><a href="#å¹¶å‘é—®é¢˜çš„æœ¬è´¨" class="headerlink" title="å¹¶å‘é—®é¢˜çš„æœ¬è´¨"></a>å¹¶å‘é—®é¢˜çš„æœ¬è´¨</h3><p>å½“Mutatorå’ŒCollectorå¹¶å‘æ‰§è¡Œæ—¶ï¼Œä¼šå‡ºç°<strong>å¯¹è±¡ä¸¢å¤±é—®é¢˜</strong>ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// é—®é¢˜åœºæ™¯ï¼šå¯¹è±¡ä¸¢å¤±</span><br><span class="hljs-comment">// 1. GCå·²æ‰«æå®ŒAå¯¹è±¡ï¼ˆAå˜ä¸ºé»‘è‰²ï¼‰</span><br><span class="hljs-comment">// 2. ç”¨æˆ·ç¨‹åºæ‰§è¡Œï¼šA.field = C  // Cæ˜¯ç™½è‰²å¯¹è±¡</span><br><span class="hljs-comment">// 3. ç”¨æˆ·ç¨‹åºæ‰§è¡Œï¼šB.field = nil // Bæ˜¯ç°è‰²ï¼ŒåŸæœ¬å¼•ç”¨C</span><br><span class="hljs-comment">// 4. ç»“æœï¼šCå¯¹è±¡å˜ä¸ºä¸å¯è¾¾ï¼Œä½†GCæ— æ³•å‘ç°ï¼Œå¯¼è‡´å­˜æ´»å¯¹è±¡è¢«è¯¯å›æ”¶</span><br></code></pre></td></tr></table></figure><h3 id="ä¸‰è‰²ä¸å˜å¼"><a href="#ä¸‰è‰²ä¸å˜å¼" class="headerlink" title="ä¸‰è‰²ä¸å˜å¼"></a>ä¸‰è‰²ä¸å˜å¼</h3><p>ä¸ºç¡®ä¿å¹¶å‘å®‰å…¨ï¼Œå¿…é¡»ç»´æŠ¤ä»¥ä¸‹ä¸å˜å¼ä¹‹ä¸€ï¼š</p><p><strong>å¼ºä¸‰è‰²ä¸å˜å¼ï¼ˆStrong Tricolor Invariantï¼‰</strong></p><ul><li><strong>çº¦æŸ</strong>ï¼šé»‘è‰²å¯¹è±¡ä¸èƒ½ç›´æ¥å¼•ç”¨ç™½è‰²å¯¹è±¡</li><li><strong>å®ç°</strong>ï¼šæ’å…¥å†™å±éšœ</li><li><strong>æœºåˆ¶</strong>ï¼šå½“é»‘è‰²å¯¹è±¡å¼•ç”¨ç™½è‰²å¯¹è±¡æ—¶ï¼Œç«‹å³å°†ç™½è‰²å¯¹è±¡æ ‡è®°ä¸ºç°è‰²</li></ul><p><strong>å¼±ä¸‰è‰²ä¸å˜å¼ï¼ˆWeak Tricolor Invariantï¼‰</strong></p><ul><li><strong>çº¦æŸ</strong>ï¼šé»‘è‰²å¯¹è±¡å¯ä»¥å¼•ç”¨ç™½è‰²å¯¹è±¡ï¼Œä½†ç™½è‰²å¯¹è±¡å¿…é¡»è¢«æŸä¸ªç°è‰²å¯¹è±¡å¯è¾¾</li><li><strong>å®ç°</strong>ï¼šåˆ é™¤å†™å±éšœ</li><li><strong>æœºåˆ¶</strong>ï¼šåˆ é™¤å¼•ç”¨æ—¶ï¼Œå°†è¢«åˆ é™¤çš„ç™½è‰²å¯¹è±¡æ ‡è®°ä¸ºç°è‰²</li></ul><h3 id="å¹¶å‘å®‰å…¨ä¿è¯"><a href="#å¹¶å‘å®‰å…¨ä¿è¯" class="headerlink" title="å¹¶å‘å®‰å…¨ä¿è¯"></a>å¹¶å‘å®‰å…¨ä¿è¯</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// ä¼ªä»£ç ï¼šå†™å±éšœä¿è¯å¯¹è±¡ä¸ä¸¢å¤±</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">writeBarrier</span><span class="hljs-params">(slot *unsafe.Pointer, ptr unsafe.Pointer)</span></span> &#123;<br>    <span class="hljs-comment">// æ··åˆå†™å±éšœé€»è¾‘</span><br>    <span class="hljs-keyword">if</span> gcphase == _GCmark &#123;<br>        <span class="hljs-comment">// æ ‡è®°è¢«å¼•ç”¨çš„å¯¹è±¡</span><br>        shade(ptr)  <span class="hljs-comment">// å°†æ–°å¼•ç”¨çš„å¯¹è±¡æ ‡è®°ä¸ºç°è‰²</span><br>        <span class="hljs-comment">// æ ‡è®°åŸæœ‰è¢«å¼•ç”¨çš„å¯¹è±¡</span><br>        shade(*slot) <span class="hljs-comment">// å°†åŸå¼•ç”¨çš„å¯¹è±¡æ ‡è®°ä¸ºç°è‰²</span><br>    &#125;<br>    *slot = ptr<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="å†™å±éšœæŠ€æœ¯æ¼”è¿›"><a href="#å†™å±éšœæŠ€æœ¯æ¼”è¿›" class="headerlink" title="å†™å±éšœæŠ€æœ¯æ¼”è¿›"></a>å†™å±éšœæŠ€æœ¯æ¼”è¿›</h3><h4 id="æ’å…¥å†™å±éšœï¼ˆGo-1-5-1-7ï¼‰"><a href="#æ’å…¥å†™å±éšœï¼ˆGo-1-5-1-7ï¼‰" class="headerlink" title="æ’å…¥å†™å±éšœï¼ˆGo 1.5-1.7ï¼‰"></a>æ’å…¥å†™å±éšœï¼ˆGo 1.5-1.7ï¼‰</h4><p><strong>åŸç†</strong>ï¼šç»´æŠ¤å¼ºä¸‰è‰²ä¸å˜å¼</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// æ’å…¥å±éšœä¼ªä»£ç </span><br>writePointer(slot, ptr) &#123;<br>    shade(ptr)  <span class="hljs-comment">// å°†æ–°æ’å…¥çš„å¯¹è±¡æ ‡è®°ä¸ºç°è‰²</span><br>    *slot = ptr<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>ç‰¹ç‚¹</strong>ï¼š</p><ul><li>âœ… <strong>ä¼˜ç‚¹</strong>ï¼šä¿è¯ä¸ä¸¢å¤±å¯¹è±¡ï¼Œå›æ”¶ç²¾åº¦é«˜</li><li>âŒ <strong>ç¼ºç‚¹</strong>ï¼šæ ˆç©ºé—´ä¸å¯ç”¨å±éšœï¼Œéœ€è¦STWé‡æ‰«æ ˆ</li><li>ğŸ”„ <strong>åº”ç”¨åœºæ™¯</strong>ï¼šä»…åœ¨å †ç©ºé—´å¯ç”¨ï¼Œæ ˆåˆ°å †çš„å¼•ç”¨éœ€è¦ç‰¹æ®Šå¤„ç†</li></ul><h4 id="æ··åˆå†™å±éšœï¼ˆGo-1-8-ï¼‰"><a href="#æ··åˆå†™å±éšœï¼ˆGo-1-8-ï¼‰" class="headerlink" title="æ··åˆå†™å±éšœï¼ˆGo 1.8+ï¼‰"></a>æ··åˆå†™å±éšœï¼ˆGo 1.8+ï¼‰</h4><p><strong>è®¾è®¡æ€æƒ³</strong>ï¼šç»“åˆæ’å…¥å’Œåˆ é™¤å±éšœçš„ä¼˜åŠ¿ï¼Œæ¶ˆé™¤æ ˆé‡æ‰«</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// æ··åˆå†™å±éšœä¼ªä»£ç </span><br>writePointer(slot, ptr) &#123;<br>    shade(*slot) <span class="hljs-comment">// æ ‡è®°åŸæœ‰å¼•ç”¨å¯¹è±¡ï¼ˆåˆ é™¤å±éšœæ€æƒ³ï¼‰</span><br>    shade(ptr)   <span class="hljs-comment">// æ ‡è®°æ–°å¼•ç”¨å¯¹è±¡ï¼ˆæ’å…¥å±éšœæ€æƒ³ï¼‰</span><br>    *slot = ptr<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>æ ¸å¿ƒæœºåˆ¶</strong>ï¼š</p><ol><li><strong>æ ˆå¯¹è±¡é¢„æ ‡è®°</strong>ï¼šGCå¼€å§‹æ—¶å°†æ‰€æœ‰æ ˆå¯¹è±¡æ ‡è®°ä¸ºé»‘è‰²</li><li><strong>æ–°å¯¹è±¡é»‘è‰²</strong>ï¼šGCæœŸé—´åˆ†é…çš„æ–°å¯¹è±¡ç›´æ¥æ ‡è®°ä¸ºé»‘è‰²</li><li><strong>å †ç©ºé—´å±éšœ</strong>ï¼šä»…åœ¨å †ç©ºé—´å¯ç”¨å†™å±éšœ</li><li><strong>æ ˆç©ºé—´å…æ‰«</strong>ï¼šæ— éœ€é‡æ‰«æ ˆç©ºé—´</li></ol><p><strong>å±éšœè§„åˆ™</strong>ï¼š</p><table><thead><tr><th>å¼•ç”¨ç±»å‹</th><th>å†™å±éšœ</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>æ ˆâ†’æ ˆ</td><td>âŒ</td><td>æ— éœ€å±éšœï¼Œæ ˆå¯¹è±¡å·²é¢„æ ‡è®°ä¸ºé»‘è‰²</td></tr><tr><td>æ ˆâ†’å †</td><td>âŒ</td><td>æ–°åˆ†é…å¯¹è±¡ä¸ºé»‘è‰²ï¼Œæ— éœ€å±éšœ</td></tr><tr><td>å †â†’æ ˆ</td><td>âŒ</td><td>æ ˆå¯¹è±¡ä¸ºé»‘è‰²ï¼Œæ— å½±å“</td></tr><tr><td>å †â†’å †</td><td>âœ…</td><td>å¯ç”¨æ··åˆå†™å±éšœ</td></tr></tbody></table><p><strong>æ€§èƒ½æå‡</strong>ï¼š</p><ul><li>ğŸš€ <strong>STWæ—¶é—´</strong>ï¼šä»æ•°åæ¯«ç§’é™è‡³äºšæ¯«ç§’çº§</li><li>ğŸ“ˆ <strong>ååé‡</strong>ï¼šæ¶ˆé™¤æ ˆé‡æ‰«å¼€é”€</li><li>ğŸ¯ <strong>é€‚ç”¨æ€§</strong>ï¼šç‰¹åˆ«é€‚åˆå¤§é‡goroutineåœºæ™¯</li></ul><h1 id="Goåƒåœ¾å›æ”¶æ€§èƒ½ä¼˜åŒ–"><a href="#Goåƒåœ¾å›æ”¶æ€§èƒ½ä¼˜åŒ–" class="headerlink" title="Goåƒåœ¾å›æ”¶æ€§èƒ½ä¼˜åŒ–"></a>Goåƒåœ¾å›æ”¶æ€§èƒ½ä¼˜åŒ–</h1><h2 id="æ€§èƒ½æŒ‡æ ‡ä½“ç³»"><a href="#æ€§èƒ½æŒ‡æ ‡ä½“ç³»" class="headerlink" title="æ€§èƒ½æŒ‡æ ‡ä½“ç³»"></a>æ€§èƒ½æŒ‡æ ‡ä½“ç³»</h2><h3 id="æ ¸å¿ƒæ€§èƒ½æŒ‡æ ‡"><a href="#æ ¸å¿ƒæ€§èƒ½æŒ‡æ ‡" class="headerlink" title="æ ¸å¿ƒæ€§èƒ½æŒ‡æ ‡"></a>æ ¸å¿ƒæ€§èƒ½æŒ‡æ ‡</h3><p><strong>å»¶è¿ŸæŒ‡æ ‡</strong></p><ul><li><strong>STWæ—¶é—´</strong>ï¼šStop-The-Worldåœé¡¿æ—¶é—´ï¼Œç›®æ ‡&lt;1ms</li><li><strong>åˆ†é…å»¶è¿Ÿ</strong>ï¼šå†…å­˜åˆ†é…æ—¶çš„è¾…åŠ©æ ‡è®°å»¶è¿Ÿ</li><li><strong>GCé¢‘ç‡</strong>ï¼šå•ä½æ—¶é—´å†…GCè§¦å‘æ¬¡æ•°</li></ul><p><strong>ååé‡æŒ‡æ ‡</strong></p><ul><li><strong>CPUåˆ©ç”¨ç‡åˆ†å¸ƒ</strong>ï¼š<ul><li>Mutator CPUä½¿ç”¨ç‡ï¼š&gt;90%ï¼ˆç›®æ ‡ï¼‰</li><li>GC CPUä½¿ç”¨ç‡ï¼š&lt;10%ï¼ˆç›®æ ‡ï¼‰</li></ul></li><li><strong>å†…å­˜åˆ†é…é€Ÿç‡</strong>ï¼šMB&#x2F;s</li><li><strong>GCæ ‡è®°é€Ÿç‡</strong>ï¼šMB&#x2F;s</li></ul><p><strong>å†…å­˜æŒ‡æ ‡</strong></p><ul><li><strong>å †å¢é•¿ç‡</strong>ï¼šå†…å­˜åˆ†é…ä¸å›æ”¶çš„å¹³è¡¡</li><li><strong>å¯¹è±¡å­˜æ´»ç‡</strong>ï¼šå½±å“GCå·¥ä½œé‡</li><li><strong>å†…å­˜åˆ©ç”¨ç‡</strong>ï¼šé¿å…å†…å­˜æµªè´¹</li></ul><h3 id="æ€§èƒ½ç›‘æ§æ–¹æ¡ˆ"><a href="#æ€§èƒ½ç›‘æ§æ–¹æ¡ˆ" class="headerlink" title="æ€§èƒ½ç›‘æ§æ–¹æ¡ˆ"></a>æ€§èƒ½ç›‘æ§æ–¹æ¡ˆ</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// è¿è¡Œæ—¶GCç»Ÿè®¡</span><br><span class="hljs-keyword">var</span> m runtime.MemStats<br>runtime.ReadMemStats(&amp;m)<br><br>fmt.Printf(<span class="hljs-string">&quot;GCæ¬¡æ•°: %d\n&quot;</span>, m.NumGC)<br>fmt.Printf(<span class="hljs-string">&quot;GCæ€»è€—æ—¶: %v\n&quot;</span>, time.Duration(m.PauseTotalNs))<br>fmt.Printf(<span class="hljs-string">&quot;å¹³å‡åœé¡¿: %v\n&quot;</span>, time.Duration(m.PauseTotalNs)/time.Duration(m.NumGC))<br>fmt.Printf(<span class="hljs-string">&quot;å †å¤§å°: %d MB\n&quot;</span>, m.HeapInuse/<span class="hljs-number">1024</span>/<span class="hljs-number">1024</span>)<br>fmt.Printf(<span class="hljs-string">&quot;GC CPUå æ¯”: %.2f%%\n&quot;</span>, m.GCCPUFraction*<span class="hljs-number">100</span>)<br></code></pre></td></tr></table></figure><h2 id="GCé¢‘ç‡è°ƒä¼˜ç­–ç•¥"><a href="#GCé¢‘ç‡è°ƒä¼˜ç­–ç•¥" class="headerlink" title="GCé¢‘ç‡è°ƒä¼˜ç­–ç•¥"></a>GCé¢‘ç‡è°ƒä¼˜ç­–ç•¥</h2><h3 id="GOGCå‚æ•°ä¼˜åŒ–"><a href="#GOGCå‚æ•°ä¼˜åŒ–" class="headerlink" title="GOGCå‚æ•°ä¼˜åŒ–"></a>GOGCå‚æ•°ä¼˜åŒ–</h3><p><strong>è§¦å‘å…¬å¼</strong>ï¼š</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">NextGC</span> = LiveHeap + LiveHeap Ã— (GOGC/<span class="hljs-number">100</span>)<br></code></pre></td></tr></table></figure><p><strong>è°ƒä¼˜ç­–ç•¥</strong>ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// æ–¹å¼1ï¼šç¯å¢ƒå˜é‡</span><br>GOGC=<span class="hljs-number">200</span> ./your-app<br><br><span class="hljs-comment">// æ–¹å¼2ï¼šè¿è¡Œæ—¶è®¾ç½®</span><br>oldGOGC := debug.SetGCPercent(<span class="hljs-number">200</span>)<br><span class="hljs-keyword">defer</span> debug.SetGCPercent(oldGOGC)<br></code></pre></td></tr></table></figure><p><strong>å‚æ•°å½±å“åˆ†æ</strong>ï¼š</p><table><thead><tr><th>GOGCå€¼</th><th>GCé¢‘ç‡</th><th>å†…å­˜ä½¿ç”¨</th><th>é€‚ç”¨åœºæ™¯</th></tr></thead><tbody><tr><td>50</td><td>é«˜é¢‘</td><td>ä½</td><td>å†…å­˜æ•æ„Ÿåº”ç”¨</td></tr><tr><td>100(é»˜è®¤)</td><td>ä¸­ç­‰</td><td>ä¸­ç­‰</td><td>é€šç”¨åœºæ™¯</td></tr><tr><td>200+</td><td>ä½é¢‘</td><td>é«˜</td><td>è®¡ç®—å¯†é›†å‹åº”ç”¨</td></tr><tr><td>off</td><td>ç¦ç”¨</td><td>æŒç»­å¢é•¿</td><td>çŸ­ç”Ÿå‘½å‘¨æœŸç¨‹åº</td></tr></tbody></table><h3 id="å†…å­˜é™åˆ¶æœºåˆ¶ï¼ˆGo-1-19-ï¼‰"><a href="#å†…å­˜é™åˆ¶æœºåˆ¶ï¼ˆGo-1-19-ï¼‰" class="headerlink" title="å†…å­˜é™åˆ¶æœºåˆ¶ï¼ˆGo 1.19+ï¼‰"></a>å†…å­˜é™åˆ¶æœºåˆ¶ï¼ˆGo 1.19+ï¼‰</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// è®¾ç½®å†…å­˜é™åˆ¶ï¼Œé˜²æ­¢OOM</span><br>debug.SetMemoryLimit(<span class="hljs-number">8</span> &lt;&lt; <span class="hljs-number">30</span>) <span class="hljs-comment">// 8GBé™åˆ¶</span><br><br><span class="hljs-comment">// æˆ–ä½¿ç”¨ç¯å¢ƒå˜é‡</span><br>GOMEMLIMIT=<span class="hljs-number">8</span>GiB ./your-app<br></code></pre></td></tr></table></figure><p><strong>æœ€ä½³å®è·µ</strong>ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// ç”Ÿäº§ç¯å¢ƒæ¨èé…ç½®</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">initGCConfig</span><span class="hljs-params">()</span></span> &#123;<br>    <span class="hljs-comment">// å®¹å™¨ç¯å¢ƒï¼šè®¾ç½®ä¸ºå®¹å™¨å†…å­˜é™åˆ¶çš„80%</span><br>    memLimit := getContainerMemoryLimit() * <span class="hljs-number">0.8</span><br>    debug.SetMemoryLimit(<span class="hljs-type">int64</span>(memLimit))<br>    <br>    <span class="hljs-comment">// æ ¹æ®åº”ç”¨ç‰¹æ€§è°ƒæ•´GOGC</span><br>    <span class="hljs-keyword">if</span> isComputeIntensive() &#123;<br>        debug.SetGCPercent(<span class="hljs-number">200</span>) <span class="hljs-comment">// å‡å°‘GCé¢‘ç‡</span><br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> isMemoryConstrained() &#123;<br>        debug.SetGCPercent(<span class="hljs-number">50</span>)  <span class="hljs-comment">// æ›´ç§¯æå›æ”¶</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="è°ƒä¼˜å†³ç­–æµç¨‹"><a href="#è°ƒä¼˜å†³ç­–æµç¨‹" class="headerlink" title="è°ƒä¼˜å†³ç­–æµç¨‹"></a>è°ƒä¼˜å†³ç­–æµç¨‹</h3><ol><li><strong>åŸºçº¿æµ‹è¯•</strong>ï¼šè®°å½•é»˜è®¤é…ç½®ä¸‹çš„æ€§èƒ½æŒ‡æ ‡</li><li><strong>å‹åŠ›æµ‹è¯•</strong>ï¼šæ¨¡æ‹Ÿç”Ÿäº§è´Ÿè½½ï¼Œè§‚å¯ŸGCè¡Œä¸º</li><li><strong>å‚æ•°å®éªŒ</strong>ï¼šé€æ­¥è°ƒæ•´GOGCå’Œå†…å­˜é™åˆ¶</li><li><strong>æ•ˆæœéªŒè¯</strong>ï¼šå¯¹æ¯”å…³é”®æŒ‡æ ‡çš„æ”¹å–„æƒ…å†µ</li><li><strong>ç”Ÿäº§éƒ¨ç½²</strong>ï¼šç°åº¦å‘å¸ƒï¼ŒæŒç»­ç›‘æ§</li></ol><h2 id="å†…å­˜åˆ†é…ä¼˜åŒ–"><a href="#å†…å­˜åˆ†é…ä¼˜åŒ–" class="headerlink" title="å†…å­˜åˆ†é…ä¼˜åŒ–"></a>å†…å­˜åˆ†é…ä¼˜åŒ–</h2><h3 id="1-å¯¹è±¡æ± æ¨¡å¼"><a href="#1-å¯¹è±¡æ± æ¨¡å¼" class="headerlink" title="1. å¯¹è±¡æ± æ¨¡å¼"></a>1. å¯¹è±¡æ± æ¨¡å¼</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// é«˜æ•ˆçš„å¯¹è±¡æ± å®ç°</span><br><span class="hljs-keyword">var</span> bufferPool = sync.Pool&#123;<br>    New: <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> <span class="hljs-keyword">interface</span>&#123;&#125; &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">make</span>([]<span class="hljs-type">byte</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1024</span>) <span class="hljs-comment">// é¢„åˆ†é…1KB</span><br>    &#125;,<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">processData</span><span class="hljs-params">(data []<span class="hljs-type">byte</span>)</span></span> &#123;<br>    buf := bufferPool.Get().([]<span class="hljs-type">byte</span>)<br>    <span class="hljs-keyword">defer</span> bufferPool.Put(buf[:<span class="hljs-number">0</span>]) <span class="hljs-comment">// é‡ç½®é•¿åº¦ä½†ä¿ç•™å®¹é‡</span><br>    <br>    <span class="hljs-comment">// ä½¿ç”¨bufè¿›è¡Œæ•°æ®å¤„ç†</span><br>    buf = <span class="hljs-built_in">append</span>(buf, data...)<br>    <span class="hljs-comment">// ... ä¸šåŠ¡é€»è¾‘</span><br>&#125;<br></code></pre></td></tr></table></figure><p><strong>åº”ç”¨åœºæ™¯</strong>ï¼š</p><ul><li>HTTPè¯·æ±‚&#x2F;å“åº”ç¼“å†²åŒº</li><li>JSONç¼–è§£ç ç¼“å†²åŒº</li><li>æ•°æ®åº“è¿æ¥å¯¹è±¡</li><li>å¤§å‹ç»“æ„ä½“å®ä¾‹</li></ul><h3 id="2-é¢„åˆ†é…ç­–ç•¥"><a href="#2-é¢„åˆ†é…ç­–ç•¥" class="headerlink" title="2. é¢„åˆ†é…ç­–ç•¥"></a>2. é¢„åˆ†é…ç­–ç•¥</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// âœ… æ­£ç¡®ï¼šé¢„åˆ†é…å®¹é‡</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">processItems</span><span class="hljs-params">(items []Item)</span></span> []Result &#123;<br>    results := <span class="hljs-built_in">make</span>([]Result, <span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(items)) <span class="hljs-comment">// é¢„åˆ†é…å®¹é‡</span><br>    <span class="hljs-keyword">for</span> _, item := <span class="hljs-keyword">range</span> items &#123;<br>        results = <span class="hljs-built_in">append</span>(results, process(item))<br>    &#125;<br>    <span class="hljs-keyword">return</span> results<br>&#125;<br><br><span class="hljs-comment">// âŒ é”™è¯¯ï¼šé¢‘ç¹æ‰©å®¹</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">processItemsBad</span><span class="hljs-params">(items []Item)</span></span> []Result &#123;<br>    <span class="hljs-keyword">var</span> results []Result <span class="hljs-comment">// é›¶å€¼åˆ‡ç‰‡ï¼Œé¢‘ç¹æ‰©å®¹</span><br>    <span class="hljs-keyword">for</span> _, item := <span class="hljs-keyword">range</span> items &#123;<br>        results = <span class="hljs-built_in">append</span>(results, process(item))<br>    &#125;<br>    <span class="hljs-keyword">return</span> results<br>&#125;<br><br><span class="hljs-comment">// ğŸ”§ Mapé¢„åˆ†é…</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">buildIndex</span><span class="hljs-params">(items []Item)</span></span> <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]Item &#123;<br>    index := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]Item, <span class="hljs-built_in">len</span>(items)) <span class="hljs-comment">// é¢„åˆ†é…å®¹é‡</span><br>    <span class="hljs-keyword">for</span> _, item := <span class="hljs-keyword">range</span> items &#123;<br>        index[item.Key] = item<br>    &#125;<br>    <span class="hljs-keyword">return</span> index<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="3-å­—ç¬¦ä¸²æ„å»ºä¼˜åŒ–"><a href="#3-å­—ç¬¦ä¸²æ„å»ºä¼˜åŒ–" class="headerlink" title="3. å­—ç¬¦ä¸²æ„å»ºä¼˜åŒ–"></a>3. å­—ç¬¦ä¸²æ„å»ºä¼˜åŒ–</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// âœ… é«˜æ•ˆï¼šä½¿ç”¨strings.Builder</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">buildMessage</span><span class="hljs-params">(parts []<span class="hljs-type">string</span>)</span></span> <span class="hljs-type">string</span> &#123;<br>    <span class="hljs-keyword">var</span> builder strings.Builder<br>    builder.Grow(estimateSize(parts)) <span class="hljs-comment">// é¢„åˆ†é…å®¹é‡</span><br>    <br>    <span class="hljs-keyword">for</span> _, part := <span class="hljs-keyword">range</span> parts &#123;<br>        builder.WriteString(part)<br>    &#125;<br>    <span class="hljs-keyword">return</span> builder.String()<br>&#125;<br><br><span class="hljs-comment">// âŒ ä½æ•ˆï¼šå­—ç¬¦ä¸²æ‹¼æ¥</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">buildMessageBad</span><span class="hljs-params">(parts []<span class="hljs-type">string</span>)</span></span> <span class="hljs-type">string</span> &#123;<br>    <span class="hljs-keyword">var</span> result <span class="hljs-type">string</span><br>    <span class="hljs-keyword">for</span> _, part := <span class="hljs-keyword">range</span> parts &#123;<br>        result += part <span class="hljs-comment">// æ¯æ¬¡æ‹¼æ¥éƒ½ä¼šåˆ†é…æ–°å†…å­˜</span><br>    &#125;<br>    <span class="hljs-keyword">return</span> result<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="4-Goroutineæ•°é‡æ§åˆ¶"><a href="#4-Goroutineæ•°é‡æ§åˆ¶" class="headerlink" title="4. Goroutineæ•°é‡æ§åˆ¶"></a>4. Goroutineæ•°é‡æ§åˆ¶</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// å·¥ä½œæ± æ¨¡å¼ï¼šæ§åˆ¶å¹¶å‘æ•°é‡</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">processWithWorkerPool</span><span class="hljs-params">(tasks &lt;-<span class="hljs-keyword">chan</span> Task, results <span class="hljs-keyword">chan</span>&lt;- Result)</span></span> &#123;<br>    <span class="hljs-keyword">const</span> maxWorkers = runtime.NumCPU()<br>    sem := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>&#123;&#125;, maxWorkers)<br>    <br>    <span class="hljs-keyword">var</span> wg sync.WaitGroup<br>    <span class="hljs-keyword">for</span> task := <span class="hljs-keyword">range</span> tasks &#123;<br>        wg.Add(<span class="hljs-number">1</span>)<br>        <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(t Task)</span></span> &#123;<br>            <span class="hljs-keyword">defer</span> wg.Done()<br>            sem &lt;- <span class="hljs-keyword">struct</span>&#123;&#125;&#123;&#125; <span class="hljs-comment">// è·å–ä¿¡å·é‡</span><br>            <span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123; &lt;-sem &#125;() <span class="hljs-comment">// é‡Šæ”¾ä¿¡å·é‡</span><br>            <br>            result := processTask(t)<br>            results &lt;- result<br>        &#125;(task)<br>    &#125;<br>    wg.Wait()<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>Goroutineå¼€é”€</strong>ï¼š</p><ul><li>æ¯ä¸ªgoroutineæ ˆç©ºé—´ï¼š2KBèµ·å§‹</li><li>GCæ‰«ææˆæœ¬ï¼šä¸goroutineæ•°é‡æˆæ­£æ¯”</li><li>è°ƒåº¦å¼€é”€ï¼šè¿‡å¤šgoroutineå½±å“è°ƒåº¦æ•ˆç‡</li></ul><h3 id="5-æ€§èƒ½æµ‹è¯•éªŒè¯"><a href="#5-æ€§èƒ½æµ‹è¯•éªŒè¯" class="headerlink" title="5. æ€§èƒ½æµ‹è¯•éªŒè¯"></a>5. æ€§èƒ½æµ‹è¯•éªŒè¯</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// å†…å­˜åˆ†é…æ€§èƒ½åŸºå‡†æµ‹è¯•</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">BenchmarkStringBuilding</span><span class="hljs-params">(b *testing.B)</span></span> &#123;<br>    parts := []<span class="hljs-type">string</span>&#123;<span class="hljs-string">&quot;hello&quot;</span>, <span class="hljs-string">&quot; &quot;</span>, <span class="hljs-string">&quot;world&quot;</span>, <span class="hljs-string">&quot;!&quot;</span>&#125;<br>    <br>    b.Run(<span class="hljs-string">&quot;StringBuilder&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(b *testing.B)</span></span> &#123;<br>        b.ReportAllocs()<br>        <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; b.N; i++ &#123;<br>            buildMessage(parts)<br>        &#125;<br>    &#125;)<br>    <br>    b.Run(<span class="hljs-string">&quot;StringConcat&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(b *testing.B)</span></span> &#123;<br>        b.ReportAllocs()<br>        <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; b.N; i++ &#123;<br>            buildMessageBad(parts)<br>        &#125;<br>    &#125;)<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="å®æˆ˜æ€§èƒ½ä¼˜åŒ–æ¡ˆä¾‹"><a href="#å®æˆ˜æ€§èƒ½ä¼˜åŒ–æ¡ˆä¾‹" class="headerlink" title="å®æˆ˜æ€§èƒ½ä¼˜åŒ–æ¡ˆä¾‹"></a>å®æˆ˜æ€§èƒ½ä¼˜åŒ–æ¡ˆä¾‹</h2><h3 id="æ¡ˆä¾‹1ï¼šHTTPæœåŠ¡å†…å­˜åˆ†é…ä¼˜åŒ–"><a href="#æ¡ˆä¾‹1ï¼šHTTPæœåŠ¡å†…å­˜åˆ†é…ä¼˜åŒ–" class="headerlink" title="æ¡ˆä¾‹1ï¼šHTTPæœåŠ¡å†…å­˜åˆ†é…ä¼˜åŒ–"></a>æ¡ˆä¾‹1ï¼šHTTPæœåŠ¡å†…å­˜åˆ†é…ä¼˜åŒ–</h3><p><strong>æµ‹è¯•åœºæ™¯</strong>ï¼šæ¨¡æ‹Ÿé«˜å¹¶å‘HTTPæœåŠ¡å¤„ç†è¯·æ±‚çš„å†…å­˜åˆ†é…é—®é¢˜</p><p><strong>å®Œæ•´æµ‹è¯•ä»£ç </strong>ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br>    <span class="hljs-string">&quot;bytes&quot;</span><br>    <span class="hljs-string">&quot;fmt&quot;</span><br>    <span class="hljs-string">&quot;runtime&quot;</span><br>    <span class="hljs-string">&quot;runtime/debug&quot;</span><br>    <span class="hljs-string">&quot;sync&quot;</span><br>    <span class="hljs-string">&quot;time&quot;</span><br>)<br><br><span class="hljs-comment">// æ¨¡æ‹Ÿè¯·æ±‚å¤„ç†</span><br><span class="hljs-keyword">type</span> Request <span class="hljs-keyword">struct</span> &#123;<br>    ID   <span class="hljs-type">int</span><br>    Data []<span class="hljs-type">byte</span><br>&#125;<br><br><span class="hljs-keyword">type</span> Response <span class="hljs-keyword">struct</span> &#123;<br>    ID     <span class="hljs-type">int</span><br>    Result <span class="hljs-type">string</span><br>    Buffer *bytes.Buffer<br>&#125;<br><br><span class="hljs-comment">// ç‰ˆæœ¬1ï¼šæœªä¼˜åŒ–ç‰ˆæœ¬ - é¢‘ç¹å†…å­˜åˆ†é…</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">processRequestV1</span><span class="hljs-params">(req Request)</span></span> Response &#123;<br>    <span class="hljs-comment">// æ¯æ¬¡éƒ½åˆ›å»ºæ–°çš„bufferå’Œå­—ç¬¦ä¸²</span><br>    buffer := &amp;bytes.Buffer&#123;&#125;<br>    buffer.WriteString(<span class="hljs-string">&quot;Processing request &quot;</span>)<br>    buffer.WriteString(fmt.Sprintf(<span class="hljs-string">&quot;%d&quot;</span>, req.ID))<br>    buffer.Write(req.Data)<br>    <br>    result := fmt.Sprintf(<span class="hljs-string">&quot;Response for request %d&quot;</span>, req.ID)<br>    <br>    <span class="hljs-keyword">return</span> Response&#123;<br>        ID:     req.ID,<br>        Result: result,<br>        Buffer: buffer,<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// ç‰ˆæœ¬2ï¼šä¼˜åŒ–ç‰ˆæœ¬ - å¯¹è±¡æ± å¤ç”¨</span><br><span class="hljs-keyword">var</span> bufferPool = sync.Pool&#123;<br>    New: <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> <span class="hljs-keyword">interface</span>&#123;&#125; &#123;<br>        <span class="hljs-keyword">return</span> &amp;bytes.Buffer&#123;&#125;<br>    &#125;,<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">processRequestV2</span><span class="hljs-params">(req Request)</span></span> Response &#123;<br>    <span class="hljs-comment">// ä»å¯¹è±¡æ± è·å–buffer</span><br>    buffer := bufferPool.Get().(*bytes.Buffer)<br>    buffer.Reset() <span class="hljs-comment">// æ¸…ç©ºå†…å®¹ï¼Œä½†ä¿ç•™å®¹é‡</span><br>    <br>    buffer.WriteString(<span class="hljs-string">&quot;Processing request &quot;</span>)<br>    buffer.WriteString(fmt.Sprintf(<span class="hljs-string">&quot;%d&quot;</span>, req.ID))<br>    buffer.Write(req.Data)<br>    <br>    result := fmt.Sprintf(<span class="hljs-string">&quot;Response for request %d&quot;</span>, req.ID)<br>    <br>    <span class="hljs-comment">// ä½¿ç”¨å®Œåæ”¾å›æ± ä¸­</span><br>    <span class="hljs-keyword">defer</span> bufferPool.Put(buffer)<br>    <br>    <span class="hljs-keyword">return</span> Response&#123;<br>        ID:     req.ID,<br>        Result: result,<br>        Buffer: buffer,<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// åŸºå‡†æµ‹è¯•å‡½æ•°</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">runBenchmark</span><span class="hljs-params">(name <span class="hljs-type">string</span>, processFunc <span class="hljs-keyword">func</span>(Request)</span></span> Response, requests []Request) &#123;<br>    fmt.Printf(<span class="hljs-string">&quot;\n=== %s ===\n&quot;</span>, name)<br>    <br>    <span class="hljs-comment">// è®°å½•å¼€å§‹çŠ¶æ€</span><br>    <span class="hljs-keyword">var</span> startMem runtime.MemStats<br>    runtime.ReadMemStats(&amp;startMem)<br>    runtime.GC() <span class="hljs-comment">// å¼ºåˆ¶GCï¼Œæ¸…ç†åŸºçº¿</span><br>    runtime.ReadMemStats(&amp;startMem)<br>    <br>    startTime := time.Now()<br>    startGC := startMem.NumGC<br>    <br>    <span class="hljs-comment">// æ¨¡æ‹Ÿå¹¶å‘å¤„ç†</span><br>    <span class="hljs-keyword">const</span> workers = <span class="hljs-number">100</span><br>    ch := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> Request, <span class="hljs-built_in">len</span>(requests))<br>    <span class="hljs-keyword">var</span> wg sync.WaitGroup<br>    <br>    <span class="hljs-comment">// å‘é€ä»»åŠ¡</span><br>    <span class="hljs-keyword">for</span> _, req := <span class="hljs-keyword">range</span> requests &#123;<br>        ch &lt;- req<br>    &#125;<br>    <span class="hljs-built_in">close</span>(ch)<br>    <br>    <span class="hljs-comment">// å¯åŠ¨workerå¤„ç†</span><br>    wg.Add(workers)<br>    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; workers; i++ &#123;<br>        <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>            <span class="hljs-keyword">defer</span> wg.Done()<br>            <span class="hljs-keyword">for</span> req := <span class="hljs-keyword">range</span> ch &#123;<br>                _ = processFunc(req)<br>            &#125;<br>        &#125;()<br>    &#125;<br>    <br>    wg.Wait()<br>    duration := time.Since(startTime)<br>    <br>    <span class="hljs-comment">// è®°å½•ç»“æŸçŠ¶æ€</span><br>    <span class="hljs-keyword">var</span> endMem runtime.MemStats<br>    runtime.ReadMemStats(&amp;endMem)<br>    <br>    <span class="hljs-comment">// è¾“å‡ºæ€§èƒ½æŒ‡æ ‡</span><br>    fmt.Printf(<span class="hljs-string">&quot;å¤„ç†æ—¶é—´: %v\n&quot;</span>, duration)<br>    fmt.Printf(<span class="hljs-string">&quot;å¤„ç†é€Ÿç‡: %.0f req/s\n&quot;</span>, <span class="hljs-type">float64</span>(<span class="hljs-built_in">len</span>(requests))/duration.Seconds())<br>    fmt.Printf(<span class="hljs-string">&quot;å†…å­˜åˆ†é…: %d bytes\n&quot;</span>, endMem.TotalAlloc-startMem.TotalAlloc)<br>    fmt.Printf(<span class="hljs-string">&quot;åˆ†é…æ¬¡æ•°: %d\n&quot;</span>, endMem.Mallocs-startMem.Mallocs)<br>    fmt.Printf(<span class="hljs-string">&quot;GCæ¬¡æ•°: %d\n&quot;</span>, endMem.NumGC-startGC)<br>    fmt.Printf(<span class="hljs-string">&quot;GCè€—æ—¶: %v\n&quot;</span>, time.Duration(endMem.PauseTotalNs-startMem.PauseTotalNs))<br>    fmt.Printf(<span class="hljs-string">&quot;å †å†…å­˜ä½¿ç”¨: %.2f MB\n&quot;</span>, <span class="hljs-type">float64</span>(endMem.HeapInuse)/<span class="hljs-number">1024</span>/<span class="hljs-number">1024</span>)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    <span class="hljs-comment">// ç”Ÿæˆæµ‹è¯•æ•°æ®</span><br>    requests := <span class="hljs-built_in">make</span>([]Request, <span class="hljs-number">50000</span>)<br>    <span class="hljs-keyword">for</span> i := <span class="hljs-keyword">range</span> requests &#123;<br>        requests[i] = Request&#123;<br>            ID:   i,<br>            Data: <span class="hljs-built_in">make</span>([]<span class="hljs-type">byte</span>, <span class="hljs-number">1024</span>), <span class="hljs-comment">// 1KBæ•°æ®</span><br>        &#125;<br>    &#125;<br>    <br>    fmt.Println(<span class="hljs-string">&quot;Go GC ä¼˜åŒ–æ•ˆæœå¯¹æ¯”æµ‹è¯•&quot;</span>)<br>    fmt.Printf(<span class="hljs-string">&quot;æµ‹è¯•æ•°æ®: %dä¸ªè¯·æ±‚ï¼Œæ¯ä¸ª1KB\n&quot;</span>, <span class="hljs-built_in">len</span>(requests))<br>    fmt.Printf(<span class="hljs-string">&quot;Goç‰ˆæœ¬: %s\n&quot;</span>, runtime.Version())<br>    fmt.Printf(<span class="hljs-string">&quot;GOGC: %d\n&quot;</span>, debug.SetGCPercent(<span class="hljs-number">-1</span>))<br>    debug.SetGCPercent(<span class="hljs-number">100</span>) <span class="hljs-comment">// æ¢å¤é»˜è®¤å€¼</span><br>    <br>    <span class="hljs-comment">// æµ‹è¯•æœªä¼˜åŒ–ç‰ˆæœ¬</span><br>    runBenchmark(<span class="hljs-string">&quot;æœªä¼˜åŒ–ç‰ˆæœ¬ï¼ˆé¢‘ç¹åˆ†é…ï¼‰&quot;</span>, processRequestV1, requests)<br>    <br>    <span class="hljs-comment">// ç¨ç­‰ç‰‡åˆ»ï¼Œè®©GCå®Œæˆ</span><br>    time.Sleep(<span class="hljs-number">100</span> * time.Millisecond)<br>    runtime.GC()<br>    <br>    <span class="hljs-comment">// æµ‹è¯•ä¼˜åŒ–ç‰ˆæœ¬</span><br>    runBenchmark(<span class="hljs-string">&quot;ä¼˜åŒ–ç‰ˆæœ¬ï¼ˆå¯¹è±¡æ± å¤ç”¨ï¼‰&quot;</span>, processRequestV2, requests)<br>    <br>    fmt.Println(<span class="hljs-string">&quot;\n=== GOGCè°ƒä¼˜æµ‹è¯• ===&quot;</span>)<br>    <br>    <span class="hljs-comment">// æµ‹è¯•ä¸åŒGOGCå€¼çš„å½±å“</span><br>    gogcValues := []<span class="hljs-type">int</span>&#123;<span class="hljs-number">50</span>, <span class="hljs-number">100</span>, <span class="hljs-number">200</span>, <span class="hljs-number">400</span>&#125;<br>    <span class="hljs-keyword">for</span> _, gogc := <span class="hljs-keyword">range</span> gogcValues &#123;<br>        fmt.Printf(<span class="hljs-string">&quot;\n--- GOGC=%d ---\n&quot;</span>, gogc)<br>        debug.SetGCPercent(gogc)<br>        <br>        <span class="hljs-keyword">var</span> m1, m2 runtime.MemStats<br>        runtime.ReadMemStats(&amp;m1)<br>        runtime.GC()<br>        <br>        start := time.Now()<br>        runBenchmark(fmt.Sprintf(<span class="hljs-string">&quot;GOGC=%d&quot;</span>, gogc), processRequestV2, requests[:<span class="hljs-number">10000</span>])<br>        duration := time.Since(start)<br>        <br>        runtime.ReadMemStats(&amp;m2)<br>        fmt.Printf(<span class="hljs-string">&quot;æ€»è€—æ—¶: %v, GCæ¬¡æ•°: %d\n&quot;</span>, duration, m2.NumGC-m1.NumGC)<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>è¿è¡Œæ–¹æ³•</strong>ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># ä¿å­˜ä¸º gc_benchmark.go</span><br>go run gc_benchmark.go<br><br><span class="hljs-comment"># æˆ–è€…ç¼–è¯‘åè¿è¡Œï¼ŒæŸ¥çœ‹æ›´è¯¦ç»†çš„GCä¿¡æ¯</span><br>go build -o gc_benchmark gc_benchmark.go<br>GODEBUG=gctrace=1 ./gc_benchmark<br></code></pre></td></tr></table></figure><p><strong>é¢„æœŸè§‚å¯Ÿç»“æœ</strong>ï¼š</p><ul><li>å¯¹è±¡æ± ç‰ˆæœ¬çš„å†…å­˜åˆ†é…æ¬¡æ•°å¤§å¹…å‡å°‘</li><li>GCé¢‘ç‡å’Œè€—æ—¶æ˜æ˜¾é™ä½  </li><li>ä¸åŒGOGCå€¼å¯¹GCé¢‘ç‡çš„å½±å“</li><li>é«˜GOGCå€¼å‡å°‘GCæ¬¡æ•°ä½†å¢åŠ å†…å­˜ä½¿ç”¨</li></ul><h3 id="æ¡ˆä¾‹2ï¼šJSONæ•°æ®æµå¼å¤„ç†ä¼˜åŒ–"><a href="#æ¡ˆä¾‹2ï¼šJSONæ•°æ®æµå¼å¤„ç†ä¼˜åŒ–" class="headerlink" title="æ¡ˆä¾‹2ï¼šJSONæ•°æ®æµå¼å¤„ç†ä¼˜åŒ–"></a>æ¡ˆä¾‹2ï¼šJSONæ•°æ®æµå¼å¤„ç†ä¼˜åŒ–</h3><p><strong>æµ‹è¯•åœºæ™¯</strong>ï¼šå¯¹æ¯”å…¨é‡è§£ævsæµå¼è§£æJSONæ•°æ®çš„å†…å­˜ä½¿ç”¨å·®å¼‚</p><p><strong>å®Œæ•´æµ‹è¯•ä»£ç </strong>ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br>    <span class="hljs-string">&quot;encoding/json&quot;</span><br>    <span class="hljs-string">&quot;fmt&quot;</span><br>    <span class="hljs-string">&quot;runtime&quot;</span><br>    <span class="hljs-string">&quot;strings&quot;</span><br>    <span class="hljs-string">&quot;time&quot;</span><br>)<br><br><span class="hljs-comment">// æ¨¡æ‹Ÿæ—¥å¿—è®°å½•ç»“æ„</span><br><span class="hljs-keyword">type</span> LogRecord <span class="hljs-keyword">struct</span> &#123;<br>    Timestamp <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;timestamp&quot;`</span><br>    Level     <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;level&quot;`</span><br>    Message   <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;message&quot;`</span><br>    UserID    <span class="hljs-type">int</span>    <span class="hljs-string">`json:&quot;user_id&quot;`</span><br>    RequestID <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;request_id&quot;`</span><br>&#125;<br><br><span class="hljs-comment">// ç”Ÿæˆæµ‹è¯•JSONæ•°æ®</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">generateTestJSON</span><span class="hljs-params">(recordCount <span class="hljs-type">int</span>)</span></span> []<span class="hljs-type">byte</span> &#123;<br>    <span class="hljs-keyword">var</span> builder strings.Builder<br>    builder.WriteString(<span class="hljs-string">`&#123;&quot;logs&quot;:[`</span>)<br>    <br>    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; recordCount; i++ &#123;<br>        <span class="hljs-keyword">if</span> i &gt; <span class="hljs-number">0</span> &#123;<br>            builder.WriteString(<span class="hljs-string">&quot;,&quot;</span>)<br>        &#125;<br>        <br>        record := LogRecord&#123;<br>            Timestamp: <span class="hljs-string">&quot;2023-07-08T10:30:00Z&quot;</span>,<br>            Level:     <span class="hljs-string">&quot;INFO&quot;</span>,<br>            Message:   fmt.Sprintf(<span class="hljs-string">&quot;ç”¨æˆ·æ“ä½œæ—¥å¿—è®°å½• %dï¼ŒåŒ…å«ä¸€äº›è¾ƒé•¿çš„æè¿°ä¿¡æ¯æ¥æ¨¡æ‹ŸçœŸå®åœºæ™¯&quot;</span>, i),<br>            UserID:    i % <span class="hljs-number">10000</span>,<br>            RequestID: fmt.Sprintf(<span class="hljs-string">&quot;req_%d_%d&quot;</span>, i, time.Now().UnixNano()),<br>        &#125;<br>        <br>        data, _ := json.Marshal(record)<br>        builder.Write(data)<br>    &#125;<br>    <br>    builder.WriteString(<span class="hljs-string">`]&#125;`</span>)<br>    <span class="hljs-keyword">return</span> []<span class="hljs-type">byte</span>(builder.String())<br>&#125;<br><br><span class="hljs-comment">// æ–¹æ³•1ï¼šå…¨é‡è§£æ - å†…å­˜å¯†é›†å‹</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">processJSONFullLoad</span><span class="hljs-params">(data []<span class="hljs-type">byte</span>)</span></span> (<span class="hljs-type">int</span>, <span class="hljs-type">error</span>) &#123;<br>    <span class="hljs-keyword">var</span> result <span class="hljs-keyword">struct</span> &#123;<br>        Logs []LogRecord <span class="hljs-string">`json:&quot;logs&quot;`</span><br>    &#125;<br>    <br>    <span class="hljs-comment">// ä¸€æ¬¡æ€§è§£ææ‰€æœ‰æ•°æ®åˆ°å†…å­˜</span><br>    <span class="hljs-keyword">if</span> err := json.Unmarshal(data, &amp;result); err != <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>, err<br>    &#125;<br>    <br>    <span class="hljs-comment">// æ¨¡æ‹Ÿå¤„ç†é€»è¾‘</span><br>    count := <span class="hljs-number">0</span><br>    <span class="hljs-keyword">for</span> _, record := <span class="hljs-keyword">range</span> result.Logs &#123;<br>        <span class="hljs-comment">// ç®€å•çš„è¿‡æ»¤é€»è¾‘</span><br>        <span class="hljs-keyword">if</span> record.Level == <span class="hljs-string">&quot;INFO&quot;</span> &amp;&amp; record.UserID &lt; <span class="hljs-number">5000</span> &#123;<br>            count++<br>        &#125;<br>    &#125;<br>    <br>    <span class="hljs-keyword">return</span> count, <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-comment">// æ–¹æ³•2ï¼šæµå¼è§£æ - å†…å­˜å‹å¥½å‹</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">processJSONStream</span><span class="hljs-params">(data []<span class="hljs-type">byte</span>)</span></span> (<span class="hljs-type">int</span>, <span class="hljs-type">error</span>) &#123;<br>    decoder := json.NewDecoder(strings.NewReader(<span class="hljs-type">string</span>(data)))<br>    <br>    <span class="hljs-comment">// è¯»å–å¼€å§‹çš„ &#123;</span><br>    <span class="hljs-keyword">if</span> _, err := decoder.Token(); err != <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>, err<br>    &#125;<br>    <br>    <span class="hljs-comment">// å¯»æ‰¾ &quot;logs&quot; å­—æ®µ</span><br>    <span class="hljs-keyword">for</span> decoder.More() &#123;<br>        key, err := decoder.Token()<br>        <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>, err<br>        &#125;<br>        <br>        <span class="hljs-keyword">if</span> key == <span class="hljs-string">&quot;logs&quot;</span> &#123;<br>            <span class="hljs-keyword">return</span> processLogsArray(decoder)<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">// è·³è¿‡å…¶ä»–å­—æ®µ</span><br>            <span class="hljs-keyword">if</span> err := decoder.Skip(); err != <span class="hljs-literal">nil</span> &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>, err<br>            &#125;<br>        &#125;<br>    &#125;<br>    <br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>, <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">processLogsArray</span><span class="hljs-params">(decoder *json.Decoder)</span></span> (<span class="hljs-type">int</span>, <span class="hljs-type">error</span>) &#123;<br>    <span class="hljs-comment">// è¯»å–æ•°ç»„å¼€å§‹çš„ [</span><br>    <span class="hljs-keyword">if</span> _, err := decoder.Token(); err != <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>, err<br>    &#125;<br>    <br>    count := <span class="hljs-number">0</span><br>    batchSize := <span class="hljs-number">100</span><br>    batch := <span class="hljs-built_in">make</span>([]LogRecord, <span class="hljs-number">0</span>, batchSize)<br>    <br>    <span class="hljs-comment">// é€ä¸ªè§£ææ•°ç»„å…ƒç´ </span><br>    <span class="hljs-keyword">for</span> decoder.More() &#123;<br>        <span class="hljs-keyword">var</span> record LogRecord<br>        <span class="hljs-keyword">if</span> err := decoder.Decode(&amp;record); err != <span class="hljs-literal">nil</span> &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>, err<br>        &#125;<br>        <br>        batch = <span class="hljs-built_in">append</span>(batch, record)<br>        <br>        <span class="hljs-comment">// è¾¾åˆ°æ‰¹æ¬¡å¤§å°æ—¶å¤„ç†</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(batch) &gt;= batchSize &#123;<br>            count += processBatch(batch)<br>            batch = batch[:<span class="hljs-number">0</span>] <span class="hljs-comment">// é‡ç½®åˆ‡ç‰‡ï¼Œå¤ç”¨åº•å±‚æ•°ç»„</span><br>        &#125;<br>    &#125;<br>    <br>    <span class="hljs-comment">// å¤„ç†å‰©ä½™è®°å½•</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(batch) &gt; <span class="hljs-number">0</span> &#123;<br>        count += processBatch(batch)<br>    &#125;<br>    <br>    <span class="hljs-keyword">return</span> count, <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">processBatch</span><span class="hljs-params">(records []LogRecord)</span></span> <span class="hljs-type">int</span> &#123;<br>    count := <span class="hljs-number">0</span><br>    <span class="hljs-keyword">for</span> _, record := <span class="hljs-keyword">range</span> records &#123;<br>        <span class="hljs-keyword">if</span> record.Level == <span class="hljs-string">&quot;INFO&quot;</span> &amp;&amp; record.UserID &lt; <span class="hljs-number">5000</span> &#123;<br>            count++<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> count<br>&#125;<br><br><span class="hljs-comment">// å†…å­˜ç›‘æ§å‡½æ•°</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">measureMemoryUsage</span><span class="hljs-params">(name <span class="hljs-type">string</span>, fn <span class="hljs-keyword">func</span>()</span></span> (<span class="hljs-type">int</span>, <span class="hljs-type">error</span>)) &#123;<br>    fmt.Printf(<span class="hljs-string">&quot;\n=== %s ===\n&quot;</span>, name)<br>    <br>    <span class="hljs-comment">// å¼ºåˆ¶GCï¼Œè·å–å‡†ç¡®çš„åŸºçº¿</span><br>    runtime.GC()<br>    <span class="hljs-keyword">var</span> startMem runtime.MemStats<br>    runtime.ReadMemStats(&amp;startMem)<br>    <br>    startTime := time.Now()<br>    result, err := fn()<br>    duration := time.Since(startTime)<br>    <br>    <span class="hljs-keyword">var</span> endMem runtime.MemStats<br>    runtime.ReadMemStats(&amp;endMem)<br>    <br>    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>        fmt.Printf(<span class="hljs-string">&quot;æ‰§è¡Œå‡ºé”™: %v\n&quot;</span>, err)<br>        <span class="hljs-keyword">return</span><br>    &#125;<br>    <br>    fmt.Printf(<span class="hljs-string">&quot;å¤„ç†ç»“æœ: %d æ¡è®°å½•\n&quot;</span>, result)<br>    fmt.Printf(<span class="hljs-string">&quot;æ‰§è¡Œæ—¶é—´: %v\n&quot;</span>, duration)<br>    fmt.Printf(<span class="hljs-string">&quot;å†…å­˜åˆ†é…: %.2f MB\n&quot;</span>, <span class="hljs-type">float64</span>(endMem.TotalAlloc-startMem.TotalAlloc)/<span class="hljs-number">1024</span>/<span class="hljs-number">1024</span>)<br>    fmt.Printf(<span class="hljs-string">&quot;åˆ†é…æ¬¡æ•°: %d\n&quot;</span>, endMem.Mallocs-startMem.Mallocs)<br>    fmt.Printf(<span class="hljs-string">&quot;GCæ¬¡æ•°: %d\n&quot;</span>, endMem.NumGC-startMem.NumGC)<br>    fmt.Printf(<span class="hljs-string">&quot;å³°å€¼å †å†…å­˜: %.2f MB\n&quot;</span>, <span class="hljs-type">float64</span>(endMem.HeapInuse)/<span class="hljs-number">1024</span>/<span class="hljs-number">1024</span>)<br>    <br>    <span class="hljs-keyword">if</span> endMem.NumGC &gt; startMem.NumGC &#123;<br>        avgPause := time.Duration(endMem.PauseTotalNs-startMem.PauseTotalNs) / <br>                   time.Duration(endMem.NumGC-startMem.NumGC)<br>        fmt.Printf(<span class="hljs-string">&quot;å¹³å‡GCåœé¡¿: %v\n&quot;</span>, avgPause)<br>    &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    fmt.Println(<span class="hljs-string">&quot;JSONå¤„ç†æ–¹å¼å†…å­˜å¯¹æ¯”æµ‹è¯•&quot;</span>)<br>    fmt.Printf(<span class="hljs-string">&quot;Goç‰ˆæœ¬: %s\n&quot;</span>, runtime.Version())<br>    <br>    <span class="hljs-comment">// ç”Ÿæˆä¸åŒå¤§å°çš„æµ‹è¯•æ•°æ®</span><br>    testSizes := []<span class="hljs-type">int</span>&#123;<span class="hljs-number">1000</span>, <span class="hljs-number">10000</span>, <span class="hljs-number">50000</span>&#125;<br>    <br>    <span class="hljs-keyword">for</span> _, size := <span class="hljs-keyword">range</span> testSizes &#123;<br>        fmt.Printf(<span class="hljs-string">&quot;\n&quot;</span> + strings.Repeat(<span class="hljs-string">&quot;=&quot;</span>, <span class="hljs-number">50</span>))<br>        fmt.Printf(<span class="hljs-string">&quot;\næµ‹è¯•æ•°æ®è§„æ¨¡: %d æ¡è®°å½•\n&quot;</span>, size)<br>        <br>        <span class="hljs-comment">// ç”Ÿæˆæµ‹è¯•æ•°æ®</span><br>        testData := generateTestJSON(size)<br>        fmt.Printf(<span class="hljs-string">&quot;JSONæ–‡ä»¶å¤§å°: %.2f MB\n&quot;</span>, <span class="hljs-type">float64</span>(<span class="hljs-built_in">len</span>(testData))/<span class="hljs-number">1024</span>/<span class="hljs-number">1024</span>)<br>        <br>        <span class="hljs-comment">// æµ‹è¯•å…¨é‡è§£æ</span><br>        measureMemoryUsage(<span class="hljs-string">&quot;å…¨é‡è§£ææ–¹å¼&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> (<span class="hljs-type">int</span>, <span class="hljs-type">error</span>) &#123;<br>            <span class="hljs-keyword">return</span> processJSONFullLoad(testData)<br>        &#125;)<br>        <br>        <span class="hljs-comment">// ç¨ç­‰è®©GCå®Œæˆ</span><br>        time.Sleep(<span class="hljs-number">100</span> * time.Millisecond)<br>        runtime.GC()<br>        <br>        <span class="hljs-comment">// æµ‹è¯•æµå¼è§£æ</span><br>        measureMemoryUsage(<span class="hljs-string">&quot;æµå¼è§£ææ–¹å¼&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> (<span class="hljs-type">int</span>, <span class="hljs-type">error</span>) &#123;<br>            <span class="hljs-keyword">return</span> processJSONStream(testData)<br>        &#125;)<br>    &#125;<br>    <br>    fmt.Println(<span class="hljs-string">&quot;\n&quot;</span> + strings.Repeat(<span class="hljs-string">&quot;=&quot;</span>, <span class="hljs-number">50</span>))<br>    fmt.Println(<span class="hljs-string">&quot;æµ‹è¯•ç»“è®º:&quot;</span>)<br>    fmt.Println(<span class="hljs-string">&quot;1. æµå¼è§£æçš„å†…å­˜åˆ†é…æ˜æ˜¾å°‘äºå…¨é‡è§£æ&quot;</span>)<br>    fmt.Println(<span class="hljs-string">&quot;2. æ•°æ®è§„æ¨¡è¶Šå¤§ï¼Œå·®å¼‚è¶Šæ˜æ˜¾&quot;</span>)<br>    fmt.Println(<span class="hljs-string">&quot;3. æµå¼è§£æçš„GCå‹åŠ›æ›´å°&quot;</span>)<br>    fmt.Println(<span class="hljs-string">&quot;4. å³°å€¼å†…å­˜ä½¿ç”¨é‡å¤§å¹…é™ä½&quot;</span>)<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>è¿è¡Œæ–¹æ³•</strong>ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># ä¿å­˜ä¸º json_benchmark.go</span><br>go run json_benchmark.go<br><br><span class="hljs-comment"># æŸ¥çœ‹è¯¦ç»†çš„GCä¿¡æ¯</span><br>GODEBUG=gctrace=1 go run json_benchmark.go<br><br><span class="hljs-comment"># ç”Ÿæˆå†…å­˜profileåˆ†æ</span><br>go run json_benchmark.go -memprofile=mem.prof<br>go tool pprof mem.prof<br></code></pre></td></tr></table></figure><p><strong>é¢„æœŸè§‚å¯Ÿç»“æœ</strong>ï¼š</p><ul><li>æµå¼è§£æçš„å³°å€¼å†…å­˜ä½¿ç”¨é‡æ˜¾è‘—é™ä½</li><li>å†…å­˜åˆ†é…æ¬¡æ•°å¤§å¹…å‡å°‘</li><li>GCè§¦å‘é¢‘ç‡æ˜æ˜¾é™ä½</li><li>æ•°æ®è§„æ¨¡è¶Šå¤§ï¼Œä¼˜åŒ–æ•ˆæœè¶Šæ˜æ˜¾</li></ul><p><strong>ä¼˜åŒ–è¦ç‚¹æ€»ç»“</strong>ï¼š</p><ol><li><strong>é¿å…ä¸€æ¬¡æ€§åŠ è½½å¤§æ•°æ®</strong> - ä½¿ç”¨æµå¼å¤„ç†</li><li><strong>æ‰¹é‡å¤„ç† + å†…å­˜å¤ç”¨</strong> - æ§åˆ¶å†…å­˜å³°å€¼</li><li><strong>åŠæ—¶é‡Šæ”¾ä¸éœ€è¦çš„å¼•ç”¨</strong> - è®©GCèƒ½å›æ”¶å†…å­˜</li><li><strong>é€‰æ‹©åˆé€‚çš„æ•°æ®ç»“æ„</strong> - å‡å°‘ä¸å¿…è¦çš„interface{}ä½¿ç”¨</li></ol><h2 id="Go-GCæŠ€æœ¯å±•æœ›"><a href="#Go-GCæŠ€æœ¯å±•æœ›" class="headerlink" title="Go GCæŠ€æœ¯å±•æœ›"></a>Go GCæŠ€æœ¯å±•æœ›</h2><h3 id="å½“å‰æŒ‘æˆ˜"><a href="#å½“å‰æŒ‘æˆ˜" class="headerlink" title="å½“å‰æŒ‘æˆ˜"></a>å½“å‰æŒ‘æˆ˜</h3><ul><li><strong>å¤§å †é—®é¢˜</strong>ï¼šå †å†…å­˜&gt;100GBæ—¶ï¼Œæ ‡è®°é˜¶æ®µå»¶è¿Ÿæ˜¾è‘—</li><li><strong>é«˜åˆ†é…ç‡</strong>ï¼šåˆ†é…é€Ÿç‡è¶…è¿‡æ ‡è®°é€Ÿç‡æ—¶çš„é€€åŒ–å¤„ç†</li><li><strong>å®æ—¶æ€§è¦æ±‚</strong>ï¼šè¶…ä½å»¶è¿Ÿåœºæ™¯ï¼ˆ&lt;100Î¼sï¼‰çš„é€‚åº”æ€§</li></ul><h3 id="æœªæ¥å‘å±•æ–¹å‘"><a href="#æœªæ¥å‘å±•æ–¹å‘" class="headerlink" title="æœªæ¥å‘å±•æ–¹å‘"></a>æœªæ¥å‘å±•æ–¹å‘</h3><ul><li><strong>åˆ†ä»£GC</strong>ï¼šé’ˆå¯¹å¯¹è±¡ç”Ÿå‘½å‘¨æœŸçš„ä¼˜åŒ–</li><li><strong>å¢é‡GC</strong>ï¼šè¿›ä¸€æ­¥å‡å°‘å•æ¬¡GCå·¥ä½œé‡</li><li><strong>å¹¶è¡Œä¼˜åŒ–</strong>ï¼šæ›´å¥½çš„å¤šæ ¸æ‰©å±•æ€§</li><li><strong>ç”¨æˆ·æ€è°ƒåº¦</strong>ï¼šä¸goroutineè°ƒåº¦å™¨çš„æ·±åº¦é›†æˆ</li></ul><h2 id="æ‰©å±•é˜…è¯»"><a href="#æ‰©å±•é˜…è¯»" class="headerlink" title="æ‰©å±•é˜…è¯»"></a>æ‰©å±•é˜…è¯»</h2><ul><li><a href="https://golang.org/doc/gc-guide">Go GCå®˜æ–¹è®¾è®¡æ–‡æ¡£</a></li><li><a href="https://golang.org/ref/mem">The Go Memory Model</a></li><li><a href="https://draveness.me/golang/docs/part3-runtime/ch07-memory/golang-garbage-collector/">Goè¯­è¨€åƒåœ¾å›æ”¶å™¨åŸç†ä¸å®ç°</a></li></ul>]]></content>
    
    
    
    <tags>
      
      <tag>GO</tag>
      
      <tag>GC</tag>
      
      <tag>æ€§èƒ½ä¼˜åŒ–</tag>
      
      <tag>åƒåœ¾å›æ”¶</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>goå†…å­˜ä¼˜åŒ–åˆ†ææ€è·¯</title>
    <link href="/2022/12/18/go-mem-optimize-thought/"/>
    <url>/2022/12/18/go-mem-optimize-thought/</url>
    
    <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡å‡è®¾è¯»è€…äº†è§£Goå†…å­˜ç©ºé—´ã€å †æ ˆç­‰åŸºç¡€æ¦‚å¿µï¼Œè‹¥å…·å¤‡ä¸€å®šçš„goä½¿ç”¨ç»éªŒæœ€ä½³</p></blockquote><span id="more"></span><h1 id="ä¼˜åŒ–åŸåˆ™"><a href="#ä¼˜åŒ–åŸåˆ™" class="headerlink" title="ä¼˜åŒ–åŸåˆ™"></a>ä¼˜åŒ–åŸåˆ™</h1><ul><li>åˆ‡å‹¿è¿‡æ—©ä¼˜åŒ–</li><li>å–„ç”¨è¯­è¨€åˆ†æå·¥å…·</li></ul><h1 id="ä¼˜åŒ–æ€è·¯ï¼Ÿ"><a href="#ä¼˜åŒ–æ€è·¯ï¼Ÿ" class="headerlink" title="ä¼˜åŒ–æ€è·¯ï¼Ÿ"></a>ä¼˜åŒ–æ€è·¯ï¼Ÿ</h1><p>å†…å­˜ä¼˜åŒ–çš„ç›®æ ‡å°±æ˜¯æŠŠ<span style="color: red;">ä¸åˆç†çš„ã€å†—ä½™ã€ä½æ•ˆ</span>çš„å†…å­˜ä½¿ç”¨é€»è¾‘å˜æˆ<span style="color: green;">åˆç†ã€ç´§å‡‘ã€é«˜æ•ˆçš„</span></p><p>è€Œç¨‹åºä¸­ä½¿ç”¨åˆ°çš„å†…å­˜ä¸æ˜¯åœ¨å †ç©ºé—´å°±æ˜¯åœ¨æ ˆç©ºé—´ï¼Œå› æ­¤ä¼˜åŒ–çš„æ ¸å¿ƒå°±æ˜¯è¿™ä¿©ä¸ªå†…å­˜æ®µã€‚<br>goé’ˆå¯¹ä¸Šè¿°ä¸¤ç§æä¾›äº†å®Œæ•´çš„å·¥å…·é“¾ï¼Œæ¥å¸®åŠ©å¼€å‘è€…å®šä½å’Œåˆ†æå†…å­˜é—®é¢˜ï¼Œæœ€ç»ˆå†™å‡ºé«˜è´¨é‡ä»£ç ã€‚</p><ul><li>æ ˆç©ºé—´ï¼Œä½¿ç”¨ <code>go build -gcflags=&quot;-m -l&quot; åŒ…å&quot;</code> åˆ†æå†…å­˜é€ƒé€¸</li><li>å †ç©ºé—´ï¼Œä½¿ç”¨goè‡ªå¸¦çš„<code>pprof</code>åˆ†æç¨‹åºå †å†…å­˜ä½¿ç”¨æƒ…å†µã€‚</li></ul><h1 id="æ ˆç©ºé—´"><a href="#æ ˆç©ºé—´" class="headerlink" title="æ ˆç©ºé—´"></a>æ ˆç©ºé—´</h1><p>ä¼˜åŒ–æ€è·¯ï¼š å°½å¯èƒ½å°†å±€éƒ¨å˜é‡è¢«åˆ†é…åˆ°æ ˆç©ºé—´ï¼Œå‡è½»GCçš„æ‰«æå‹åŠ›ï¼Œå‡å°‘é€ƒé€¸çš„å±€éƒ¨å˜é‡ã€‚</p><h2 id="åˆ†æå·¥å…·"><a href="#åˆ†æå·¥å…·" class="headerlink" title="åˆ†æå·¥å…·"></a>åˆ†æå·¥å…·</h2><p>goåœ¨ç¼–è¯‘æ—¶é€šè¿‡<code>gcflags</code>åˆ†æç‰¹å®šåŒ…ä¸‹æ‰€æœ‰å‡½æ•°å˜é‡çš„é€ƒé€¸æƒ…å†µã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs go"># -l ç¦æ­¢ç¼–è¯‘å™¨å†…è”ä¼˜åŒ–<br><span class="hljs-keyword">go</span> build -gcflags=<span class="hljs-string">&quot;-m -l&quot;</span>  <span class="hljs-keyword">package</span><br></code></pre></td></tr></table></figure><h2 id="é€ƒé€¸åœºæ™¯"><a href="#é€ƒé€¸åœºæ™¯" class="headerlink" title="é€ƒé€¸åœºæ™¯"></a>é€ƒé€¸åœºæ™¯</h2><ul><li>å‡½æ•°å¤–å¼•ç”¨, return </li><li>å±€éƒ¨å˜é‡å¤ªå¤§</li><li>æŒ‡é’ˆç±»å‹</li><li>æ¥å£ç±»å‹ï¼Œç¼–è¯‘æ—¶æ— æ³•ç¡®å®šå¤§å°ï¼Œ</li><li>åå°„</li></ul><h2 id="å¸¸è§é€ƒé€¸ä¼˜åŒ–"><a href="#å¸¸è§é€ƒé€¸ä¼˜åŒ–" class="headerlink" title="å¸¸è§é€ƒé€¸ä¼˜åŒ–"></a>å¸¸è§é€ƒé€¸ä¼˜åŒ–</h2><ul><li>å±€éƒ¨å˜é‡slice&#x2F;mapï¼Œå°½é‡åœ¨ç¼–è¯‘é˜¶æ®µç¡®å®šå¤§å°(éä¾èµ–å¤–éƒ¨å‚æ•°åœºæ™¯)</li><li>å­—ç¬¦ä¸²æ‹¼æ¥ï¼Œä½¿ç”¨strings.Builder</li><li>æ…ç”¨ time.Format(). åº•å±‚ä¸­[]byteä¼šé€ƒé€¸ï¼Œä½¿ç”¨time.AppendFormat(ä½¿ç”¨å·²çŸ¥å¤§å°çš„byte)</li></ul><p>æ¨¡æ‹Ÿæ ‡å‡†åº“<code>time.Now.Format</code>ä¸ºä¾‹</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Format</span><span class="hljs-params">(layout <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">string</span> &#123;<br>    <span class="hljs-keyword">const</span> bufSize = <span class="hljs-number">64</span><br>    <span class="hljs-keyword">var</span> b []<span class="hljs-type">byte</span><br>    max := <span class="hljs-built_in">len</span>(layout) + <span class="hljs-number">10</span><br>    <span class="hljs-keyword">if</span> max &lt; bufSize &#123;<br>        <span class="hljs-keyword">var</span> buf [bufSize]<span class="hljs-type">byte</span><br>        b = buf[:<span class="hljs-number">0</span>]<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        b = <span class="hljs-built_in">make</span>([]<span class="hljs-type">byte</span>, <span class="hljs-number">0</span>, max)<br>    &#125;<br>    b = AppendFormat(b, layout) <span class="hljs-comment">//è¿™é‡Œç®€åŒ–ï¼Œåªä¸ºäº†è¯´æ˜bufå†…å­˜é€ƒé€¸</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-type">string</span>(b)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">AppendFormat</span><span class="hljs-params">(b []<span class="hljs-type">byte</span>, c <span class="hljs-type">string</span>)</span></span> []<span class="hljs-type">byte</span> &#123;<br>    <span class="hljs-keyword">return</span> []<span class="hljs-type">byte</span>&#123;&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ‰§è¡Œï¼šgo build -gcflags â€œ-m -lâ€ main.go</p><p><img src="/images/go_mem_escape.png" alt="go_mem_escape"></p><h1 id="å †ç©ºé—´"><a href="#å †ç©ºé—´" class="headerlink" title="å †ç©ºé—´"></a>å †ç©ºé—´</h1><h2 id="pprof"><a href="#pprof" class="headerlink" title="pprof"></a>pprof</h2><p>goæä¾›äº†å¼ºå¤§çš„æ€§èƒ½åˆ†æå·¥å…·pprofï¼Œé€šå¸¸ç”Ÿäº§ç¯å¢ƒä¼šä»¥æœåŠ¡çš„å½¢å¼æ‰“å¼€pprof, å¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤åˆ†æã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">go</span> tool pprof http:<span class="hljs-comment">//ç›®æ ‡æœºå™¨:ç«¯å£/debug/pprof/heap?seconds=é‡‡é›†å‘¨æœŸ</span><br><br># åˆ›å»ºæœ¬åœ°webæœåŠ¡ï¼Œè®¿é—®ç«ç„°å›¾<br><span class="hljs-keyword">go</span> tool pprof -http=:<span class="hljs-number">8884</span> pprofæ–‡ä»¶ <br></code></pre></td></tr></table></figure><p>ä¸Šè¿°ä¸¤è€…ä¹Ÿå¯ä»¥åˆå¹¶:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">go</span> tool pprof -http=:<span class="hljs-number">8884</span>  http:<span class="hljs-comment">//ç›®æ ‡æœºå™¨:ç«¯å£/debug/pprof/heap?seconds=é‡‡é›†å‘¨æœŸ</span><br></code></pre></td></tr></table></figure><h2 id="é—®é¢˜åˆ†ç±»"><a href="#é—®é¢˜åˆ†ç±»" class="headerlink" title="é—®é¢˜åˆ†ç±»"></a>é—®é¢˜åˆ†ç±»</h2><ol><li>å†…å­˜æ³„æ¼</li><li>GC-STWè€—æ—¶</li></ol><h3 id="å†…å­˜æ³„æ¼"><a href="#å†…å­˜æ³„æ¼" class="headerlink" title="å†…å­˜æ³„æ¼"></a>å†…å­˜æ³„æ¼</h3><ol><li>ä¸´æ—¶æ€§ (å¤§é‡ä¸´æ—¶å¯¹è±¡ï¼Œgcè¿˜æ²¡æ¥çš„å³æ¸…ç†ï¼Œå½±å“æ–°å¯¹è±¡çš„ç”³è¯·)</li><li>æ°¸ä¹…æ€§ (èµ„æºæœªå…³é—­&#x2F;é‡Šæ”¾, æ–‡ä»¶&#x2F;è¿æ¥æœªå…³é—­, åç¨‹æœªé‡Šæ”¾)</li></ol><h4 id="ä¸´æ—¶å¯¹è±¡æ³„æ¼"><a href="#ä¸´æ—¶å¯¹è±¡æ³„æ¼" class="headerlink" title="ä¸´æ—¶å¯¹è±¡æ³„æ¼"></a>ä¸´æ—¶å¯¹è±¡æ³„æ¼</h4><p>æ’æŸ¥æ€è·¯:</p><ol><li>pprof heap alloc_space ç¨‹åºå†…å­˜åˆ†é…æƒ…å†µã€‚(ä¸´æ—¶å¯¹è±¡çš„ä¼˜åŒ–) <figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs golang"><span class="hljs-keyword">go</span> tool pprof -alloc_space -http=:<span class="hljs-number">8088</span> http:<span class="hljs-comment">//ç›®æ ‡æœºå™¨:ç«¯å£/debug/pprof/heap?debug=1&amp;seconds=é‡‡é›†å‘¨æœŸ</span><br></code></pre></td></tr></table></figure></li></ol><p>å¸¸è§case:</p><ol><li>ä¸€æ¬¡æ€§ç”³è¯·ç©ºé—´, æ¯”å¦‚slice&#x2F;map, åˆå§‹åŒ–æ—¶ä¼ å…·ä½“å¤§å°å‚æ•°ï¼Œè§„é¿æ‰©å®¹(rehash&#x2F;growslice)é€»è¾‘ã€‚</li><li>ä½¿ç”¨å•ä¾‹æ¨¡å¼ã€‚ä¸€èˆ¬æœåŠ¡éƒ½æ˜¯åˆ†å±‚çš„ï¼Œå¦‚service&#x2F;daoç­‰ï¼Œé“¾è·¯ä¸­ä¼šNewXXXService, ä½¿ç”¨sync.Onceé¿å…åˆ›å»ºå¤§é‡ä¸´æ—¶å¯¹è±¡ã€‚</li><li>å»é™¤ä¸å¿…è¦çš„æ•°æ®ç»“æ„ã€‚ä¸€èˆ¬è¯»æ¥å£ä¼šæ¶‰åŠåˆ°ç»„è£…æ•°æ®ï¼Œé€šå¸¸ä¼šç”¨mapå­˜å‚¨æ˜ å°„æ•°æ®æ–¹ä¾¿å®šä½ï¼Œä¸è¿‡å¯ä»¥å»é™¤è¿™ä¸ªmapï¼Œç›´æ¥ç”¨sliceç´¢å¼•å®šä½æ•°æ®ï¼Œèƒ½çœä¸‹å¤§é‡çš„mapä¸´æ—¶å¯¹è±¡ã€‚</li></ol><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs go"><br>ä¼ªä»£ç <br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">getComments</span><span class="hljs-params">(commentIds []<span class="hljs-type">int</span>)</span></span> <span class="hljs-keyword">map</span>[<span class="hljs-type">int</span>]commentInfo &#123;<br>     <br>     []commentsInfo  &lt;= comments:=  loadDataFromDB(commentIds)<br>    <br>     <span class="hljs-keyword">var</span> <span class="hljs-keyword">map</span>[<span class="hljs-type">int</span>]commentInfo <span class="hljs-comment">//å¯ä»¥ç§»é™¤ï¼Œ ç›´æ¥è¿”å›[]commentsInfoã€‚å¤–éƒ¨ç»„è£…æ—¶ï¼Œç›´æ¥ç”¨ç´¢å¼•å®šä½æ•°æ®</span><br>     <span class="hljs-keyword">for</span> _, comm :=<span class="hljs-keyword">range</span> comments &#123;<br>        ret <span class="hljs-keyword">map</span>[comm.ID] = comm<br>     &#125;<br>    <span class="hljs-keyword">return</span> <br> &#125;<br></code></pre></td></tr></table></figure><ol start="4"><li>å¤ç”¨èµ„æºã€‚å¸¸è§çš„æ¯”å¦‚ä»è¿æ¥ä¸­è¯»å–æ•°æ®, é€šå¸¸ä¼šåˆ›å»º bytes.Bufferï¼Œå¯ä½¿ç”¨sync.Pool</li></ol><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">var</span> buffPool10K = sync.Pool&#123;<br>New: <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> <span class="hljs-keyword">interface</span>&#123;&#125; &#123; <span class="hljs-keyword">return</span> <span class="hljs-built_in">make</span>([]<span class="hljs-type">byte</span>, <span class="hljs-number">10240</span>) &#125;,<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">GetBuffer</span><span class="hljs-params">()</span></span> *bytes.Buffer &#123;<br> <span class="hljs-keyword">return</span> buffPool10K.Get().(*bytes.Buffer)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">PutBuffer</span><span class="hljs-params">(buff *bytes.Buffer)</span></span> &#123;<br>buff.Reset()<br>buffPool10K.Put(buff)<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="æ°¸ä¹…æ€§å¯¹è±¡æ³„æ¼"><a href="#æ°¸ä¹…æ€§å¯¹è±¡æ³„æ¼" class="headerlink" title="æ°¸ä¹…æ€§å¯¹è±¡æ³„æ¼"></a>æ°¸ä¹…æ€§å¯¹è±¡æ³„æ¼</h4><p>æ’æŸ¥æ€è·¯:</p><ol><li>æ£€æŸ¥ç›‘æ§æŒ‡æ ‡, ç¡®è®¤å†…å­˜æ˜¯æŒç»­å¢é•¿ï¼Œä¼˜å…ˆæŸ¥çœ‹æ˜¯å¦æ˜¯åç¨‹æ³„æ¼ã€‚</li><li>pprof heap inuse_space ç¨‹åºå¸¸é©»å†…å­˜å ç”¨æƒ…å†µã€‚(éœ€è¦é‡ç‚¹å…³æ³¨ï¼Œç»“åˆæ‹“æ‰‘å›¾å®šä½å†…å­˜æ³„æ¼çš„æºå¤´) <figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs golang"><span class="hljs-keyword">go</span> tool pprof -inuse_space -http=:<span class="hljs-number">8088</span> http:<span class="hljs-comment">//ç›®æ ‡æœºå™¨:ç«¯å£/debug/pprof/heap?debug=1</span><br></code></pre></td></tr></table></figure></li></ol><p>æ³„æ¼case:</p><ol><li>åç¨‹æ³„æ¼ã€‚ç›‘æ§æŒ‡æ ‡(åç¨‹æ•°ã€å†…å­˜)æŒç»­å¢é•¿ï¼Œpprof profileçš„<code>runtime.malg</code>å¢é•¿è¾ƒé«˜ <figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-comment"># debug=0:å¯ä»¥çœ‹åˆ°goroutineæ€»æ•°; 1: å¯ä»¥çœ‹åˆ°æ´»è·ƒgoroutineå †æ ˆä¿¡æ¯ï¼Œåˆ†æå®šä½é—®é¢˜(å¦‚æ­»é”æˆ–èµ„æºç«äº‰)</span><br><span class="hljs-attribute">go</span> tool pprof -http=:<span class="hljs-number">8088</span> http://ç›®æ ‡æœºå™¨:ç«¯å£/debug/pprof/groutine?debug=<span class="hljs-number">1</span><br></code></pre></td></tr></table></figure></li><li>è¿æ¥æœªå…³é—­ã€‚httpè¯·æ±‚çš„å“åº”ï¼Œè¦ä¹ˆè¯»å®Œè¦ä¹ˆä¸€å®šè¦Close,å¦åˆ™åº•å±‚readloopåç¨‹ä¼šå› ä¸ºåº•å±‚channelæ²¡æ”¶åˆ°é€€å‡ºä¿¡å·ä¸€è‡´é˜»å¡å¯¼è‡´åç¨‹æ³„æ¼ã€‚</li><li><font color="red">è­¦æƒ•connã€clientã€dbã€mysql rowsã€mysql statment </font><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs golang"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Mysql</span><span class="hljs-params">()</span></span> &#123;<br>    db, err := sql.Open(<span class="hljs-string">&quot;driver-name&quot;</span>, <span class="hljs-string">&quot;database=dsn&quot;</span>)<br>    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>     log.Fatal(err)<br>    &#125;<br>    <span class="hljs-keyword">defer</span> db.Close() <span class="hljs-comment">//æ•°æ®åº“å…³é—­!!!!!</span><br>    <br>    stmt, err := db.Prepare(<span class="hljs-string">&quot;SELECT * FROM users WHERE age &gt; ?&quot;</span>)<br>    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>      log.Fatal(err)<br>    &#125;<br>    <span class="hljs-keyword">defer</span> stmt.Close() <span class="hljs-comment">// Statementå…³é—­!!!!! ç¡®ä¿åœ¨ä¸å†éœ€è¦ statement æ—¶å…³é—­å®ƒ</span><br>    <br>    rows, err := stmt.Query(<span class="hljs-number">18</span>)<br>    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>     log.Fatal(err)<br>    &#125;<br>    <span class="hljs-keyword">defer</span> rows.Close() <span class="hljs-comment">// Rowså…³é—­!!!! ç¡®ä¿åœ¨è¯»å–å®Œæ•°æ®åå…³é—­ rows</span><br>    <br>    <span class="hljs-keyword">for</span> rows.Next() &#123;<br>        <span class="hljs-comment">// å¤„ç†æ¯ä¸€è¡Œæ•°æ®</span><br>    &#125;<br>    <span class="hljs-keyword">if</span> err = rows.Err(); err != <span class="hljs-literal">nil</span> &#123;<br>     log.Fatal(err)<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li></ol><h3 id="GCä¼˜åŒ–"><a href="#GCä¼˜åŒ–" class="headerlink" title="GCä¼˜åŒ–"></a>GCä¼˜åŒ–</h3><h4 id="ä¸ºä»€ä¹ˆè¦GCä¼˜åŒ–"><a href="#ä¸ºä»€ä¹ˆè¦GCä¼˜åŒ–" class="headerlink" title="ä¸ºä»€ä¹ˆè¦GCä¼˜åŒ–?"></a>ä¸ºä»€ä¹ˆè¦GCä¼˜åŒ–?</h4><ol><li>æœåŠ¡è€—æ—¶å½±å“</li></ol><p>GCå¹¶å‘æ‰«æå®Œä¹‹åä¼šæœ‰STWï¼Œæ­¤æ—¶å…¶ä»–goroutineéƒ½æ˜¯ä¼‘çœ çš„çŠ¶æ€ï¼Œå³ä¸æ‰§è¡Œä»»ä½•é€»è¾‘ã€‚å› æ­¤æç«¯æƒ…å†µä¸‹ä¸€æ—¦STWè€—æ—¶å˜é•¿ï¼Œå¯¹æ—¶å»¶æ•æ„Ÿçš„æœåŠ¡ï¼ŒP99è€—æ—¶å¯èƒ½ä¼šå‡ºç°æ¯›åˆºæˆ–è€…æ³¢åŠ¨ã€‚</p><h5 id="å½±å“STWæœ‰å“ªäº›å› ç´ "><a href="#å½±å“STWæœ‰å“ªäº›å› ç´ " class="headerlink" title="å½±å“STWæœ‰å“ªäº›å› ç´ ?"></a>å½±å“STWæœ‰å“ªäº›å› ç´ ?</h5><ol><li>åƒåœ¾å¯¹è±¡çš„æ•°é‡</li><li>æ¸…ç†åƒåœ¾å¯¹è±¡çš„é¢‘ç‡</li></ol><h5 id="GCæ—¶æœº"><a href="#GCæ—¶æœº" class="headerlink" title="GCæ—¶æœº?"></a>GCæ—¶æœº?</h5><ul><li><p>ä¸»åŠ¨æ‰§è¡Œ</p>  <figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go">runtime.GC()<br></code></pre></td></tr></table></figure></li><li><p>sysmonçº¿ç¨‹å®šæœŸæ‰§è¡Œ</p>  <figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs go"># è®¡ç®—ä¸‹æ¬¡GCçš„å†…å­˜é˜ˆå€¼<br>NextGC = live data + GCPercent * live data<br></code></pre></td></tr></table></figure></li><li><p>ç”³è¯·å†…å­˜æ—¶æ‰§è¡Œ, mallocgc</p></li></ul><p>ç»“è®º:</p><p>è¿™é‡Œé¢çœ‹ä¸‹æ¥ï¼Œæœ€é€‚åˆæ§åˆ¶GCé¢‘ç‡çš„å°±æ˜¯GCPercentäº†ã€‚åŸå› æ˜¯æˆ‘ä»¬æœåŠ¡ä¸­ä¸€èˆ¬ä¸ä¼šä¸»åŠ¨å»æ‰§è¡ŒGC è€Œmallocgc æ— æ³•æ‰‹åŠ¨å¹²é¢„ï¼Œåªèƒ½å‡å°‘ç”³è¯·å¯¹è±¡ã€‚</p><h4 id="GCæ’æŸ¥æ€è·¯"><a href="#GCæ’æŸ¥æ€è·¯" class="headerlink" title="GCæ’æŸ¥æ€è·¯"></a>GCæ’æŸ¥æ€è·¯</h4><p>æ’æŸ¥å·¥å…·: trace</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go">curl <span class="hljs-string">&quot;http://ç›®æ ‡æœºå™¨:ç›®æ ‡ç«¯å£/debug/pprof/trace?seconds&quot;</span>  &gt; trace.out<br><br><span class="hljs-keyword">go</span> tool trace -http=<span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>:<span class="hljs-number">8129</span> trace.out<br></code></pre></td></tr></table></figure><p>é€šè¿‡traceå¯ä»¥å¾—çŸ¥ä»¥ä¸‹ä¿¡æ¯:</p><ul><li>GCé¢‘ç‡ï¼Œçœ‹æ˜¯å¦å¤ªè¿‡é¢‘ç¹</li><li><strong>Minimum mutator utilization</strong>ï¼Œ mutatorä½¿ç”¨ç‡è¶Šæ¥è¿‘100%ï¼Œè¯´æ˜CPUå¤§éƒ¨åˆ†æ—¶é—´éƒ½æ˜¯ç¨‹åºåœ¨è·‘ã€‚<br><img src="/images/gc_mutator.png" alt="mutatorä½¿ç”¨ç‡"></li></ul><p>tips:</p><ol><li>ä»…å‹¾é€‰â€STWâ€ ï¼Œmutator&#x3D;0æ—¶ï¼Œå³ä¸ºGCè€—æ—¶</li><li>trace viewä¸­å¯ä»¥çœ‹åˆ°æœåŠ¡æ˜¯ä¸æ˜¯å¹¶å‘çš„ï¼Œå…·ä½“æ¥è¯´çœ‹çœ‹æœåŠ¡åç¨‹æ˜¯ä¸æ˜¯åœ¨åŒä¸€æ—¶é—´ç«¯å†…è·‘</li></ol><h4 id="GCè§£å†³æ–¹æ¡ˆ"><a href="#GCè§£å†³æ–¹æ¡ˆ" class="headerlink" title="GCè§£å†³æ–¹æ¡ˆ"></a>GCè§£å†³æ–¹æ¡ˆ</h4><p>æ‰€ä»¥GCä¼˜åŒ–æ–¹å‘ä¸€èˆ¬å°±æ˜¯é€šè¿‡è°ƒæ•´GCPercent, é™ä½GCé¢‘ç‡ï¼Œä¸è¿‡è¿™æ ·å†…å­˜å ç”¨å°±å¤šäº†ï¼Œæœ¬è´¨è¿˜æ˜¯ç©ºé—´æ¢æ—¶é—´çš„æ€è·¯ã€‚</p><p>è¿™é‡Œéœ€è¦æ³¨æ„ï¼ï¼ï¼ï¼ä¸ºé˜²æ­¢OOM, éœ€è¦è®¾ç½®:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go">GOMEMLIMIT å¦‚æœè¶…è¿‡ï¼Œä¼šå¼ºåˆ¶æ‰§è¡ŒGCï¼Œé˜²æ­¢OOM <br><br>å¦‚å›¾ å®¹å™¨æ˜¯<span class="hljs-number">3</span>GBå†…å­˜ï¼ŒGOMEMLIMIT=<span class="hljs-number">2750</span>MiB, ä¼šè‡ªåŠ¨å¼ºåˆ¶æ‰§è¡ŒGCã€‚<br></code></pre></td></tr></table></figure><p><img src="/images/memory_limit.png" alt="memory_limit"></p><h1 id="ã€ŠGOç¼–ç å»ºè®®ã€‹"><a href="#ã€ŠGOç¼–ç å»ºè®®ã€‹" class="headerlink" title="ã€ŠGOç¼–ç å»ºè®®ã€‹"></a>ã€ŠGOç¼–ç å»ºè®®ã€‹</h1><p><a href="https://dablelv.github.io/go-coding-advice/">è·³è½¬æŸ¥çœ‹</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>GO</tag>
      
      <tag>memory</tag>
      
      <tag>pprof</tag>
      
      <tag>é€ƒé€¸åˆ†æ</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ç”Ÿäº§ç¯å¢ƒæ•°æ®è¿ç§»å®æˆ˜æŒ‡å—ï¼šä»ç­–ç•¥è®¾è®¡åˆ°è½åœ°å®è·µ</title>
    <link href="/2022/10/23/how-to-migrate-data/"/>
    <url>/2022/10/23/how-to-migrate-data/</url>
    
    <content type="html"><![CDATA[<h2 id="æ•°æ®è¿ç§»åœºæ™¯ä¸æŒ‘æˆ˜"><a href="#æ•°æ®è¿ç§»åœºæ™¯ä¸æŒ‘æˆ˜" class="headerlink" title="æ•°æ®è¿ç§»åœºæ™¯ä¸æŒ‘æˆ˜"></a>æ•°æ®è¿ç§»åœºæ™¯ä¸æŒ‘æˆ˜</h2><p>åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œæ•°æ®è¿ç§»æ˜¯ä¸€é¡¹é«˜é£é™©ã€é«˜å¤æ‚åº¦çš„è¿ç»´æ“ä½œã€‚å¸¸è§çš„è¿ç§»é©±åŠ¨å› ç´ åŒ…æ‹¬ï¼š</p><h3 id="è¿ç§»é©±åŠ¨å› ç´ "><a href="#è¿ç§»é©±åŠ¨å› ç´ " class="headerlink" title="è¿ç§»é©±åŠ¨å› ç´ "></a>è¿ç§»é©±åŠ¨å› ç´ </h3><ul><li><strong>å®¹é‡æ‰©å±•</strong>ï¼šä¸šåŠ¡å¿«é€Ÿå¢é•¿å¯¼è‡´å­˜å‚¨å®¹é‡ä¸è¶³ï¼Œéœ€è¦æ‰©å®¹æˆ–åˆ†åº“åˆ†è¡¨</li><li><strong>æ€§èƒ½ä¼˜åŒ–</strong>ï¼šå•æœºæ€§èƒ½ç“¶é¢ˆï¼Œéœ€è¦è¿ç§»åˆ°æ›´é«˜é…ç½®çš„ç¡¬ä»¶æˆ–é›†ç¾¤</li><li><strong>æˆæœ¬ä¼˜åŒ–</strong>ï¼šé™æœ¬å¢æ•ˆï¼Œè¿ç§»åˆ°æˆæœ¬æ›´ä½çš„å­˜å‚¨æ–¹æ¡ˆ</li><li><strong>æŠ€æœ¯å‡çº§</strong>ï¼šæ•°æ®åº“ç‰ˆæœ¬å‡çº§ã€å­˜å‚¨å¼•æ“åˆ‡æ¢</li><li><strong>åˆè§„è¦æ±‚</strong>ï¼šæ•°æ®æœ¬åœ°åŒ–ã€å¼‚åœ°å®¹ç¾ç­‰åˆè§„æ€§éœ€æ±‚</li></ul><h3 id="æ ¸å¿ƒæŒ‘æˆ˜"><a href="#æ ¸å¿ƒæŒ‘æˆ˜" class="headerlink" title="æ ¸å¿ƒæŒ‘æˆ˜"></a>æ ¸å¿ƒæŒ‘æˆ˜</h3><ul><li><strong>æ•°æ®ä¸€è‡´æ€§</strong>ï¼šç¡®ä¿è¿ç§»è¿‡ç¨‹ä¸­æ•°æ®ä¸ä¸¢å¤±ã€ä¸é‡å¤</li><li><strong>æœåŠ¡å¯ç”¨æ€§</strong>ï¼šæœ€å°åŒ–ä¸šåŠ¡ä¸­æ–­æ—¶é—´</li><li><strong>æ€§èƒ½å½±å“</strong>ï¼šé¿å…è¿ç§»è¿‡ç¨‹å¯¹çº¿ä¸ŠæœåŠ¡é€ æˆæ€§èƒ½å†²å‡»</li><li><strong>å›æ»šèƒ½åŠ›</strong>ï¼šå…·å¤‡å¿«é€Ÿå›æ»šæœºåˆ¶åº”å¯¹å¼‚å¸¸æƒ…å†µ</li></ul><h2 id="è¿ç§»ç­–ç•¥é€‰æ‹©"><a href="#è¿ç§»ç­–ç•¥é€‰æ‹©" class="headerlink" title="è¿ç§»ç­–ç•¥é€‰æ‹©"></a>è¿ç§»ç­–ç•¥é€‰æ‹©</h2><h3 id="åœæœºè¿ç§»"><a href="#åœæœºè¿ç§»" class="headerlink" title="åœæœºè¿ç§»"></a>åœæœºè¿ç§»</h3><p><strong>é€‚ç”¨åœºæ™¯</strong>ï¼š</p><ul><li>é‡‘èã€æ”¯ä»˜ç­‰å¼ºä¸€è‡´æ€§è¦æ±‚çš„æ ¸å¿ƒä¸šåŠ¡</li><li>æ•°æ®é‡ç›¸å¯¹è¾ƒå°ï¼Œå¯æ¥å—çŸ­æ—¶é—´åœæœº</li><li>è¿ç§»çª—å£æœŸæœ‰æ˜ç¡®çš„ä¸šåŠ¡åœæœºæ—¶é—´</li></ul><p><strong>ä¼˜åŠ¿</strong>ï¼š</p><ul><li>å®æ–½ç®€å•ï¼Œé£é™©å¯æ§</li><li>æ•°æ®ä¸€è‡´æ€§æœ‰ä¿éšœ</li><li>æ“ä½œæµç¨‹æ¸…æ™°</li></ul><p><strong>åŠ£åŠ¿</strong>ï¼š</p><ul><li>ä¸šåŠ¡ä¸­æ–­æ—¶é—´è¾ƒé•¿</li><li>ç”¨æˆ·ä½“éªŒå—å½±å“</li></ul><h3 id="ä¸åœæœºè¿ç§»"><a href="#ä¸åœæœºè¿ç§»" class="headerlink" title="ä¸åœæœºè¿ç§»"></a>ä¸åœæœºè¿ç§»</h3><p><strong>é€‚ç”¨åœºæ™¯</strong>ï¼š</p><ul><li>7x24å°æ—¶æœåŠ¡çš„äº’è”ç½‘ä¸šåŠ¡</li><li>å¤§æ•°æ®é‡è¿ç§»åœºæ™¯</li><li>å¯¹å¯ç”¨æ€§è¦æ±‚æé«˜çš„ç³»ç»Ÿ</li></ul><p><strong>ä¼˜åŠ¿</strong>ï¼š</p><ul><li>ä¸šåŠ¡æ— æ„ŸçŸ¥</li><li>å¯åˆ†é˜¶æ®µæ‰§è¡Œï¼Œé£é™©åˆ†æ•£</li><li>å…·å¤‡å®æ—¶å›æ»šèƒ½åŠ›</li></ul><p><strong>åŠ£åŠ¿</strong>ï¼š</p><ul><li>æŠ€æœ¯å¤æ‚åº¦é«˜</li><li>éœ€è¦å®Œå–„çš„æ•°æ®æ ¡éªŒæœºåˆ¶</li><li>è¿ç§»å‘¨æœŸç›¸å¯¹è¾ƒé•¿</li></ul><h2 id="è¿ç§»æ—¶æœºé€‰æ‹©"><a href="#è¿ç§»æ—¶æœºé€‰æ‹©" class="headerlink" title="è¿ç§»æ—¶æœºé€‰æ‹©"></a>è¿ç§»æ—¶æœºé€‰æ‹©</h2><h3 id="å‰ç½®æ¡ä»¶éªŒè¯"><a href="#å‰ç½®æ¡ä»¶éªŒè¯" class="headerlink" title="å‰ç½®æ¡ä»¶éªŒè¯"></a>å‰ç½®æ¡ä»¶éªŒè¯</h3><ul><li><strong>æµ‹è¯•ç¯å¢ƒéªŒè¯</strong>ï¼šåœ¨ä¸ç”Ÿäº§ç¯å¢ƒç›¸åŒçš„æ•°æ®è§„æ¨¡ä¸‹å®Œæˆå®Œæ•´è¿ç§»æ¼”ç»ƒ</li><li><strong>ç›‘æ§å‘Šè­¦å®Œå¤‡</strong>ï¼šç¡®ä¿è¿ç§»è¿‡ç¨‹ä¸­çš„å…³é”®æŒ‡æ ‡å¯è§‚æµ‹</li><li><strong>å›æ»šé¢„æ¡ˆå°±ç»ª</strong>ï¼šåˆ¶å®šè¯¦ç»†çš„å›æ»šç­–ç•¥å’Œæ“ä½œæ‰‹å†Œ</li></ul><h3 id="æœ€ä½³æ‰§è¡Œæ—¶é—´çª—å£"><a href="#æœ€ä½³æ‰§è¡Œæ—¶é—´çª—å£" class="headerlink" title="æœ€ä½³æ‰§è¡Œæ—¶é—´çª—å£"></a>æœ€ä½³æ‰§è¡Œæ—¶é—´çª—å£</h3><ul><li><strong>ä¸šåŠ¡ä½å³°æœŸ</strong>ï¼šé€šå¸¸é€‰æ‹©å‡Œæ™¨2-6ç‚¹ï¼Œæ­¤æ—¶QPSç›¸å¯¹è¾ƒä½</li><li><strong>éå…³é”®ä¸šåŠ¡æ—¶æ®µ</strong>ï¼šé¿å¼€è¥é”€æ´»åŠ¨ã€ç»“ç®—ç­‰å…³é”®ä¸šåŠ¡æ—¶é—´ç‚¹</li><li><strong>å……è¶³çš„å¤„ç†æ—¶é—´</strong>ï¼šç¡®ä¿æœ‰è¶³å¤Ÿæ—¶é—´å¤„ç†å¼‚å¸¸æƒ…å†µ</li></ul><h2 id="ä¸åœæœºè¿ç§»å®æ–½æ–¹æ¡ˆ"><a href="#ä¸åœæœºè¿ç§»å®æ–½æ–¹æ¡ˆ" class="headerlink" title="ä¸åœæœºè¿ç§»å®æ–½æ–¹æ¡ˆ"></a>ä¸åœæœºè¿ç§»å®æ–½æ–¹æ¡ˆ</h2><h3 id="äº”é˜¶æ®µè¿ç§»ç­–ç•¥"><a href="#äº”é˜¶æ®µè¿ç§»ç­–ç•¥" class="headerlink" title="äº”é˜¶æ®µè¿ç§»ç­–ç•¥"></a>äº”é˜¶æ®µè¿ç§»ç­–ç•¥</h3><h4 id="ç¬¬ä¸€é˜¶æ®µï¼šåˆå§‹çŠ¶æ€"><a href="#ç¬¬ä¸€é˜¶æ®µï¼šåˆå§‹çŠ¶æ€" class="headerlink" title="ç¬¬ä¸€é˜¶æ®µï¼šåˆå§‹çŠ¶æ€"></a>ç¬¬ä¸€é˜¶æ®µï¼šåˆå§‹çŠ¶æ€</h4><figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs brainfuck"><span class="hljs-comment">åº”ç”¨</span> <span class="hljs-literal">----</span><span class="hljs-comment">å†™</span><span class="hljs-literal">----</span>&gt; <span class="hljs-comment">æ—§åº“</span><br>     <span class="hljs-literal">----</span><span class="hljs-comment">è¯»</span><span class="hljs-literal">----</span>&gt; <span class="hljs-comment">æ—§åº“</span><br></code></pre></td></tr></table></figure><ul><li><strong>ç›®æ ‡</strong>ï¼šå»ºç«‹åŸºçº¿ï¼Œç¡®ä¿ç³»ç»Ÿç¨³å®šè¿è¡Œ</li><li><strong>å…³é”®æŒ‡æ ‡</strong>ï¼šè®°å½•è¿ç§»å‰çš„æ€§èƒ½åŸºçº¿æ•°æ®</li></ul><h4 id="ç¬¬äºŒé˜¶æ®µï¼šå…¨é‡æ•°æ®åŒæ­¥"><a href="#ç¬¬äºŒé˜¶æ®µï¼šå…¨é‡æ•°æ®åŒæ­¥" class="headerlink" title="ç¬¬äºŒé˜¶æ®µï¼šå…¨é‡æ•°æ®åŒæ­¥"></a>ç¬¬äºŒé˜¶æ®µï¼šå…¨é‡æ•°æ®åŒæ­¥</h4><figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs brainfuck"><span class="hljs-comment">åº”ç”¨</span> <span class="hljs-literal">----</span><span class="hljs-comment">å†™</span><span class="hljs-literal">----</span>&gt; <span class="hljs-comment">æ—§åº“</span><br>     <span class="hljs-literal">----</span><span class="hljs-comment">è¯»</span><span class="hljs-literal">----</span>&gt; <span class="hljs-comment">æ—§åº“</span><br><br><span class="hljs-comment">æ—§åº“</span> <span class="hljs-literal">----</span><span class="hljs-comment">å…¨é‡åŒæ­¥</span><span class="hljs-literal">----</span>&gt; <span class="hljs-comment">æ–°åº“</span><br></code></pre></td></tr></table></figure><ul><li><strong>MySQLè¿ç§»å·¥å…·</strong>ï¼š<ul><li><code>mysqldump</code>ï¼šé€‚åˆä¸­å°å‹æ•°æ®åº“ï¼ˆ&lt; 100GBï¼‰</li><li><code>XtraBackup</code>ï¼šé€‚åˆå¤§å‹æ•°æ®åº“ï¼Œæ”¯æŒçƒ­å¤‡ä»½</li></ul></li><li><strong>Redisè¿ç§»å·¥å…·</strong>ï¼š<ul><li><code>redis-shake</code>ï¼šæ”¯æŒå…¨é‡+å¢é‡åŒæ­¥</li><li><code>redis-port</code>ï¼šé˜¿é‡Œäº‘å¼€æºçš„Redisè¿ç§»å·¥å…·</li></ul></li></ul><p><strong>å…¨é‡åŒæ­¥å…³é”®é…ç½®</strong>ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># MySQL XtraBackupç¤ºä¾‹</span><br>xtrabackup --backup --target-dir=/backup/full --datadir=/var/lib/mysql \<br>           --parallel=4 --compress --compress-threads=4<br><br><span class="hljs-comment"># Redis redis-shakeç¤ºä¾‹</span><br>redis-shake -<span class="hljs-built_in">type</span>=<span class="hljs-built_in">sync</span> -<span class="hljs-built_in">source</span>=127.0.0.1:6379 -target=127.0.0.1:6380 \<br>           -source.password_raw=xxx -target.password_raw=xxx<br></code></pre></td></tr></table></figure><h4 id="ç¬¬ä¸‰é˜¶æ®µï¼šåŒå†™æ—§è¯»"><a href="#ç¬¬ä¸‰é˜¶æ®µï¼šåŒå†™æ—§è¯»" class="headerlink" title="ç¬¬ä¸‰é˜¶æ®µï¼šåŒå†™æ—§è¯»"></a>ç¬¬ä¸‰é˜¶æ®µï¼šåŒå†™æ—§è¯»</h4><figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs brainfuck"><span class="hljs-comment">åº”ç”¨</span> <span class="hljs-literal">----</span><span class="hljs-comment">å†™</span><span class="hljs-literal">----</span>&gt; <span class="hljs-comment">æ—§åº“</span> <span class="hljs-literal">----</span><span class="hljs-comment">å¢é‡åŒæ­¥</span><span class="hljs-literal">----</span>&gt; <span class="hljs-comment">æ–°åº“</span><br>     <span class="hljs-literal">----</span><span class="hljs-comment">å†™</span><span class="hljs-literal">----</span>&gt; <span class="hljs-comment">æ–°åº“</span><br>     <span class="hljs-literal">----</span><span class="hljs-comment">è¯»</span><span class="hljs-literal">----</span>&gt; <span class="hljs-comment">æ—§åº“</span><br></code></pre></td></tr></table></figure><ul><li><strong>å®ç°æ–¹å¼</strong>ï¼šä¸šåŠ¡ä»£ç ä¿®æ”¹ï¼Œå¢åŠ åŒå†™é€»è¾‘</li><li><strong>æ ¸å¿ƒè¦ç‚¹</strong>ï¼š<ul><li>ä¼˜å…ˆå†™æ—§åº“ï¼Œä¿è¯ä¸»è·¯å¾„ç¨³å®š</li><li>æ–°åº“å†™å…¥å¤±è´¥ä¸å½±å“æ—§åº“äº‹åŠ¡</li><li>è®°å½•å†™å…¥å·®å¼‚ç”¨äºåç»­æ ¡éªŒ</li></ul></li></ul><p><strong>åŸºäºé…ç½®ä¸­å¿ƒçš„åŠ¨æ€åŒå†™å®ç°</strong>ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// è¿ç§»é˜¶æ®µæšä¸¾</span><br><span class="hljs-keyword">type</span> MigrationPhase <span class="hljs-type">int</span><br><br><span class="hljs-keyword">const</span> (<br>    PhaseReadOldWriteOld MigrationPhase = <span class="hljs-literal">iota</span> + <span class="hljs-number">1</span>  <span class="hljs-comment">// é˜¶æ®µ1ï¼šè¯»æ—§å†™æ—§</span><br>    PhaseReadOldWriteOldNew                         <span class="hljs-comment">// é˜¶æ®µ3ï¼šå…ˆå†™æ—§å†å†™æ–°ï¼Œè¯»æ—§</span><br>    PhaseReadNewWriteNewOld                         <span class="hljs-comment">// é˜¶æ®µ4ï¼šå…ˆå†™æ–°å†å†™æ—§ï¼Œè¯»æ–°</span><br>    PhaseReadNewWriteNew                            <span class="hljs-comment">// é˜¶æ®µ5ï¼šè¯»æ–°å†™æ–°</span><br>)<br><br><span class="hljs-comment">// é…ç½®ä¸­å¿ƒæ¥å£</span><br><span class="hljs-keyword">type</span> ConfigCenter <span class="hljs-keyword">interface</span> &#123;<br>    GetMigrationPhase(service <span class="hljs-type">string</span>) MigrationPhase<br>    GetWriteStrategy(service <span class="hljs-type">string</span>) WriteStrategy<br>&#125;<br><br><span class="hljs-comment">// å†™ç­–ç•¥é…ç½®</span><br><span class="hljs-keyword">type</span> WriteStrategy <span class="hljs-keyword">struct</span> &#123;<br>    PrimaryDB      <span class="hljs-type">string</span>        <span class="hljs-comment">// ä¸»åº“æ ‡è¯†ï¼šold/new</span><br>    SecondaryDB    <span class="hljs-type">string</span>        <span class="hljs-comment">// å‰¯åº“æ ‡è¯†ï¼šold/new  </span><br>    IsAsync        <span class="hljs-type">bool</span>          <span class="hljs-comment">// æ˜¯å¦å¼‚æ­¥å†™å‰¯åº“</span><br>    FailureAction  <span class="hljs-type">string</span>        <span class="hljs-comment">// å‰¯åº“å†™å¤±è´¥å¤„ç†ï¼šlog/queue/ignore</span><br>    TimeoutMs      <span class="hljs-type">int</span>           <span class="hljs-comment">// å†™å…¥è¶…æ—¶æ—¶é—´</span><br>&#125;<br><br><span class="hljs-comment">// æ•°æ®è®¿é—®å±‚</span><br><span class="hljs-keyword">type</span> DataAccessLayer <span class="hljs-keyword">struct</span> &#123;<br>    oldDB        *sql.DB<br>    newDB        *sql.DB<br>    configCenter ConfigCenter<br>    serviceName  <span class="hljs-type">string</span><br>    logger       Logger<br>    failureQueue Queue<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(dal *DataAccessLayer)</span></span> WriteData(data *Data) <span class="hljs-type">error</span> &#123;<br>    phase := dal.configCenter.GetMigrationPhase(dal.serviceName)<br>    strategy := dal.configCenter.GetWriteStrategy(dal.serviceName)<br>    <br>    <span class="hljs-keyword">switch</span> phase &#123;<br>    <span class="hljs-keyword">case</span> PhaseReadOldWriteOld:<br>        <span class="hljs-keyword">return</span> dal.writeToOldOnly(data)<br>        <br>    <span class="hljs-keyword">case</span> PhaseReadOldWriteOldNew:<br>        <span class="hljs-keyword">return</span> dal.writeOldThenNew(data, strategy)<br>        <br>    <span class="hljs-keyword">case</span> PhaseReadNewWriteNewOld:<br>        <span class="hljs-keyword">return</span> dal.writeNewThenOld(data, strategy)<br>        <br>    <span class="hljs-keyword">case</span> PhaseReadNewWriteNew:<br>        <span class="hljs-keyword">return</span> dal.writeToNewOnly(data)<br>        <br>    <span class="hljs-keyword">default</span>:<br>        <span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">&quot;unknown migration phase: %d&quot;</span>, phase)<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// é˜¶æ®µ1ï¼šåªå†™æ—§åº“</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(dal *DataAccessLayer)</span></span> writeToOldOnly(data *Data) <span class="hljs-type">error</span> &#123;<br>    <span class="hljs-keyword">return</span> dal.oldDB.Create(data)<br>&#125;<br><br><span class="hljs-comment">// é˜¶æ®µ3ï¼šå…ˆå†™æ—§åº“ï¼Œå†å†™æ–°åº“</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(dal *DataAccessLayer)</span></span> writeOldThenNew(data *Data, strategy WriteStrategy) <span class="hljs-type">error</span> &#123;<br>    <span class="hljs-comment">// ä¸»è·¯å¾„ï¼šå†™æ—§åº“ï¼Œå¿…é¡»æˆåŠŸ</span><br>    <span class="hljs-keyword">if</span> err := dal.oldDB.Create(data); err != <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">&quot;write to old db failed: %w&quot;</span>, err)<br>    &#125;<br>    <br>    <span class="hljs-comment">// å‰¯è·¯å¾„ï¼šå†™æ–°åº“</span><br>    <span class="hljs-keyword">return</span> dal.writeSecondary(dal.newDB, data, strategy, <span class="hljs-string">&quot;new&quot;</span>)<br>&#125;<br><br><span class="hljs-comment">// é˜¶æ®µ4ï¼šå…ˆå†™æ–°åº“ï¼Œå†å†™æ—§åº“  </span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(dal *DataAccessLayer)</span></span> writeNewThenOld(data *Data, strategy WriteStrategy) <span class="hljs-type">error</span> &#123;<br>    <span class="hljs-comment">// ä¸»è·¯å¾„ï¼šå†™æ–°åº“ï¼Œå¿…é¡»æˆåŠŸ</span><br>    <span class="hljs-keyword">if</span> err := dal.newDB.Create(data); err != <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">&quot;write to new db failed: %w&quot;</span>, err)<br>    &#125;<br>    <br>    <span class="hljs-comment">// å‰¯è·¯å¾„ï¼šå†™æ—§åº“ï¼ˆç”¨äºå›æ»šä¿éšœï¼‰</span><br>    <span class="hljs-keyword">return</span> dal.writeSecondary(dal.oldDB, data, strategy, <span class="hljs-string">&quot;old&quot;</span>)<br>&#125;<br><br><span class="hljs-comment">// é˜¶æ®µ5ï¼šåªå†™æ–°åº“</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(dal *DataAccessLayer)</span></span> writeToNewOnly(data *Data) <span class="hljs-type">error</span> &#123;<br>    <span class="hljs-keyword">return</span> dal.newDB.Create(data)<br>&#125;<br><br><span class="hljs-comment">// å‰¯åº“å†™å…¥é€»è¾‘</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(dal *DataAccessLayer)</span></span> writeSecondary(db *sql.DB, data *Data, strategy WriteStrategy, dbType <span class="hljs-type">string</span>) <span class="hljs-type">error</span> &#123;<br>    writeFunc := <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> <span class="hljs-type">error</span> &#123;<br>        ctx, cancel := context.WithTimeout(context.Background(), <br>            time.Duration(strategy.TimeoutMs)*time.Millisecond)<br>        <span class="hljs-keyword">defer</span> cancel()<br>        <br>        <span class="hljs-keyword">return</span> db.CreateWithContext(ctx, data)<br>    &#125;<br>    <br>    <span class="hljs-keyword">if</span> strategy.IsAsync &#123;<br>        <span class="hljs-comment">// å¼‚æ­¥å†™å…¥</span><br>        <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>            <span class="hljs-keyword">if</span> err := writeFunc(); err != <span class="hljs-literal">nil</span> &#123;<br>                dal.handleSecondaryWriteFailure(data, err, strategy, dbType)<br>            &#125;<br>        &#125;()<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">// åŒæ­¥å†™å…¥</span><br>        <span class="hljs-keyword">if</span> err := writeFunc(); err != <span class="hljs-literal">nil</span> &#123;<br>            dal.handleSecondaryWriteFailure(data, err, strategy, dbType)<br>            <span class="hljs-comment">// æ ¹æ®ç­–ç•¥å†³å®šæ˜¯å¦è¿”å›é”™è¯¯</span><br>            <span class="hljs-keyword">if</span> strategy.FailureAction == <span class="hljs-string">&quot;fail&quot;</span> &#123;<br>                <span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">&quot;write to %s db failed: %w&quot;</span>, dbType, err)<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// å‰¯åº“å†™å…¥å¤±è´¥å¤„ç†</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(dal *DataAccessLayer)</span></span> handleSecondaryWriteFailure(data *Data, err <span class="hljs-type">error</span>, strategy WriteStrategy, dbType <span class="hljs-type">string</span>) &#123;<br>    <span class="hljs-keyword">switch</span> strategy.FailureAction &#123;<br>    <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;log&quot;</span>:<br>        dal.logger.Error(<span class="hljs-string">&quot;secondary db write failed&quot;</span>, <br>            <span class="hljs-string">&quot;db_type&quot;</span>, dbType, <span class="hljs-string">&quot;error&quot;</span>, err, <span class="hljs-string">&quot;data&quot;</span>, data)<br>            <br>    <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;queue&quot;</span>:<br>        dal.failureQueue.Push(&amp;FailureRecord&#123;<br>            Data:      data,<br>            DBType:    dbType,<br>            Error:     err.Error(),<br>            Timestamp: time.Now(),<br>            Retries:   <span class="hljs-number">0</span>,<br>        &#125;)<br>        <br>    <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;ignore&quot;</span>:<br>        <span class="hljs-comment">// é™é»˜å¿½ç•¥</span><br>        <br>    <span class="hljs-keyword">default</span>:<br>        dal.logger.Error(<span class="hljs-string">&quot;unknown failure action&quot;</span>, <span class="hljs-string">&quot;action&quot;</span>, strategy.FailureAction)<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// è¯»å–æ•°æ®</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(dal *DataAccessLayer)</span></span> ReadData(id <span class="hljs-type">string</span>) (*Data, <span class="hljs-type">error</span>) &#123;<br>    phase := dal.configCenter.GetMigrationPhase(dal.serviceName)<br>    <br>    <span class="hljs-keyword">switch</span> phase &#123;<br>    <span class="hljs-keyword">case</span> PhaseReadOldWriteOld, PhaseReadOldWriteOldNew:<br>        <span class="hljs-keyword">return</span> dal.readFromOld(id)<br>        <br>    <span class="hljs-keyword">case</span> PhaseReadNewWriteNewOld, PhaseReadNewWriteNew:<br>        <span class="hljs-keyword">return</span> dal.readFromNew(id)<br>        <br>    <span class="hljs-keyword">default</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;unknown migration phase: %d&quot;</span>, phase)<br>    &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(dal *DataAccessLayer)</span></span> readFromOld(id <span class="hljs-type">string</span>) (*Data, <span class="hljs-type">error</span>) &#123;<br>    <span class="hljs-keyword">return</span> dal.oldDB.FindByID(id)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(dal *DataAccessLayer)</span></span> readFromNew(id <span class="hljs-type">string</span>) (*Data, <span class="hljs-type">error</span>) &#123;<br>    <span class="hljs-keyword">return</span> dal.newDB.FindByID(id)<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>é…ç½®ä¸­å¿ƒå››é˜¶æ®µé…ç½®ç¤ºä¾‹</strong>ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># Apollo/Nacos/etcd é…ç½®ç¤ºä¾‹ - å®Œæ•´çš„å››é˜¶æ®µé…ç½®</span><br><span class="hljs-attr">migration:</span><br>  <span class="hljs-comment"># ========== é˜¶æ®µ1ï¼šè¯»æ—§å†™æ—§ï¼ˆåˆå§‹çŠ¶æ€ï¼‰==========</span><br>  <span class="hljs-attr">user_service_phase1:</span><br>    <span class="hljs-attr">phase:</span> <span class="hljs-number">1</span>                    <span class="hljs-comment"># é˜¶æ®µ1ï¼šåªè¯»å†™æ—§åº“</span><br>    <span class="hljs-attr">write_strategy:</span><br>      <span class="hljs-attr">primary_db:</span> <span class="hljs-string">&quot;old&quot;</span>         <span class="hljs-comment"># åªå†™æ—§åº“</span><br>      <span class="hljs-attr">secondary_db:</span> <span class="hljs-string">&quot;&quot;</span>          <span class="hljs-comment"># æ— å‰¯åº“</span><br>      <span class="hljs-attr">is_async:</span> <span class="hljs-literal">false</span>          <span class="hljs-comment"># ä¸æ¶‰åŠåŒå†™</span><br>      <span class="hljs-attr">failure_action:</span> <span class="hljs-string">&quot;fail&quot;</span>    <span class="hljs-comment"># å†™å…¥å¤±è´¥ç›´æ¥è¿”å›é”™è¯¯</span><br>      <span class="hljs-attr">timeout_ms:</span> <span class="hljs-number">3000</span>         <span class="hljs-comment"># å†™å…¥è¶…æ—¶3ç§’</span><br>    <span class="hljs-attr">read_strategy:</span><br>      <span class="hljs-attr">primary_db:</span> <span class="hljs-string">&quot;old&quot;</span>         <span class="hljs-comment"># åªè¯»æ—§åº“</span><br>      <span class="hljs-attr">fallback_db:</span> <span class="hljs-string">&quot;&quot;</span>          <span class="hljs-comment"># æ— é™çº§åº“</span><br>    <br>  <span class="hljs-comment"># ========== é˜¶æ®µ2ï¼šå…¨é‡åŒæ­¥é˜¶æ®µï¼ˆåå°è¿›è¡Œï¼‰==========</span><br>  <span class="hljs-comment"># æ­¤é˜¶æ®µåº”ç”¨å±‚é…ç½®ä¸å˜ï¼Œç”±åŒæ­¥å·¥å…·æ‰§è¡Œå…¨é‡æ‹·è´</span><br>  <br>  <span class="hljs-comment"># ========== é˜¶æ®µ3ï¼šåŒå†™æ—§è¯»ï¼ˆå…ˆå†™æ—§å†å†™æ–°ï¼Œè¯»æ—§ï¼‰==========</span><br>  <span class="hljs-attr">user_service_phase3:</span><br>    <span class="hljs-attr">phase:</span> <span class="hljs-number">3</span>                    <span class="hljs-comment"># é˜¶æ®µ3ï¼šåŒå†™æ—§è¯»</span><br>    <span class="hljs-attr">write_strategy:</span><br>      <span class="hljs-attr">primary_db:</span> <span class="hljs-string">&quot;old&quot;</span>         <span class="hljs-comment"># ä¸»åº“ï¼šæ—§åº“ï¼ˆå¿…é¡»æˆåŠŸï¼‰</span><br>      <span class="hljs-attr">secondary_db:</span> <span class="hljs-string">&quot;new&quot;</span>       <span class="hljs-comment"># å‰¯åº“ï¼šæ–°åº“ï¼ˆå…è®¸å¤±è´¥ï¼‰</span><br>      <span class="hljs-attr">is_async:</span> <span class="hljs-literal">true</span>           <span class="hljs-comment"># å¼‚æ­¥å†™å‰¯åº“ï¼Œé™ä½å»¶è¿Ÿ</span><br>      <span class="hljs-attr">failure_action:</span> <span class="hljs-string">&quot;queue&quot;</span>   <span class="hljs-comment"># å‰¯åº“å¤±è´¥å…¥é˜Ÿé‡è¯•</span><br>      <span class="hljs-attr">timeout_ms:</span> <span class="hljs-number">1000</span>         <span class="hljs-comment"># å‰¯åº“å†™å…¥è¶…æ—¶1ç§’</span><br>      <span class="hljs-attr">max_retries:</span> <span class="hljs-number">3</span>           <span class="hljs-comment"># æœ€å¤§é‡è¯•æ¬¡æ•°</span><br>    <span class="hljs-attr">read_strategy:</span><br>      <span class="hljs-attr">primary_db:</span> <span class="hljs-string">&quot;old&quot;</span>         <span class="hljs-comment"># è¯»æ—§åº“</span><br>      <span class="hljs-attr">fallback_db:</span> <span class="hljs-string">&quot;&quot;</span>          <span class="hljs-comment"># æš‚æ— é™çº§</span><br>    <span class="hljs-attr">validation:</span><br>      <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span>            <span class="hljs-comment"># å¼€å¯æ•°æ®æ ¡éªŒ</span><br>      <span class="hljs-attr">sample_rate:</span> <span class="hljs-number">0.1</span>         <span class="hljs-comment"># 10%é‡‡æ ·æ ¡éªŒ</span><br>      <span class="hljs-attr">diff_threshold:</span> <span class="hljs-number">0.001</span>    <span class="hljs-comment"># å…è®¸0.1%æ•°æ®å·®å¼‚</span><br>    <br>  <span class="hljs-comment"># ========== é˜¶æ®µ4ï¼šåŒå†™æ–°è¯»ï¼ˆå…ˆå†™æ–°å†å†™æ—§ï¼Œè¯»æ–°ï¼‰==========  </span><br>  <span class="hljs-attr">user_service_phase4:</span><br>    <span class="hljs-attr">phase:</span> <span class="hljs-number">4</span>                    <span class="hljs-comment"># é˜¶æ®µ4ï¼šåŒå†™æ–°è¯»</span><br>    <span class="hljs-attr">write_strategy:</span><br>      <span class="hljs-attr">primary_db:</span> <span class="hljs-string">&quot;new&quot;</span>         <span class="hljs-comment"># ä¸»åº“ï¼šæ–°åº“ï¼ˆå¿…é¡»æˆåŠŸï¼‰</span><br>      <span class="hljs-attr">secondary_db:</span> <span class="hljs-string">&quot;old&quot;</span>       <span class="hljs-comment"># å‰¯åº“ï¼šæ—§åº“ï¼ˆä¿éšœå›æ»šï¼‰</span><br>      <span class="hljs-attr">is_async:</span> <span class="hljs-literal">false</span>          <span class="hljs-comment"># åŒæ­¥å†™å‰¯åº“ï¼Œä¿è¯å¼ºä¸€è‡´æ€§</span><br>      <span class="hljs-attr">failure_action:</span> <span class="hljs-string">&quot;log&quot;</span>     <span class="hljs-comment"># å‰¯åº“å¤±è´¥è®°å½•æ—¥å¿—</span><br>      <span class="hljs-attr">timeout_ms:</span> <span class="hljs-number">500</span>          <span class="hljs-comment"># å‰¯åº“å†™å…¥è¶…æ—¶500ms</span><br>      <span class="hljs-attr">max_retries:</span> <span class="hljs-number">1</span>           <span class="hljs-comment"># æœ€å¤šé‡è¯•1æ¬¡</span><br>    <span class="hljs-attr">read_strategy:</span><br>      <span class="hljs-attr">primary_db:</span> <span class="hljs-string">&quot;new&quot;</span>         <span class="hljs-comment"># è¯»æ–°åº“</span><br>      <span class="hljs-attr">fallback_db:</span> <span class="hljs-string">&quot;old&quot;</span>       <span class="hljs-comment"># é™çº§åˆ°æ—§åº“</span><br>      <span class="hljs-attr">fallback_threshold:</span> <span class="hljs-number">0.95</span> <span class="hljs-comment"># æ–°åº“æˆåŠŸç‡&lt;95%æ—¶é™çº§</span><br>    <span class="hljs-attr">validation:</span><br>      <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span>            <span class="hljs-comment"># ç»§ç»­æ•°æ®æ ¡éªŒ</span><br>      <span class="hljs-attr">sample_rate:</span> <span class="hljs-number">0.05</span>        <span class="hljs-comment"># 5%é‡‡æ ·æ ¡éªŒ</span><br>      <span class="hljs-attr">diff_threshold:</span> <span class="hljs-number">0.0001</span>   <span class="hljs-comment"># å…è®¸0.01%æ•°æ®å·®å¼‚</span><br>    <span class="hljs-attr">circuit_breaker:</span><br>      <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span>            <span class="hljs-comment"># å¼€å¯ç†”æ–­å™¨</span><br>      <span class="hljs-attr">failure_threshold:</span> <span class="hljs-number">10</span>    <span class="hljs-comment"># è¿ç»­10æ¬¡å¤±è´¥è§¦å‘ç†”æ–­</span><br>      <span class="hljs-attr">timeout_ms:</span> <span class="hljs-number">30000</span>        <span class="hljs-comment"># ç†”æ–­30ç§’åå°è¯•æ¢å¤</span><br>      <br>  <span class="hljs-comment"># ========== é˜¶æ®µ5ï¼šè¯»æ–°å†™æ–°ï¼ˆæœ€ç»ˆçŠ¶æ€ï¼‰==========</span><br>  <span class="hljs-attr">user_service_phase5:</span><br>    <span class="hljs-attr">phase:</span> <span class="hljs-number">5</span>                    <span class="hljs-comment"># é˜¶æ®µ5ï¼šåªè¯»å†™æ–°åº“</span><br>    <span class="hljs-attr">write_strategy:</span><br>      <span class="hljs-attr">primary_db:</span> <span class="hljs-string">&quot;new&quot;</span>         <span class="hljs-comment"># åªå†™æ–°åº“</span><br>      <span class="hljs-attr">secondary_db:</span> <span class="hljs-string">&quot;&quot;</span>          <span class="hljs-comment"># æ— å‰¯åº“</span><br>      <span class="hljs-attr">is_async:</span> <span class="hljs-literal">false</span>          <span class="hljs-comment"># ä¸æ¶‰åŠåŒå†™</span><br>      <span class="hljs-attr">failure_action:</span> <span class="hljs-string">&quot;fail&quot;</span>    <span class="hljs-comment"># å†™å…¥å¤±è´¥ç›´æ¥è¿”å›é”™è¯¯</span><br>      <span class="hljs-attr">timeout_ms:</span> <span class="hljs-number">2000</span>         <span class="hljs-comment"># å†™å…¥è¶…æ—¶2ç§’</span><br>    <span class="hljs-attr">read_strategy:</span><br>      <span class="hljs-attr">primary_db:</span> <span class="hljs-string">&quot;new&quot;</span>         <span class="hljs-comment"># åªè¯»æ–°åº“</span><br>      <span class="hljs-attr">fallback_db:</span> <span class="hljs-string">&quot;old&quot;</span>       <span class="hljs-comment"># ç´§æ€¥æƒ…å†µå¯é™çº§åˆ°æ—§åº“</span><br>      <span class="hljs-attr">fallback_enabled:</span> <span class="hljs-literal">false</span>  <span class="hljs-comment"># é»˜è®¤ä¸å¼€å¯é™çº§</span><br>    <span class="hljs-attr">cleanup:</span><br>      <span class="hljs-attr">old_db_retention_days:</span> <span class="hljs-number">30</span> <span class="hljs-comment"># æ—§åº“ä¿ç•™30å¤©</span><br>      <span class="hljs-attr">auto_cleanup:</span> <span class="hljs-literal">false</span>      <span class="hljs-comment"># ä¸è‡ªåŠ¨æ¸…ç†ï¼Œäººå·¥ç¡®è®¤</span><br>      <br><span class="hljs-comment"># ========== ä¸åŒä¸šåŠ¡æœåŠ¡çš„é…ç½®ç¤ºä¾‹ ==========</span><br>  <span class="hljs-comment"># è®¢å•æœåŠ¡ï¼ˆé«˜ä¸€è‡´æ€§è¦æ±‚ï¼‰</span><br>  <span class="hljs-attr">order_service:</span><br>    <span class="hljs-attr">phase:</span> <span class="hljs-number">4</span><br>    <span class="hljs-attr">write_strategy:</span><br>      <span class="hljs-attr">primary_db:</span> <span class="hljs-string">&quot;new&quot;</span><br>      <span class="hljs-attr">secondary_db:</span> <span class="hljs-string">&quot;old&quot;</span><br>      <span class="hljs-attr">is_async:</span> <span class="hljs-literal">false</span>          <span class="hljs-comment"># åŒæ­¥åŒå†™ï¼Œç¡®ä¿å¼ºä¸€è‡´æ€§</span><br>      <span class="hljs-attr">failure_action:</span> <span class="hljs-string">&quot;fail&quot;</span>    <span class="hljs-comment"># å‰¯åº“å¤±è´¥ä¹Ÿè¦æŠ¥é”™</span><br>      <span class="hljs-attr">timeout_ms:</span> <span class="hljs-number">200</span>          <span class="hljs-comment"># æ›´çŸ­çš„è¶…æ—¶æ—¶é—´</span><br>    <span class="hljs-attr">read_strategy:</span><br>      <span class="hljs-attr">primary_db:</span> <span class="hljs-string">&quot;new&quot;</span><br>      <span class="hljs-attr">fallback_db:</span> <span class="hljs-string">&quot;old&quot;</span><br>      <span class="hljs-attr">fallback_threshold:</span> <span class="hljs-number">0.99</span> <span class="hljs-comment"># æ›´é«˜çš„é™çº§é˜ˆå€¼</span><br>      <br>  <span class="hljs-comment"># ç”¨æˆ·ç”»åƒæœåŠ¡ï¼ˆå¯æ¥å—æœ€ç»ˆä¸€è‡´æ€§ï¼‰</span><br>  <span class="hljs-attr">profile_service:</span><br>    <span class="hljs-attr">phase:</span> <span class="hljs-number">3</span><br>    <span class="hljs-attr">write_strategy:</span><br>      <span class="hljs-attr">primary_db:</span> <span class="hljs-string">&quot;old&quot;</span><br>      <span class="hljs-attr">secondary_db:</span> <span class="hljs-string">&quot;new&quot;</span><br>      <span class="hljs-attr">is_async:</span> <span class="hljs-literal">true</span>           <span class="hljs-comment"># å¼‚æ­¥åŒå†™ï¼Œæ€§èƒ½ä¼˜å…ˆ</span><br>      <span class="hljs-attr">failure_action:</span> <span class="hljs-string">&quot;ignore&quot;</span> <span class="hljs-comment"># å¿½ç•¥å‰¯åº“å¤±è´¥</span><br>      <span class="hljs-attr">timeout_ms:</span> <span class="hljs-number">2000</span>         <span class="hljs-comment"># æ›´å®½æ¾çš„è¶…æ—¶</span><br>    <span class="hljs-attr">read_strategy:</span><br>      <span class="hljs-attr">primary_db:</span> <span class="hljs-string">&quot;old&quot;</span><br>      <span class="hljs-attr">fallback_db:</span> <span class="hljs-string">&quot;&quot;</span><br><br><span class="hljs-comment"># ========== å…¨å±€é…ç½® ==========</span><br><span class="hljs-attr">global:</span><br>  <span class="hljs-attr">migration:</span><br>    <span class="hljs-attr">monitoring:</span><br>      <span class="hljs-attr">metrics_interval_seconds:</span> <span class="hljs-number">30</span>   <span class="hljs-comment"># æŒ‡æ ‡é‡‡é›†é—´éš”</span><br>      <span class="hljs-attr">alert_threshold:</span><br>        <span class="hljs-attr">error_rate:</span> <span class="hljs-number">0.01</span>             <span class="hljs-comment"># é”™è¯¯ç‡è¶…è¿‡1%å‘Šè­¦</span><br>        <span class="hljs-attr">latency_p99_ms:</span> <span class="hljs-number">1000</span>         <span class="hljs-comment"># P99å»¶è¿Ÿè¶…è¿‡1ç§’å‘Šè­¦</span><br>        <span class="hljs-attr">consistency_rate:</span> <span class="hljs-number">0.999</span>      <span class="hljs-comment"># ä¸€è‡´æ€§ä½äº99.9%å‘Šè­¦</span><br>    <span class="hljs-attr">auto_promotion:</span><br>      <span class="hljs-attr">enabled:</span> <span class="hljs-literal">false</span>                 <span class="hljs-comment"># æ˜¯å¦å¼€å¯è‡ªåŠ¨é˜¶æ®µæ¨è¿›</span><br>      <span class="hljs-attr">check_interval_minutes:</span> <span class="hljs-number">30</span>     <span class="hljs-comment"># æ£€æŸ¥é—´éš”30åˆ†é’Ÿ</span><br>      <span class="hljs-attr">stability_duration_hours:</span> <span class="hljs-number">2</span>    <span class="hljs-comment"># ç¨³å®šè¿è¡Œ2å°æ—¶åå…è®¸æ¨è¿›</span><br></code></pre></td></tr></table></figure><p><strong>è¿ç§»é˜¶æ®µåŠ¨æ€æ§åˆ¶å™¨</strong>ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// è¿ç§»æ§åˆ¶å™¨</span><br><span class="hljs-keyword">type</span> MigrationController <span class="hljs-keyword">struct</span> &#123;<br>    configCenter    ConfigCenter<br>    dataValidator   *DataValidator<br>    metrics        *MigrationMetrics<br>    logger         Logger<br>&#125;<br><br><span class="hljs-comment">// è‡ªåŠ¨é˜¶æ®µæ¨è¿›</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(mc *MigrationController)</span></span> AutoPromotePhase(serviceName <span class="hljs-type">string</span>) <span class="hljs-type">error</span> &#123;<br>    currentPhase := mc.configCenter.GetMigrationPhase(serviceName)<br>    <br>    <span class="hljs-comment">// æ£€æŸ¥å½“å‰é˜¶æ®µæ˜¯å¦æ»¡è¶³æ¨è¿›æ¡ä»¶</span><br>    canPromote, err := mc.checkPhasePromotionConditions(serviceName, currentPhase)<br>    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">&quot;check promotion conditions failed: %w&quot;</span>, err)<br>    &#125;<br>    <br>    <span class="hljs-keyword">if</span> !canPromote &#123;<br>        mc.logger.Info(<span class="hljs-string">&quot;phase promotion conditions not met&quot;</span>, <br>            <span class="hljs-string">&quot;service&quot;</span>, serviceName, <span class="hljs-string">&quot;current_phase&quot;</span>, currentPhase)<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>    &#125;<br>    <br>    <span class="hljs-comment">// æ¨è¿›åˆ°ä¸‹ä¸€é˜¶æ®µ</span><br>    nextPhase := currentPhase + <span class="hljs-number">1</span><br>    <span class="hljs-keyword">if</span> nextPhase &gt; PhaseReadNewWriteNew &#123;<br>        mc.logger.Info(<span class="hljs-string">&quot;migration completed&quot;</span>, <span class="hljs-string">&quot;service&quot;</span>, serviceName)<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>    &#125;<br>    <br>    <span class="hljs-keyword">return</span> mc.setMigrationPhase(serviceName, nextPhase)<br>&#125;<br><br><span class="hljs-comment">// æ£€æŸ¥é˜¶æ®µæ¨è¿›æ¡ä»¶</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(mc *MigrationController)</span></span> checkPhasePromotionConditions(serviceName <span class="hljs-type">string</span>, phase MigrationPhase) (<span class="hljs-type">bool</span>, <span class="hljs-type">error</span>) &#123;<br>    <span class="hljs-keyword">switch</span> phase &#123;<br>    <span class="hljs-keyword">case</span> PhaseReadOldWriteOld:<br>        <span class="hljs-comment">// æ£€æŸ¥å…¨é‡åŒæ­¥æ˜¯å¦å®Œæˆ</span><br>        <span class="hljs-keyword">return</span> mc.checkFullSyncCompleted(serviceName)<br>        <br>    <span class="hljs-keyword">case</span> PhaseReadOldWriteOldNew:<br>        <span class="hljs-comment">// æ£€æŸ¥åŒå†™ä¸€è‡´æ€§</span><br>        <span class="hljs-keyword">return</span> mc.checkDualWriteConsistency(serviceName)<br>        <br>    <span class="hljs-keyword">case</span> PhaseReadNewWriteNewOld:<br>        <span class="hljs-comment">// æ£€æŸ¥æ–°åº“ç¨³å®šæ€§</span><br>        <span class="hljs-keyword">return</span> mc.checkNewDBStability(serviceName)<br>        <br>    <span class="hljs-keyword">case</span> PhaseReadNewWriteNew:<br>        <span class="hljs-comment">// å·²æ˜¯æœ€ç»ˆé˜¶æ®µ</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>, <span class="hljs-literal">nil</span><br>        <br>    <span class="hljs-keyword">default</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>, fmt.Errorf(<span class="hljs-string">&quot;unknown phase: %d&quot;</span>, phase)<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// æ£€æŸ¥å…¨é‡åŒæ­¥å®Œæˆæƒ…å†µ</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(mc *MigrationController)</span></span> checkFullSyncCompleted(serviceName <span class="hljs-type">string</span>) (<span class="hljs-type">bool</span>, <span class="hljs-type">error</span>) &#123;<br>    <span class="hljs-comment">// æ£€æŸ¥æ•°æ®è¡Œæ•°æ˜¯å¦ä¸€è‡´</span><br>    oldCount, err := mc.getTableRowCount(serviceName, <span class="hljs-string">&quot;old&quot;</span>)<br>    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>, err<br>    &#125;<br>    <br>    newCount, err := mc.getTableRowCount(serviceName, <span class="hljs-string">&quot;new&quot;</span>)<br>    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>, err<br>    &#125;<br>    <br>    <span class="hljs-comment">// å…è®¸1%çš„è¯¯å·®ï¼ˆè€ƒè™‘åˆ°åŒæ­¥è¿‡ç¨‹ä¸­çš„å¢é‡æ•°æ®ï¼‰</span><br>    threshold := <span class="hljs-type">float64</span>(oldCount) * <span class="hljs-number">0.01</span><br>    diff := math.Abs(<span class="hljs-type">float64</span>(oldCount - newCount))<br>    <br>    <span class="hljs-keyword">return</span> diff &lt;= threshold, <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-comment">// æ£€æŸ¥åŒå†™ä¸€è‡´æ€§</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(mc *MigrationController)</span></span> checkDualWriteConsistency(serviceName <span class="hljs-type">string</span>) (<span class="hljs-type">bool</span>, <span class="hljs-type">error</span>) &#123;<br>    metrics := mc.metrics.GetDualWriteMetrics(serviceName)<br>    <br>    <span class="hljs-comment">// æ£€æŸ¥å†™å…¥æˆåŠŸç‡ï¼ˆè¦æ±‚99.9%ä»¥ä¸Šï¼‰</span><br>    successRate := <span class="hljs-type">float64</span>(metrics.SuccessCount) / <span class="hljs-type">float64</span>(metrics.TotalCount)<br>    <span class="hljs-keyword">if</span> successRate &lt; <span class="hljs-number">0.999</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>, <span class="hljs-literal">nil</span><br>    &#125;<br>    <br>    <span class="hljs-comment">// æ£€æŸ¥æ•°æ®ä¸€è‡´æ€§ï¼ˆè¦æ±‚99.99%ä»¥ä¸Šï¼‰</span><br>    consistencyRate := <span class="hljs-type">float64</span>(metrics.ConsistentCount) / <span class="hljs-type">float64</span>(metrics.ValidatedCount)<br>    <span class="hljs-keyword">if</span> consistencyRate &lt; <span class="hljs-number">0.9999</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>, <span class="hljs-literal">nil</span><br>    &#125;<br>    <br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>, <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-comment">// ç´§æ€¥å›æ»šæœºåˆ¶</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(mc *MigrationController)</span></span> EmergencyRollback(serviceName <span class="hljs-type">string</span>) <span class="hljs-type">error</span> &#123;<br>    currentPhase := mc.configCenter.GetMigrationPhase(serviceName)<br>    <br>    mc.logger.Warn(<span class="hljs-string">&quot;executing emergency rollback&quot;</span>, <br>        <span class="hljs-string">&quot;service&quot;</span>, serviceName, <span class="hljs-string">&quot;current_phase&quot;</span>, currentPhase)<br>    <br>    <span class="hljs-comment">// æ ¹æ®å½“å‰é˜¶æ®µæ‰§è¡Œä¸åŒçš„å›æ»šç­–ç•¥</span><br>    <span class="hljs-keyword">switch</span> currentPhase &#123;<br>    <span class="hljs-keyword">case</span> PhaseReadOldWriteOldNew:<br>        <span class="hljs-comment">// å›æ»šåˆ°é˜¶æ®µ1ï¼šåœæ­¢åŒå†™ï¼Œåªå†™æ—§åº“</span><br>        <span class="hljs-keyword">return</span> mc.setMigrationPhase(serviceName, PhaseReadOldWriteOld)<br>        <br>    <span class="hljs-keyword">case</span> PhaseReadNewWriteNewOld:<br>        <span class="hljs-comment">// å›æ»šåˆ°é˜¶æ®µ3ï¼šæ¢å¤è¯»æ—§åº“</span><br>        <span class="hljs-keyword">return</span> mc.setMigrationPhase(serviceName, PhaseReadOldWriteOldNew)<br>        <br>    <span class="hljs-keyword">case</span> PhaseReadNewWriteNew:<br>        <span class="hljs-comment">// å›æ»šåˆ°é˜¶æ®µ4ï¼šæ¢å¤åŒå†™</span><br>        <span class="hljs-keyword">return</span> mc.setMigrationPhase(serviceName, PhaseReadNewWriteNewOld)<br>        <br>    <span class="hljs-keyword">default</span>:<br>        <span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">&quot;cannot rollback from phase: %d&quot;</span>, currentPhase)<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// è®¾ç½®è¿ç§»é˜¶æ®µ</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(mc *MigrationController)</span></span> setMigrationPhase(serviceName <span class="hljs-type">string</span>, phase MigrationPhase) <span class="hljs-type">error</span> &#123;<br>    <span class="hljs-comment">// æ›´æ–°é…ç½®ä¸­å¿ƒ</span><br>    err := mc.configCenter.SetMigrationPhase(serviceName, phase)<br>    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">&quot;update config center failed: %w&quot;</span>, err)<br>    &#125;<br>    <br>    <span class="hljs-comment">// è®°å½•é˜¶æ®µå˜æ›´æ—¥å¿—</span><br>    mc.logger.Info(<span class="hljs-string">&quot;migration phase changed&quot;</span>, <br>        <span class="hljs-string">&quot;service&quot;</span>, serviceName, <span class="hljs-string">&quot;new_phase&quot;</span>, phase)<br>    <br>    <span class="hljs-comment">// å‘é€å‘Šè­¦é€šçŸ¥</span><br>    mc.sendPhaseChangeAlert(serviceName, phase)<br>    <br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="ç¬¬å››é˜¶æ®µï¼šåŒå†™æ–°è¯»"><a href="#ç¬¬å››é˜¶æ®µï¼šåŒå†™æ–°è¯»" class="headerlink" title="ç¬¬å››é˜¶æ®µï¼šåŒå†™æ–°è¯»"></a>ç¬¬å››é˜¶æ®µï¼šåŒå†™æ–°è¯»</h4><figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs brainfuck"><span class="hljs-comment">åº”ç”¨</span> <span class="hljs-literal">----</span><span class="hljs-comment">å†™</span><span class="hljs-literal">----</span>&gt; <span class="hljs-comment">æ–°åº“</span> <span class="hljs-literal">----</span><span class="hljs-comment">åå‘åŒæ­¥</span><span class="hljs-literal">----</span>&gt; <span class="hljs-comment">æ—§åº“</span><br>     <span class="hljs-literal">----</span><span class="hljs-comment">å†™</span><span class="hljs-literal">----</span>&gt; <span class="hljs-comment">æ—§åº“</span><br>     <span class="hljs-literal">----</span><span class="hljs-comment">è¯»</span><span class="hljs-literal">----</span>&gt; <span class="hljs-comment">æ–°åº“</span><br></code></pre></td></tr></table></figure><ul><li><strong>å…³é”®æ“ä½œ</strong>ï¼šåˆ‡æ¢è¯»å–æ•°æ®æºåˆ°æ–°åº“</li><li><strong>ç›‘æ§é‡ç‚¹</strong>ï¼š<ul><li>æ–°åº“æŸ¥è¯¢æ€§èƒ½æŒ‡æ ‡</li><li>æ•°æ®ä¸€è‡´æ€§æ ¡éªŒ</li><li>ä¸šåŠ¡åŠŸèƒ½æ­£ç¡®æ€§éªŒè¯</li></ul></li></ul><h4 id="ç¬¬äº”é˜¶æ®µï¼šå•å†™æ–°è¯»"><a href="#ç¬¬äº”é˜¶æ®µï¼šå•å†™æ–°è¯»" class="headerlink" title="ç¬¬äº”é˜¶æ®µï¼šå•å†™æ–°è¯»"></a>ç¬¬äº”é˜¶æ®µï¼šå•å†™æ–°è¯»</h4><figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs brainfuck"><span class="hljs-comment">åº”ç”¨</span> <span class="hljs-literal">----</span><span class="hljs-comment">å†™</span><span class="hljs-literal">----</span>&gt; <span class="hljs-comment">æ–°åº“</span><br>     <span class="hljs-literal">----</span><span class="hljs-comment">è¯»</span><span class="hljs-literal">----</span>&gt; <span class="hljs-comment">æ–°åº“</span><br></code></pre></td></tr></table></figure><ul><li><strong>æ¸…ç†å·¥ä½œ</strong>ï¼šç§»é™¤åŒå†™é€»è¾‘ï¼Œæ¸…ç†æ—§åº“èµ„æº</li><li><strong>ä¿ç•™ç­–ç•¥</strong>ï¼šæ—§åº“æ•°æ®ä¿ç•™ä¸€å®šå‘¨æœŸç”¨äºåº”æ€¥å›æ»š</li></ul><h2 id="æ•°æ®æ ¡éªŒä¸ä¸€è‡´æ€§ä¿è¯"><a href="#æ•°æ®æ ¡éªŒä¸ä¸€è‡´æ€§ä¿è¯" class="headerlink" title="æ•°æ®æ ¡éªŒä¸ä¸€è‡´æ€§ä¿è¯"></a>æ•°æ®æ ¡éªŒä¸ä¸€è‡´æ€§ä¿è¯</h2><h3 id="å®æ—¶æ•°æ®æ ¡éªŒ"><a href="#å®æ—¶æ•°æ®æ ¡éªŒ" class="headerlink" title="å®æ—¶æ•°æ®æ ¡éªŒ"></a>å®æ—¶æ•°æ®æ ¡éªŒ</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> DataValidator <span class="hljs-keyword">struct</span> &#123;<br>    oldDB    *sql.DB<br>    newDB    *sql.DB<br>    diffChan <span class="hljs-keyword">chan</span> *DiffRecord<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(v *DataValidator)</span></span> ValidateAsync(key <span class="hljs-type">string</span>) &#123;<br>    <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>        oldData := v.queryFromOldDB(key)<br>        newData := v.queryFromNewDB(key)<br>        <br>        <span class="hljs-keyword">if</span> !v.isEqual(oldData, newData) &#123;<br>            v.diffChan &lt;- &amp;DiffRecord&#123;<br>                Key:     key,<br>                OldData: oldData,<br>                NewData: newData,<br>                Time:    time.Now(),<br>            &#125;<br>        &#125;<br>    &#125;()<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="æ•°æ®ä¿®å¤æœºåˆ¶"><a href="#æ•°æ®ä¿®å¤æœºåˆ¶" class="headerlink" title="æ•°æ®ä¿®å¤æœºåˆ¶"></a>æ•°æ®ä¿®å¤æœºåˆ¶</h3><ul><li><strong>è‡ªåŠ¨ä¿®å¤</strong>ï¼šå¯¹äºç®€å•çš„æ•°æ®å·®å¼‚ï¼Œè‡ªåŠ¨æ‰§è¡Œä¿®å¤é€»è¾‘</li><li><strong>äººå·¥ä»‹å…¥</strong>ï¼šå¤æ‚å·®å¼‚éœ€è¦äººå·¥åˆ†æå’Œå¤„ç†</li><li><strong>ä¿®å¤æ—¥å¿—</strong>ï¼šè®°å½•æ‰€æœ‰ä¿®å¤æ“ä½œï¼Œç¡®ä¿å¯è¿½æº¯</li></ul><h2 id="ç”Ÿäº§å®æˆ˜æ¡ˆä¾‹"><a href="#ç”Ÿäº§å®æˆ˜æ¡ˆä¾‹" class="headerlink" title="ç”Ÿäº§å®æˆ˜æ¡ˆä¾‹"></a>ç”Ÿäº§å®æˆ˜æ¡ˆä¾‹</h2><h3 id="MySQLåˆ†åº“åˆ†è¡¨è¿ç§»æ¡ˆä¾‹"><a href="#MySQLåˆ†åº“åˆ†è¡¨è¿ç§»æ¡ˆä¾‹" class="headerlink" title="MySQLåˆ†åº“åˆ†è¡¨è¿ç§»æ¡ˆä¾‹"></a>MySQLåˆ†åº“åˆ†è¡¨è¿ç§»æ¡ˆä¾‹</h3><p><strong>åœºæ™¯æè¿°</strong>ï¼šç”¨æˆ·è¡¨ä»å•è¡¨è¿ç§»åˆ°åˆ†åº“åˆ†è¡¨æ¶æ„</p><h4 id="åŸè¡¨ç»“æ„"><a href="#åŸè¡¨ç»“æ„" class="headerlink" title="åŸè¡¨ç»“æ„"></a>åŸè¡¨ç»“æ„</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> users (<br>    id <span class="hljs-type">bigint</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> AUTO_INCREMENT <span class="hljs-keyword">PRIMARY</span> KEY,<br>    username <span class="hljs-type">varchar</span>(<span class="hljs-number">64</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">UNIQUE</span>,<br>    email <span class="hljs-type">varchar</span>(<span class="hljs-number">128</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>    created_at <span class="hljs-type">timestamp</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>,<br>    updated_at <span class="hljs-type">timestamp</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">UPDATE</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>,<br>    INDEX idx_username (username),<br>    INDEX idx_email (email)<br>) ENGINE<span class="hljs-operator">=</span>InnoDB <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8mb4;<br></code></pre></td></tr></table></figure><h4 id="ç›®æ ‡åˆ†è¡¨ç»“æ„"><a href="#ç›®æ ‡åˆ†è¡¨ç»“æ„" class="headerlink" title="ç›®æ ‡åˆ†è¡¨ç»“æ„"></a>ç›®æ ‡åˆ†è¡¨ç»“æ„</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-comment">-- åˆ†è¡¨è§„åˆ™ï¼šæŒ‰user_id hashåˆ†16ä¸ªè¡¨</span><br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> users_0 (<br>    id <span class="hljs-type">bigint</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> AUTO_INCREMENT <span class="hljs-keyword">PRIMARY</span> KEY,<br>    user_id <span class="hljs-type">bigint</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>    username <span class="hljs-type">varchar</span>(<span class="hljs-number">64</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>    email <span class="hljs-type">varchar</span>(<span class="hljs-number">128</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>    created_at <span class="hljs-type">timestamp</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>,<br>    updated_at <span class="hljs-type">timestamp</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">UPDATE</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>,<br>    <span class="hljs-keyword">UNIQUE</span> KEY uk_user_id (user_id),<br>    INDEX idx_username (username),<br>    INDEX idx_email (email)<br>) ENGINE<span class="hljs-operator">=</span>InnoDB <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8mb4;<br><br><span class="hljs-comment">-- users_1 åˆ° users_15 ç»“æ„ç›¸åŒ</span><br></code></pre></td></tr></table></figure><h4 id="åˆ†è¡¨è·¯ç”±é€»è¾‘"><a href="#åˆ†è¡¨è·¯ç”±é€»è¾‘" class="headerlink" title="åˆ†è¡¨è·¯ç”±é€»è¾‘"></a>åˆ†è¡¨è·¯ç”±é€»è¾‘</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">GetTableSuffix</span><span class="hljs-params">(userID <span class="hljs-type">int64</span>)</span></span> <span class="hljs-type">int</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-type">int</span>(userID % <span class="hljs-number">16</span>)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">GetTableName</span><span class="hljs-params">(userID <span class="hljs-type">int64</span>)</span></span> <span class="hljs-type">string</span> &#123;<br>    <span class="hljs-keyword">return</span> fmt.Sprintf(<span class="hljs-string">&quot;users_%d&quot;</span>, GetTableSuffix(userID))<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="Redisé›†ç¾¤è¿ç§»æ¡ˆä¾‹"><a href="#Redisé›†ç¾¤è¿ç§»æ¡ˆä¾‹" class="headerlink" title="Redisé›†ç¾¤è¿ç§»æ¡ˆä¾‹"></a>Redisé›†ç¾¤è¿ç§»æ¡ˆä¾‹</h3><p><strong>åœºæ™¯æè¿°</strong>ï¼šRediså•æœºè¿ç§»åˆ°Redis Cluster</p><h4 id="è¿ç§»é…ç½®"><a href="#è¿ç§»é…ç½®" class="headerlink" title="è¿ç§»é…ç½®"></a>è¿ç§»é…ç½®</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># redis-shakeé…ç½®</span><br>[<span class="hljs-string">source</span>]<br><span class="hljs-string">type</span> <span class="hljs-string">=</span> <span class="hljs-string">standalone</span><br><span class="hljs-string">address</span> <span class="hljs-string">=</span> <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span><span class="hljs-string">:6379</span><br><span class="hljs-string">password</span> <span class="hljs-string">=</span> <span class="hljs-string">oldpassword</span><br><br>[<span class="hljs-string">target</span>] <br><span class="hljs-string">type</span> <span class="hljs-string">=</span> <span class="hljs-string">cluster</span><br><span class="hljs-string">address</span> <span class="hljs-string">=</span> <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span><span class="hljs-string">:7000,127.0.0.1:7001,127.0.0.1:7002</span><br><span class="hljs-string">password</span> <span class="hljs-string">=</span> <span class="hljs-string">newpassword</span><br><br>[<span class="hljs-string">filter</span>]<br><span class="hljs-comment"># è¿‡æ»¤ä¸´æ—¶æ•°æ®</span><br><span class="hljs-string">key.whitelist</span> <span class="hljs-string">=</span> <span class="hljs-string">user:*,session:*,cache:*</span><br></code></pre></td></tr></table></figure><h2 id="é£é™©æ§åˆ¶ä¸åº”æ€¥é¢„æ¡ˆ"><a href="#é£é™©æ§åˆ¶ä¸åº”æ€¥é¢„æ¡ˆ" class="headerlink" title="é£é™©æ§åˆ¶ä¸åº”æ€¥é¢„æ¡ˆ"></a>é£é™©æ§åˆ¶ä¸åº”æ€¥é¢„æ¡ˆ</h2><h3 id="å…³é”®é£é™©ç‚¹è¯†åˆ«"><a href="#å…³é”®é£é™©ç‚¹è¯†åˆ«" class="headerlink" title="å…³é”®é£é™©ç‚¹è¯†åˆ«"></a>å…³é”®é£é™©ç‚¹è¯†åˆ«</h3><ol><li><strong>æ•°æ®ä¸¢å¤±é£é™©</strong>ï¼šåŒæ­¥å»¶è¿Ÿå¯¼è‡´çš„æ•°æ®ä¸¢å¤±</li><li><strong>æ€§èƒ½æŠ–åŠ¨é£é™©</strong>ï¼šè¿ç§»è¿‡ç¨‹å¯¹çº¿ä¸ŠæœåŠ¡çš„æ€§èƒ½å½±å“</li><li><strong>æ•°æ®ä¸ä¸€è‡´é£é™©</strong>ï¼šå¹¶å‘å†™å…¥å¯¼è‡´çš„æ•°æ®ä¸ä¸€è‡´</li><li><strong>ä¾èµ–æœåŠ¡é£é™©</strong>ï¼šä¸Šä¸‹æ¸¸æœåŠ¡çš„å…¼å®¹æ€§é—®é¢˜</li></ol><h3 id="åº”æ€¥é¢„æ¡ˆ"><a href="#åº”æ€¥é¢„æ¡ˆ" class="headerlink" title="åº”æ€¥é¢„æ¡ˆ"></a>åº”æ€¥é¢„æ¡ˆ</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> MigrationController <span class="hljs-keyword">struct</span> &#123;<br>    state       MigrationState<br>    rollbackFn  <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> <span class="hljs-type">error</span><br>    checkpoints []Checkpoint<br>&#125;<br><br><span class="hljs-comment">// å¿«é€Ÿå›æ»šæœºåˆ¶</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(mc *MigrationController)</span></span> EmergencyRollback() <span class="hljs-type">error</span> &#123;<br>    logger.Warn(<span class="hljs-string">&quot;executing emergency rollback&quot;</span>)<br>    <br>    <span class="hljs-comment">// 1. åœæ­¢æ‰€æœ‰è¿ç§»ä»»åŠ¡</span><br>    mc.stopAllTasks()<br>    <br>    <span class="hljs-comment">// 2. æ¢å¤åˆ°æœ€è¿‘çš„æ£€æŸ¥ç‚¹</span><br>    lastCheckpoint := mc.getLastCheckpoint()<br>    <span class="hljs-keyword">if</span> err := mc.restoreCheckpoint(lastCheckpoint); err != <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">&quot;rollback failed: %w&quot;</span>, err)<br>    &#125;<br>    <br>    <span class="hljs-comment">// 3. éªŒè¯å›æ»šç»“æœ</span><br>    <span class="hljs-keyword">return</span> mc.validateRollback()<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="æ€»ç»“ä¸æœ€ä½³å®è·µ"><a href="#æ€»ç»“ä¸æœ€ä½³å®è·µ" class="headerlink" title="æ€»ç»“ä¸æœ€ä½³å®è·µ"></a>æ€»ç»“ä¸æœ€ä½³å®è·µ</h2><h3 id="æ ¸å¿ƒè¦ç‚¹"><a href="#æ ¸å¿ƒè¦ç‚¹" class="headerlink" title="æ ¸å¿ƒè¦ç‚¹"></a>æ ¸å¿ƒè¦ç‚¹</h3><ol><li><strong>å……åˆ†æµ‹è¯•</strong>ï¼šåœ¨æµ‹è¯•ç¯å¢ƒè¿›è¡Œå¤šè½®å®Œæ•´è¿ç§»æ¼”ç»ƒ</li><li><strong>æ¸è¿›å¼è¿ç§»</strong>ï¼šåˆ†é˜¶æ®µæ‰§è¡Œï¼Œæ¯ä¸ªé˜¶æ®µå……åˆ†éªŒè¯åå†è¿›å…¥ä¸‹ä¸€é˜¶æ®µ</li><li><strong>å®Œå–„ç›‘æ§</strong>ï¼šå»ºç«‹å…¨é¢çš„ç›‘æ§ä½“ç³»ï¼ŒåŠæ—¶å‘ç°å’Œå¤„ç†å¼‚å¸¸</li><li><strong>åº”æ€¥é¢„æ¡ˆ</strong>ï¼šåˆ¶å®šè¯¦ç»†çš„å›æ»šé¢„æ¡ˆï¼Œç¡®ä¿å‡ºç°é—®é¢˜æ—¶èƒ½å¿«é€Ÿæ¢å¤</li></ol><h3 id="æŠ€æœ¯é€‰å‹å»ºè®®"><a href="#æŠ€æœ¯é€‰å‹å»ºè®®" class="headerlink" title="æŠ€æœ¯é€‰å‹å»ºè®®"></a>æŠ€æœ¯é€‰å‹å»ºè®®</h3><ul><li><strong>å°æ•°æ®é‡ï¼ˆ&lt; 10GBï¼‰</strong>ï¼šmysqldump + åº”ç”¨å±‚åŒå†™</li><li><strong>ä¸­æ•°æ®é‡ï¼ˆ10GB - 1TBï¼‰</strong>ï¼šXtraBackup + DTSå·¥å…·</li><li><strong>å¤§æ•°æ®é‡ï¼ˆ&gt; 1TBï¼‰</strong>ï¼šåˆ†æ‰¹è¿ç§» + ä¸“ä¸šè¿ç§»å·¥å…·</li></ul><h3 id="æˆåŠŸçš„å…³é”®å› ç´ "><a href="#æˆåŠŸçš„å…³é”®å› ç´ " class="headerlink" title="æˆåŠŸçš„å…³é”®å› ç´ "></a>æˆåŠŸçš„å…³é”®å› ç´ </h3><ul><li><strong>å›¢é˜Ÿåä½œ</strong>ï¼šå¼€å‘ã€è¿ç»´ã€æµ‹è¯•å¤šå›¢é˜Ÿç´§å¯†é…åˆ</li><li><strong>æ—¶é—´è§„åˆ’</strong>ï¼šé¢„ç•™å……è¶³çš„æ—¶é—´å¤„ç†å¼‚å¸¸æƒ…å†µ</li><li><strong>é£é™©æ„è¯†</strong>ï¼šå§‹ç»ˆä¿æŒå¯¹é£é™©çš„æ•¬ç•å¿ƒç†</li><li><strong>æŠ€æœ¯å‚¨å¤‡</strong>ï¼šè¿ç§»å‰ç¡®ä¿å›¢é˜Ÿå…·å¤‡è¶³å¤Ÿçš„æŠ€æœ¯èƒ½åŠ›</li></ul><p>é€šè¿‡éµå¾ªä¸Šè¿°å®è·µæŒ‡å—ï¼Œå¯ä»¥å¤§å¤§é™ä½æ•°æ®è¿ç§»çš„é£é™©ï¼Œç¡®ä¿ä¸šåŠ¡ç³»ç»Ÿçš„ç¨³å®šè¿è¡Œã€‚</p>]]></content>
    
    
    <categories>
      
      <category>ç³»ç»Ÿæ¶æ„</category>
      
      <category>æ•°æ®åº“</category>
      
    </categories>
    
    
    <tags>
      
      <tag>æ•°æ®åº“è¿ç§»</tag>
      
      <tag>é«˜å¯ç”¨</tag>
      
      <tag>è¿ç»´</tag>
      
      <tag>MySQL</tag>
      
      <tag>Redis</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Single-flight æ ¸å¿ƒé€»è¾‘æ‹†è§£</title>
    <link href="/2022/07/17/single-flight-analysis/"/>
    <url>/2022/07/17/single-flight-analysis/</url>
    
    <content type="html"><![CDATA[<p>ä¸šåŠ¡åœºæ™¯ä¸­ç»å¸¸ä¼šæœ‰ç¼“å­˜çš„èº«å½±ï¼Œè™½ç„¶ç¼“å­˜ç»™æˆ‘ä»¬å¸¦æ¥äº†è¯¸å¤šå¥½å¤„ï¼Œä½†æ˜¯ç¼“å­˜å¸¦æ¥çš„é—®é¢˜å´ä¸å®¹å°è§‘ï¼Œå¸¸è§çš„æœ‰ç¼“å­˜é›ªå´©ã€ç¼“å­˜ç©¿é€ã€ç¼“å­˜å‡»ç©¿ã€‚ ä»Šå¤©æ¥è¯´è¯´ç¼“å­˜å‡»ç©¿åŠå…¶è§£å†³æ–¹æ¡ˆã€‚</p><h2 id="é—®é¢˜åœºæ™¯"><a href="#é—®é¢˜åœºæ™¯" class="headerlink" title="é—®é¢˜åœºæ™¯"></a>é—®é¢˜åœºæ™¯</h2><p>å½“å‘ç”Ÿç¼“å­˜å‡»ç©¿æ—¶ï¼Œç¬æ—¶æµé‡ä¼šæ¶Œå…¥ä¸‹æ¸¸æœåŠ¡æˆ–è€…å­˜å‚¨é€ æˆæå¤§çš„å†²å‡»ç”šè‡³æ‰“æŒ‚ï¼Œæ­¤æ—¶ä¸šåŠ¡åº”è¯¥å¦‚ä½•åº”å¯¹ï¼Ÿ</p><span id="more"></span><h2 id="è§£å†³æ–¹æ¡ˆ"><a href="#è§£å†³æ–¹æ¡ˆ" class="headerlink" title="è§£å†³æ–¹æ¡ˆ:"></a>è§£å†³æ–¹æ¡ˆ:</h2><p>singleflight, ä¸»è¦è§£å†³äº†:</p><ol><li>æµé‡åˆå¹¶ï¼Œå°†Nä¸ªè¯·æ±‚-&gt;1ä¸ªè¯·æ±‚</li><li>æµé‡æ‹¦æˆªï¼Œå¦‚æœå‘ç°å·²ç»æœ‰inflightè¯·æ±‚ï¼Œä¼šé˜»å¡ç­‰å¾…inflightè¯·æ±‚è¿”å›ç»“æœ</li></ol><h3 id="æ ¸å¿ƒé€»è¾‘"><a href="#æ ¸å¿ƒé€»è¾‘" class="headerlink" title="æ ¸å¿ƒé€»è¾‘"></a>æ ¸å¿ƒé€»è¾‘</h3><ul><li><p>æŠ½è±¡åŒç±»è¯·æ±‚ï¼Œåˆ©ç”¨wgå»æ§åˆ¶é˜»å¡</p><figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs gauss"><span class="hljs-built_in">type</span> <span class="hljs-keyword">call</span> <span class="hljs-keyword">struct</span> &#123;<br>wg sync.WaitGroup <span class="hljs-comment">//åˆ©ç”¨å…¶Wait é˜»å¡è¯·æ±‚</span><br><br>val interface&#123;&#125; <span class="hljs-comment">// è¿”å›ç»“æœï¼Œè¢«é˜»å¡è¯·æ±‚éœ€è¦</span><br><br>    <span class="hljs-meta">## çœç•¥éæ ¸å¿ƒå­—æ®µ</span><br>&#125;<br><br></code></pre></td></tr></table></figure></li><li><p>ä¿å­˜å…¨å±€ç¬æ—¶è¯·æ±‚</p><figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs gauss"><span class="hljs-built_in">type</span> Group <span class="hljs-keyword">struct</span> &#123;<br>mu sync.Mutex       <span class="hljs-comment">// protects m</span><br>m  map[<span class="hljs-keyword">string</span>]*<span class="hljs-keyword">call</span> <span class="hljs-comment">// ä¿å­˜å…¨å±€è¯·æ±‚ï¼Œlazily initialized</span><br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>æ ¸å¿ƒå‡½æ•°Do</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(g *Group)</span></span> Do(key <span class="hljs-type">string</span>, fn <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> (<span class="hljs-keyword">interface</span>&#123;&#125;, <span class="hljs-type">error</span>)) (v <span class="hljs-keyword">interface</span>&#123;&#125;, err <span class="hljs-type">error</span>, shared <span class="hljs-type">bool</span>) &#123;<br>g.mu.Lock()<br><span class="hljs-keyword">if</span> g.m == <span class="hljs-literal">nil</span> &#123;<br>g.m = <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]*call)<br>&#125;<br><span class="hljs-keyword">if</span> c, ok := g.m[key]; ok &#123;<br>c.dups++<br>g.mu.Unlock()<br>## ä¸€æ—¦å‘ç°æœ‰è¯·æ±‚ï¼Œå°±åœ¨è¿™é˜»å¡ï¼Œæ³¨æ„ä½¿ç”¨äº†wg<br>c.wg.Wait()<br><br>#<span class="hljs-keyword">if</span> e, ok := c.err.(*panicError); ok &#123;<br>#<span class="hljs-built_in">panic</span>(e)<br>#&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> c.err == errGoexit &#123;<br>#runtime.Goexit()<br>#&#125;<br><span class="hljs-keyword">return</span> c.val, c.err, <span class="hljs-literal">true</span><br>&#125;<br>c := <span class="hljs-built_in">new</span>(call)<br>c.wg.Add(<span class="hljs-number">1</span>)<br>g.m[key] = c<br>g.mu.Unlock()<br><br>g.doCall(c, key, fn)<br><span class="hljs-keyword">return</span> c.val, c.err, c.dups &gt; <span class="hljs-number">0</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(g *Group)</span></span> doCall(c *call, key <span class="hljs-type">string</span>, fn <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> (<span class="hljs-keyword">interface</span>&#123;&#125;, <span class="hljs-type">error</span>)) &#123;<br><span class="hljs-comment">// use double-defer to distinguish panic from runtime.Goexit,</span><br><span class="hljs-comment">// more details see https://golang.org/cl/134395</span><br><span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-comment">// the given function invoked runtime.Goexit</span><br><span class="hljs-keyword">if</span> !normalReturn &amp;&amp; !recovered &#123;<br>c.err = errGoexit<br>&#125;<br><br>g.mu.Lock()<br><span class="hljs-keyword">defer</span> g.mu.Unlock()<br>c.wg.Done()<br><span class="hljs-keyword">if</span> g.m[key] == c &#123;<br><span class="hljs-built_in">delete</span>(g.m, key)<br>&#125;<br>        .... çœç•¥<span class="hljs-built_in">panic</span>/channelç›¸å…³å¤„ç†<br>&#125;()<br>    .... çœç•¥éæ ¸å¿ƒä»£ç <br>c.val, c.err = fn()<br>    ...  çœç•¥éæ ¸å¿ƒä»£ç <br><br><span class="hljs-keyword">if</span> !normalReturn &#123;<br>recovered = <span class="hljs-literal">true</span><br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure></li></ul><h3 id="è‡ªå·±åŠ¨æ‰‹å®è·µ"><a href="#è‡ªå·±åŠ¨æ‰‹å®è·µ" class="headerlink" title="è‡ªå·±åŠ¨æ‰‹å®è·µ"></a>è‡ªå·±åŠ¨æ‰‹å®è·µ</h3><p>tips:<br>ä¸ºäº†ç†è§£singleflightçš„è®¾è®¡æ€æƒ³ï¼Œåœ¨å®è·µè¿‡ç¨‹ä¸­çœå»äº†éæ ¸å¿ƒé€»è¾‘, åªå…³æ³¨æ ¸å¿ƒæ•°æ®ç»“æ„ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;fmt&quot;</span><br><span class="hljs-string">&quot;sync&quot;</span><br><span class="hljs-string">&quot;sync/atomic&quot;</span><br><span class="hljs-string">&quot;time&quot;</span><br>)<br><br><span class="hljs-keyword">type</span> HandleFn <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> (<span class="hljs-keyword">interface</span>&#123;&#125;, <span class="hljs-type">error</span>)<br><br><span class="hljs-keyword">type</span> call <span class="hljs-keyword">struct</span> &#123;<br>sync.WaitGroup<br>val <span class="hljs-keyword">interface</span>&#123;&#125;<br>err <span class="hljs-type">error</span><br>&#125;<br><br><span class="hljs-keyword">var</span> (<br>groups = <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]*call)<br>mu     sync.RWMutex<br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-keyword">var</span> wg sync.WaitGroup<br>num := <span class="hljs-number">5</span><br>wg.Add(num)<br><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; num; i++ &#123;<br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(gid <span class="hljs-type">int</span>)</span></span> &#123;<br><span class="hljs-keyword">defer</span> wg.Done()<br>v, err := Do(<span class="hljs-string">&quot;key1&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> (<span class="hljs-keyword">interface</span>&#123;&#125;, <span class="hljs-type">error</span>) &#123;<br>queryDB(gid)<br><span class="hljs-keyword">return</span> time.Now().Unix(), <span class="hljs-literal">nil</span><br>&#125;)<br>fmt.Println(<span class="hljs-string">&quot;Goroutine:&quot;</span>, gid, <span class="hljs-string">&quot;----&gt; get data &quot;</span>, v, err)<br>&#125;(i)<br>&#125;<br>wg.Wait()<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">queryDB</span><span class="hljs-params">(gid <span class="hljs-type">int</span>)</span></span> &#123;<br><span class="hljs-comment">// æ¨¡æ‹ŸæŸ¥è¯¢DB</span><br>time.Sleep(<span class="hljs-number">1</span> * time.Second)<br>fmt.Println(<span class="hljs-string">&quot;Goroutine:&quot;</span>, gid, <span class="hljs-string">&quot;---&gt; querying DB .... &quot;</span>)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Do</span><span class="hljs-params">(key <span class="hljs-type">string</span>, fn HandleFn)</span></span> (<span class="hljs-keyword">interface</span>&#123;&#125;, <span class="hljs-type">error</span>) &#123;<br>mu.Lock()<br>w, ok := groups[key]<br><span class="hljs-keyword">if</span> ok &#123;<br>mu.Unlock()<br>w.Wait()<br><span class="hljs-keyword">return</span> w.val, w.err<br>&#125;<br>c := <span class="hljs-built_in">new</span>(call)<br>c.Add(<span class="hljs-number">1</span>)<br>groups[key] = c<br>mu.Unlock()<br><br>fmt.Println(<span class="hljs-string">&quot;---&gt;call&quot;</span>)<br>c.val, c.err = fn()<br><br>mu.Lock()<br>c.Done()<br><span class="hljs-built_in">delete</span>(groups, key)<br>mu.Unlock()<br><br><span class="hljs-keyword">return</span> c.val, c.err<br>&#125;<br><br></code></pre></td></tr></table></figure><p>è¾“å‡ºç»“æœ:</p><figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs xl">---&gt;call<br>G<span class="hljs-function"><span class="hljs-title">oroutine</span>: 0 ---&gt;</span> querying DB .... <br>G<span class="hljs-function"><span class="hljs-title">oroutine</span>: 2 ----&gt;</span> get <span class="hljs-keyword">data</span>  <span class="hljs-number">1721205160</span> &lt;<span class="hljs-literal">nil</span>&gt;<br>G<span class="hljs-function"><span class="hljs-title">oroutine</span>: 0 ----&gt;</span> get <span class="hljs-keyword">data</span>  <span class="hljs-number">1721205160</span> &lt;<span class="hljs-literal">nil</span>&gt;<br>G<span class="hljs-function"><span class="hljs-title">oroutine</span>: 1 ----&gt;</span> get <span class="hljs-keyword">data</span>  <span class="hljs-number">1721205160</span> &lt;<span class="hljs-literal">nil</span>&gt;<br>G<span class="hljs-function"><span class="hljs-title">oroutine</span>: 4 ----&gt;</span> get <span class="hljs-keyword">data</span>  <span class="hljs-number">1721205160</span> &lt;<span class="hljs-literal">nil</span>&gt;<br>G<span class="hljs-function"><span class="hljs-title">oroutine</span>: 3 ----&gt;</span> get <span class="hljs-keyword">data</span>  <span class="hljs-number">1721205160</span> &lt;<span class="hljs-literal">nil</span>&gt;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>GO</tag>
      
      <tag>ç¼“å­˜å‡»ç©¿</tag>
      
      <tag>ç¼“å­˜é—®é¢˜</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>go_nginx_502é—®é¢˜æ’æŸ¥</title>
    <link href="/2022/07/09/go-nginx-502/"/>
    <url>/2022/07/09/go-nginx-502/</url>
    
    <content type="html"><![CDATA[<blockquote><p>çº¿ä¸Šå·¡æ£€å‘ç°å¾ˆå¤š502æ—¥å¿—ï¼Œäºæ˜¯å°±å¼€å§‹äº†æ¼«æ¼«debug</p></blockquote><span id="more"></span><p>ç®€å•ä»‹ç»èƒŒæ™¯</p><ol><li>çº¿ä¸ŠæœåŠ¡:</li></ol><ul><li>å®¹å™¨éƒ¨ç½²</li><li>http</li><li>Nginx + Go</li><li>æœåŠ¡è€—æ—¶åŸºæœ¬åœ¨100mså·¦å³</li></ul><ol start="2"><li>å·²åšæ’æŸ¥ï¼Œæ’é™¤æœåŠ¡ä¸å¯ç”¨å¯¼è‡´çš„502é—®é¢˜</li></ol><ul><li>æœåŠ¡æ˜¯å¦é‡å¯</li><li>å®¹å™¨æ˜¯å¦å¼‚å¸¸ã€é‡å¯</li><li>ç£ç›˜ã€cpuæ˜¯å¦å¼‚å¸¸</li></ul><h2 id="é—®é¢˜ç°åœº"><a href="#é—®é¢˜ç°åœº" class="headerlink" title="é—®é¢˜ç°åœº"></a>é—®é¢˜ç°åœº</h2><h3 id="é—®é¢˜1-upstream-prematurely-closed-connection"><a href="#é—®é¢˜1-upstream-prematurely-closed-connection" class="headerlink" title="é—®é¢˜1: upstream prematurely closed connection"></a>é—®é¢˜1: upstream prematurely closed connection</h3><p>åœ¨æ’æŸ¥nginxæ—¥å¿—æ—¶å‘ç°å¦‚ä¸‹é”™è¯¯</p><blockquote><p>nginx error log: â€œupstream prematurely closed connection while reading response header from upstreamâ€</p></blockquote><p>å¾ˆæ˜æ˜¾æœåŠ¡ä¸»åŠ¨å…³é—­äº†è¿æ¥ï¼ŒhttpServerä¸»åŠ¨å…³é—­è¿æ¥ä¸€èˆ¬æ˜¯read&#x2F;writeè¶…æ—¶äº†, ä½†æ˜¯æŸ¥çœ‹æœåŠ¡é…ç½®å‘ç°read&#x2F;writeåˆ†åˆ«1s&#x2F;3s, å¹¶ä¸”æœåŠ¡é€»è¾‘ä¸­éƒ½æœ‰ä¸¥æ ¼çš„è¶…æ—¶æ§åˆ¶ã€æ²¡æœ‰é˜»å¡é€»è¾‘ï¼Œè®²é“ç†ä¸å¤ªå¯èƒ½è§¦å‘ï¼Œæ‰€ä»¥è¿™é‡Œæ’é™¤ã€‚é—®é¢˜åˆ°è¿™é‡Œä¼¼ä¹è¿›åˆ°æ­»èƒ¡åŒäº†ï¼Œè¿™æ—¶åœ¨çœ‹serveræºç æ˜¯å‘ç°<font color="red">idletimeout</font>è¿™ä¸ªé…ç½®, å¦‚æœæ²¡æœ‰è®¾ç½®é»˜è®¤å–read timeoutï¼Œç»googleä¹‹åå‘ç°å°±æ˜¯keepaliveçš„timeoutã€‚æˆ‘ä»¬çŸ¥é“http&#x2F;1.1é»˜è®¤éƒ½æ˜¯keepaliveçš„, å¦‚æœè§¦å‘äº†keepalive timeout, serverä¼šä¸»åŠ¨å…³é—­è¿æ¥ï¼Œäºæ˜¯å¼€å§‹æŠ“åŒ…åˆ†æ(å¦‚ä¸‹å›¾)ï¼Œå‘ç°goæœåŠ¡åœ¨1sä¹‹åä¸»åŠ¨æ–­å¼€äº†å’Œnginxçš„è¿æ¥ã€‚</p><p><img src="/images/wireshark_502.png" alt="img.png"></p><p>è¿™é‡Œæ€»ç»“ä¸‹æ•´ä¸ªè¯·æ±‚é“¾è·¯.<br>é¦–å…ˆnginxå’Œupstream server(go æœåŠ¡)ä¹‹é—´ä¼šåˆ›å»ºå¤šä¸ªè¿æ¥ï¼›å¤–éƒ¨è¯·æ±‚è¿›æ¥ä»¥å, nginxä½œä¸ºclientç«¯ï¼Œä»è¿æ¥æ± è·å–ä¸€ä¸ªè¿æ¥è¯·æ±‚ï¼Œå¦‚æœæ­¤æ—¶åˆšå¥½è¿™ä¸ªè¿æ¥keepalive timeoutäº†é‚£ä¹ˆå°±ä¼šè§¦å‘502ã€‚</p><p>é—®é¢˜è§£å†³:</p><ol><li>nginx proxyè®¾ç½®keepalive;<br><code>proxy_http_version 1.1</code> ã€ <code>proxy_set_header Connection &quot;&quot;</code><br>upstreamä¸éœ€è¦å¤–éƒ¨è¯·æ±‚Connectionæ§åˆ¶ï¼Œç›´æ¥æ¸…ç©º<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-section">location</span> / &#123;<br>        <span class="hljs-attribute">proxy_pass</span> xxxx;<br>        <br>        <span class="hljs-comment"># !!!!! start </span><br>        <span class="hljs-attribute">proxy_http_version</span> <span class="hljs-number">1</span>.<span class="hljs-number">1</span>;<br>        <span class="hljs-attribute">proxy_set_header</span> Connection <span class="hljs-string">&quot;&quot;</span>;<br>         <span class="hljs-comment"># !!!!! end </span><br>        <span class="hljs-comment">#proxy_read_timeout     300;    </span><br>        <span class="hljs-comment">#proxy_connect_timeout  300;</span><br>        <span class="hljs-comment">#proxy_set_header X-Real-IP $remote_addr;</span><br>        <span class="hljs-comment"># needed for HTTPS</span><br>        <span class="hljs-comment"># # proxy_set_header X_FORWARDED_PROTO https;</span><br>        <span class="hljs-comment">#proxy_set_header X-Forwarded-For $remote_addr;</span><br>        <span class="hljs-comment">#proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br>        <span class="hljs-comment">#proxy_set_header Host $host;</span><br>&#125;<br></code></pre></td></tr></table></figure></li><li>nginx.confè®¾ç½®keepalive timeout<br>è¿™é‡Œæ—¶nginxå’Œå¤–éƒ¨è¯·æ±‚çš„keepalive, å¦‚æœè¶…è¿‡è¿™æ—¶é—´nginxä¼šå…³é—­è¿æ¥ã€‚<figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs abnf">keepalive_timeout  <span class="hljs-number">60</span>s<span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure></li><li>upstream serverè®¾ç½®keepalive timeout<figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs lasso">&amp;http.Server&#123;<br>#Addr: addr,<br>#Handler:    http.HandlerFunc(ServeHTTP),<br>#ReadTimeout:  time.<span class="hljs-built_in">Duration</span>(httpRunner.ReadTimeout) * time.Second,<br>#WriteTimeout: time.<span class="hljs-built_in">Duration</span>(httpRunner.WriteTimeout) * time.Second,<br><span class="hljs-params">...</span><br>IdleTimeout:  time.<span class="hljs-built_in">Duration</span>(httpRunner.IdleTimeout) * time.Second,<br><span class="hljs-params">...</span><br>#ConnState:    httpRunner.connState,<br>#ErrorLog:     syslog.<span class="hljs-literal">New</span>(httpErrorLog&#123;logger&#125;, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-number">0</span>),<br>&#125;<br></code></pre></td></tr></table></figure></li></ol><h3 id="é—®é¢˜2-listen-backlog-è¿‡ä½"><a href="#é—®é¢˜2-listen-backlog-è¿‡ä½" class="headerlink" title="é—®é¢˜2: listen backlog è¿‡ä½"></a>é—®é¢˜2: listen backlog è¿‡ä½</h3><p>åœ¨å¯¹æœåŠ¡è¿›è¡Œå‹æµ‹æ—¶ï¼Œå‘ç°è¯·æ±‚å¦‚æœèµ°nginxä¼šå‘ç”Ÿé˜»å¡ï¼Œè€Œç›´æ¥å‹æµ‹æœåŠ¡å´èƒ½æ­£å¸¸è¿è¡Œï¼Œæ­¤æ—¶å‘ç°nginxæ—¥å¿—æœ‰å¤§é‡502</p><p>é—®é¢˜è§£å†³:</p><ol><li>listen backlogç”¨äº†é»˜è®¤é•¿åº¦511, listen backlogæ˜¯é•¿è¿æ¥é˜Ÿåˆ—é•¿åº¦ï¼Œå¦‚æœé•¿åº¦è¿‡çŸ­ï¼Œå®¹æ˜“æ‰“æ»¡æ‹’ç»è¯·æ±‚ï¼Œå°†backlogé•¿åº¦è°ƒå¤§ï¼Œèƒ½è¿›ä¸€æ­¥æå‡ååã€‚</li><li>æ³¨æ„å…¨å±€é•¿è¿æ¥é˜Ÿåˆ—é™åˆ¶ <code>/proc/sys/net/core/somaxconn</code> ä¹Ÿå¾—è°ƒæ•´ï¼Œ<code>nginx backlog</code> &lt;&#x3D; <code>somaxconn</code></li></ol><h3 id="é—®é¢˜3-æš´åŠ›æ¸…ç†nginxæ—¥å¿—"><a href="#é—®é¢˜3-æš´åŠ›æ¸…ç†nginxæ—¥å¿—" class="headerlink" title="é—®é¢˜3: æš´åŠ›æ¸…ç†nginxæ—¥å¿—"></a>é—®é¢˜3: æš´åŠ›æ¸…ç†nginxæ—¥å¿—</h3><p>é€šè¿‡keepaliveé…ç½®ï¼Œ502é—®é¢˜ç¡®å®æ˜æ˜¾æ”¹å–„äº†ï¼Œä½†æ˜¯çªç„¶è¿‡äº†å‡ å¤©ï¼Œåˆå¶ç°äº†502é—®é¢˜ï¼Œåœ¨æ’æŸ¥åŸºç¡€èµ„æºç›‘æ§æ—¶å‘ç°502çš„æ—¶é—´ç‚¹ï¼Œæ°å¥½æœ‰ç£ç›˜å’Œå†…å­˜ç©ºé—´éª¤é™ï¼›<br>è¿™é‡Œå®šä½æ˜¯å› ä¸ºåå‘ä»£ç†çš„nginxä¼šè®°å½•accessæ—¥å¿—ï¼Œè€Œæˆ‘ä»¬çš„æœåŠ¡æµé‡å¾ˆé«˜accessæ—¥å¿—å®¹æ˜“å†™æ»¡ï¼Œéœ€è¦å®šæ—¶æ¸…ç†ï¼Œæ¸…ç†é€»è¾‘ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># crontab</span><br><span class="hljs-built_in">echo</span> &gt; /path/access.log<br></code></pre></td></tr></table></figure><p>è¿™é‡Œæœ‰ä¸ªèƒŒæ™¯è¯´æ˜ä¸‹:<br>accessæ–‡ä»¶æ˜¯ä¼šè¢«é‡‡é›†ç¨‹åºè®¿é—®ä¸ŠæŠ¥åˆ°æ—¥å¿—å¹³å°ã€‚ä¸Šè¿°ç›´æ¥â€echo &gt; â€œ æ˜¯å¯èƒ½ä¼šå¯¼è‡´os.Cacheä¸­æ—¥å¿—è¢«æ¸…ç†,å¯èƒ½é‡‡é›†ç¨‹åºå°±ä¼šé‡‡é›†ä¸åˆ°ï¼Œå‡ºç°å¼‚å¸¸ã€‚</p><p>æ”¹é€ é€»è¾‘: </p><ul><li>logrotate 10Gåˆ‡å‰²ï¼Œåªä¿ç•™1ä¸ªå¤‡ä»½æ–‡ä»¶</li><li>å¤‡ä»½æ–‡ä»¶ä¼šç­‰æ®µæ—¶é—´æ‰è¢«æ¸…ç†(å½“å‰10min), ä¿è¯é‡‡é›†ç¨‹åºèƒ½é‡‡é›†æˆåŠŸ</li></ul><p>å½“ç„¶ä¹Ÿå¯ä»¥è‡ªå·±å†™é€»è¾‘:</p><ol><li>æŒ‰access.log 10gä¸ºåˆ‡å‰²</li><li>å†å²æ–‡ä»¶ä¸ä¼šç«‹å³è¢«æ¸…ç†ä¼šï¼Œç­‰å¾…10minï¼Œä¿è¯é‡‡é›†ç¨‹åºèƒ½é‡‡é›†æˆåŠŸ</li><li>kill -USR1 nginxpid, å‘½ä»¤nginxé‡æ–°åŠ è½½é…ç½®ã€‚<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-attribute">file_path</span>=<span class="hljs-string">&quot;/path/&quot;</span><br><span class="hljs-attribute">log_file</span>=<span class="hljs-string">&quot;access.log&quot;</span><br><span class="hljs-comment">#nginxè¿›ç¨‹id</span><br><span class="hljs-attribute">nginx_pid</span>=<span class="hljs-string">&quot;/path/nginx.pid &quot;</span><br><span class="hljs-comment">#å•ä½:G</span><br><span class="hljs-attribute">max_log_size</span>=10<br><span class="hljs-comment"># å¤‡ä»½æ—¥å¿—æœ€é•¿å­˜æ´»æ—¶é—´ å•ä½:s</span><br><span class="hljs-attribute">max_log_ttl</span>=300<br><br><br><span class="hljs-attribute">timestamp</span>=$(date +%s)<br><span class="hljs-attribute">log_back_file</span>=<span class="hljs-string">&quot;<span class="hljs-variable">$file_path</span><span class="hljs-variable">$log_file</span>-bak-<span class="hljs-variable">$timestamp</span>&quot;</span><br><span class="hljs-comment"># è·å–æ–‡ä»¶å¤§å°ï¼ˆä»¥å­—èŠ‚ä¸ºå•ä½ï¼‰</span><br><span class="hljs-attribute">file_size</span>=$(stat -c <span class="hljs-string">&quot;%s&quot;</span> <span class="hljs-string">&quot;<span class="hljs-variable">$file_path</span><span class="hljs-variable">$log_file</span>&quot;</span>)<br><span class="hljs-attribute">file_size_gb</span>=$(echo <span class="hljs-string">&quot;scale=2; <span class="hljs-variable">$file_size</span> / 1024^3&quot;</span> | bc)<br><span class="hljs-comment"># åˆ¤æ–­æ–‡ä»¶å¤§å°æ˜¯å¦è¶…è¿‡10G</span><br><span class="hljs-keyword">if</span> (( $(echo <span class="hljs-string">&quot;<span class="hljs-variable">$file_size_gb</span> &gt; <span class="hljs-variable">$max_log_size</span> &quot;</span> | bc -l) )); then<br>    mv <span class="hljs-variable">$file_path</span><span class="hljs-variable">$log_file</span>  <span class="hljs-variable">$log_back_file</span><br>    cat <span class="hljs-variable">$nginx_pid</span> | xargs kill -USR1<br>fi<br><br><span class="hljs-comment"># éå†å½“å‰ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶</span><br><span class="hljs-keyword">for</span> file <span class="hljs-keyword">in</span> <span class="hljs-string">&quot;<span class="hljs-variable">$file_path</span>/<span class="hljs-variable">$log_file</span>&quot;</span>-bak-*; <span class="hljs-keyword">do</span><br>    # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦ä¸ºæ™®é€šæ–‡ä»¶å¹¶ä¸”ä¿®æ”¹æ—¶é—´è¶…è¿‡10åˆ†é’Ÿ<br>    <span class="hljs-keyword">if</span> [[ -f <span class="hljs-string">&quot;<span class="hljs-variable">$file</span>&quot;</span> &amp;&amp; $(($(date +%s) - $(stat -c %Y <span class="hljs-string">&quot;<span class="hljs-variable">$file</span>&quot;</span>))) -gt <span class="hljs-variable">$max_log_ttl</span> ]]; then<br>        # åˆ é™¤æ–‡ä»¶<br>        rm <span class="hljs-string">&quot;<span class="hljs-variable">$file</span>&quot;</span><br>        echo <span class="hljs-string">&quot;å·²åˆ é™¤æ–‡ä»¶: <span class="hljs-variable">$file</span>&quot;</span><br>    fi<br>done<br></code></pre></td></tr></table></figure></li></ol><h3 id="ä¼˜åŒ–æˆæœ"><a href="#ä¼˜åŒ–æˆæœ" class="headerlink" title="ä¼˜åŒ–æˆæœ"></a>ä¼˜åŒ–æˆæœ</h3><p>ä¹‹å‰æ¯å¤©å¿…å¤ç°, è¿ç»­ä¸€å‘¨æœªæ”¶åˆ°å‘Šè­¦<br><img src="/../images/now_502.png" alt="img.png"></p>]]></content>
    
    
    
    <tags>
      
      <tag>Go</tag>
      
      <tag>Nginx</tag>
      
      <tag>502</tag>
      
      <tag>keepalive</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
